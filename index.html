<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACT — MAKE A IMPACT</title>
  <meta name="description" content="IMPACT — WordPress 기반 학생 저자 콘텐츠를 불러와 자체 포스트/ABOUT/EDITORS 페이지로 표시하는 통합 페이지" />
  <link rel="icon" href="logo.png" type="image/png">

  <style>
  /* ==========================================================================
     IMPACT — Full index.html styles
     - Layout, components, responsive behavior, accessibility enhancements
     - No tokens or secrets in client-side code. Use Netlify Functions for WP calls.
     ========================================================================== */

  /* ====================
     RESET & BASE
     ==================== */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; width: 100%; }
  body {
    margin: 0;
    font-family: "Noto Sans KR", "Apple SD Gothic Neo", "Segoe UI", Roboto, Arial, sans-serif;
    background: #f6f7f9;
    color: #111;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden; /* Prevent horizontal scrolling on mobile */
  }
  a { color: inherit; text-decoration: none; }
  img { display: block; max-width: 100%; height: auto; }

  /* ====================
     UTILS
     ==================== */
  .wrap { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
  .hidden { display: none !important; }
  .visually-hidden {
    position: absolute !important;
    height: 1px; width: 1px; overflow: hidden;
    clip: rect(1px,1px,1px,1px); white-space: nowrap;
  }

  /* ====================
     HEADER
     ==================== */
  header.header {
    position: sticky; top: 0; z-index: 1200;
    background: #fff; border-bottom: 1px solid rgba(0,0,0,0.06);
    backdrop-filter: blur(6px);
  }
  .header-inner {
    height: 72px; display:flex; align-items:center;
    justify-content:space-between; gap:12px; max-width:1400px;
    margin:0 auto; padding: 0 20px;
  }
  .brand { display:flex; gap:12px; align-items:center; }
  .brand .logo {
    display:flex; gap:8px; align-items:center; font-weight:900;
    font-size:26px; letter-spacing:1px; color:#111; cursor:pointer;
  }
  .brand .logo small { font-size:11px; color:#777; font-weight:800; display:block; line-height:1; }
  .header-actions { display:flex; gap:8px; align-items:center; }

  .btn {
    border-radius:10px; background:#fff; padding:8px 12px;
    border:1px solid rgba(0,0,0,0.08); font-weight:700; font-size:14px;
    cursor:pointer; transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn:active { transform: translateY(1px); }
  .btn.primary { background: linear-gradient(135deg,#2e8b57,#1f7a6f); color:#fff; border:none; }

  /* search icon button forces consistent width even if text hidden */
  .btn.search { min-width:56px; display:inline-flex; align-items:center; justify-content:center; font-size:18px; }

  /* ====================
     NAV OVERLAY
     ==================== */
  .nav-overlay {
    position: fixed; top: 0; right: -50%; width: 50%; height: 100vh;
    background: rgba(255,255,255,0.98); z-index: 2200;
    transition: right 0.32s cubic-bezier(.2,.9,.2,1);
    display: flex; flex-direction: column; padding: 64px 40px; box-shadow: -6px 0 40px rgba(0,0,0,0.08);
  }
  .nav-overlay.active { right: 0; }
  .nav-close { position:absolute; top:28px; right:28px; background:none; border:none; font-size:30px; cursor:pointer; }
  .nav-search { display:flex; align-items:center; gap:10px; margin-bottom:36px; }
  .nav-search input[type="search"] {
    flex:1; border:none; border-bottom:2px solid #111; padding:10px 8px; outline:none; font-weight:700; font-size:16px;
    background:transparent;
  }
  .nav-list { list-style:none; padding:0; margin:0 0 24px; display:flex; flex-direction:column; gap:18px; }
  .nav-list li { font-size:28px; font-weight:900; cursor:pointer; color:#111; transition: color .16s ease; }
  .nav-list li:hover { color:#2e8b57; }
  .nav-footer-links { margin-top:auto; display:flex; gap:12px; align-items:center; font-weight:800; }
  .nav-footer-links a { color:#111; font-size:13px; }

  /* Mobile: nav overlay full-screen */
  @media (max-width:680px) {
    .nav-overlay { right: 0; left: 0; width: 100%; padding: 28px; }
  }

  /* ====================
     HOME LAYOUT
     ==================== */
  .home { max-width:1400px; margin: 28px auto; display:flex; flex-direction:column; gap:28px; padding: 0 20px 100px; }

  /* Grid: left hero big + right column of 4 stack cards */
  .row { display:grid; grid-template-columns: 2fr 1fr; gap:20px; align-items:start; }
  .col-left { position:relative; border-radius:12px; overflow:hidden; min-height:360px; background:#eee; cursor:pointer; display:flex; flex-direction:column; }
  .col-left .hero { width:100%; height:100%; object-fit:cover; display:block; min-height:360px; }
  .col-left .hero-overlay { position:absolute; inset:auto 0 0 0; padding:22px; display:flex; flex-direction:column; gap:12px; background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.55)); color:#fff; }
  .col-left .hero-title { margin:0; font-size:28px; font-weight:900; line-height:1.05; max-width:92%; }
  .col-left .meta { display:flex; align-items:center; gap:10px; color:#fff; font-size:13px; opacity:0.95; }
  .col-right { display:flex; flex-direction:column; gap:12px; }

  .card { background:#fff; border-radius:10px; overflow:hidden; border:1px solid rgba(0,0,0,0.06); transition: box-shadow .16s ease, transform .12s ease; cursor:pointer; display:flex; flex-direction:column;}
  .card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.06); }
  .card .thumb { width:100%; height:120px; overflow:hidden; background:#efefef; }
  .card .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
  .card .card-body { padding:12px; flex:1; display:flex; flex-direction:column; justify-content:space-between; }
  .card h3 { font-size:16px; font-weight:800; margin:0 0 8px; color:#111; }
  .card .meta { display:flex; align-items:center; gap:8px; color:#666; font-size:13px; }

  .cat-badge { display:inline-block; padding:6px 10px; border-radius:6px; font-weight:800; font-size:12px; color:#fff; }

  .hero-cats { position:absolute; right:16px; bottom:16px; display:flex; gap:6px; }

  /* 카테고리 컬러 */
  .cat-tech{ background:#1e90ff; }
  .cat-eat{ background:#ff6347; }
  .cat-style{ background:#32cd32; }
  .cat-culture{ background:#8a2be2; }
  .cat-life{ background:#ffa500; color:#000; }
  .cat-editors-pick{ background:#ff1493; }

  /* ====================
     OVERLAYS: category, post, search, about, editors
     ==================== */
  .overlay-full {
    display:none; position:fixed; inset:0; background:#fff; z-index:2000; overflow:auto; padding:28px; animation: overlayIn .28s ease;
  }
  .overlay-full.active { display:block; }
  @keyframes overlayIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

  .overlay-top { display:flex; justify-content:space-between; align-items:center; gap:12px; border-bottom:1px solid rgba(0,0,0,0.06); padding-bottom:12px; }
  .overlay-title { font-size:24px; font-weight:900; color:#111; }

  .overlay-grid { margin-top:18px; display:grid; gap:18px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); padding:20px 0 80px; }

  .post-article { margin:0 auto; max-width:900px; }
  .post-article h1 { font-size:34px; font-weight:900; margin-bottom:12px; color:#111; }
  .post-content { color:#222; line-height:1.9; }

  /* SEARCH BAR */
  .search-bar { display:flex; align-items:center; background:#fff; border-radius:50px; box-shadow:0 6px 20px rgba(0,0,0,0.06); padding:6px 10px; gap:8px; }
  .search-bar input[type="search"] { flex:1; border:none; outline:none; font-size:16px; padding:12px 14px; border-radius:50px; }
  .search-bar .search-btn { background:#111; color:#fff; border:none; padding:10px 18px; border-radius:50px; font-weight:800; cursor:pointer; }
  .search-bar .close-btn { background:none; border:none; font-size:20px; cursor:pointer; color:#666; }

  /* 모바일에서 검색 버튼 텍스트가 가로로 '검색'으로 보이도록 조정 (요청사항) */
  @media (max-width: 680px) {
    .search-bar .search-btn { padding:10px 18px; font-size:16px; }
    .row { grid-template-columns: 1fr; }
    .col-right { grid-auto-rows: unset; grid-template-columns: 1fr; display:grid; gap:12px; }
  }

  /* ====================
     TO TOP
     ==================== */
  .to-top { position: fixed; right:22px; bottom:22px; width:52px; height:52px; border-radius:12px; background:#fff; color:#000; display:flex; align-items:center; justify-content:center; font-size:22px; z-index:2500; box-shadow:0 12px 30px rgba(0,0,0,0.08); opacity:0; transform:translateY(20px); transition:all .28s cubic-bezier(.2,.9,.2,1); border:1px solid rgba(0,0,0,0.06);}
  .to-top.show { opacity:1; transform:translateY(0); }

  /* ====================
     FOOTER
     ==================== */
  footer.site-footer { background:#111; color:#eee; padding:40px 20px; margin-top:20px; }
  .footer-inner { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; gap:20px; align-items:flex-start; flex-wrap:wrap; }
  .footer-brand { font-size:40px; font-weight:900; color:#fff; font-style:italic; }
  .footer-links a { color:#ddd; }

  /* ====================
     EDITORS (profile grid)
     ==================== */
  .editors-grid { display:flex; gap:12px; flex-wrap:wrap; margin-top:18px; }
  .editor-card { width:140px; background:#fff; border:1px solid rgba(0,0,0,0.06); border-radius:10px; padding:12px; text-align:center; cursor:pointer; }
  .editor-card img { width:80px; height:80px; border-radius:50%; object-fit:cover; margin:0 auto 10px; display:block; }
  .editor-name { font-weight:800; font-size:14px; }

  /* ====================
     Small devices adjustments
     ==================== */
  @media (max-width: 480px) {
    .brand .logo { font-size:20px; }
    .header-inner { height:60px; padding: 0 12px; }
    .col-left .hero-title { font-size:20px; }
  }

  /* ====================
     End of CSS
     ==================== */
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header" id="siteHeader" role="banner" aria-label="사이트 헤더">
    <div class="header-inner wrap">
      <div class="brand" role="img" aria-label="IMPACT brand">
        <div class="logo" id="logoBtn" onclick="router.goHome()" tabindex="0" title="IMPACT — go home">
          <img src="logo.png" alt="IMPACT logo" style="width:36px;height:36px;border-radius:8px;object-fit:cover;">
          <div>
            <div style="line-height:1">IMPACT</div>
            <small>MAKE A IMPACT</small>
          </div>
        </div>
      </div>

      <div class="header-actions" role="navigation" aria-label="상단 메뉴">
        <button class="btn search" id="topSearchBtn" onclick="openNavlessSearch()" aria-label="검색">🔍</button>
        <button class="btn" aria-controls="navOverlay" aria-expanded="false" onclick="ui.toggleNav()" aria-label="더보기">더보기</button>
      </div>
    </div>
  </header>

  <!-- NAV OVERLAY -->
  <aside class="nav-overlay" id="navOverlay" aria-hidden="true" aria-label="카테고리 네비게이션">
    <button class="nav-close" aria-label="네비 닫기" onclick="ui.toggleNav()">×</button>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div class="nav-search" role="search" aria-label="네비 검색">
        <span style="font-size:18px">🔍</span>
        <input type="search" id="globalNavSearch" placeholder="검색어 입력" aria-label="네비 검색어">
      </div>

      <ul class="nav-list" id="navList" role="menu" aria-label="카테고리 목록">
        <!-- JS에서 채움 -->
      </ul>

      <div class="nav-footer-links" aria-hidden="false">
        <a href="javascript:void(0)" onclick="ui.toggleNav(); router.openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="router.openEditors()">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER 페이지는 추후 구현됩니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>

      <div class="nav-extra" style="margin-top:18px;color:#777;font-size:13px">
        IMPACT는 WordPress 기반으로 콘텐츠를 받아와 사이트 내에서 자체 포스트 페이지로 표시합니다.
      </div>
    </div>
  </aside>

  <!-- MAIN HOME -->
  <main class="home" id="home" role="main" aria-live="polite" tabindex="-1">
    <div id="rowsContainer" aria-live="polite"></div>
    <div id="homeLoading" style="text-align:center;color:#666;padding:36px 0">로딩 중...</div>
  </main>

  <!-- CATEGORY OVERLAY -->
  <section class="overlay-full category-overlay" id="categoryOverlay" aria-hidden="true" role="region">
    <div class="wrap">
      <div class="overlay-top">
        <div>
          <div class="overlay-title" id="categoryOverlayTitle">CATEGORY</div>
          <div class="category-sub" id="categoryOverlaySubtitle">카테고리 설명</div>
        </div>
        <div>
          <button class="btn" onclick="router.closeCategory()">닫기</button>
        </div>
      </div>

      <div class="overlay-grid" id="categoryGrid" aria-live="polite"></div>
      <div id="categoryLoading" style="text-align:center;color:#666;padding:28px 0"></div>
    </div>
  </section>

  <!-- POST OVERLAY -->
  <article class="overlay-full post-overlay" id="postOverlay" aria-hidden="true" role="article">
    <div style="width:100%;max-width:1200px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px">
        <div>
          <button class="btn" onclick="router.closePost()">닫기</button>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="sharePostBtn">🔗 공유</button>
          <button class="btn" id="openOriginalBtn">원문 보기</button>
        </div>
      </div>
      <div class="post-article" id="postArticle"></div>
    </div>
  </article>

  <!-- SEARCH OVERLAY -->
  <section class="overlay-full search-overlay" id="searchOverlay" aria-hidden="true" role="search">
    <div class="wrap" style="max-width:1100px;margin:0 auto;">
      <div class="overlay-top">
        <div class="overlay-title">검색</div>
        <div>
          <button class="btn" onclick="ui.closeSearch()">닫기</button>
        </div>
      </div>

      <div style="margin-top:18px">
        <div class="search-bar" role="search" aria-label="사이트 검색">
          <input type="search" class="search-input" id="searchInputTop" placeholder="검색어 입력 (Enter로 검색)" aria-label="검색어">
          <button type="button" class="search-btn" id="globalSearchBtn">검색</button>
          <button type="button" class="close-btn" onclick="ui.closeSearch()">×</button>
        </div>
      </div>

      <div id="searchResults" class="overlay-grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- ABOUT PAGE -->
  <section class="overlay-full about-page" id="aboutPageSection" aria-hidden="true" role="region">
    <div class="wrap about-content">
      <div class="overlay-top">
        <div>
          <div class="overlay-title">ABOUT</div>
          <div style="color:#333;font-size:15px;line-height:1.8">
            <p><strong>IMPACT</strong> 은 現 & 前 KAIST IP-CEO 학생들과 POSTECH CEO 학생들이 함께 작성하는 심층 콘텐츠 플랫폼입니다.</p>
            <p>학생 저자들의 경험과 분석을 바탕으로 기술·경영·창의성을 결합한 글을 제공합니다. 현장의 사례, 데이터 인텔리전스, 깊이 있는 분석을 통해 독자에게 통찰을 전달합니다.</p>
          </div>
        </div>
        <div>
          <button class="btn" onclick="router.closeAbout()">닫기</button>
        </div>
      </div>

      <div style="margin-top:20px">
        <h3>핵심 키워드</h3>
        <ul>
          <li><strong>Innovation</strong> — 혁신</li>
          <li><strong>Management</strong> — 관리</li>
          <li><strong>Passion</strong> — 열정</li>
          <li><strong>Acceleration</strong> — 혁신 가속화</li>
          <li><strong>Creativity</strong> — 창의성</li>
          <li><strong>Technology</strong> — 기술</li>
        </ul>

        <h3 style="margin-top:18px">MAKE A IMPACT</h3>
        <p>우리는 기술과 경영, 창의성과 열정을 융합하여 혁신을 가속화합니다. 학생 저자의 시선에서 사회와 산업, 그리고 사람들에게 의미 있는 임팩트를 만들어 나갑니다.</p>
      </div>
    </div>
  </section>

  <!-- EDITORS OVERLAY -->
  <section class="overlay-full editors-overlay" id="editorsOverlay" aria-hidden="true" role="region">
    <div class="wrap">
      <div class="overlay-top">
        <div>
          <div class="overlay-title">EDITORS</div>
          <div class="overlay-sub" id="editorsSubtitle">등록된 에디터 프로필</div>
        </div>
        <div>
          <button class="btn" onclick="router.closeEditors()">닫기</button>
        </div>
      </div>

      <div id="editorsGrid" class="editors-grid"></div>
      <div id="editorPostsContainer" style="margin-top:24px"></div>
    </div>
  </section>

  <!-- TO TOP -->
  <button class="to-top" id="toTopBtn" title="맨 위로" aria-label="맨 위로">↑</button>

  <!-- FOOTER -->
  <footer class="site-footer" role="contentinfo" aria-label="사이트 푸터">
    <div class="wrap footer-inner">
      <div>
        <div class="footer-brand">IMPACT</div>
        <div style="margin-top:10px;color:#ddd;font-size:13px">광고 제휴 문의 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
        <div style="color:#ddd;font-size:13px;margin-top:6px">보도자료 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
      </div>

      <div class="footer-links">
        <a href="javascript:void(0)" onclick="router.openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="router.openEditors()">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER 페이지는 추후 구현됩니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>

      <div class="footer-right">
        <div style="font-weight:800;color:#fff">IMPACT CEO. ALL RIGHTS RESERVED.</div>
        <div style="color:#999;font-size:13px;margin-top:10px">사이트는 WordPress.com API로부터 콘텐츠를 가져옵니다.</div>
      </div>
    </div>
  </footer>

  <!-- CARD TEMPLATE -->
  <template id="cardTpl">
    <article class="card" role="article">
      <div class="thumb"><img src="" alt=""></div>
      <div class="card-body">
        <div class="cat-row"></div>
        <h3 class="title"></h3>
        <div class="meta">
          <img class="author-avatar" src="" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
          <div>
            <div class="author-name"></div>
            <div class="date" style="font-size:12px;color:#777"></div>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
  /**************************************************************************
   * IMPACT — Full JS (No token in client)
   *
   * Features:
   * - Netlify Functions proxy usage: /.netlify/functions/wpProxy?path=...
   * - Infinite scroll on home (loadHomeChunk)
   * - Category overlay, post overlay, search overlay, editors overlay
   * - Editor profiles listing and per-editor posts view (#editor-{id})
   * - Hash-based routing for sharing: #post-{id}, #category-{slug}, #about, #editor-{id}
   * - Share button: navigator.share if available, otherwise clipboard fallback
   * - Prevent horizontal mobile overflow; ensure hero height sync with right column
   *
   * Notes:
   * - Replace WP_SITE constant in Netlify function environment, not here.
   **************************************************************************/

  /* ===========================
     Config
     =========================== */
  const WP_SITE = "impactceo0.wordpress.com"; // reference only
  const CATEGORIES = {
    "tech": 318,
    "eat": 123073,
    "style": 2286,
    "culture": 1098,
    "life": 124,
    "editors-pick": 259543
  };
  const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];
  const HOME_PER_PAGE = 5;
  const HOME_MAX = 40;

  /* ===========================
     State
     =========================== */
  const state = {
    homePage: 1,
    homeLoaded: 0,
    homeFinished: false,
    loadingHome: false,
    postsCache: {},
    categoryPages: {},
    categoryFinished: {},
    editors: {}, // editorId -> {id,name,avatar,posts:[]}
  };

  /* ===========================
     API helper (Netlify proxy)
     =========================== */
  function api(path) {
    const p = path.includes('_embed') ? path : (path + (path.includes('?') ? '&' : '?') + '_embed');
    return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`;
  }

  function headers() {
    return {};
  }

  /* ===========================
     Small utility helpers
     =========================== */
  function formatDate(dstr) {
    try {
      const d = new Date(dstr);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}. ${m}. ${dd}.`;
    } catch(e){ return ''; }
  }

  function placeholderDataURI(w=600,h=400,txt='No Image'){
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='#efefef'/><text x='50%' y='50%' fill='#aaa' font-size='20' text-anchor='middle' dominant-baseline='middle'>${txt}</text></svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function pickCategoryClass(nameOrSlug) {
    if(!nameOrSlug) return '';
    const s = String(nameOrSlug).toLowerCase();
    if(s.includes('tech') || s.includes('technology')) return 'cat-tech';
    if(s.includes('eat')) return 'cat-eat';
    if(s.includes('style')) return 'cat-style';
    if(s.includes('culture')) return 'cat-culture';
    if(s.includes('life')) return 'cat-life';
    if(s.includes('editor') || s.includes('editors')) return 'cat-editors-pick';
    return '';
  }

  /* ===========================
     Render NavList
     =========================== */
  function renderNavList() {
    const navList = document.getElementById('navList');
    navList.innerHTML = '';
    NAV_ORDER.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      li.tabIndex = 0;
      li.setAttribute('role','menuitem');
      li.addEventListener('click', () => {
        ui.toggleNav();
        let slug = item.toLowerCase().replace(/'/g,'').replace(/\s/g,'-');
        if(slug === "editors-pick") slug = 'editors-pick';
        if(CATEGORIES[slug]) router.openCategory(slug);
        else alert('해당 카테고리는 현재 사용할 수 없습니다.');
      });
      li.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') li.click(); });
      navList.appendChild(li);
    });
  }

  /* ===========================
     Create Card Node
     =========================== */
  function createCardNode(post) {
    const tpl = document.getElementById('cardTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);

    const imgEl = node.querySelector('.thumb img');
    let thumbUrl = '';
    try {
      if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0] && post._embedded['wp:featuredmedia'][0].source_url) {
        thumbUrl = post._embedded['wp:featuredmedia'][0].source_url;
      }
    } catch(e) {}
    imgEl.src = thumbUrl || placeholderDataURI(1200,800,'No Image');

    node.querySelector('.title').innerHTML = post.title && post.title.rendered ? post.title.rendered : '제목 없음';

    const avatarImg = node.querySelector('.author-avatar');
    const authorNameEl = node.querySelector('.author-name');
    const dateEl = node.querySelector('.date');

    if(post._embedded && post._embedded.author && post._embedded.author[0]) {
      const a = post._embedded.author[0];
      const avatarUrl = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
      avatarImg.src = avatarUrl || placeholderDataURI(96,96,'U');
      avatarImg.alt = a.name || 'author';
      authorNameEl.textContent = a.name || '익명';
    } else {
      avatarImg.src = placeholderDataURI(96,96,'U');
      authorNameEl.textContent = '익명';
    }
    dateEl.textContent = formatDate(post.date);

    // categories
    const catRow = node.querySelector('.cat-row');
    catRow.innerHTML = '';
    if(post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) {
      const cats = post._embedded['wp:term'][0];
      cats.forEach(c => {
        if(c && c.name) {
          const span = document.createElement('span');
          span.className = 'cat-badge';
          span.textContent = c.name;
          const cls = pickCategoryClass(c.slug || c.name);
          if(cls) span.classList.add(cls);
          else span.style.background = '#666';
          catRow.appendChild(span);
        }
      });
    }

    node.addEventListener('click', ()=> openPostOverlayById(post.id));
    return node;
  }

  /* ===========================
     Sync hero height with right column
     - Ensure left hero height equals sum of small cards on right
     =========================== */
  function syncHeroHeight(row) {
    try {
      const left = row.querySelector('.col-left');
      const right = row.querySelector('.col-right');
      if(!left || !right) return;
      // compute right height
      const rightHeight = right.getBoundingClientRect().height;
      // set left height minimal to rightHeight
      left.style.minHeight = rightHeight + 'px';
    } catch(e) { /* ignore */ }
  }

  /* ===========================
     Load Home Chunk (infinite scroll)
     =========================== */
  async function loadHomeChunk() {
    if(state.loadingHome || state.homeFinished) return;
    state.loadingHome = true;
    document.getElementById('homeLoading').textContent = '로딩 중...';

    // For demonstration: if Netlify proxy not available, fallback to local demo posts
    const useDemo = false; // set to true locally if you don't want to call API
    try {
      let posts;
      if(useDemo) {
        posts = getDemoPosts(); // local demo
      } else {
        const res = await fetch(api(`posts?per_page=${HOME_PER_PAGE}&page=${state.homePage}`), { headers: headers() });
        if(!res.ok) {
          if(res.status === 400) {
            state.homeFinished = true;
            document.getElementById('homeLoading').textContent = '더 이상 글이 없습니다.';
          } else {
            throw new Error('Home fetch failed: ' + res.status);
          }
          state.loadingHome = false;
          return;
        }
        posts = await res.json();
      }

      if(!Array.isArray(posts) || posts.length === 0) {
        state.homeFinished = true;
        document.getElementById('homeLoading').textContent = '아직 게시된 글이 없습니다.';
        state.loadingHome = false;
        return;
      }

      posts.forEach(p => state.postsCache[p.id] = p);

      const container = document.getElementById('rowsContainer');

      // group into sets of 5: 1 hero + up to 4 smalls
      for(let i=0;i<posts.length;i+=5) {
        const group = posts.slice(i,i+5);
        if(state.homeLoaded >= HOME_MAX) { state.homeFinished = true; break; }
        const row = document.createElement('div');
        row.className = 'row';

        // left hero
        const leftPost = group[0];
        const leftDiv = document.createElement('div');
        leftDiv.className = 'col-left';

        let heroUrl = '';
        try {
          if(leftPost._embedded && leftPost._embedded['wp:featuredmedia'] && leftPost._embedded['wp:featuredmedia'][0]) {
            heroUrl = leftPost._embedded['wp:featuredmedia'][0].source_url || '';
          }
        } catch(e) { heroUrl = ''; }

        leftDiv.innerHTML = `
          <img class="hero" src="${heroUrl || placeholderDataURI(1200,800,'No Image')}" alt="hero">
          <div class="hero-overlay">
            <h2 class="hero-title"></h2>
            <div style="display:flex;align-items:center;gap:10px">
              <img class="hero-avatar" src="" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
              <div class="hero-author" style="font-weight:800;color:#fff"></div>
              <div class="hero-date" style="margin-left:8px;color:#eee;opacity:.9"></div>
            </div>
          </div>
        `;

        // hero category badge
        const catWrap = document.createElement('div');
        catWrap.className = 'hero-cats';
        if(leftPost._embedded && leftPost._embedded['wp:term'] && leftPost._embedded['wp:term'][0] && leftPost._embedded['wp:term'][0].length>0) {
          const c = leftPost._embedded['wp:term'][0][0];
          const span = document.createElement('span');
          span.className = 'cat-badge ' + pickCategoryClass(c.slug || c.name);
          span.textContent = c.name;
          catWrap.appendChild(span);
        }
        leftDiv.appendChild(catWrap);

        const heroTitle = leftDiv.querySelector('.hero-title');
        heroTitle.innerHTML = leftPost.title && leftPost.title.rendered ? leftPost.title.rendered : '제목 없음';
        const heroAvatar = leftDiv.querySelector('.hero-avatar');
        const heroAuthor = leftDiv.querySelector('.hero-author');
        const heroDate = leftDiv.querySelector('.hero-date');

        if(leftPost._embedded && leftPost._embedded.author && leftPost._embedded.author[0]) {
          const a = leftPost._embedded.author[0];
          const av = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
          heroAvatar.src = av || placeholderDataURI(48,48,'U');
          heroAuthor.textContent = (a.name || '익명');
        } else {
          heroAvatar.src = placeholderDataURI(48,48,'U');
          heroAuthor.textContent = '익명';
        }
        heroDate.textContent = formatDate(leftPost.date);

        adjustHeroContrast(leftDiv.querySelector('.hero'), heroTitle, leftDiv.querySelector('.hero-overlay'));
        leftDiv.addEventListener('click', ()=> openPostOverlayById(leftPost.id));
        row.appendChild(leftDiv);

        // right small cards
        const rightDiv = document.createElement('div');
        rightDiv.className = 'col-right';
        const smalls = group.slice(1,5);
        smalls.forEach(s => {
          const cardNode = createCardNode(s);
          rightDiv.appendChild(cardNode);
        });

        row.appendChild(rightDiv);
        container.appendChild(row);

        // sync hero height with right column after render
        setTimeout(()=> syncHeroHeight(row), 80);

        state.homeLoaded += group.length;
        if(state.homeLoaded >= HOME_MAX) { state.homeFinished = true; break; }
      }

      state.homePage += 1;
      document.getElementById('homeLoading').textContent = '';
    } catch(err) {
      console.error(err);
      document.getElementById('homeLoading').textContent = '메인 글 불러오기 실패';
    } finally {
      state.loadingHome = false;
    }
  }

  /* ===========================
     Category load
     =========================== */
  async function loadCategoryPage(slug) {
    if(!slug) return;
    if(state.categoryFinished[slug]) return;
    const nextPage = state.categoryPages[slug] || 1;
    document.getElementById('categoryLoading').textContent = '로딩 중...';
    try {
      const catId = CATEGORIES[slug];
      if(!catId) { document.getElementById('categoryLoading').textContent = '알 수 없는 카테고리입니다.'; return; }
      const res = await fetch(api(`posts?categories=${catId}&per_page=10&page=${nextPage}`), { headers: headers() });
      if(!res.ok) {
        if(res.status === 400) { state.categoryFinished[slug] = true; document.getElementById('categoryLoading').textContent = '더 이상 글이 없습니다.'; return; }
        throw new Error('category fetch failed: ' + res.status);
      }
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        state.categoryFinished[slug] = true;
        document.getElementById('categoryLoading').textContent = '아직 게시된 글이 없습니다.';
        return;
      }

      const grid = document.getElementById('categoryGrid');
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        grid.appendChild(card);
      });

      state.categoryPages[slug] = nextPage + 1;
      document.getElementById('categoryLoading').textContent = '';
    } catch(err) {
      console.error(err);
      document.getElementById('categoryLoading').textContent = '카테고리 글 불러오기 실패';
    }
  }

  /* ===========================
     Post overlay open
     =========================== */
  async function openPostOverlayById(id) {
    if(!id) return;
    const cached = state.postsCache[id];
    if(cached && cached.content && cached.content.rendered) {
      renderPostOverlay(cached);
      return;
    }
    try {
      const res = await fetch(api(`posts/${id}`), { headers: headers() });
      if(!res.ok) throw new Error('post fetch failed ' + res.status);
      const post = await res.json();

      // ensure embed
      if(!(post._embedded && post._embedded.author)) {
        const res2 = await fetch(api(`posts/${id}?_embed`), { headers: headers() });
        if(res2.ok) {
          const post2 = await res2.json();
          state.postsCache[id] = post2;
          renderPostOverlay(post2);
          return;
        }
      }
      state.postsCache[id] = post;
      renderPostOverlay(post);
    } catch(err) {
      console.error(err);
      alert('포스트 로드 실패 — 원문으로 이동합니다.');
      if(cached && cached.link) window.open(cached.link, '_blank');
    }
  }

  function renderPostOverlay(post) {
    const overlay = document.getElementById('postOverlay');
    const article = document.getElementById('postArticle');
    const title = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
    const authorName = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].name) ? post._embedded.author[0].name : '익명';
    const avatar = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].avatar_urls) ? (post._embedded.author[0].avatar_urls['96'] || post._embedded.author[0].avatar_urls['48']) : '';
    const categories = (post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) ? post._embedded['wp:term'][0].map(t=>t.name).join(', ') : '-';
    const dateStr = formatDate(post.date);
    const contentHTML = post.content && post.content.rendered ? post.content.rendered : (post.excerpt && post.excerpt.rendered ? post.excerpt.rendered : '');

    // Insert content
    article.innerHTML = `
      <h1>${title}</h1>
      <div class="post-meta" style="margin-bottom:14px;display:flex;gap:12px;align-items:center">
        <img src="${avatar || placeholderDataURI(96,96,'U')}" alt="author" style="width:52px;height:52px;border-radius:50%;object-fit:cover;">
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:800;color:#111">${authorName}</div>
          <div style="color:#666;font-size:13px">${dateStr} · ${categories}</div>
        </div>
      </div>
      <div class="post-content">${contentHTML}</div>
      <div style="margin-top:18px;color:#888;font-size:13px">원문 링크: <a href="${post.link}" target="_blank" rel="noopener">${post.link}</a></div>
    `;

    // make post images responsive
    article.querySelectorAll('.post-content img').forEach(img=>{
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.margin = '12px 0';
    });

    overlay.classList.add('active');
    overlay.scrollTop = 0;

    // push history hash for shareable URL
    history.pushState({ page: 'post', id: post.id }, '', `#post-${post.id}`);

    // configure share and original buttons
    const shareBtn = document.getElementById('sharePostBtn');
    shareBtn.onclick = () => {
      const shareUrl = location.origin + location.pathname + `#post-${post.id}`;
      const titlePlain = stripHtml(post.title && post.title.rendered ? post.title.rendered : 'IMPACT');
      if(navigator.share) {
        navigator.share({ title: titlePlain, url: shareUrl }).catch(()=>copyToClipboard(shareUrl) && alert('링크가 클립보드에 복사되었습니다.'));
      } else {
        copyToClipboard(shareUrl);
        alert('링크가 클립보드에 복사되었습니다.');
      }
    };

    const openOrig = document.getElementById('openOriginalBtn');
    openOrig.onclick = () => {
      // on mobile, open original link in new tab
      window.open(post.link, '_blank', 'noopener');
    };
  }

  /* ===========================
     Search
     =========================== */
  async function doSearch(q) {
    if(!q) return;
    ui.openSearch();
    const resultsGrid = document.getElementById('searchResults');
    resultsGrid.innerHTML = '';
    try {
      const res = await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=20`), { headers: headers() });
      if(!res.ok) throw new Error('search failed ' + res.status);
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        resultsGrid.innerHTML = '<div style="padding:20px;color:#666">검색 결과가 없습니다.</div>';
        return;
      }
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        resultsGrid.appendChild(card);
      });
    } catch(err) {
      console.error(err);
      resultsGrid.innerHTML = '<div style="padding:20px;color:#d00">검색 중 오류가 발생했습니다.</div>';
    }
  }

  /* ===========================
     Hero contrast (text color)
     =========================== */
  async function adjustHeroContrast(imgEl, titleEl, overlayEl) {
    if(!imgEl || !imgEl.src) return;
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = imgEl.src;
    function setColors(isLight) {
      if(isLight) {
        titleEl.style.color = '#111';
        titleEl.style.textShadow = 'none';
        overlayEl.style.background = 'linear-gradient(0deg, rgba(255,255,255,0.85), rgba(255,255,255,0.35))';
      } else {
        titleEl.style.color = '#fff';
        titleEl.style.textShadow = '0 3px 12px rgba(0,0,0,0.45)';
        overlayEl.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45))';
      }
    }
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        const w = Math.min(200, img.width);
        const h = Math.min(120, img.height);
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0,count=0;
        for(let i=0;i<data.length;i+=4) { r += data[i]; g += data[i+1]; b += data[i+2]; count++; }
        const avgR = r/count, avgG = g/count, avgB = b/count;
        const lum = 0.2126*avgR + 0.7152*avgG + 0.0722*avgB;
        setColors(lum > 150);
      } catch(e) { setColors(false); }
    };
    img.onerror = function() { setColors(false); };
  }

  /* ===========================
     UI & Router
     =========================== */
  const ui = {
    toggleNav() {
      const nav = document.getElementById('navOverlay');
      nav.classList.toggle('active');
      const expanded = nav.classList.contains('active');
      document.querySelector('.header-actions button[aria-controls="navOverlay"]').setAttribute('aria-expanded', expanded ? 'true' : 'false');
    },
    openSearch() {
      const overlay = document.getElementById('searchOverlay');
      overlay.classList.add('active');
      const input = document.getElementById('searchInputTop');
      if(input) input.focus();
      history.pushState({ page: 'search' }, '', '#search');
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeSearch() {
      document.getElementById('searchOverlay').classList.remove('active');
      // pop history gently if needed
      if(location.hash === '#search') history.back();
    },
    searchNow() {
      const overlayInput = document.querySelector('#searchOverlay .search-input') || document.getElementById('searchInputTop');
      const navInput = document.querySelector('#globalNavSearch');
      const q = (overlayInput && overlayInput.value.trim()) || (navInput && navInput.value.trim());
      if(!q) { alert('검색어를 입력하세요'); return; }
      doSearch(q);
    }
  };

  /* ===========================
     Router actions
     =========================== */
  const router = {
    goHome() {
      document.querySelectorAll('.category-overlay, .post-overlay, .about-page, .search-overlay, .editors-overlay').forEach(el => el.classList.remove('active'));
      window.scrollTo({ top: 0, behavior: 'smooth' });
      history.pushState({ page: 'home' }, '', '/');
    },
    openCategory(slug) {
      const overlay = document.getElementById('categoryOverlay');
      overlay.dataset.slug = slug;
      overlay.classList.add('active');
      overlay.scrollTop = 0;
      document.getElementById('categoryOverlayTitle').textContent = slug.toUpperCase();
      document.getElementById('categoryOverlaySubtitle').textContent = CATEGORY_DESCRIPTIONS[slug] || "카테고리 콘텐츠";
      state.categoryPages[slug] = 1;
      state.categoryFinished[slug] = false;
      document.getElementById('categoryGrid').innerHTML = '';
      loadCategoryPage(slug);
      history.pushState({ page: 'category', slug }, '', `#category-${slug}`);
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeCategory() {
      const overlay = document.getElementById('categoryOverlay');
      overlay.classList.remove('active');
      delete overlay.dataset.slug;
      history.back();
    },
    openPost(post) {
      if(post && post.id) {
        state.postsCache[post.id] = post;
        renderPostOverlay(post);
        history.pushState({ page: 'post', id: post.id }, '', `#post-${post.id}`);
        document.getElementById('navOverlay').classList.remove('active');
      }
    },
    closePost() {
      document.getElementById('postOverlay').classList.remove('active');
      if(location.hash && location.hash.startsWith('#post-')) history.back();
    },
    openAbout() {
      document.getElementById('aboutPageSection').classList.add('active');
      history.pushState({ page: 'about' }, '', '#about');
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeAbout() {
      document.getElementById('aboutPageSection').classList.remove('active');
      if(location.hash === '#about') history.back();
    },
    openEditors() {
      document.getElementById('editorsOverlay').classList.add('active');
      renderEditorsList();
      history.pushState({ page: 'editors' }, '', '#editors');
    },
    closeEditors() {
      document.getElementById('editorsOverlay').classList.remove('active');
      if(location.hash === '#editors') history.back();
    },
    openEditorPage(editorId) {
      // render posts by editor
      const editorPosts = Object.values(state.postsCache).filter(p => {
        try {
          if(p._embedded && p._embedded.author && p._embedded.author[0] && p._embedded.author[0].id) {
            return p._embedded.author[0].id === editorId;
          }
          return false;
        } catch(e) { return false; }
      });
      const container = document.getElementById('editorPostsContainer');
      container.innerHTML = `<h3>작성 글 (${editorPosts.length})</h3>`;
      if(editorPosts.length === 0) container.innerHTML += '<div>해당 에디터의 글이 없습니다.</div>';
      else {
        const ul = document.createElement('div');
        ul.style.display='grid';
        ul.style.gap='10px';
        editorPosts.forEach(p=>{
          const el = document.createElement('div');
          el.innerHTML = `<a href="#post-${p.id}" onclick="openPostOverlayById(${p.id})" style="font-weight:700">${p.title && p.title.rendered ? p.title.rendered : '제목'}</a>`;
          ul.appendChild(el);
        });
        container.appendChild(ul);
      }
      history.pushState({ page: 'editor', id: editorId }, '', `#editor-${editorId}`);
    }
  };

  /* ===========================
     Global helper bindings
     =========================== */
  window.openAbout = function(){ router.openAbout(); };
  window.openCategory = function(catSlug){ router.openCategory(catSlug); };
  window.openSearch = function(){ ui.openSearch(); };
  window.openPost = function(postIdOrObj){
    if(!postIdOrObj) return;
    if(typeof postIdOrObj === 'number') openPostOverlayById(postIdOrObj);
    else if(postIdOrObj.id) router.openPost(postIdOrObj);
  };

  function openNavlessSearch() {
    const nav = document.getElementById('navOverlay');
    nav.classList.remove('active');
    ui.openSearch();
    const input = document.getElementById('searchInputTop');
    if(input) input.focus();
  }

  /* ===========================
     Popstate (back/forward) handling
     =========================== */
  (function setupHistoryHandlers() {
    window.addEventListener('popstate', function(event) {
      // close overlays initially
      document.querySelectorAll('.overlay-full').forEach(el => el.classList.remove('active'));

      if(event.state && event.state.page) {
        const pg = event.state.page;
        if(pg === 'about') document.getElementById('aboutPageSection').classList.add('active');
        else if(pg === 'search') document.getElementById('searchOverlay').classList.add('active');
        else if(pg === 'category') {
          const slug = event.state.slug || null;
          if(slug) router.openCategory(String(slug));
        } else if(pg === 'post') {
          const pid = event.state.id;
          if(pid) openPostOverlayById(pid);
        } else if(pg === 'editor') {
          const eid = event.state.id;
          if(eid) router.openEditorPage(eid);
        } else if(pg === 'editors') {
          document.getElementById('editorsOverlay').classList.add('active');
          renderEditorsList();
        } else if(pg === 'home') {
          // nothing
        }
      } else {
        // default: show home
        // no-op: home layout already visible
      }
    }, false);
  })();

  /* ===========================
     Editors list & render
     =========================== */
  function collectEditorsFromPosts() {
    // scan postsCache and build editors map
    const editors = {};
    Object.values(state.postsCache).forEach(p => {
      try {
        if(p._embedded && p._embedded.author && p._embedded.author[0]) {
          const a = p._embedded.author[0];
          const id = a.id || a.slug || a.name;
          if(!editors[id]) {
            editors[id] = { id: a.id || id, name: a.name || '익명', avatar: (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : placeholderDataURI(96,96,'U'), posts: [] };
          }
          editors[id].posts.push(p);
        }
      } catch(e){}
    });
    state.editors = editors;
  }

  function renderEditorsList() {
    collectEditorsFromPosts();
    const grid = document.getElementById('editorsGrid');
    grid.innerHTML = '';
    const editorsObj = state.editors;
    if(!editorsObj || Object.keys(editorsObj).length === 0) {
      grid.innerHTML = '<div style="color:#666">등록된 에디터가 없습니다.</div>';
      return;
    }
    Object.values(editorsObj).forEach(ed => {
      const div = document.createElement('div');
      div.className = 'editor-card';
      div.innerHTML = `<img src="${ed.avatar}" alt="${ed.name}"><div class="editor-name">${ed.name}</div><div style="font-size:12px;color:#666;margin-top:8px">${ed.posts.length} posts</div>`;
      div.onclick = ()=> router.openEditorPage(ed.id);
      grid.appendChild(div);
    });
  }

  /* ===========================
     Event binding and init
     =========================== */
  function bindEvents() {
    renderNavList();

    const searchBtn = document.getElementById('globalSearchBtn');
    if(searchBtn) searchBtn.addEventListener('click', (e)=>{ e.preventDefault(); ui.searchNow(); });

    const navSearch = document.getElementById('globalNavSearch');
    if(navSearch) {
      navSearch.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') {
          e.preventDefault();
          const q = e.target.value.trim();
          if(!q) { alert('검색어를 입력하세요'); return; }
          document.getElementById('navOverlay').classList.remove('active');
          doSearch(q);
        }
      });
    }

    const searchOverlayInput = document.getElementById('searchInputTop');
    if(searchOverlayInput) {
      searchOverlayInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') {
          e.preventDefault();
          const q = e.target.value.trim();
          if(!q) { alert('검색어를 입력하세요'); return; }
          doSearch(q);
        }
      });
    }

    const toTopBtn = document.getElementById('toTopBtn');
    if(toTopBtn) toTopBtn.addEventListener('click', ()=> window.scrollTo({ top:0, behavior:'smooth' }));

    window.addEventListener('scroll', onScrollHandler, { passive:true });

    window.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape') {
        document.getElementById('navOverlay').classList.remove('active');
        document.querySelectorAll('.overlay-full').forEach(el => el.classList.remove('active'));
      }
    });
  }

  /* ===========================
     Scroll handler (infinite scroll)
     =========================== */
  function onScrollHandler() {
    const toTop = document.getElementById('toTopBtn');
    if(window.scrollY > 300) toTop.classList.add('show'); else toTop.classList.remove('show');

    const categoryOverlay = document.getElementById('categoryOverlay');
    if(categoryOverlay.classList.contains('active')) {
      const scroller = categoryOverlay;
      if(scroller.scrollHeight - (scroller.scrollTop + scroller.clientHeight) < 300) {
        const slug = categoryOverlay.dataset.slug;
        if(slug) loadCategoryPage(slug);
      }
      return;
    }

    const postOverlay = document.getElementById('postOverlay');
    if(postOverlay.classList.contains('active')) return;

    const searchOverlay = document.getElementById('searchOverlay');
    if(searchOverlay.classList.contains('active')) return;

    if(!state.loadingHome && !state.homeFinished) {
      const bottomThreshold = 1200;
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - bottomThreshold) {
        loadHomeChunk();
      }
    }
  }

  /* ===========================
     Router on load/hashchange
     =========================== */
  function routeFromHash() {
    const h = location.hash ? location.hash.replace('#','') : '';
    if(!h) return;
    if(h.startsWith('post-')) {
      const id = parseInt(h.replace('post-',''));
      if(id) openPostOverlayById(id);
    } else if(h === 'about') {
      document.getElementById('aboutPageSection').classList.add('active');
    } else if(h.startsWith('category-')) {
      const slug = h.replace('category-','');
      router.openCategory(slug);
    } else if(h === 'editors') {
      router.openEditors();
    } else if(h.startsWith('editor-')) {
      const eid = parseInt(h.replace('editor-',''));
      if(eid) router.openEditorPage(eid);
    } else if(h === 'search') {
      document.getElementById('searchOverlay').classList.add('active');
    }
  }
  window.addEventListener('hashchange', routeFromHash, false);
  window.addEventListener('load', routeFromHash, false);

  /* ===========================
     Init
     =========================== */
  (function init() {
    bindEvents();
    loadHomeChunk();
    renderNavList();
    history.replaceState({ page: 'home' }, '', '/');
  })();

  /* ===========================
     Utility: copy to clipboard
     =========================== */
  function copyToClipboard(text) {
    if(navigator.clipboard && navigator.clipboard.writeText) {
      return navigator.clipboard.writeText(text);
    } else {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); } catch(e){}
      document.body.removeChild(ta);
    }
  }

  /* ===========================
     Utility: strip HTML
     =========================== */
  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  /* ===========================
     Demo fallback posts (optional)
     =========================== */
  function getDemoPosts(){
    // Small set of demo posts to allow local testing without Netlify function
    return [
      { id: 101, date: new Date().toISOString(), title: { rendered: "데모 글 1" }, excerpt:{ rendered: "<p>데모 요약 1</p>" }, content:{ rendered: "<p>데모 본문 1</p>" }, link: "https://example.com/post/101", _embedded: { author: [{ id: 11, name: "김저자", avatar_urls: { "48": placeholderDataURI(48,48,"K") } }], 'wp:featuredmedia': [{ source_url: "https://picsum.photos/1200/800?random=1" }], 'wp:term': [[{ id: 1, name: "Tech", slug: "tech" }]] } },
      { id: 102, date: new Date().toISOString(), title: { rendered: "데모 글 2" }, excerpt:{ rendered: "<p>데모 요약 2</p>" }, content:{ rendered: "<p>데모 본문 2</p>" }, link: "https://example.com/post/102", _embedded: { author: [{ id: 12, name: "박저자", avatar_urls: { "48": placeholderDataURI(48,48,"P") } }], 'wp:featuredmedia': [{ source_url: "https://picsum.photos/1200/800?random=2" }], 'wp:term': [[{ id: 2, name: "Life", slug: "life" }]] } },
      // add more demo posts if needed
    ];
  }

  /* ===========================
     End of JS
     =========================== */

  </script>

  <!-- ======================================================================================
       Deployment notes (Netlify Functions)
       - Create file: netlify/functions/wpProxy.js
       - Add environment variable in Netlify: WP_TOKEN = <your_wordpress_token>
       - Example wpProxy.js (Node 14+):
         exports.handler = async function(event, context) {
           const WP_SITE = "impactceo0.wordpress.com";
           const ACCESS_TOKEN = process.env.WP_TOKEN;
           const path = event.queryStringParameters.path;
           if(!path) return { statusCode:400, body: JSON.stringify({error:"Missing path"}) };
           const url = `https://public-api.wordpress.com/wp/v2/sites/${WP_SITE}/${path}`;
           try {
             const res = await fetch(url, { headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` }});
             const data = await res.text();
             return { statusCode: res.status, headers: { "Content-Type": "application/json" }, body: data };
           } catch(err) {
             return { statusCode:500, body: JSON.stringify({error:err.message}) };
           }
         };
   ======================================================================================= -->

  <!-- =======================================================================================
       Additional implementation notes & tips (long comment block for documentation)
       - The page uses hash-based routing to allow sharing specific overlays:
         * #post-<id>   -> opens post overlay for given id
         * #category-<slug> -> opens category overlay
         * #about -> opens ABOUT overlay
         * #editors -> opens EDITORS overlay
         * #editor-<id> -> opens editor page overlay (author's posts)
       - Accessibility:
         * Buttons include aria-label where helpful.
         * Keyboard: Escape closes overlays (added in bindEvents).
       - Responsive:
         * nav-overlay switches to full-screen on <=680px.
         * main layout stacks on narrow viewports.
       - Hero height syncing:
         * Because images and dynamic content affect heights, after rows are appended we call syncHeroHeight(row).
       - Editor profiles:
         * We scan loaded posts for embedded author info to construct an editors map.
         * On clicking an editor, router.openEditorPage renders posts written by that author.
       - Search:
         * UI includes search bar in header nav and in search overlay.
         * Search requests the WP API via proxy: 'posts?search=<q>&per_page=20'
       - Infinite scroll:
         * loadHomeChunk pulls pages until HOME_MAX or server exhausted.
       - Share:
         * navigator.share on supported devices, fallback to clipboard copy.
       - Security:
         * No access token or secrets in this file — must be provided via serverless proxy.
       - Debugging:
         * If Netlify functions are not available or during local dev, toggle `useDemo = true` inside loadHomeChunk to show demo posts.
       ======================================================================================= -->
</body>
</html>
