<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACT — MAKE A IMPACT</title>
  <meta name="description" content="IMPACT — WordPress 기반의 학생 저자 콘텐츠를 불러와 자체 포스트 페이지로 보여주는 통합 페이지 (에디터, 프로필, 카테고리 배지, 무한스크롤, 포스트/ABOUT 오버레이 포함)">

  <!-- 파비콘: 프로젝트 루트에 logo.png 업로드 필요 -->
  <link rel="icon" href="logo.png" type="image/png">

  <style>
/* ==========================================================================
   IMPACT - 확장판 스타일시트 (상세 주석 포함)
   - 목적: 단일 HTML 파일에서 전체 UI 렌더링
   - 주의: 실제 서비스에서는 자바스크립트 분리 및 빌드 고려
   ========================================================================== */

/* ----------------------------------------
   기본 리셋
   ---------------------------------------- */
*,
*::before,
*::after { box-sizing: border-box; }

html, body { height: 100%; }
body {
  margin: 0;
  font-family: "Noto Sans KR", "Apple SD Gothic Neo", "Segoe UI", Roboto, Arial, sans-serif;
  background: #f5f5f5;
  color: #111;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
  scroll-behavior: smooth;
}

/* 링크/이미지 기본 */
a { color: inherit; text-decoration: none; }
img { display: block; max-width: 100%; height: auto; }

/* 레이아웃 컨테이너 */
.wrap {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}

/* ----------------------------------------
   HEADER
   ---------------------------------------- */
header.header {
  position: sticky;
  top: 0;
  z-index: 1200;
  background: #fff;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  backdrop-filter: blur(6px);
  transition: box-shadow .25s ease;
}
header.header.scrolled { box-shadow: 0 8px 30px rgba(0,0,0,0.06); }

.header-inner {
  height: 72px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 20px;
}

.brand { display:flex; gap:12px; align-items:center; }
.brand .logo {
  font-weight:900;
  font-size:28px;
  letter-spacing:1px;
  color:#000;
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
}
.brand .tag { font-size:12px; color:#777; font-weight:800; }

/* header actions */
.header-actions { display:flex; gap:8px; align-items:center; }
.btn {
  border-radius:10px;
  background:#fff;
  padding:8px 12px;
  border:1px solid rgba(0,0,0,0.08);
  font-weight:700;
  font-size:14px;
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease;
}
.btn:active { transform: translateY(1px); }
.btn.primary {
  background: linear-gradient(135deg,#2e8b57,#1f7a6f);
  color:#fff;
  border: none;
}

/* ----------------------------------------
   NAV OVERLAY (더보기)
   - 데스크탑: 화면 오른쪽에서 반 오버레이
   - 모바일: 전체 화면 오버레이
   ---------------------------------------- */
.nav-overlay {
  position: fixed;
  top: 0;
  right: -50%;
  width: 50%;
  height: 100vh;
  background: rgba(255,255,255,0.98);
  z-index: 2000;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
  padding: 60px 40px;
  box-shadow: -5px 0 20px rgba(0,0,0,0.08);
}
.nav-overlay.active { right: 0; }

@media (max-width: 900px) {
  .nav-overlay { width:100%; right: -100%; padding: 30px 20px; }
  .nav-overlay.active { right:0; }
}

.nav-close {
  position:absolute;
  top:24px;
  right:24px;
  background:none;
  border:none;
  font-size:32px;
  cursor:pointer;
  color:#000;
}

/* 검색창 (네비 내부) */
.nav-search {
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:20px;
}
.nav-search .search-icon { font-size:18px; color:#111; }
.nav-search input[type="search"] {
  flex:1;
  border:none;
  border-bottom:2px solid #111;
  font-size:16px;
  padding:8px 6px;
  outline:none;
  background:transparent;
}

/* 카테고리 리스트 */
.nav-list {
  list-style:none;
  padding:0;
  margin: 12px 0 0;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.nav-list li {
  font-size:28px;
  font-weight:900;
  color:#111;
  cursor:pointer;
}
.nav-list li:hover { color:#1e90ff; }

/* nav footer links */
.nav-footer-links {
  margin-top:auto;
  display:flex;
  gap:12px;
  font-size:13px;
  font-weight:800;
  align-items:center;
  flex-wrap:wrap;
}
.nav-footer-links a { color:#111; text-decoration:none;}

/* ----------------------------------------
   HOME LAYOUT
   - 데스크탑: grid 2fr / 1fr
   - 모바일: single column, small cards stacked 1열
   ---------------------------------------- */
.home {
  max-width:1400px;
  margin:28px auto;
  display:flex;
  flex-direction:column;
  gap:26px;
  padding: 0 20px 80px;
}

.row {
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
  align-items:start;
}

/* left hero */
.col-left {
  background: transparent;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  min-height: 320px;
  cursor:pointer;
}
.col-left .hero {
  width:100%;
  height:100%;
  min-height:320px;
  display:block;
  object-fit:cover;
  background:#ddd;
}
.col-left .hero-overlay {
  position:absolute;
  inset:auto 0 0 0;
  padding:20px;
  padding-bottom:28px;
  display:flex;
  flex-direction:column;
  gap:8px;
  background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45));
}
.col-left .hero-title {
  margin:0;
  font-size:26px;
  font-weight:900;
  color:#fff;
  line-height:1.05;
}

/* right column: small cards vertical stack on mobile */
.col-right {
  display:grid;
  gap:12px;
  grid-auto-rows: 1fr;
}

/* card */
.card {
  background:#fff;
  border-radius:10px;
  overflow:hidden;
  border:1px solid rgba(0,0,0,0.06);
  transition: transform .16s ease, box-shadow .16s ease;
  cursor:pointer;
}
.card:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
.card .thumb { width:100%; height:120px; overflow:hidden; background:#eee; }
.card .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.card .card-body { padding:12px; }
.card h3 { font-size:15px; font-weight:800; margin-bottom:8px; color:#111; }
.card .meta { display:flex; align-items:center; gap:8px; color:#666; font-size:13px; }

/* category badges */
.cat-badge {
  display:inline-block;
  padding:6px 10px;
  border-radius:6px;
  font-weight:800;
  font-size:12px;
  color:#fff;
}

/* hero category badges */
.hero-cats {
  position:absolute;
  right:16px;
  bottom:16px;
  display:flex;
  gap:6px;
}

/* category colors */
.cat-tech{ background:#1e90ff; }
.cat-eat{ background:#ff6347; }
.cat-style{ background:#32cd32; }
.cat-culture{ background:#8a2be2; }
.cat-life{ background:#ffa500; color:#000; }
.cat-editors-pick{ background:#ff1493; }

/* ----------------------------------------
   CATEGORY OVERLAY (전체화면)
   ---------------------------------------- */
.category-overlay {
  display:none;
  position:fixed;
  inset:0;
  background:#fff;
  z-index:1500;
  overflow:auto;
  padding:20px;
}
.category-overlay.active { display:block; }
.category-top {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  border-bottom:1px solid rgba(0,0,0,0.06);
  padding-bottom:12px;
}
.category-title { font-size:24px; font-weight:900; color:#111; }
.category-grid {
  margin-top:18px;
  display:grid;
  gap:18px;
  grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
  padding:20px 0 80px;
}

/* ----------------------------------------
   POST OVERLAY
   ---------------------------------------- */
.post-overlay {
  display:none;
  position:fixed;
  inset:0;
  background:#fff;
  z-index:1800;
  overflow-y:auto;
  padding:32px;
  align-items:start;
}
.post-overlay.active { display:flex; }
.post-article { margin:0 auto; max-width:900px; }
.post-article h1 { font-size:32px; font-weight:900; color:#111; }
.post-article .post-meta { display:flex; align-items:center; gap:12px; color:#444; margin-bottom:18px; }
.post-article .post-content { color:#222; line-height:1.9; }

/* ----------------------------------------
   SEARCH OVERLAY
   ---------------------------------------- */
.search-overlay {
  display:none;
  position:fixed;
  inset:0;
  background: rgba(255,255,255,0.98);
  z-index: 1600;
  overflow:auto;
  padding:28px;
}
.search-overlay.active { display:block; }
.search-bar {
  display:flex;
  align-items:center;
  background:#fff;
  border-radius:50px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
  padding:6px 14px;
  gap:8px;
}
.search-bar input[type="search"] {
  flex:1;
  border:none;
  outline:none;
  font-size:16px;
  padding:12px 14px;
  border-radius:50px;
}
.search-bar .search-btn {
  background:#111;
  color:#fff;
  border:none;
  border-radius:50px;
  padding:10px 18px;
  font-weight:800;
  cursor:pointer;
}
/* 모바일에서 버튼 텍스트 '검색' 가로로 보이게 */
@media (max-width:680px) {
  .search-bar .search-btn { padding:10px 20px; font-size:16px; }
  /* ensure the button shows the word '검색' */
  .search-bar .search-btn::after { content: "검색"; margin-left:6px; font-weight:800; }
}

/* ----------------------------------------
   ABOUT PAGE
   ---------------------------------------- */
.about-page {
  display:none;
  position:fixed;
  inset:0;
  background:#fff;
  z-index:1700;
  overflow:auto;
  padding:40px;
}
.about-page.active { display:block; }

/* ----------------------------------------
   TO TOP
   ---------------------------------------- */
.to-top {
  position: fixed;
  right: 22px;
  bottom: 22px;
  width:52px;
  height:52px;
  border-radius:12px;
  background:#fff;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  z-index:2500;
  box-shadow: 0 12px 30px rgba(0,0,0,0.08);
  opacity:0;
  transform: translateY(20px);
  transition: all .28s cubic-bezier(.2,.9,.2,1);
  border:1px solid rgba(0,0,0,0.06);
}
.to-top.show { opacity:1; transform: translateY(0); }

/* ----------------------------------------
   FOOTER
   ---------------------------------------- */
footer.site-footer {
  background:#111;
  color:#eee;
  padding:40px 20px;
  margin-top:20px;
}
.footer-inner { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; gap:20px; align-items:flex-start; flex-wrap:wrap; }
.footer-brand { font-size:40px; font-weight:900; color:#fff; font-style:italic; }

/* ----------------------------------------
   애니메이션 보조 및 유틸
   ---------------------------------------- */
@keyframes overlayIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }

/* ========================================================================
   끝: 스타일시트
   ======================================================================== */
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header" id="siteHeader" role="banner">
    <div class="header-inner wrap">
      <div class="brand" aria-hidden="false">
        <div class="logo" id="logoBtn" onclick="router.goHome()">
          <img src="logo.png" alt="IMPACT" style="height:36px;width:auto;display:inline-block;vertical-align:middle;margin-right:8px">
          <span style="display:inline-block;vertical-align:middle">IMPACT</span>
          <span class="tag" style="margin-left:8px">MAKE A IMPACT</span>
        </div>
      </div>

      <div class="header-actions" role="navigation" aria-label="상단 메뉴">
        <button class="btn" onclick="(function(){ document.getElementById('navOverlay').classList.remove('active'); ui.openSearch(); })()">검색</button>
        <button class="btn" aria-controls="navOverlay" aria-expanded="false" onclick="ui.toggleNav()">더보기</button>
      </div>
    </div>
  </header>

  <!-- NAV OVERLAY -->
  <aside class="nav-overlay" id="navOverlay" aria-hidden="true" aria-label="카테고리 네비">
    <button class="nav-close" aria-label="네비게이션 닫기" onclick="ui.toggleNav()">×</button>
    <div style="padding-top:8px">
      <div class="nav-search">
        <span class="search-icon">🔍</span>
        <input type="search" id="globalSearchInput" placeholder="검색어 입력" aria-label="네비게이션 검색">
      </div>

      <ul class="nav-list" id="navList" role="menu" aria-label="카테고리 목록">
        <!-- 렌더 시 JS에서 채움 -->
      </ul>

      <div class="nav-footer-links" style="margin-top:28px">
        <a href="javascript:void(0)" onclick="(function(){ ui.toggleNav(); router.openAbout(); })()">ABOUT</a>
        <a href="javascript:void(0)" onclick="alert('EDITORS 페이지는 추후 구현됩니다')">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER 페이지는 추후 구현됩니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>
    </div>
  </aside>

  <!-- MAIN HOME -->
  <main class="home" id="home" role="main" aria-live="polite">
    <div id="rowsContainer" aria-live="polite"></div>
    <div id="homeLoading" style="text-align:center;color:#666;padding:36px 0">로딩 중...</div>
  </main>

  <!-- CATEGORY OVERLAY -->
  <section class="category-overlay" id="categoryOverlay" aria-hidden="true">
    <div class="wrap">
      <div class="category-top">
        <div>
          <div class="category-title" id="categoryOverlayTitle">CATEGORY</div>
          <div class="category-sub" id="categoryOverlaySubtitle">카테고리 설명</div>
        </div>
        <div>
          <button class="btn" onclick="router.closeCategory()">닫기</button>
        </div>
      </div>

      <div class="category-grid" id="categoryGrid"></div>
      <div id="categoryLoading" style="text-align:center;color:#666;padding:28px 0"></div>
    </div>
  </section>

  <!-- POST OVERLAY -->
  <article class="post-overlay" id="postOverlay" aria-hidden="true">
    <div style="width:100%;max-width:1200px;margin:0 auto;">
      <div style="display:flex;justify-content:flex-end;align-items:center;gap:12px;margin-bottom:18px">
        <button class="btn" onclick="router.closePost()">닫기</button>
      </div>
      <div class="post-article" id="postArticle"></div>
    </div>
  </article>

  <!-- SEARCH OVERLAY -->
  <section class="search-overlay" id="searchOverlay" aria-hidden="true">
    <div class="wrap" style="max-width:1100px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px">
        <div style="flex:1">
          <div class="search-bar">
            <input type="search" class="search-input" placeholder="검색어 입력 (Enter로 검색)" aria-label="검색어">
            <button type="button" class="search-btn" id="globalSearchBtn" aria-label="검색 실행">🔍</button>
            <button type="button" class="close-btn" onclick="ui.closeSearch()" aria-label="검색 닫기">×</button>
          </div>
        </div>
      </div>

      <div id="searchResults" class="category-grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- ABOUT -->
  <section class="about-page" id="aboutPageSection" aria-hidden="true">
    <div class="wrap about-content">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:18px">
        <div style="max-width:900px">
          <h2 style="font-size:32px;margin-bottom:10px">ABOUT</h2>
          <div style="color:#333;font-size:15px;line-height:1.8">
            <p><strong>IMPACT</strong> 은 現 & 前 KAIST IP-CEO 학생들과 POSTECH CEO 학생들이 함께 작성하는 심층 콘텐츠 플랫폼입니다.</p>
            <p>학생 저자들의 경험과 분석을 바탕으로 기술·경영·창의성을 결합한 글을 제공합니다. 현장의 사례, 데이터 인텔리전스, 깊이 있는 분석을 통해 독자에게 통찰을 전달합니다.</p>
          </div>

          <div style="margin-top:20px"><button class="btn" onclick="router.closeAbout()">닫기</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- TO TOP -->
  <button class="to-top" id="toTopBtn" title="맨 위로" aria-label="맨 위로">↑</button>

  <!-- FOOTER -->
  <footer class="site-footer" role="contentinfo" aria-label="사이트 푸터">
    <div class="wrap footer-inner">
      <div>
        <div class="footer-brand">IMPACT</div>
        <div style="margin-top:10px;color:#ddd;font-size:13px">광고 제휴 문의 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
      </div>

      <div class="footer-links">
        <a href="javascript:void(0)" onclick="router.openAbout()">ABOUT</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>

      <div class="footer-right">
        <div style="font-weight:800;color:#fff">IMPACT CEO. ALL RIGHTS RESERVED.</div>
        <div style="color:#999;font-size:13px;margin-top:10px">사이트는 WordPress.com API로부터 콘텐츠를 가져옵니다.</div>
      </div>
    </div>
  </footer>

  <!-- 템플릿: 카드 -->
  <template id="cardTpl">
    <article class="card">
      <div class="thumb"><img src="" alt=""></div>
      <div class="card-body">
        <div class="cat-row"></div>
        <h3 class="title"></h3>
        <div class="meta">
          <img class="author-avatar" src="" alt="">
          <div>
            <div class="author-name"></div>
            <div class="date" style="font-size:12px;color:#777"></div>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
/* ==========================================================================
   IMPACT - 확장판 자바스크립트
   - 토큰은 클라이언트에 없음. 모든 WP 호출은 Netlify Function (/.netlify/functions/wpProxy) 을 통해 이루어짐.
   - 주요 기능:
     * 메인: posts 페이지네이션 + 무한 스크롤
     * 카테고리: overlay 전체화면 + 무한스크롤
     * 검색: 검색 오버레이, Enter로 검색
     * 포스트: 내부 오버레이로 렌더 (원문 링크 추가)
     * history.pushState/popstate로 검색/카테고리/포스트/ABOUT/홈 제어
   ========================================================================== */

  /* ===========================
     설정
     =========================== */
  const WP_SITE = "impactceo0.wordpress.com";
  // ACCESS_TOKEN은 여기서 제거되었습니다. 서버(Netlify)에서 삽입됩니다.

  const CATEGORIES = {
    "tech": 318,
    "eat": 123073,
    "style": 2286,
    "culture": 1098,
    "life": 124,
    "editors-pick": 259543
  };

  const NAV_ORDER = ["TECH", "EAT", "STYLE", "CULTURE", "LIFE", "EDITORS' PICK"];

  const HOME_PER_PAGE = 5;
  const HOME_MAX = 20;

  /* 상태 */
  const state = {
    homePage: 1,
    homeLoaded: 0,
    homeFinished: false,
    loadingHome: false,
    postsCache: {},
    categoryPages: {},
    categoryFinished: {},
  };

  /* ===========================
     유틸: Netlify 함수 프록시 API 빌드
     - 함수 경로: /.netlify/functions/wpProxy
     - 전달 param: path (예: "posts?per_page=5&page=1&_embed")
     =========================== */
  function api(path) {
    // ensure _embed present for posts data
    const p = path.includes('_embed') ? path : (path + (path.includes('?') ? '&' : '?') + '_embed');
    return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`;
  }

  function headers() { return {}; } // 클라이언트에서는 Authorization 추가하지 않음

  function placeholderDataURI(w=600, h=400, txt='No Image') {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='#efefef'/><text x='50%' y='50%' fill='#aaa' font-size='20' text-anchor='middle' dominant-baseline='middle'>${txt}</text></svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function formatDate(dstr) {
    if(!dstr) return '';
    const d = new Date(dstr);
    if(isNaN(d)) return '';
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}. ${m}. ${dd}.`;
  }

  function pickCategoryClass(nameOrSlug) {
    if(!nameOrSlug) return '';
    const s = String(nameOrSlug).toLowerCase();
    if(s.includes('tech') || s.includes('technology')) return 'cat-tech';
    if(s.includes('eat')) return 'cat-eat';
    if(s.includes('style')) return 'cat-style';
    if(s.includes('culture')) return 'cat-culture';
    if(s.includes('life')) return 'cat-life';
    if(s.includes('editor') || s.includes('editors')) return 'cat-editors-pick';
    return '';
  }

  /* ===========================
     DOM: 네비 리스트 렌더
     =========================== */
  function renderNavList() {
    const navList = document.getElementById('navList');
    if(!navList) return;
    navList.innerHTML = '';
    NAV_ORDER.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      li.addEventListener('click', () => {
        ui.toggleNav();
        if(item === 'SEARCH') {
          ui.openSearch();
          return;
        }
        let slug = item.toLowerCase().replace(/'/g,'').replace(/\s/g,'-');
        if(slug === 'editors-pick') slug = 'editors-pick';
        const catId = CATEGORIES[slug];
        if(catId) {
          router.openCategory(slug);
        } else {
          alert('해당 카테고리는 현재 사용할 수 없습니다.');
        }
      });
      navList.appendChild(li);
    });
  }

  /* ===========================
     카드 생성기
     =========================== */
  function createCardNode(post) {
    const tpl = document.getElementById('cardTpl');
    const node = tpl.content.firstElementChild.cloneNode(true);
    const img = node.querySelector('.thumb img');
    let thumbUrl = '';
    try {
      if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0] && post._embedded['wp:featuredmedia'][0].source_url) {
        thumbUrl = post._embedded['wp:featuredmedia'][0].source_url;
      }
    } catch(e){ thumbUrl = ''; }
    img.src = thumbUrl || placeholderDataURI(1200,800,'No Image');

    node.querySelector('.title').innerHTML = post.title && post.title.rendered ? post.title.rendered : '제목 없음';

    const avatarImg = node.querySelector('.author-avatar');
    const authorNameEl = node.querySelector('.author-name');
    const dateEl = node.querySelector('.date');

    if(post._embedded && post._embedded.author && post._embedded.author[0]) {
      const a = post._embedded.author[0];
      const avatarUrl = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
      avatarImg.src = avatarUrl || placeholderDataURI(96,96,'U');
      avatarImg.alt = a.name || 'author';
      authorNameEl.textContent = a.name || '익명';
    } else {
      avatarImg.src = placeholderDataURI(96,96,'U');
      authorNameEl.textContent = '익명';
    }
    dateEl.textContent = formatDate(post.date);

    const catRow = node.querySelector('.cat-row');
    catRow.innerHTML = '';
    if(post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) {
      const cats = post._embedded['wp:term'][0];
      cats.forEach(c => {
        if(c && c.name) {
          const span = document.createElement('span');
          span.className = 'cat-badge';
          span.textContent = c.name;
          const cls = pickCategoryClass(c.slug || c.name);
          if(cls) span.classList.add(cls);
          else span.style.background = '#666';
          catRow.appendChild(span);
        }
      });
    }

    node.addEventListener('click', ()=> openPostOverlayById(post.id));
    return node;
  }

  /* ===========================
     홈 로더 (무한스크롤)
     =========================== */
  async function loadHomeChunk() {
    if(state.loadingHome || state.homeFinished) return;
    state.loadingHome = true;
    document.getElementById('homeLoading').textContent = '로딩 중...';
    try {
      const res = await fetch(api(`posts?per_page=${HOME_PER_PAGE}&page=${state.homePage}`), { headers: headers() });
      if(!res.ok) {
        if(res.status === 400) {
          state.homeFinished = true;
          document.getElementById('homeLoading').textContent = '더 이상 글이 없습니다.';
        } else {
          throw new Error('Home fetch failed: ' + res.status);
        }
        state.loadingHome = false;
        return;
      }
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        state.homeFinished = true;
        document.getElementById('homeLoading').textContent = '아직 게시된 글이 없습니다.';
        state.loadingHome = false;
        return;
      }

      // 캐싱
      posts.forEach(p => state.postsCache[p.id] = p);

      const container = document.getElementById('rowsContainer');

      // 그룹 단위로 렌더: 각 응답을 그대로 1:4 배치 (left big, right small)
      // 하지만 모바일에서는 right column이 1열로 표시됩니다 (CSS 미디어쿼리)
      for(let i=0;i<posts.length;i+=5) {
        const group = posts.slice(i, i+5);
        if(state.homeLoaded >= HOME_MAX) {
          state.homeFinished = true;
          break;
        }
        const row = document.createElement('div');
        row.className = 'row';

        // left big
        const leftPost = group[0];
        const leftDiv = document.createElement('div');
        leftDiv.className = 'col-left';
        let heroUrl = '';
        try {
          if(leftPost._embedded && leftPost._embedded['wp:featuredmedia'] && leftPost._embedded['wp:featuredmedia'][0]) {
            heroUrl = leftPost._embedded['wp:featuredmedia'][0].source_url || '';
          }
        } catch(e){ heroUrl=''; }

        leftDiv.innerHTML = `
          <img class="hero" src="${heroUrl || placeholderDataURI(1200,800,'No Image')}" alt="hero">
          <div class="hero-overlay">
            <h2 class="hero-title"></h2>
            <div class="meta">
              <img class="hero-avatar" src="">
              <div class="hero-author"></div>
              <div style="margin-left:8px;color:#eee;opacity:.9" class="hero-date"></div>
            </div>
          </div>
        `;

        // hero category badge
        const catWrap = document.createElement('div');
        catWrap.className = 'hero-cats';
        if(leftPost._embedded && leftPost._embedded['wp:term'] && leftPost._embedded['wp:term'][0] && leftPost._embedded['wp:term'][0].length>0) {
          const c = leftPost._embedded['wp:term'][0][0];
          const span = document.createElement('span');
          span.className = 'cat-badge ' + pickCategoryClass(c.slug || c.name);
          span.textContent = c.name;
          catWrap.appendChild(span);
        }
        leftDiv.appendChild(catWrap);

        // title + meta
        const heroTitle = leftDiv.querySelector('.hero-title');
        heroTitle.innerHTML = leftPost.title && leftPost.title.rendered ? leftPost.title.rendered : '제목 없음';
        const heroAvatar = leftDiv.querySelector('.hero-avatar');
        const heroAuthor = leftDiv.querySelector('.hero-author');
        const heroDate = leftDiv.querySelector('.hero-date');
        if(leftPost._embedded && leftPost._embedded.author && leftPost._embedded.author[0]) {
          const a = leftPost._embedded.author[0];
          const av = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
          heroAvatar.src = av || placeholderDataURI(48,48,'U');
          heroAuthor.textContent = (a.name || '익명');
        } else {
          heroAvatar.src = placeholderDataURI(48,48,'U');
          heroAuthor.textContent = '익명';
        }
        heroDate.textContent = formatDate(leftPost.date);

        leftDiv.addEventListener('click', ()=> openPostOverlayById(leftPost.id));
        row.appendChild(leftDiv);

        // right small stack
        const rightDiv = document.createElement('div');
        rightDiv.className = 'col-right';
        const smalls = group.slice(1,5);
        // smalls are appended as each their own full-width card (on mobile: single column)
        smalls.forEach(s => {
          const cardNode = createCardNode(s);
          rightDiv.appendChild(cardNode);
        });
        row.appendChild(rightDiv);

        container.appendChild(row);
        state.homeLoaded += group.length;
        if(state.homeLoaded >= HOME_MAX) {
          state.homeFinished = true;
          break;
        }
      }

      state.homePage += 1;
      document.getElementById('homeLoading').textContent = '';
    } catch(err) {
      console.error('loadHomeChunk error', err);
      document.getElementById('homeLoading').textContent = '메인 글 불러오기 실패';
    } finally {
      state.loadingHome = false;
    }
  }

  /* ===========================
     카테고리 로더
     =========================== */
  async function loadCategoryPage(slug) {
    if(!slug) return;
    if(state.categoryFinished[slug]) return;
    const nextPage = state.categoryPages[slug] || 1;
    document.getElementById('categoryLoading').textContent = '로딩 중...';
    try {
      const catId = CATEGORIES[slug];
      if(!catId) {
        document.getElementById('categoryLoading').textContent = '알 수 없는 카테고리입니다.';
        return;
      }
      const res = await fetch(api(`posts?categories=${catId}&per_page=10&page=${nextPage}`), { headers: headers() });
      if(!res.ok) {
        if(res.status === 400) {
          state.categoryFinished[slug] = true;
          document.getElementById('categoryLoading').textContent = '더 이상 글이 없습니다.';
          return;
        }
        throw new Error('category fetch failed: ' + res.status);
      }
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        state.categoryFinished[slug] = true;
        document.getElementById('categoryLoading').textContent = '아직 게시된 글이 없습니다.';
        return;
      }

      const grid = document.getElementById('categoryGrid');
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        grid.appendChild(card);
      });

      state.categoryPages[slug] = nextPage + 1;
      document.getElementById('categoryLoading').textContent = '';
    } catch(err) {
      console.error('loadCategoryPage error', err);
      document.getElementById('categoryLoading').textContent = '카테고리 글 불러오기 실패';
    }
  }

  /* ===========================
     포스트 오버레이 로드 (단건)
     =========================== */
  async function openPostOverlayById(id) {
    if(!id) return;
    const cached = state.postsCache[id];
    if(cached && cached.content && cached.content.rendered) {
      renderPostOverlay(cached);
      history.pushState({ page: 'post', id }, '', `#post-${id}`);
      return;
    }
    try {
      const res = await fetch(api(`posts/${id}`), { headers: headers() });
      if(!res.ok) throw new Error('post fetch failed ' + res.status);
      const post = await res.json();
      // if _embedded missing, try fetch with _embed explicitly
      if(!(post._embedded && post._embedded.author)) {
        const res2 = await fetch(api(`posts/${id}?_embed`), { headers: headers() });
        if(res2.ok) {
          const p2 = await res2.json();
          state.postsCache[id] = p2;
          renderPostOverlay(p2);
          history.pushState({ page: 'post', id }, '', `#post-${id}`);
          return;
        }
      }
      state.postsCache[id] = post;
      renderPostOverlay(post);
      history.pushState({ page: 'post', id }, '', `#post-${id}`);
    } catch(err) {
      console.error('openPostOverlayById error', err);
      alert('포스트 로드 실패 — 원문으로 이동합니다.');
      if(cached && cached.link) window.open(cached.link, '_blank');
    }
  }

  function renderPostOverlay(post) {
    const overlay = document.getElementById('postOverlay');
    const article = document.getElementById('postArticle');
    if(!post) {
      article.innerHTML = '<div style="padding:20px;color:#666">포스트를 불러올 수 없습니다.</div>';
      overlay.classList.add('active');
      return;
    }
    const title = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
    const authorName = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].name) ? post._embedded.author[0].name : '익명';
    const avatar = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].avatar_urls) ? (post._embedded.author[0].avatar_urls['96'] || post._embedded.author[0].avatar_urls['48']) : '';
    const categories = (post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) ? post._embedded['wp:term'][0].map(t=>t.name).join(', ') : '-';
    const dateStr = formatDate(post.date);
    const contentHTML = post.content && post.content.rendered ? post.content.rendered : (post.excerpt && post.excerpt.rendered ? post.excerpt.rendered : '');

    article.innerHTML = `
      <h1>${title}</h1>
      <div class="post-meta" style="margin-bottom:14px;">
        <img src="${avatar || placeholderDataURI(96,96,'U')}" alt="author">
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:800;color:#111">${authorName}</div>
          <div style="color:#666;font-size:13px">${dateStr} · ${categories}</div>
        </div>
      </div>
      <div class="post-content">${contentHTML}</div>
      <div style="margin-top:18px;color:#888;font-size:13px">원문 링크: <a href="${post.link}" target="_blank" rel="noopener">${post.link}</a></div>
    `;

    article.querySelectorAll('.post-content img').forEach(img=>{
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.margin = '12px 0';
    });

    overlay.classList.add('active');
    overlay.scrollTop = 0;
  }

  /* ===========================
     검색 기능
     =========================== */
  async function doSearch(q) {
    if(!q) return;
    ui.openSearch(); // opens overlay and pushes state
    const resultsGrid = document.getElementById('searchResults');
    resultsGrid.innerHTML = '';
    try {
      const res = await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=20`), { headers: headers() });
      if(!res.ok) throw new Error('search failed ' + res.status);
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        resultsGrid.innerHTML = '<div style="padding:20px;color:#666">검색 결과가 없습니다.</div>';
        return;
      }
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        resultsGrid.appendChild(card);
      });
      history.pushState({ page: 'search', q }, '', `#search-${encodeURIComponent(q)}`);
    } catch(err) {
      console.error('doSearch error', err);
      resultsGrid.innerHTML = '<div style="padding:20px;color:#d00">검색 중 오류가 발생했습니다.</div>';
    }
  }

  /* ===========================
     이미지 대비 자동 조정 (히어로 타이틀 가독성)
     =========================== */
  async function adjustHeroContrast(imgEl, titleEl, overlayEl) {
    if(!imgEl || !imgEl.src) return;
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = imgEl.src;
    function setColors(isLight) {
      if(isLight) {
        titleEl.style.color = '#111';
        titleEl.style.textShadow = 'none';
        overlayEl.style.background = 'linear-gradient(0deg, rgba(255,255,255,0.85), rgba(255,255,255,0.35))';
      } else {
        titleEl.style.color = '#fff';
        titleEl.style.textShadow = '0 3px 12px rgba(0,0,0,0.45)';
        overlayEl.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45))';
      }
    }
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        const w = Math.min(200, img.width);
        const h = Math.min(120, img.height);
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        const data = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0,count=0;
        for(let i=0;i<data.length;i+=4) {
          r += data[i]; g += data[i+1]; b += data[i+2]; count++;
        }
        const avgR = r/count, avgG = g/count, avgB = b/count;
        const lum = 0.2126*avgR + 0.7152*avgG + 0.0722*avgB;
        setColors(lum > 150);
      } catch(e) {
        setColors(false);
      }
    };
    img.onerror = function() { setColors(false); };
  }

  /* ===========================
     스크롤 핸들러 (to-top, 무한스크롤 트리거)
     =========================== */
  function onScrollHandler() {
    const toTop = document.getElementById('toTopBtn');
    if(window.scrollY > 300) toTop.classList.add('show'); else toTop.classList.remove('show');

    // 카테고리 오버레이 스크롤: 아래 근접 시 더 불러오기
    const categoryOverlay = document.getElementById('categoryOverlay');
    if(categoryOverlay && categoryOverlay.classList.contains('active')) {
      const scroller = categoryOverlay;
      if(scroller.scrollHeight - (scroller.scrollTop + scroller.clientHeight) < 300) {
        const slug = categoryOverlay.dataset.slug;
        if(slug) loadCategoryPage(slug);
      }
      return;
    }

    // if search open, skip home infinite
    const searchOverlay = document.getElementById('searchOverlay');
    if(searchOverlay && searchOverlay.classList.contains('active')) return;
    const postOverlay = document.getElementById('postOverlay');
    if(postOverlay && postOverlay.classList.contains('active')) return;

    if(!state.loadingHome && !state.homeFinished) {
      const bottomThreshold = 1200;
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - bottomThreshold) {
        loadHomeChunk();
      }
    }
  }

  /* ===========================
     UI 및 Router
     =========================== */
  const ui = {
    toggleNav() {
      const nav = document.getElementById('navOverlay');
      nav.classList.toggle('active');
      // aria
      const expanded = nav.classList.contains('active');
      document.querySelector('.header-actions button[aria-controls="navOverlay"]')?.setAttribute('aria-expanded', expanded);
    },
    openSearch() {
      document.getElementById('searchOverlay').classList.add('active');
      const input = document.querySelector('#searchOverlay .search-input');
      if(input) { input.focus(); }
      history.pushState({ page: 'search' }, '', '#search');
      // close nav if open
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeSearch() {
      document.getElementById('searchOverlay').classList.remove('active');
      // when closing search by code (not popstate) push home
      history.pushState({ page: 'home' }, '', '/');
    },
    searchNow() {
      const overlayInput = document.querySelector('#searchOverlay .search-input');
      const navInput = document.getElementById('globalSearchInput');
      const input = overlayInput || navInput;
      if(!input) { alert('검색창을 찾을 수 없습니다.'); return; }
      const q = input.value.trim();
      if(!q) { alert('검색어를 입력하세요'); return; }
      doSearch(q);
    }
  };

  const CATEGORY_DESCRIPTIONS = {
    tech: "최신 기술과 혁신 트렌드를 다룹니다.",
    eat: "다양한 음식 문화와 맛집을 소개합니다.",
    style: "패션, 뷰티, 라이프스타일을 탐구합니다.",
    culture: "문화, 예술, 사회 현상을 분석합니다.",
    life: "일상과 경험에서 얻은 통찰을 나눕니다.",
    "editors-pick": "에디터가 직접 엄선한 글 모음입니다."
  };

  const router = {
    goHome() {
      document.querySelectorAll('.category-overlay, .post-overlay, .about-page, .search-overlay').forEach(el => el.classList.remove('active'));
      window.scrollTo({ top: 0, behavior: 'smooth' });
      history.pushState({ page: 'home' }, '', '/');
    },
    openCategory(slug) {
      if(!slug) return;
      const overlay = document.getElementById('categoryOverlay');
      overlay.dataset.slug = slug;
      overlay.classList.add('active');
      overlay.scrollTop = 0;
      document.getElementById('categoryOverlayTitle').textContent = slug.toUpperCase();
      document.getElementById('categoryOverlaySubtitle').textContent = CATEGORY_DESCRIPTIONS[slug] || '카테고리 콘텐츠';
      state.categoryPages[slug] = 1;
      state.categoryFinished[slug] = false;
      document.getElementById('categoryGrid').innerHTML = '';
      loadCategoryPage(slug);
      history.pushState({ page: 'category', slug }, '', `#category-${slug}`);
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeCategory() {
      const overlay = document.getElementById('categoryOverlay');
      overlay.classList.remove('active');
      delete overlay.dataset.slug;
      history.pushState({ page: 'home' }, '', '/');
    },
    openPost(post) {
      if(post && post.id) {
        state.postsCache[post.id] = post;
        renderPostOverlay(post);
        history.pushState({ page: 'post', id: post.id }, '', `#post-${post.id}`);
        document.getElementById('navOverlay').classList.remove('active');
      }
    },
    closePost() {
      document.getElementById('postOverlay').classList.remove('active');
      history.pushState({ page: 'home' }, '', '/');
    },
    openAbout() {
      document.getElementById('aboutPageSection').classList.add('active');
      history.pushState({ page: 'about' }, '', '#about');
      document.getElementById('navOverlay').classList.remove('active');
    },
    closeAbout() {
      document.getElementById('aboutPageSection').classList.remove('active');
      history.pushState({ page: 'home' }, '', '/');
    }
  };

  /* ===========================
     이벤트 바인딩
     =========================== */
  function bindEvents() {
    // 네비 리스트 렌더
    renderNavList();

    // search button inside overlay
    const searchBtn = document.getElementById('globalSearchBtn');
    if(searchBtn) {
      searchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        ui.searchNow();
      });
    }

    // nav search input (Enter)
    const navSearchInput = document.getElementById('globalSearchInput');
    if(navSearchInput) {
      navSearchInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
          e.preventDefault();
          const q = e.target.value.trim();
          if(!q) { alert('검색어를 입력하세요'); return; }
          document.getElementById('navOverlay').classList.remove('active');
          doSearch(q);
        }
      });
    }

    // overlay search input (Enter)
    const searchOverlayInput = document.querySelector('#searchOverlay .search-input');
    if(searchOverlayInput) {
      searchOverlayInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter') {
          e.preventDefault();
          const q = e.target.value.trim();
          if(!q) { alert('검색어를 입력하세요'); return; }
          doSearch(q);
        }
      });
    }

    // to-top
    const toTopBtn = document.getElementById('toTopBtn');
    if(toTopBtn) {
      toTopBtn.addEventListener('click', ()=> window.scrollTo({ top: 0, behavior: 'smooth' }));
    }

    // scroll
    window.addEventListener('scroll', onScrollHandler, { passive: true });

    // ESC: close overlays
    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') {
        document.getElementById('navOverlay').classList.remove('active');
        document.getElementById('searchOverlay').classList.remove('active');
        document.getElementById('categoryOverlay').classList.remove('active');
        document.getElementById('postOverlay').classList.remove('active');
        document.getElementById('aboutPageSection').classList.remove('active');
      }
    });

    // popstate handling for back/forward navigation
    window.addEventListener('popstate', function(event) {
      // close all overlays
      document.querySelectorAll('.about-page, .category-overlay, .search-overlay, .post-overlay').forEach(el => el.classList.remove('active'));
      if(event.state && event.state.page) {
        const pg = event.state.page;
        if(pg === 'about') {
          document.getElementById('aboutPageSection').classList.add('active');
        } else if(pg === 'search') {
          document.getElementById('searchOverlay').classList.add('active');
        } else if(pg === 'category') {
          const slug = event.state.slug || null;
          if(slug) {
            router.openCategory(String(slug));
          }
        } else if(pg === 'post') {
          const pid = event.state.id;
          if(pid) openPostOverlayById(pid);
        } else if(pg === 'home') {
          window.scrollTo({ top:0, behavior:'smooth' });
        }
      } else {
        // default: go to home
        window.scrollTo({ top:0, behavior:'smooth' });
      }
    }, false);

    // provide global helpers for debug convenience (optional)
    window.openCategory = function(slug){ router.openCategory(slug); };
    window.openAbout = function(){ router.openAbout(); };
    window.openPost = function(idOrObj){
      if(typeof idOrObj === 'number') openPostOverlayById(idOrObj);
      else if(idOrObj && idOrObj.id) router.openPost(idOrObj);
    };
  }

  /* ===========================
     초기화
     =========================== */
  (function init(){
    bindEvents();
    // initial load
    loadHomeChunk();
    renderNavList();
  })();

  /* ==========================================================================
     추가적인 보조 함수 / 디버그 도움말
     - 필요 시 여기서 확장
     ========================================================================== */

  </script>

</body>
</html>
