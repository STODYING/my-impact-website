<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <!--
    IMPACT — MAKE A IMPACT
    요구사항 요약:
    1) 다크/라이트 토글(좌하단, 기본 라이트)
    2) 포스트에서 ‘조금만 위로 스크롤’ 시 툴바(로고+햄버거) 등장 (상단 고정 아님, 애니메이션)
    3) 읽기 진행바는 문서 최상단(전역, 화면 상단 고정)
    4) 홈: PC=좌큰1 + 우작4, 다음은 우큰1 + 좌작4 (20개/페이지) / 모바일=큰1 + 작은4 반복
    5) 임베드(유튜브 등) 모바일 100% 폭, PC는 최대 폭(860px) 중앙 정렬
    6) 상단 카테고리 버튼 제거 → 햄버거 내부에서 노출
    7) 더보기→햄버거, 검색 텍스트→검색 아이콘, 모든 닫기 버튼은 X
    8) 페이지네이션만, 무한 스크롤 금지
    9) 포스트: 진입 즉시 썸네일(좌), 제목/에디터/날짜(우) 카드 헤더 → 본문
    10) 포스트 하단 관련글 4개(같은 카테고리 최신, 현재 글 제외)
    + 세로형 카드 리스트(잡지식 배열) 추가: 카테고리/검색 결과에 사용
  -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IMPACT — MAKE A IMPACT</title>
  <link rel="icon" href="logo.png" type="image/png"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-title" content="IMPACT"/>

  <style>
  /* =========================================================
     THEME TOKENS + EASING (스무스 애니메이션 전역 규칙)
     ========================================================= */
  :root{
    --bg:#f6f7f9;
    --text:#111;
    --muted:#666;
    --card:#ffffff;
    --border:rgba(0,0,0,.08);
    --shadow:0 10px 28px rgba(0,0,0,.08);
    --overlay:color-mix(in oklab, var(--card) 90%, transparent);
    --accent:#2e8b57;
    --accent-2:#7e5fff;
    --progress:#ff7a1a;

    --ease: cubic-bezier(.22,.61,.36,1);   /* 자연스러운 감속 */
    --ease-io: cubic-bezier(.2,.9,.2,1);  /* 살짝 탄성감(입·퇴장) */
    --dur: .22s;
    --dur-fast: .16s;
  }
  html[data-theme="dark"]{
    --bg:#0f1115;
    --text:#f2f4f7;
    --muted:#a6adbb;
    --card:#171a21;
    --border:rgba(255,255,255,.08);
    --shadow:0 12px 38px rgba(0,0,0,.35);
    --overlay:color-mix(in oklab, var(--card) 88%, transparent);
    --accent:#39c07c;
    --accent-2:#a98bff;
    --progress:#ff9f45;
  }

  /* =========================================================
     RESET + 기본 구조
     ========================================================= */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    line-height:1.65;
    font-family:"Noto Sans KR","Apple SD Gothic Neo","Segoe UI",system-ui,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overscroll-behavior-y:contain;
    overflow-x:hidden;              /* (5) 가로 스크롤 방지 */
    scroll-behavior:smooth;         /* 페이지 내 스크롤 부드럽게 */
  }
  a{color:inherit;text-decoration:none}
  img{display:block;max-width:100%;height:auto}
  input[type="search"]::-webkit-search-cancel-button{cursor:pointer}
  .wrap{max-width:1400px;margin:0 auto;padding:0 20px}

  /* =========================================================
     (3) 읽기 진행바 — 화면 최상단 전역 고정
     ========================================================= */
  #progressTop{
    position:fixed; top:0; left:0; width:0; height:4px;
    background:var(--progress);
    z-index:3000;
    transition:width .08s linear;
  }

  /* =========================================================
     HEADER — 심플 아이콘 (6)(7)
     ========================================================= */
  header.header{
    position:sticky; top:0; z-index:1200;
    background:var(--card);
    border-bottom:1px solid var(--border);
    backdrop-filter:blur(6px);
  }
  .header-inner{
    height:64px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    max-width:1400px; margin:0 auto; padding:0 16px;
  }
  .logo-btn{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
  .logo-btn img{width:30px; height:30px; border-radius:6px; object-fit:cover}
  .logo-btn span{font-weight:900; font-size:18px}
  .header-actions{display:flex; gap:8px}
  .icon-btn{
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:10px; background:var(--card); border:1px solid var(--border);
    transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    will-change:transform;
    cursor:pointer;
  }
  .icon-btn:active{transform:scale(.98)}
  .icon{width:20px;height:20px;display:block}
  .icon.search{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.27v.8L20 21.5 21.5 20l-6-6zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/></svg>') no-repeat center/contain; background:currentColor}
  .icon.menu{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>') no-repeat center/contain; background:currentColor}
  .icon.close{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="m19 6.41-1.41-1.41L12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12"/></svg>') no-repeat center/contain; background:currentColor}

  /* =========================================================
     NAV / SEARCH OVERLAY (6)(7)
     ========================================================= */
  .overlay{
    position:fixed; inset:0; z-index:2200; background:var(--card);
    opacity:0; visibility:hidden; transform:translateY(8px);
    transition:opacity var(--dur-fast) var(--ease-io), transform var(--dur-fast) var(--ease-io), visibility 0s var(--dur-fast);
  }
  .overlay.active{opacity:1; visibility:visible; transform:translateY(0)}
  .overlay-head{display:flex; justify-content:flex-end; padding:12px}
  .overlay-body{max-width:1100px; margin:0 auto; padding:0 20px 28px}
  .nav-list{list-style:none; margin:10px 0 0; padding:0; display:grid; gap:14px}
  .nav-item{font-weight:900; font-size:26px; cursor:pointer; transition:color var(--dur) var(--ease)}
  .nav-item:hover{color:var(--accent)}
  .search-bar{display:flex; gap:8px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:6px 10px}
  .search-bar input{flex:1; border:none; background:transparent; color:var(--text); font-size:16px; outline:none}
  .search-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; margin-top:14px}

  /* =========================================================
     좌하단 테마 토글 (1)
     ========================================================= */
  .theme-toggle{
    position:fixed; left:12px; bottom:12px; z-index:2600;
    display:flex; gap:8px; align-items:center;
    background:var(--card); border:1px solid var(--border); border-radius:999px; padding:8px 10px;
    box-shadow:var(--shadow);
  }
  .theme-toggle input{appearance:none; width:36px; height:20px; border-radius:999px; background:#ccc; position:relative; cursor:pointer; outline:none}
  .theme-toggle input::after{content:""; position:absolute; left:2px; top:2px; width:16px; height:16px; border-radius:50%; background:#fff; transition:left var(--dur) var(--ease)}
  .theme-toggle input:checked{background:#222}
  .theme-toggle input:checked::after{left:18px}

  /* =========================================================
     HOME — 교차 그리드 (4)(8)(9)
     ========================================================= */
  main.home{max-width:1400px; margin:22px auto; padding:0 16px}
  .row{display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-bottom:16px}
  .row.alt{grid-template-columns:1fr 2fr}
  .col{display:flex; flex-direction:column; gap:12px}

  .big{
    position:relative; border-radius:12px; overflow:hidden; background:#222; min-height:360px; cursor:pointer;
    transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    will-change:transform;
  }
  .big:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .big img{width:100%; height:100%; object-fit:cover}
  .big .overlay{position:absolute; inset:auto 0 0 0; padding:18px; color:#fff; background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.6))}
  .big .title{margin:0; font-size:28px; font-weight:900; line-height:1.1}

  .card{
    background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden; cursor:pointer;
    transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
  }
  .card:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .thumb{height:120px; background:#2a2f38}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .body{padding:10px}
  .title-s{font-size:15px; margin:0 0 6px; font-weight:900}
  .meta{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}
  .meta img{width:28px; height:28px; border-radius:50%; object-fit:cover}

  .cat{display:inline-block; padding:4px 8px; border-radius:6px; background:var(--accent-2); color:#fff; font-weight:800; font-size:11px}
  .cat-tech{background:#1e90ff}.cat-eat{background:#ff6347}.cat-style{background:#32cd32}.cat-culture{background:#8a2be2}.cat-life{background:#ffa500;color:#000}

  @media (max-width:980px){
    .row,.row.alt{grid-template-columns:1fr}
    .big{min-height:40vh}
  }

  /* =========================================================
     VERTICAL LIST (세로형 잡지식 카드) — 카테고리/검색 결과에서 사용
     ========================================================= */
  .vlist{display:flex; flex-direction:column; gap:16px; padding:6px 0}
  .vcard{display:grid; grid-template-columns:160px 1fr; gap:16px; align-items:stretch; background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; transition:transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease)}
  .vcard:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .vthumb{width:100%; height:100%; min-height:140px; background:#222}
  .vthumb img{width:100%; height:100%; object-fit:cover}
  .vbody{padding:12px 12px 14px}
  .vtitle{margin:0 0 8px; font-size:18px; font-weight:900; line-height:1.2}
  @media (max-width:680px){ .vcard{grid-template-columns:1fr} .vthumb{min-height:200px} }

  /* =========================================================
     PAGINATION (8) — 무한 스크롤 제거
     ========================================================= */
  .pager{display:flex; justify-content:center; gap:8px; flex-wrap:wrap; padding:10px 0 28px}
  .pager button{padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--card); font-weight:800; cursor:pointer; color:var(--text)}
  .pager .current{border:none; background:transparent; color:var(--progress); cursor:default}

  /* =========================================================
     POST OVERLAY (2)(3)(5)(10) + 관련글
     ========================================================= */
  .post{
    position:fixed; inset:0; z-index:2000; background:var(--card); overflow:auto;
    opacity:0; visibility:hidden; transform:translateY(8px);
    transition:opacity var(--dur-fast) var(--ease-io), transform var(--dur-fast) var(--ease-io), visibility 0s var(--dur-fast);
  }
  .post.active{opacity:1; visibility:visible; transform:translateY(0)}
  .post-wrap{max-width:1200px; margin:0 auto; padding:24px 16px 40px}

  /* (2)(4) — 위로 스크롤 시 떠오르는 툴바 (초기 숨김) */
  .post-toolbar{
    position:fixed; top:10px; left:50%; transform:translate(-50%,-60px);
    width:min(1200px, calc(100% - 24px)); height:46px; padding:0 10px;
    display:flex; align-items:center; justify-content:space-between;
    background:var(--overlay); border:1px solid var(--border); border-radius:12px; backdrop-filter:blur(8px);
    box-shadow:var(--shadow); pointer-events:none; transition:transform var(--dur) var(--ease);
  }
  .post-toolbar.show{transform:translate(-50%,0); pointer-events:auto}
  .tool-left{display:flex; gap:8px; align-items:center; font-weight:900; cursor:pointer}
  .tool-left img{width:24px; height:24px; border-radius:6px; object-fit:cover}

  /* (10) — 카드형 헤더: 좌 썸네일, 우 정보 */
  .post-head{display:grid; grid-template-columns:1.3fr 1fr; gap:16px; align-items:stretch; margin-bottom:16px}
  .ph-img{border-radius:12px; overflow:hidden; background:#000; height:66vh; max-height:90vh}
  .ph-img img{width:100%; height:100%; object-fit:cover}
  .ph-meta{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; display:flex; flex-direction:column; justify-content:center}
  .ph-meta h1{margin:0 0 10px; font-size:34px; line-height:1.1}
  .who{display:flex; gap:10px; align-items:center; color:var(--muted)}
  .who img{width:40px; height:40px; border-radius:50%}
  @media (max-width:900px){ .post-head{grid-template-columns:1fr} .ph-img{height:72vh} .ph-meta h1{font-size:28px} }

  /* 본문 — 임베드 보정 (5) */
  .post-content{color:var(--text); line-height:1.9}
  .post-content img,.post-content video{max-width:100%; height:auto; display:block}
  .post-content iframe{max-width:100% !important; width:100% !important; border:none; height:auto}
  /* 모바일(<=1024px): 100% 폭 / PC: 최대 860px + 중앙 정렬 + 16:9 */
  @media (min-width:1024px){
    .post-content iframe,.post-content video,.post-content embed,.post-content object{
      width:min(860px,100%); margin:12px auto; display:block; aspect-ratio:16/9; height:auto;
    }
  }

  /* =========================================================
     FOOTER
     ========================================================= */
  footer.site-footer{background:#111;color:#eee;padding:36px 16px;margin-top:10px}
  html[data-theme="dark"] footer.site-footer{background:#0b0c10;color:#cfd3dc}
  .footer-inner{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;gap:20px;flex-wrap:wrap}
  .footer-links a{color:#ddd;display:block;margin:6px 0;font-weight:800}
  </style>
</head>
<body>

  <!-- (3) 화면 최상단 진행바 -->
  <div id="progressTop"></div>

  <!-- 좌하단 라이트/다크 토글 (1) -->
  <button class="theme-toggle" onclick="toggleTheme()" title="다크/라이트 전환">
    <span style="font-weight:800;font-size:12px">Light</span>
    <input id="themeSwitch" type="checkbox" aria-label="테마 전환">
    <span style="font-weight:800;font-size:12px">Dark</span>
  </button>

  <!-- 헤더: 심플 아이콘 (6)(7) -->
  <header class="header">
    <div class="header-inner">
      <div class="logo-btn" onclick="router.goHome()">
        <img src="logo.png" alt="IMPACT"/><span>IMPACT</span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" aria-label="검색" onclick="openSearch()"><i class="icon search"></i></button>
        <button class="icon-btn" aria-label="메뉴" onclick="toggleNav(true)"><i class="icon menu"></i></button>
      </div>
    </div>
  </header>

  <!-- NAV 오버레이 (6)(7) -->
  <aside id="nav" class="overlay" aria-hidden="true">
    <div class="overlay-head">
      <button class="icon-btn" aria-label="닫기" onclick="toggleNav(false)"><i class="icon close"></i></button>
    </div>
    <div class="overlay-body">
      <div class="search-bar" style="margin-bottom:14px">
        <input id="navSearch" type="search" placeholder="검색어 입력 (Enter)"/>
        <button class="icon-btn" onclick="openSearchFromNav()" aria-label="검색"><i class="icon search"></i></button>
      </div>
      <ul id="navList" class="nav-list"></ul> <!-- 카테고리: 상단에서 제거하고 햄버거 내부에만 노출 -->
    </div>
  </aside>

  <!-- SEARCH 오버레이 (7) -->
  <section id="search" class="overlay" aria-hidden="true">
    <div class="overlay-head">
      <button class="icon-btn" aria-label="닫기" onclick="closeSearch()"><i class="icon close"></i></button>
    </div>
    <div class="overlay-body">
      <div class="search-bar">
        <i class="icon search"></i>
        <input id="searchInput" type="search" placeholder="검색어 입력 후 Enter"/>
      </div>
      <!-- 검색/카테고리 결과는 세로형 카드(vlist)로 -->
      <div id="searchList" class="vlist" style="margin-top:14px"></div>
    </div>
  </section>

  <!-- HOME: 좌큰1+우작4 교차 그리드 (4)(8)(9) -->
  <main id="home" class="home" role="main">
    <div id="rows"></div>
    <nav id="homePager" class="pager" aria-label="페이지 이동"></nav>
  </main>

  <!-- POST 오버레이 (2)(3)(10) -->
  <article id="post" class="post" aria-hidden="true">
    <!-- (4) 위로 스크롤 시에만 나타나는 툴바 -->
    <div id="postToolbar" class="post-toolbar">
      <div class="tool-left" onclick="router.goHome()">
        <img src="logo.png" alt=""/><span>IMPACT</span>
      </div>
      <button class="icon-btn" aria-label="메뉴" onclick="toggleNav(true)"><i class="icon menu"></i></button>
    </div>

    <div class="post-wrap">
      <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
        <button class="icon-btn" aria-label="닫기" onclick="closePost()"><i class="icon close"></i></button>
      </div>

      <!-- (10) 카드형 헤더 -->
      <section id="postHead" class="post-head" aria-label="포스트 헤더">
        <figure class="ph-img"><img id="postHero" src="" alt=""></figure>
        <div class="ph-meta">
          <h1 id="postTitle">제목</h1>
          <div class="who">
            <img id="postAvatar" src="" alt="">
            <div>
              <div id="postAuthor" style="font-weight:800;color:var(--text)">author</div>
              <div id="postDate" style="font-size:13px;color:var(--muted)">date · categories</div>
            </div>
          </div>
        </div>
      </section>

      <div id="postContent" class="post-content"></div>

      <!-- 관련 글 4개 -->
      <section id="related" style="display:none;margin-top:26px">
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:900">관련 글</h3>
        <div id="relatedGrid" class="search-grid" style="padding:0"></div>
      </section>
    </div>
  </article>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div style="font-size:32px;font-weight:900">IMPACT</div>
        <div style="margin-top:8px;color:#ddd;font-size:13px">광고 제휴 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
        <div style="color:#ddd;font-size:13px;margin-top:6px">보도자료 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
      </div>
      <div class="footer-links">
        <a href="javascript:void(0)" onclick="openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="openEditors()">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER는 준비 중입니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>
      <div style="font-weight:800">IMPACT CEO. ALL RIGHTS RESERVED.</div>
    </div>
  </footer>

  <!-- 템플릿: 작은 카드(홈용) -->
  <template id="cardTpl">
    <article class="card">
      <div class="thumb"><img alt=""></div>
      <div class="body">
        <span class="cat">CATEGORY</span>
        <h3 class="title-s"></h3>
        <div class="meta">
          <img class="av" alt="">
          <div><div class="name" style="font-weight:800;color:var(--text)"></div><div class="d"></div></div>
        </div>
      </div>
    </article>
  </template>

  <!-- 템플릿: 세로 카드(카테고리/검색용) -->
  <template id="vcardTpl">
    <article class="vcard">
      <div class="vthumb"><img alt=""></div>
      <div class="vbody">
        <span class="cat">CATEGORY</span>
        <h3 class="vtitle"></h3>
        <div class="meta">
          <img class="av" alt="">
          <div><div class="name" style="font-weight:800;color:var(--text)"></div><div class="d"></div></div>
        </div>
      </div>
    </article>
  </template>

<script>
/* =========================================================
   CONFIG / STATE
   ========================================================= */
const PER_PAGE = 20; // (8) 페이지당 20 — 무한 스크롤 제거
const CATS = { tech:318, eat:123073, style:2286, culture:1098, life:124, "editors-pick":259543 };
const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];
const state = { homePage:1, homeTotal:1, cache:{}, lastY:0, lastDirUp:false };

/* =========================================================
   HELPERS
   ========================================================= */
function api(path){
  const withEmbed = path.includes('_embed') ? path : (path + (path.includes('?')?'&':'?') + '_embed');
  // 필요 시 여기 프록시 경로를 실제 워드프레스 REST로 바꿔도 됨
  return `/.netlify/functions/wpProxy?path=${encodeURIComponent(withEmbed)}`;
}
function headers(){ return {}; }
function fmt(d){
  try{ const x=new Date(d); return `${x.getFullYear()}. ${String(x.getMonth()+1).padStart(2,'0')}. ${String(x.getDate()).padStart(2,'0')}.`; }
  catch{ return '' }
}
function ph(w=600,h=400,t='No Image'){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='#2b2f36'/><text x='50%' y='50%' fill='#9aa3af' font-size='20' text-anchor='middle' dominant-baseline='middle'>${t}</text></svg>`;
  return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg);
}
function catCls(slug){ slug=String(slug||'').toLowerCase();
  if(slug.includes('tech'))return'cat-tech';
  if(slug.includes('eat'))return'cat-eat';
  if(slug.includes('style'))return'cat-style';
  if(slug.includes('culture'))return'cat-culture';
  if(slug.includes('life'))return'cat-life';
  return '';
}

/* =========================================================
   THEME (1)
   ========================================================= */
(function themeInit(){
  const saved = localStorage.getItem('impact-theme') || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeSwitch').checked = (saved==='dark');
})();
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme') || 'light';
  const next = cur==='light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', next);
  document.getElementById('themeSwitch').checked = (next==='dark');
  localStorage.setItem('impact-theme', next);
}

/* =========================================================
   NAV / SEARCH (6)(7)
   ========================================================= */
function renderNav(){
  const ul = document.getElementById('navList'); ul.innerHTML='';
  NAV_ORDER.forEach(label=>{
    const li=document.createElement('li');
    li.className='nav-item';
    li.textContent=label;
    li.onclick=()=>{
      toggleNav(false);
      const slug=label.toLowerCase().replace(/'/g,'').replace(/\s/g,'-');
      openCategory(slug,1);
    };
    ul.appendChild(li);
  });
}
function toggleNav(open){ const el=document.getElementById('nav'); open?el.classList.add('active'):el.classList.remove('active'); }
function openSearch(){ const el=document.getElementById('search'); el.classList.add('active'); document.getElementById('searchInput').focus(); }
function closeSearch(){ document.getElementById('search').classList.remove('active'); }
function openSearchFromNav(){
  const v=document.getElementById('navSearch').value.trim();
  toggleNav(false); openSearch();
  if(v){ document.getElementById('searchInput').value=v; doSearch(v); }
}

/* =========================================================
   HOME — 좌큰1 + 우작4 교차 (4)(8)(9)
   ========================================================= */
async function loadHome(page=1){
  const rows=document.getElementById('rows'); rows.innerHTML='';
  const pager=document.getElementById('homePager'); pager.innerHTML='';
  const res=await fetch(api(`posts?per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
  if(!res.ok){ rows.innerHTML='<div style="text-align:center;color:var(--muted)">불러오기 실패</div>'; return; }
  const posts=await res.json();
  const total=parseInt(res.headers.get('X-WP-TotalPages')||'1',10);
  state.homePage=page; state.homeTotal=total;
  posts.forEach(p=> state.cache[p.id]=p);

  for(let i=0;i<posts.length;i+=5){
    const group=posts.slice(i,i+5);
    const row=document.createElement('section');
    row.className = (Math.floor(i/5)%2===0) ? 'row' : 'row alt';
    const colA=document.createElement('div'); colA.className='col';
    const colB=document.createElement('div'); colB.className='col';

    const big=group[0] ? makeBig(group[0]) : document.createElement('div');
    const small=group.slice(1,5).map(p=> makeSmall(p));

    if(row.className==='row'){ // big left
      colA.appendChild(big); small.forEach(n=> colB.appendChild(n));
    }else{ // big right
      small.forEach(n=> colA.appendChild(n)); colB.appendChild(big);
    }
    row.append(colA,colB);
    rows.appendChild(row);
  }
  renderPager(pager, page, total, (to)=> loadHome(to));
}

function makeBig(post){
  const el=document.createElement('article'); el.className='big';
  const hero=post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
  const cat = post._embedded?.['wp:term']?.[0]?.[0];
  el.innerHTML=`
    <img src="${hero || ph(1200,800)}" alt="">
    <div class="overlay">
      <span class="cat ${catCls(cat?.slug||'')}">${cat?.name || '&nbsp;'}</span>
      <h2 class="title">${post.title?.rendered || '제목 없음'}</h2>
      <div class="meta" style="margin-top:6px">
        <img src="${post._embedded?.author?.[0]?.avatar_urls?.['48']||ph(48,48,'U')}" alt="">
        <div><div class="name" style="color:#fff;font-weight:800">${post._embedded?.author?.[0]?.name || '익명'}</div><div class="d" style="color:#eee">${fmt(post.date)}</div></div>
      </div>
    </div>
  `;
  el.onclick=()=> openPost(post.id);
  return el;
}

function makeSmall(post){
  const tpl=document.getElementById('cardTpl').content.firstElementChild.cloneNode(true);
  tpl.querySelector('.thumb img').src = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
  tpl.querySelector('.title-s').innerHTML = post.title?.rendered || '제목 없음';
  const cat = post._embedded?.['wp:term']?.[0]?.[0];
  const catEl = tpl.querySelector('.cat'); catEl.textContent = cat?.name || ' '; const cls = catCls(cat?.slug||''); if(cls) catEl.classList.add(cls);
  tpl.querySelector('.av').src = post._embedded?.author?.[0]?.avatar_urls?.['48'] || ph(48,48,'U');
  tpl.querySelector('.name').textContent = post._embedded?.author?.[0]?.name || '익명';
  tpl.querySelector('.d').textContent = fmt(post.date);
  tpl.onclick=()=> openPost(post.id);
  return tpl;
}

function renderPager(container, current, total, onChange){
  if(total<=1) return;
  const add=(l,p,cur=false,dis=false)=>{ const b=document.createElement('button'); b.textContent=l; if(cur){b.className='current';b.disabled=true;} else if(!dis){ b.onclick=()=>onChange(p);} container.appendChild(b); };
  const ell=()=>{ const s=document.createElement('span'); s.textContent='…'; s.style.opacity=.6; container.appendChild(s); };
  add('«',1,false,current===1);
  if(total<=9){ for(let p=1;p<=total;p++) add(p,p,p===current); }
  else if(current<=4){ for(let p=1;p<=5;p++) add(p,p,p===current); ell(); add(total,total); }
  else if(current>=total-3){ add(1,1); ell(); for(let p=total-4;p<=total;p++) add(p,p,p===current); }
  else{ add(1,1); ell(); for(let p=current-1;p<=current+1;p++) add(p,p,p===current); ell(); add(total,total); }
  add('»',total,false,current===total);
}

/* =========================================================
   CATEGORY → 세로형 리스트 (1)
   ========================================================= */
async function openCategory(slug,page=1){
  const list=document.getElementById('searchList'); list.innerHTML='';
  const overlay=document.getElementById('search'); overlay.classList.add('active');
  const res=await fetch(api(`posts?categories=${CATS[slug]}&per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
  const posts=await res.json(); posts.forEach(p=> list.appendChild(makeVCard(p)));
}

function makeVCard(p){
  const tpl=document.getElementById('vcardTpl').content.firstElementChild.cloneNode(true);
  tpl.querySelector('.vthumb img').src = p._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
  const cat = p._embedded?.['wp:term']?.[0]?.[0];
  const el = tpl.querySelector('.cat'); el.textContent = cat?.name || ' '; const cls = catCls(cat?.slug||''); if(cls) el.classList.add(cls);
  tpl.querySelector('.vtitle').innerHTML = p.title?.rendered || '제목 없음';
  tpl.querySelector('.av').src = p._embedded?.author?.[0]?.avatar_urls?.['48'] || ph(48,48,'U');
  tpl.querySelector('.name').textContent = p._embedded?.author?.[0]?.name || '익명';
  tpl.querySelector('.d').textContent = fmt(p.date);
  tpl.onclick=()=> openPost(p.id);
  return tpl;
}

/* =========================================================
   SEARCH (세로형 리스트로 렌더)
   ========================================================= */
document.getElementById('searchInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ doSearch(e.target.value.trim()); }
  if(e.key==='Escape') closeSearch();
});
document.getElementById('navSearch').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ openSearchFromNav(); }
});
async function doSearch(q){
  const list=document.getElementById('searchList'); list.innerHTML='';
  if(!q){ list.innerHTML='<div style="color:var(--muted)">검색어를 입력하세요</div>'; return; }
  const res=await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=${PER_PAGE}`),{headers:headers()});
  if(!res.ok){ list.innerHTML='<div style="color:var(--muted)">검색 실패</div>'; return; }
  const posts=await res.json(); if(!posts.length){ list.innerHTML='<div style="color:var(--muted)">결과 없음</div>'; return; }
  posts.forEach(p=> list.appendChild(makeVCard(p)));
}

/* =========================================================
   POST (2)(3)(5)(10) + 관련글
   ========================================================= */
async function openPost(id){
  let post = state.cache[id];
  if(!post){
    const r=await fetch(api(`posts/${id}?_embed`),{headers:headers()});
    if(!r.ok){ alert('게시물을 불러오지 못했습니다.'); return; }
    post=await r.json(); state.cache[id]=post;
  }

  // 헤더
  const hero = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
  document.getElementById('postHero').src = hero;
  document.getElementById('postTitle').innerHTML = post.title?.rendered || '제목 없음';
  document.getElementById('postAvatar').src = post._embedded?.author?.[0]?.avatar_urls?.['96'] || ph(96,96,'U');
  document.getElementById('postAuthor').textContent = post._embedded?.author?.[0]?.name || '익명';
  const cats=(post._embedded?.['wp:term']?.[0]||[]).map(t=>t.name).join(', ');
  document.getElementById('postDate').textContent = `${fmt(post.date)} · ${cats||'-'}`;

  // 본문
  const content=document.getElementById('postContent');
  content.innerHTML = post.content?.rendered || post.excerpt?.rendered || '';
  // “이 글 공유하기” 문구 제거 (공유 기능 자체는 브라우저에서 가능)
  try{ content.querySelectorAll('*').forEach(el=>{ if(el.textContent?.trim().includes('이 글 공유하기')) el.remove(); }); }catch(e){}
  // 수정일/수정 관련 엘리먼트 제거
  try{ content.querySelectorAll('.updated, time[itemprop="dateModified"], [data-modified], .post-modified, .modified-date').forEach(el=>el.remove()); }catch(e){}
  // 임베드 보정: 속성 제거(폭은 CSS로 제어)
  content.querySelectorAll('iframe,video,embed,object').forEach(el=>{ el.removeAttribute('width'); el.removeAttribute('height'); });

  // 관련글
  loadRelated(post);

  // 오버레이 열기 + 진행바 초기화
  const ov=document.getElementById('post'); ov.classList.add('active');
  document.getElementById('progressTop').style.width='0%';
  ov.scrollTop=0; state.lastY=0; state.lastDirUp=false;
  history.pushState({page:'post',id},'',`#post-${id}`);
}

function closePost(){
  document.getElementById('post').classList.remove('active');
  document.getElementById('progressTop').style.width='0%';
  history.pushState({page:'home'},'',location.pathname);
}

async function loadRelated(post){
  const cat=(post.categories||[])[0];
  const grid=document.getElementById('relatedGrid');
  const section=document.getElementById('related');
  grid.innerHTML=''; section.style.display='none';
  if(!cat) return;
  const res=await fetch(api(`posts?categories=${cat}&per_page=5&orderby=date&order=desc&exclude=${post.id}`),{headers:headers()});
  if(!res.ok) return;
  const arr=await res.json(); const pick=(Array.isArray(arr)?arr:[]).slice(0,4);
  pick.forEach(p=> grid.appendChild(makeSmall(p)));
  if(pick.length) section.style.display='grid';
}

/* 진행바 + 위로 스크롤 시 툴바 표시(2)(3)(4) */
(function(){
  const ov=document.getElementById('post');
  const prog=document.getElementById('progressTop');
  const bar=document.getElementById('postToolbar');
  ov.addEventListener('scroll', ()=>{
    const max = ov.scrollHeight - ov.clientHeight;
    const pct = max>0 ? (ov.scrollTop / max) * 100 : 0;
    prog.style.width = Math.min(100,Math.max(0,pct)) + '%';

    const y = ov.scrollTop;
    const goingUp = y < state.lastY;
    if(goingUp && !state.lastDirUp){ bar.classList.add('show'); }
    if(!goingUp && state.lastDirUp && y > 40){ bar.classList.remove('show'); }
    state.lastDirUp = goingUp;
    state.lastY = y;
  }, {passive:true});
})();

/* =========================================================
   BOOT
   ========================================================= */
document.addEventListener('DOMContentLoaded', ()=>{
  renderNav();
  loadHome(1);

  // 해시 라우팅: #post-123 직접 진입 대응
  if(location.hash.startsWith('#post-')){
    const id=parseInt(location.hash.replace('#post-','')); if(id) openPost(id);
  }

  // 뒤로가기 처리
  window.addEventListener('popstate', ()=>{
    if(location.hash.startsWith('#post-')){ const id=parseInt(location.hash.replace('#post-','')); if(id) openPost(id); }
    else { closePost(); }
  });
});

// 라우터 헬퍼
const router = {
  goHome(){
    closePost();
    loadHome(1);
    window.scrollTo({top:0,behavior:'smooth'});
  }
};

// ABOUT / EDITORS 자리 표시자 (필요 시 구현)
function openAbout(){ alert('ABOUT은 햄버거 메뉴에서 접근하세요.'); }
function openEditors(){ alert('EDITORS 페이지는 준비 중입니다.'); }
</script>
</body>
</html>
