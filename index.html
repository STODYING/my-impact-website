<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMPACT — MAKE A IMPACT</title>
  <link rel="icon" href="logo.png" type="image/png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="IMPACT" />

  <style>
  /* ============================
     THEME + EASING (스무스함 복원)
     ============================ */
  :root{
    --bg:#f7f8fa; --text:#111; --muted:#6b7280; --card:#fff; --border:rgba(0,0,0,.08);
    --shadow:0 10px 28px rgba(0,0,0,.08);
    --accent:#2e8b57; --progress:#ff7a1a;
    --ease: cubic-bezier(.22,.61,.36,1);        /* 부드러운 가속/감속 */
    --ease-fast: cubic-bezier(.2,.9,.2,1);      /* 오버레이용 */
    --dur: .22s;                                /* 통일된 지속시간 */
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --text:#f2f4f7; --muted:#a6adbb; --card:#171a21; --border:rgba(255,255,255,.08);
    --shadow:0 12px 38px rgba(0,0,0,.35);
    --accent:#39c07c; --progress:#ff9f45;
  }

  /* ===== RESET ===== */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); line-height:1.6;
    font-family:"Noto Sans KR","Apple SD Gothic Neo","Segoe UI",system-ui,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overscroll-behavior-y:contain; overflow-x:hidden;         /* (5) 가로 스크롤 방지 */
    scroll-behavior:smooth;
  }
  a{color:inherit;text-decoration:none}
  img{display:block;max-width:100%;height:auto}
  input[type="search"]::-webkit-search-cancel-button{cursor:pointer}
  .wrap{max-width:1400px;margin:0 auto;padding:0 20px}

  /* ============================
     TOP PROGRESS (3)
     ============================ */
  #progressTop{
    position:fixed; top:0; left:0; height:4px; width:0;
    background:var(--progress); z-index:3000; transition:width .08s linear;
  }

  /* ============================
     HEADER (6,7 심플 아이콘)
     ============================ */
  header.header{
    position:sticky; top:0; z-index:1200; background:var(--card);
    border-bottom:1px solid var(--border); backdrop-filter:blur(6px);
  }
  .header-inner{
    height:64px; display:flex; align-items:center; justify-content:space-between; gap:12px;
    max-width:1400px; margin:0 auto; padding:0 16px;
  }
  .logo-btn{display:flex; align-items:center; gap:8px; cursor:pointer; will-change:transform}
  .logo-btn img{width:30px; height:30px; border-radius:6px; object-fit:cover}
  .logo-btn span{font-weight:900; font-size:18px}
  .header-actions{display:flex; gap:8px}
  .icon-btn{
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    border-radius:10px; background:var(--card); border:1px solid var(--border);
    transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    will-change:transform;
  }
  .icon-btn:active{transform:scale(.98)}
  .icon{width:20px; height:20px; display:block}
  .icon.search{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.27v.8L20 21.5 21.5 20l-6-6zM9.5 14A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/></svg>') no-repeat center/contain; background:currentColor}
  .icon.menu{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>') no-repeat center/contain; background:currentColor}
  .icon.close{mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="m19 6.4-1.4-1.4L12 10.6 6.4 5 5 6.4 10.6 12 5 17.6 6.4 19 12 13.4 17.6 19 19 17.6 13.4 12"/></svg>') no-repeat center/contain; background:currentColor}

  /* ============================
     NAV OVERLAY (6,7 아이콘/닫기 X)
     ============================ */
  .nav{
    position:fixed; inset:0; z-index:2200; background:var(--card);
    opacity:0; visibility:hidden; transform:translateY(8px);
    transition: opacity var(--dur) var(--ease-fast), transform var(--dur) var(--ease-fast), visibility 0s var(--dur);
  }
  .nav.active{opacity:1; visibility:visible; transform:translateY(0); transition: opacity var(--dur) var(--ease-fast), transform var(--dur) var(--ease-fast)}
  .nav-head{display:flex; justify-content:flex-end; padding:12px}
  .nav-body{max-width:960px; margin:0 auto; padding:0 20px 28px}
  .nav-list{list-style:none; padding:0; margin:6px 0 0; display:grid; gap:14px}
  .nav-item{font-weight:900; font-size:28px; cursor:pointer; transition:color var(--dur) var(--ease)}
  .nav-item:hover{color:var(--accent)}
  .nav-search{display:flex; gap:8px; align-items:center; margin:8px 0 16px}
  .nav-search input{flex:1; border:none; border-bottom:2px solid var(--text); background:transparent; color:var(--text); padding:10px 6px; font-weight:800}

  /* ============================
     SEARCH OVERLAY (7)
     ============================ */
  .search{
    position:fixed; inset:0; z-index:2100; background:var(--card);
    opacity:0; visibility:hidden; transform:translateY(8px);
    transition: opacity var(--dur) var(--ease-fast), transform var(--dur) var(--ease-fast), visibility 0s var(--dur);
  }
  .search.active{opacity:1; visibility:visible; transform:translateY(0)}
  .search-head{display:flex; gap:8px; align-items:center; padding:12px}
  .search-bar{flex:1; display:flex; gap:8px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:999px; padding:6px 10px}
  .search-bar input{flex:1; border:none; background:transparent; color:var(--text); font-size:16px; outline:none}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; padding:10px 20px 24px}

  /* ============================
     HOME (4,8,9) — 1(큰)+4(작은) 패턴 교차
     ============================ */
  .home{max-width:1400px; margin:22px auto; padding:0 16px}
  .row{display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-bottom:16px}
  .row.reverse{grid-template-columns:1fr 2fr}
  .col{display:flex; flex-direction:column; gap:12px}

  .big{
    position:relative; border-radius:12px; overflow:hidden; background:#222; min-height:360px; cursor:pointer;
    transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    will-change:transform;
  }
  .big:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .big img{width:100%; height:100%; object-fit:cover}
  .big .overlay{position:absolute; inset:auto 0 0 0; padding:18px; color:#fff;
                background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.6))}
  .big .title{margin:0; font-size:28px; font-weight:900; line-height:1.1}
  .small{
    background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden; cursor:pointer;
    transition: transform var(--dur) var(--ease), box-shadow var(--dur) var(--ease);
    will-change:transform;
  }
  .small:hover{transform:translateY(-4px); box-shadow:var(--shadow)}
  .small .thumb{height:120px; background:#2a2f38}
  .small .thumb img{width:100%; height:100%; object-fit:cover}
  .small .body{padding:10px}
  .small h3{font-size:15px; margin:0 0 6px; font-weight:900}
  .meta{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:12px}
  .meta img{width:28px; height:28px; border-radius:50%; object-fit:cover}
  .cat{display:inline-block; padding:4px 8px; border-radius:6px; background:#7e5fff; color:#fff; font-weight:800; font-size:11px}
  .cat-tech{background:#1e90ff}.cat-eat{background:#ff6347}.cat-style{background:#32cd32}.cat-culture{background:#8a2be2}.cat-life{background:#ffa500;color:#000}

  @media (max-width:980px){
    /* (4) 모바일: 큰1 + 작은4 반복(세로) */
    .row,.row.reverse{grid-template-columns:1fr}
    .big{min-height:40vh}
  }

  /* ============================
     PAGINATION (8)
     ============================ */
  .pager{display:flex; justify-content:center; gap:8px; flex-wrap:wrap; padding:10px 0 28px}
  .pager button{padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--card); font-weight:800; cursor:pointer; color:var(--text)}
  .pager .current{border:none; background:transparent; color:var(--progress); cursor:default}

  /* ============================
     POST OVERLAY (2,3,5,10)
     ============================ */
  .post{
    position:fixed; inset:0; z-index:2000; background:var(--card); overflow:auto;
    opacity:0; visibility:hidden; transform:translateY(8px);
    transition: opacity var(--dur) var(--ease-fast), transform var(--dur) var(--ease-fast), visibility 0s var(--dur);
  }
  .post.active{opacity:1; visibility:visible; transform:translateY(0)}
  .post-wrap{max-width:1200px; margin:0 auto; padding:24px 16px 40px}

  /* (2) 위로 스크롤시에만 툴바 show (초기 숨김) */
  .post-toolbar{
    position:fixed; top:10px; left:50%; transform:translateX(-50%);
    width:min(1200px, calc(100% - 24px)); height:46px; padding:0 10px;
    display:flex; align-items:center; justify-content:space-between;
    background:color-mix(in oklab, var(--card) 88%, transparent);
    border:1px solid var(--border); border-radius:12px; backdrop-filter:blur(8px);
    box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity var(--dur) var(--ease);
  }
  .post-toolbar.show{opacity:1; pointer-events:auto}
  .tool-left{display:flex; gap:8px; align-items:center; font-weight:900; cursor:pointer}
  .tool-left img{width:24px; height:24px; border-radius:6px; object-fit:cover}

  /* (10) 카드형 헤더: 좌 이미지 / 우 텍스트 */
  .post-head{
    display:grid; grid-template-columns:1.3fr 1fr; gap:16px; align-items:stretch; margin-bottom:14px
  }
  .ph-img{border-radius:12px; overflow:hidden; background:#000}
  .ph-img img{width:100%; height:100%; object-fit:cover}
  .ph-meta{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; display:flex; flex-direction:column; justify-content:center}
  .ph-meta h1{margin:0 0 10px; font-size:34px; line-height:1.1}
  .who{display:flex; gap:10px; align-items:center; color:var(--muted)}
  .who img{width:40px; height:40px; border-radius:50%}
  @media (max-width:900px){ .post-head{grid-template-columns:1fr} .ph-meta h1{font-size:28px} }

  /* 본문 미디어(5) — 모바일 가로 넘침 방지 */
  .post-content{color:var(--text); line-height:1.85}
  .post-content img,.post-content video{max-width:100%; height:auto; display:block}
  .post-content iframe{max-width:100% !important; width:100% !important; border:none; aspect-ratio:16/9; height:auto}

  /* ===== 좌하단 테마 토글(1) ===== */
  .theme-toggle{
    position:fixed; left:12px; bottom:12px; z-index:2600; display:flex; align-items:center; gap:8px;
    background:var(--card); border:1px solid var(--border); border-radius:999px; padding:8px 10px; cursor:pointer; box-shadow:var(--shadow);
    transition:transform var(--dur) var(--ease)
  }
  .theme-toggle:active{transform:scale(.98)}
  .theme-toggle input{appearance:none; width:36px; height:20px; border-radius:999px; background:#ccc; position:relative; outline:none; cursor:pointer}
  .theme-toggle input::after{content:""; position:absolute; left:2px; top:2px; width:16px; height:16px; border-radius:50%; background:#fff; transition:left var(--dur) var(--ease)}
  .theme-toggle input:checked{background:#222}
  .theme-toggle input:checked::after{left:18px}

  /* ===== FOOTER ===== */
  footer.site-footer{background:#111; color:#eee; padding:36px 16px; margin-top:10px}
  html[data-theme="dark"] footer.site-footer{background:#0b0c10; color:#cfd3dc}
  .footer-inner{max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; gap:20px; flex-wrap:wrap}
  .footer-links a{color:#ddd; display:block; margin:6px 0; font-weight:800}
  </style>
</head>
<body>

  <!-- (3) 페이지 최상단 진행바 -->
  <div id="progressTop"></div>

  <!-- 좌하단 다크/라이트 토글 (1) -->
  <button class="theme-toggle" onclick="toggleTheme()" title="다크/라이트 전환">
    <span style="font-weight:800;font-size:12px">Light</span>
    <input id="themeSwitch" type="checkbox" aria-label="테마 전환">
    <span style="font-weight:800;font-size:12px">Dark</span>
  </button>

  <!-- 헤더(6,7) -->
  <header class="header">
    <div class="header-inner">
      <div class="logo-btn" onclick="router.goHome()">
        <img src="logo.png" alt="IMPACT" /><span>IMPACT</span>
      </div>
      <div class="header-actions">
        <button class="icon-btn" aria-label="검색" onclick="openSearch()"><i class="icon search"></i></button>
        <button class="icon-btn" aria-label="메뉴" onclick="toggleNav(true)"><i class="icon menu"></i></button>
      </div>
    </div>
  </header>

  <!-- NAV (6,7) -->
  <aside id="nav" class="nav" aria-hidden="true">
    <div class="nav-head">
      <button class="icon-btn" aria-label="닫기" onclick="toggleNav(false)"><i class="icon close"></i></button>
    </div>
    <div class="nav-body">
      <div class="nav-search">
        <input id="navSearch" type="search" placeholder="검색어 입력 (Enter)" />
        <button class="icon-btn" onclick="openSearchFromNav()"><i class="icon search"></i></button>
      </div>
      <ul id="navList" class="nav-list"></ul> <!-- 카테고리는 여기에서만 노출 -->
    </div>
  </aside>

  <!-- SEARCH (7) -->
  <section id="search" class="search" aria-hidden="true">
    <div class="search-head">
      <div class="search-bar">
        <i class="icon search"></i>
        <input id="searchInput" type="search" placeholder="검색어 입력 후 Enter" />
      </div>
      <button class="icon-btn" aria-label="닫기" onclick="closeSearch()"><i class="icon close"></i></button>
    </div>
    <div id="searchGrid" class="grid"></div>
  </section>

  <!-- HOME (4,8,9) -->
  <main id="home" class="home" role="main">
    <div id="rows"></div>
    <nav id="homePager" class="pager" aria-label="페이지 이동"></nav>
  </main>

  <!-- POST OVERLAY (2,3,10 + 관련글) -->
  <article id="post" class="post" aria-hidden="true">
    <!-- (2) 위로 스크롤 시에만 보이는 툴바 (최상단 고정 X) -->
    <div id="postToolbar" class="post-toolbar" aria-hidden="true">
      <div class="tool-left" onclick="router.goHome()">
        <img src="logo.png" alt="" /><span>IMPACT</span>
      </div>
      <div class="tool-right"><button class="icon-btn" aria-label="메뉴" onclick="toggleNav(true)"><i class="icon menu"></i></button></div>
    </div>

    <div class="post-wrap">
      <div style="display:flex;justify-content:flex-end;padding:6px 0 10px">
        <button class="icon-btn" aria-label="닫기" onclick="closePost()"><i class="icon close"></i></button>
      </div>

      <!-- (10) 카드형 헤더: 좌=썸네일, 우=제목/에디터/날짜 -->
      <section id="postHead" class="post-head">
        <div class="ph-img"><img id="postHero" src="" alt=""></div>
        <div class="ph-meta">
          <h1 id="postTitle">제목</h1>
          <div class="who">
            <img id="postAvatar" src="" alt="">
            <div>
              <div id="postAuthor" style="font-weight:800;color:var(--text)">author</div>
              <div id="postDate" style="font-size:13px;color:var(--muted)">date · categories</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 본문 -->
      <div id="postContent" class="post-content"></div>

      <!-- 관련 글 4개 -->
      <section id="related" style="display:none;margin-top:26px">
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:900">관련 글</h3>
        <div id="relatedGrid" class="grid" style="padding:0"></div>
      </section>
    </div>
  </article>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="footer-inner">
      <div>
        <div style="font-size:32px;font-weight:900">IMPACT</div>
        <div style="margin-top:8px;color:#ddd;font-size:13px">광고 제휴 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
        <div style="color:#ddd;font-size:13px;margin-top:6px">보도자료 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
      </div>
      <div class="footer-links">
        <a href="javascript:void(0)" onclick="openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="openEditors()">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER는 준비 중입니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>
      <div style="font-weight:800">IMPACT CEO. ALL RIGHTS RESERVED.</div>
    </div>
  </footer>

  <!-- 작은 카드 템플릿 -->
  <template id="smallTpl">
    <article class="small">
      <div class="thumb"><img alt=""></div>
      <div class="body">
        <span class="cat">CATEGORY</span>
        <h3 class="t"></h3>
        <div class="meta">
          <img class="av" alt="">
          <div><div class="name" style="font-weight:800;color:var(--text)"></div><div class="d"></div></div>
        </div>
      </div>
    </article>
  </template>

  <script>
  /* =========================
     CONFIG / STATE
     ========================= */
  const PER_PAGE = 20; // (8) 한 페이지 최대 20
  const CATS = { tech:318, eat:123073, style:2286, culture:1098, life:124, "editors-pick":259543 };
  const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];
  const state = { homePage:1, homeTotal:1, cache:{}, lastY:0, postId:null };

  /* =========================
     HELPERS
     ========================= */
  function api(path){ const p = path.includes('_embed') ? path : (path + (path.includes('?')?'&':'?') + '_embed'); return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`; }
  function headers(){ return {}; }
  function fmt(d){ const x=new Date(d); return `${x.getFullYear()}. ${String(x.getMonth()+1).padStart(2,'0')}. ${String(x.getDate()).padStart(2,'0')}.`; }
  function ph(w=600,h=400,t='No Image'){ const s=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='%232b2f36'/><text x='50%' y='50%' fill='%239aa3af' font-size='20' text-anchor='middle' dominant-baseline='middle'>${t}</text></svg>`; return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(s); }
  function pickCat(slug){ slug=String(slug||'').toLowerCase(); if(slug.includes('tech'))return'cat-tech'; if(slug.includes('eat'))return'cat-eat'; if(slug.includes('style'))return'cat-style'; if(slug.includes('culture'))return'cat-culture'; if(slug.includes('life'))return'cat-life'; return ''; }

  /* =========================
     THEME (1)
     ========================= */
  (function initTheme(){
    const saved = localStorage.getItem('impact-theme') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('themeSwitch').checked = (saved==='dark');
  })();
  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur==='light'?'dark':'light';
    document.documentElement.setAttribute('data-theme', next);
    document.getElementById('themeSwitch').checked = (next==='dark');
    localStorage.setItem('impact-theme', next);
  }

  /* =========================
     NAV (6)
     ========================= */
  function renderNav(){
    const ul=document.getElementById('navList'); ul.innerHTML='';
    NAV_ORDER.forEach(label=>{
      const li=document.createElement('li'); li.className='nav-item'; li.textContent=label;
      li.onclick=()=>{ toggleNav(false); const slug=label.toLowerCase().replace(/'/g,'').replace(/\s/g,'-'); openCategory(slug,1); };
      ul.appendChild(li);
    });
  }
  function toggleNav(open){ const el=document.getElementById('nav'); open?el.classList.add('active'):el.classList.remove('active'); }
  function openSearch(){ document.getElementById('search').classList.add('active'); document.getElementById('searchInput').focus(); }
  function closeSearch(){ document.getElementById('search').classList.remove('active'); }
  function openSearchFromNav(){ const v=document.getElementById('navSearch').value.trim(); toggleNav(false); openSearch(); if(v){ document.getElementById('searchInput').value=v; doSearch(v); } }

  /* =========================
     HOME (4,8,9) — 1+4 교차
     ========================= */
  async function loadHome(page=1){
    const rows=document.getElementById('rows'); rows.innerHTML='';
    const pager=document.getElementById('homePager'); pager.innerHTML='';
    const res=await fetch(api(`posts?per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
    if(!res.ok){ rows.innerHTML='<div style="text-align:center;color:var(--muted)">불러오기 실패</div>'; return; }
    const posts=await res.json();
    const total=parseInt(res.headers.get('X-WP-TotalPages')||'1',10); state.homePage=page; state.homeTotal=total;
    posts.forEach(p=> state.cache[p.id]=p);

    // 5개씩(큰1 + 작은4) 묶어 좌우 교차 배치 (오른쪽 4개가 끝까지 보이고 다음 행이 나오도록 한 행에 묶음)
    for(let i=0;i<posts.length;i+=5){
      const group=posts.slice(i,i+5);
      const row=document.createElement('section');
      row.className = (Math.floor(i/5)%2===0) ? 'row' : 'row reverse';

      const colA=document.createElement('div'); colA.className='col';   // 왼쪽
      const colB=document.createElement('div'); colB.className='col';   // 오른쪽

      const big=makeBig(group[0]);
      const small=group.slice(1,5).map(makeSmall);

      if(row.className==='row'){               // big left + small right
        colA.appendChild(big); small.forEach(n=> colB.appendChild(n));
      }else{                                   // small left + big right
        small.forEach(n=> colA.appendChild(n)); colB.appendChild(big);
      }
      row.append(colA,colB); rows.appendChild(row);
    }
    renderPager(pager, page, total, to=>loadHome(to));
  }
  function makeBig(post){
    if(!post) return document.createElement('div');
    const el=document.createElement('article'); el.className='big';
    const url=post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
    el.innerHTML=`
      <img src="${url||ph(1200,800)}" alt="">
      <div class="overlay">
        <span class="cat ${pickCat(post._embedded?.['wp:term']?.[0]?.[0]?.slug||'')}">
          ${post._embedded?.['wp:term']?.[0]?.[0]?.name || '&nbsp;'}
        </span>
        <h2 class="title">${post.title?.rendered || '제목 없음'}</h2>
        <div class="meta" style="margin-top:6px">
          <img src="${post._embedded?.author?.[0]?.avatar_urls?.['48']||ph(48,48,'U')}" alt="">
          <div><div class="name" style="font-weight:800;color:#fff">${post._embedded?.author?.[0]?.name||'익명'}</div><div class="d" style="color:#eee">${fmt(post.date)}</div></div>
        </div>
      </div>`;
    el.onclick=()=> openPost(post.id);
    return el;
  }
  function makeSmall(post){
    if(!post) return document.createElement('div');
    const tpl=document.getElementById('smallTpl').content.firstElementChild.cloneNode(true);
    tpl.querySelector('.thumb img').src = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
    tpl.querySelector('.t').innerHTML = post.title?.rendered || '제목 없음';
    const cat = post._embedded?.['wp:term']?.[0]?.[0];
    tpl.querySelector('.cat').textContent = cat?.name || ' ';
    const cls = pickCat(cat?.slug||''); if(cls) tpl.querySelector('.cat').classList.add(cls);
    tpl.querySelector('.av').src = post._embedded?.author?.[0]?.avatar_urls?.['48'] || ph(48,48,'U');
    tpl.querySelector('.name').textContent = post._embedded?.author?.[0]?.name || '익명';
    tpl.querySelector('.d').textContent = fmt(post.date);
    tpl.onclick=()=> openPost(post.id);
    return tpl;
  }
  function renderPager(container, cur, total, cb){
    if(total<=1) return;
    const add=(l,p,isCur=false,dis=false)=>{ const b=document.createElement('button'); b.textContent=l; if(isCur){b.className='current'; b.disabled=true;} else if(!dis){ b.onclick=()=>cb(p); } container.appendChild(b); };
    const ell=()=>{ const s=document.createElement('span'); s.textContent='…'; s.style.opacity=.6; container.appendChild(s); };
    add('«',1,false,cur===1);
    if(total<=9){ for(let p=1;p<=total;p++) add(p,p,p===cur); }
    else if(cur<=4){ for(let p=1;p<=5;p++) add(p,p,p===cur); ell(); add(total,total); }
    else if(cur>=total-3){ add(1,1); ell(); for(let p=total-4;p<=total;p++) add(p,p,p===cur); }
    else { add(1,1); ell(); for(let p=cur-1;p<=cur+1;p++) add(p,p,p===cur); ell(); add(total,total); }
    add('»',total,false,cur===total);
  }

  /* =========================
     CATEGORY (메뉴에서만 접근)
     ========================= */
  async function openCategory(slug, page=1){
    const grid=document.getElementById('searchGrid'); grid.innerHTML=''; openSearch();
    const res=await fetch(api(`posts?categories=${CATS[slug]}&per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
    const posts=await res.json(); posts.forEach(p=> grid.appendChild(makeSmall(p)));
  }

  /* =========================
     SEARCH
     ========================= */
  document.getElementById('searchInput').addEventListener('keydown',e=>{
    if(e.key==='Enter'){ doSearch(e.target.value.trim()); }
    if(e.key==='Escape') closeSearch();
  });
  document.getElementById('navSearch').addEventListener('keydown',e=>{
    if(e.key==='Enter'){ openSearchFromNav(); }
  });
  async function doSearch(q){
    const grid=document.getElementById('searchGrid'); grid.innerHTML='';
    if(!q){ grid.innerHTML='<div style="color:var(--muted)">검색어를 입력하세요</div>'; return; }
    const res=await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=${PER_PAGE}`),{headers:headers()});
    if(!res.ok){ grid.innerHTML='<div style="color:var(--muted)">검색 실패</div>'; return; }
    const posts=await res.json(); if(!posts.length){ grid.innerHTML='<div style="color:var(--muted)">결과 없음</div>'; return; }
    posts.forEach(p=> grid.appendChild(makeSmall(p)));
  }

  /* =========================
     POST (2,3,5,10) + RELATED
     ========================= */
  async function openPost(id){
    state.postId = id;
    let post = state.cache[id];
    if(!post){
      const r = await fetch(api(`posts/${id}?_embed`),{headers:headers()}); post = await r.json(); state.cache[id]=post;
    }
    // 헤더 채우기 (10)
    const hero = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
    document.getElementById('postHero').src = hero;
    document.getElementById('postTitle').innerHTML = post.title?.rendered || '제목 없음';
    document.getElementById('postAvatar').src = post._embedded?.author?.[0]?.avatar_urls?.['96'] || ph(96,96,'U');
    document.getElementById('postAuthor').textContent = post._embedded?.author?.[0]?.name || '익명';
    const cats = (post._embedded?.['wp:term']?.[0]||[]).map(t=>t.name).join(', ');
    document.getElementById('postDate').textContent = `${fmt(post.date)} · ${cats||'-'}`;

    // 본문 + 공유문구/수정일 제거 + 임베드 반응형 (5)
    const content=document.getElementById('postContent');
    content.innerHTML = post.content?.rendered || post.excerpt?.rendered || '';
    try{ content.querySelectorAll('*').forEach(el=>{ if(el.textContent?.includes('이 글 공유하기')) el.remove(); }); }catch(e){}
    try{ content.querySelectorAll('.updated, time[itemprop="dateModified"], [data-modified], .post-modified, .modified-date').forEach(el=>el.remove()); }catch(e){}
    content.querySelectorAll('iframe').forEach(f=>{ f.removeAttribute('width'); f.removeAttribute('height'); });

    // 관련 글 4개
    loadRelated(post);

    // 오버레이 열기 + 진행바 초기화
    const ov=document.getElementById('post'); ov.classList.add('active');
    document.getElementById('progressTop').style.width='0%';
    document.getElementById('postToolbar').classList.remove('show');
    ov.scrollTop=0; state.lastY=0;

    history.pushState({page:'post',id}, '', `#post-${id}`);
  }
  function closePost(){
    document.getElementById('post').classList.remove('active');
    document.getElementById('progressTop').style.width='0%';
    history.pushState({page:'home'}, '', location.pathname);
  }
  async function loadRelated(post){
    const cat=(post.categories||[])[0]; const sect=document.getElementById('related');
    const grid=document.getElementById('relatedGrid'); grid.innerHTML=''; sect.style.display='none';
    if(!cat) return;
    const res=await fetch(api(`posts?categories=${cat}&per_page=5&orderby=date&order=desc&exclude=${post.id}`),{headers:headers()});
    const arr=await res.json(); const list=(Array.isArray(arr)?arr:[]).slice(0,4);
    list.forEach(p=> grid.appendChild(makeSmall(p)));
    if(list.length) sect.style.display='block';
  }

  // (2,3) 진행바 + “위로 스크롤 시 툴바 show”
  (function(){
    const ov=document.getElementById('post');
    const prog=document.getElementById('progressTop');
    const bar=document.getElementById('postToolbar');
    ov.addEventListener('scroll', ()=>{
      const max = ov.scrollHeight - ov.clientHeight;
      const pct = max>0 ? (ov.scrollTop / max) * 100 : 0;
      prog.style.width = Math.min(100, Math.max(0, pct)) + '%';

      const y = ov.scrollTop;
      if(y < state.lastY - 4) bar.classList.add('show');       // 조금만 위로 스크롤 → 보임
      else if(y > state.lastY + 6) bar.classList.remove('show'); // 아래로 스크롤 → 숨김
      state.lastY = y;
    });
  })();

  /* =========================
     BOOT
     ========================= */
  function routerGoHome(){ closePost(); loadHome(1); window.scrollTo({top:0,behavior:'smooth'}); }
  const router = { goHome: routerGoHome };

  document.addEventListener('DOMContentLoaded', ()=>{
    renderNav(); loadHome(1);

    // 뒤로가기 라우팅
    if(location.hash.startsWith('#post-')){ const id=parseInt(location.hash.replace('#post-','')); if(id) openPost(id); }
    window.addEventListener('popstate', ()=>{
      if(location.hash.startsWith('#post-')){ const id=parseInt(location.hash.replace('#post-','')); if(id) openPost(id); }
      else closePost();
    });
  });
  </script>
</body>
</html>
