<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- 수정됨: 모바일 화면 회전 시 텍스트 크기 고정 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IMPACT – MAKE A IMPACT</title>
  <meta name="description" content="Innovation Management Passion Acceleration Creativity Technology" id="metaDescription">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" id="ogType">
  <meta property="og:url" content="https://impactceo.art/" id="ogUrl">
  <meta property="og:title" content="IMPACT – MAKE A IMPACT" id="ogTitle">
  <meta property="og:description" content="Innovation Management Passion Acceleration Creativity Technology" id="ogDescription">
  <meta property="og:image" content="https://impactceo.art/logo.png" id="ogImage">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" id="twitterCard">
  <meta property="twitter:url" content="https://impactceo.art/" id="twitterUrl">
  <meta property="twitter:title" content="IMPACT – MAKE A IMPACT" id="twitterTitle">
  <meta property="twitter:description" content="Innovation Management Passion Acceleration Creativity Technology" id="twitterDescription">
  <meta property="twitter:image" content="https://impactceo.art/logo.png" id="twitterImage">
  <meta name="naver-site-verification" content="75a4e73cbf2b7f3acb2c71fac1ea821a9c13ae85" />
  
  <!-- Canonical URL for SEO -->
  <link rel="canonical" href="https://impactceo.art/" id="canonicalUrl">
  
  <!-- 최적화된 리소스 힌트 -->
  <link rel="preconnect" href="https://www.googletagmanager.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://public-api.wordpress.com">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://public-api.wordpress.com">
  
  <!-- 프리렌더링 힌트 (주요 페이지들을 미리 로드) -->
  <!-- 이 링크들은 JavaScript로 동적으로 업데이트됩니다 -->
  <link rel="prefetch" id="prefetchLink1" as="document">
  <link rel="prefetch" id="prefetchLink2" as="document">
  <link rel="prefetch" id="prefetchLink3" as="document">
  
  <!-- Speculation Rules API for Chrome (최신 프리렌더링) -->
  <script type="speculationrules" id="speculationRules">
  {
    "prefetch": [
      {
        "source": "list",
        "urls": []
      }
    ],
    "prerender": [
      {
        "source": "list",
        "urls": []
      }
    ]
  }
  </script>

  <!-- Google Analytics - 비동기 로딩 최적화 -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D0DVTWYNGN');
  </script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D0DVTWYNGN"></script>
  <!-- ⚡ 최적화된 파비콘 -->
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">

  <!-- Microsoft -->
  <meta name="msapplication-TileImage" content="/logo.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">
  
  <!-- 수정됨: 네이버 웨일 모바일 파비콘 표시 -->
  <link rel="manifest" href="/manifest.json">

  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="IMPACT">
  <!-- 폰트 최적화: font-display swap으로 FOIT 방지 -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800;900&display=swap" rel="stylesheet"></noscript>
  
  <!-- 시스템 폰트 폴백 (폰트 로드 실패 시) -->
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif !important;
    }
  </style>
  
  <!-- ⚡ 게시물 및 이미지 뷰어 CSS -->
  <style>
  /* 게시물 콘텐츠 스타일 */
  .post-content, .wp-content {
    max-width: 100%;
    line-height: 1.8;
    color: inherit;
  }

  /* 게시물 이미지 스타일 */
  .post-content img, .wp-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .post-content img:hover, .wp-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  /* 유튜브 비디오 임베드 */
  .post-content iframe, .wp-content iframe,
  .post-content video, .wp-content video {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 20px auto;
    border-radius: 12px;
  }

  /* 반응형 유튜브 컨테이너 */
  .video-container, .wp-video-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    border-radius: 12px;
    margin: 20px 0;
  }

  .video-container iframe, .wp-video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 12px;
  }

  /* 이미지 갤러리 스타일 */
  .gallery, .wp-block-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .gallery img, .wp-block-gallery img {
    cursor: pointer;
    width: 100%;
    height: auto;
    border-radius: 12px;
    transition: transform 0.3s ease;
  }

  .gallery img:hover, .wp-block-gallery img:hover {
    transform: scale(1.05);
  }

  /* ⚡ 이미지 뷰어 오버레이 */
  .image-viewer-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
  }

  .image-viewer-overlay.active {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* 이미지 뷰어 컨테이너 */
  .image-viewer-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  /* 이미지 뷰어 이미지 */
  .image-viewer-img {
    max-width: 95%;
    max-height: 95%;
    object-fit: contain;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

  /* 이미지 뷰어 닫기 버튼 */
  .image-viewer-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    z-index: 10000;
  }

  .image-viewer-close:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .image-viewer-close::before,
  .image-viewer-close::after {
    content: '';
    position: absolute;
    width: 24px;
    height: 2px;
    background: rgba(255, 255, 255, 0.8);
  }

  .image-viewer-close::before {
    transform: rotate(45deg);
  }

  .image-viewer-close::after {
    transform: rotate(-45deg);
  }

  /* 이미지 뷰어 정보 */
  .image-viewer-info {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: rgba(255, 255, 255, 0.8);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
    z-index: 10000;
  }

  /* 이미지 뷰어 컨트롤 */
  .image-viewer-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.5);
    padding: 10px 15px;
    border-radius: 10px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 12px;
    z-index: 10000;
  }

  /* 모바일 컨트롤 텍스트 */
  @media (max-width: 768px) {
    .image-viewer-controls {
      font-size: 11px;
      padding: 8px 12px;
    }

    .image-viewer-close {
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
    }

    .image-viewer-info {
      bottom: 15px;
      font-size: 12px;
    }
  }
  </style>
  
  <!-- ⚡ Critical CSS: Above-the-fold 최적화 -->
  <style>
  /* Critical: 페이지 로딩 스피너 */
  .page-transition{position:fixed;top:0;left:0;right:0;bottom:0;background:#f6f7f9;z-index:10001;opacity:0;pointer-events:none;transition:opacity .3s ease;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:500;color:#111}
  .page-transition.active{opacity:1;pointer-events:all}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* ⚡ Skeleton UI - Critical Styles */
  .skeleton-container{padding:0 20px;max-width:100%;margin:0 auto;margin-top:100px}
  @media (max-width:1280px){.skeleton-container{max-width:1400px}}
  .skeleton-header{position:fixed;top:0;left:0;right:0;height:72px;background:rgba(255,255,255,0.95);border-bottom:1px solid rgba(0,0,0,0.06);z-index:1200;backdrop-filter:blur(10px)}
  
  /* Skeleton row layout matching real layout */
  .skeleton-row{display:grid;gap:24px;margin-bottom:48px}
  .skeleton-card{background:#fff;border-radius:20px;overflow:hidden;border:1px solid rgba(0,0,0,0.06)}
  .skeleton-large-card{background:#fff;border-radius:20px;overflow:hidden;border:1px solid rgba(0,0,0,0.06);position:relative}
  .skeleton-large-image{width:100%;background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite}
  .skeleton-large-overlay{position:absolute;bottom:0;left:0;right:0;padding:32px;background:linear-gradient(to top,rgba(0,0,0,0.7),transparent)}
  .skeleton-large-title{height:32px;background:linear-gradient(90deg,rgba(255,255,255,0.3) 25%,rgba(255,255,255,0.4) 50%,rgba(255,255,255,0.3) 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;border-radius:4px;margin-bottom:12px;width:80%}
  .skeleton-large-meta{height:20px;background:linear-gradient(90deg,rgba(255,255,255,0.3) 25%,rgba(255,255,255,0.4) 50%,rgba(255,255,255,0.3) 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;border-radius:4px;width:50%}
  
  .skeleton-small-grid{display:grid;gap:24px}
  .skeleton-image{width:100%;background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite}
  .skeleton-content{padding:24px}
  .skeleton-title{height:24px;background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;border-radius:4px;margin-bottom:12px}
  .skeleton-text{height:16px;background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;border-radius:4px;margin-bottom:8px}
  .skeleton-meta{height:14px;width:60%;background:linear-gradient(90deg,#f0f0f0 25%,#e8e8e8 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite;border-radius:4px}
  @keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
  
  /* Desktop layout: 1 large + 4 small (2x2) in a row */
  @media (min-width:1281px){
    .skeleton-row{grid-template-columns:1.2fr 1fr}
    .skeleton-row.skeleton-reverse{grid-template-columns:1fr 1.2fr;direction:ltr}
    .skeleton-large-image{aspect-ratio:1.5/1;min-height:500px}
    .skeleton-small-grid{grid-template-columns:repeat(2,1fr)}
    .skeleton-image{aspect-ratio:1.5/1}
  }
  
  /* Tablet layout: 1 large full width + 2x2 small grid (always large first) */
  @media (min-width:769px) and (max-width:1280px){
    .skeleton-row{grid-template-columns:1fr;display:flex;flex-direction:column}
    .skeleton-row.skeleton-reverse{flex-direction:column} /* Large first on tablet */
    .skeleton-large-card{order:1} /* Large always first */
    .skeleton-small-grid{order:2;grid-template-columns:repeat(2,1fr)}
    .skeleton-large-image{aspect-ratio:1.5/1;min-height:400px}
    .skeleton-image{aspect-ratio:1.5/1}
  }
  
  /* Mobile layout: 1 large + 1 column small (always large first) */
  @media (max-width:768px){
    .skeleton-row{grid-template-columns:1fr;display:flex;flex-direction:column}
    .skeleton-row.skeleton-reverse{flex-direction:column} /* Large first on mobile */
    .skeleton-large-card{order:1} /* Large always first */
    .skeleton-small-grid{order:2;grid-template-columns:1fr}
    .skeleton-large-image{aspect-ratio:16/9;min-height:300px}
    .skeleton-image{aspect-ratio:16/9}
    .skeleton-card,.skeleton-large-card{border-radius:16px}
    .skeleton-content{padding:20px}
    .skeleton-large-overlay{padding:24px}
  }
  
  /* Dark mode skeleton */
  body.dark-mode .skeleton-header{background:rgba(20,20,20,0.95);border-bottom-color:rgba(255,255,255,0.08)}
  body.dark-mode .skeleton-card,body.dark-mode .skeleton-large-card{background:#1a1a1a;border-color:rgba(255,255,255,0.12)}
  body.dark-mode .skeleton-image,body.dark-mode .skeleton-large-image,body.dark-mode .skeleton-title,body.dark-mode .skeleton-text,body.dark-mode .skeleton-meta{background:linear-gradient(90deg,#2a2a2a 25%,#333 50%,#2a2a2a 75%);background-size:200% 100%}
  body.dark-mode .skeleton-large-title,body.dark-mode .skeleton-large-meta{background:linear-gradient(90deg,rgba(255,255,255,0.1) 25%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.1) 75%);background-size:200% 100%}
  
  /* ⚡ 모바일 최적화: 이미지 로딩 개선 */
  img, picture { content-visibility: auto; }
  img[loading="lazy"] { content-visibility: auto; }
  
  /* ⚡ 폰트 디스플레이 최적화 */
  @font-face {
    font-family: 'Noto Sans KR';
    font-display: swap;
    src: url('https://fonts.gstatic.com/s/notoSansKr/...') format('woff2');
  }
  </style>
  
  <style>
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height: 100%; }
  /* 수정됨: 모바일 화면 회전 시 텍스트 크기 고정 */
  html, body {
    -webkit-text-size-adjust: 100%;
    -moz-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  body {
    margin: 0;
    font-family: "Noto Sans KR", -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
    background: #f6f7f9;
    color: #111;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    scroll-behavior: smooth;
    overscroll-behavior-y: contain;
    -webkit-tap-highlight-color: transparent;
    transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  body.dark-mode {
    background: #0d0d0d;
    color: #e8e8e8;
  }

  body.dark-mode .header {
    background: rgba(20,20,20,0.95);
    border-bottom-color: rgba(255,255,255,0.08);
  }

  body.dark-mode .card,
  body.dark-mode .btn,
  body.dark-mode .to-top,
  body.dark-mode .nav-search,
  body.dark-mode .search-bar,
  body.dark-mode .editor-card {
    background: #1a1a1a;
    border-color: rgba(255,255,255,0.12);
    color: #e8e8e8;
  }

  body.dark-mode .btn:hover {
    background: #252525;
  }

  body.dark-mode .card h3,
  body.dark-mode .category-title {
    color: #f5f5f5;
  }

  body.dark-mode .nav-overlay {
    background: rgba(20,20,20,0.98);
  }

  body.dark-mode .nav-list li {
    color: #e8e8e8;
    border-bottom-color: rgba(255,255,255,0.08);
  }

  body.dark-mode .category-overlay,
  body.dark-mode .post-overlay,
  body.dark-mode .search-overlay,
  body.dark-mode .about-page,
  body.dark-mode .editors-overlay {
    background: #0d0d0d;
    color: #e8e8e8;
  }

  /* to-top 스타일은 위에서 통합됨 */

  body.dark-mode .post-content {
    color: #e8e8e8;
  }

  body.dark-mode .post-content p,
  body.dark-mode .post-content h1,
  body.dark-mode .post-content h2,
  body.dark-mode .post-content h3,
  body.dark-mode .post-content h4,
  body.dark-mode .post-content li,
  body.dark-mode .post-content span,
  body.dark-mode .post-content div {
    color: #ffffff !important;
  }

  body.dark-mode .meta,
  body.dark-mode .category-sub,
  body.dark-mode .editor-bio,
  body.dark-mode .post-meta-info {
    color: #cccccc !important;
  }

  body.dark-mode .post-info h1 {
    color: #f5f5f5 !important;
  }

  body.dark-mode .hero-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
  }

  /* nav-search 배경은 위에서 통합됨 */
  body.dark-mode .nav-search input {
    color: #e8e8e8;
  }

  body.dark-mode .nav-footer-links a {
    color: #e8e8e8;
  }

  /* search-bar 배경은 위에서 통합됨 */
  body.dark-mode .search-bar input[type="search"] {
    color: #e8e8e8;
  }

  body.dark-mode #searchLoading {
    color: #ffffff !important;
  }

  body.dark-mode .card h3,
  body.dark-mode .card .meta,
  body.dark-mode .card .date {
    color: #e8e8e8 !important;
  }

  /* btn, editor-card 스타일은 위에서 통합됨 */

  body.dark-mode .page-header {
    border-bottom-color: rgba(255,255,255,0.08);
  }

  body.dark-mode .post-header-bar {
    background: rgba(20,20,20,0.95);
    border-bottom-color: rgba(255,255,255,0.08);
  }

  body.dark-mode .post-header-bar .logo {
    color: #e8e8e8 !important;
  }

  body.dark-mode .post-header-bar .btn {
    color: #e8e8e8 !important;
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.12);
  }

  body.dark-mode .hero-author,
  body.dark-mode .hero-date {
    color: #e8e8e8 !important;
  }

  body.dark-mode .date {
    color: #cccccc !important;
  }

  body.dark-mode .page-header h2 {
    color: #f5f5f5;
  }

  body.dark-mode .about-page p,
  body.dark-mode .about-page h3,
  body.dark-mode .about-page h4,
  body.dark-mode .about-page div {
    color: #e8e8e8 !important;
  }

  body.dark-mode .about-page a {
    color: #ff8c5a !important;
  }

  body.dark-mode .roadmap-item h4 {
    color: #f5f5f5 !important;
  }

  body.dark-mode .roadmap-item p {
    color: #cccccc !important;
  }

  body.dark-mode .roadmap-item span {
    color: #e8e8e8 !important;
  }

  body.dark-mode .copyright-notice {
    color: #cccccc !important;
  }

  body.dark-mode .share-title {
    color: #ffffff !important;
  }

  body.dark-mode .author-profile-section {
    background: #1a1a1a;
    border-color: rgba(255,255,255,0.12);
  }

  body.dark-mode .author-profile-name {
    color: #f5f5f5 !important;
  }

  body.dark-mode .author-profile-bio {
    color: #cccccc !important;
  }

  body.dark-mode .image-modal {
    background: rgba(0,0,0,0.95);
  }

  a { color: inherit; text-decoration: none; }
  img { display: block; max-width: 100%; height: auto; }
  input[type="search"]::-webkit-search-cancel-button { cursor: pointer; }
  .wrap { max-width: 100%; margin: 0 auto; padding: 0 20px; }
  
  /* 태블릿과 모바일에서는 기존대로 제한된 너비 유지 */
  @media (max-width: 1280px) {
    .wrap { max-width: 1400px; }
  }
  .hidden { display:none !important; }

  .page-transition {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #f6f7f9;
    z-index: 10001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 500;
    color: #111;
  }

  body.dark-mode .page-transition {
    background: #0d0d0d;
    color: #e8e8e8;
  }

  .page-transition.active {
    opacity: 1;
    pointer-events: all;
  }

  .progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    width: 0%;
    height: 3px;
    background: linear-gradient(90deg, #ff6b35, #ff8c5a);
    z-index: 10000;
    transition: width 0.1s ease;
    display: none;
  }

  .progress-bar.active {
    display: block;
  }
  header.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1200;
    background: rgba(255,255,255,0.95);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    backdrop-filter: blur(10px);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
  }

  header.header.hide {
    transform: translateY(-100%);
    opacity: 0;
  }

  .post-header-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    background: rgba(255,255,255,0.95);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    backdrop-filter: blur(10px);
    transform: translateY(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    height: 72px;
    display: flex;
    align-items: center;
  }

  .post-header-bar.show {
    transform: translateY(0);
  }

  .header-inner {
    height: 72px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    max-width:100%;
    margin:0 auto;
    padding: 0 20px;
  }
  
  /* 태블릿과 모바일에서는 기존대로 제한된 너비 유지 */
  @media (max-width: 1280px) {
    .header-inner { max-width: 1400px; }
  }
  .brand { display:flex; gap:12px; align-items:center; }
  .brand .logo {
    display:flex;
    gap:8px;
    align-items:center;
    font-weight:900;
    font-size:26px;
    letter-spacing:1px;
    color:#111;
    cursor:pointer;
    transition: opacity 0.2s ease;
  }
  body.dark-mode .brand .logo {
    color: #e8e8e8;
  }
  
  @media (hover: hover) {
    .brand .logo:hover {
      opacity: 0.7;
    }
  }
  
  .brand .logo:active {
    opacity: 0.7;
  }
  
  .brand .logo.clicked {
    opacity: 1 !important;
  }
  
  .brand .logo .logo-text {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .brand .logo .logo-text .main-text {
    line-height: 1;
    letter-spacing: 1px;
  }
  .brand .logo small {
    font-size:11px;
    color:#777;
    font-weight:800;
    display:block;
    line-height:1;
    letter-spacing: 1px;
  }
  body.dark-mode .brand .logo small { color: #cccccc; }
  .header-actions { display:flex; gap:8px; align-items:center; }
  .btn {
    border-radius:10px;
    background:#fff;
    padding:8px 12px;
    border:1px solid rgba(0,0,0,0.08);
    font-weight:700;
    font-size:14px;
    cursor:pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    color: #111;
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .btn:active { transform: translateY(1px); }
  .btn.primary {
    background: linear-gradient(135deg,#ff6b35,#ff8c5a);
    color:#fff;
    border:none;
  }

  .icon-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .icon-btn svg {
    width: 20px;
    height: 20px;
    fill: #111;
    transition: fill 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  body.dark-mode .icon-btn svg {
    fill: #e8e8e8;
  }
  .nav-overlay {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    width: 400px;
    background: rgba(255,255,255,0.98);
    z-index: 2000;
    padding: 28px 20px 28px 28px;
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
    box-shadow: -4px 0 20px rgba(0,0,0,0.1);
  }

  @media (max-width: 680px) {
    .nav-overlay {
      width: 100vw;
      left: 0;
    }
    
    .nav-close {
      position: absolute;
      top: 26px;
      right: 24px;
    }
  }
  .nav-overlay.active { transform: translateX(0); }
  .nav-close {
    position: absolute;
    top: 34px;
    right: 28px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #111;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }
  body.dark-mode .nav-close {
    color: #e8e8e8;
  }
  .nav-close:hover {
    background: rgba(0,0,0,0.05);
    transform: rotate(90deg);
  }
  body.dark-mode .nav-close:hover {
    background: rgba(255,255,255,0.1);
  }
  .nav-search {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f0f0f0;
    border-radius: 50px;
    padding: 14px 20px;
    margin-bottom: 20px;
    min-height: 56px;
  }
  .nav-search svg {
    width: 20px;
    height: 20px;
    fill: #111;
    transition: fill 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  body.dark-mode .nav-search svg {
    fill: #e8e8e8;
  }
  .nav-search input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 17px;
    color: #111;
    padding: 2px 0;
  }
  .nav-list {
    list-style: none;
    padding: 0;
    margin: 20px 0;
  }
  .nav-list li {
    padding: 16px 0;
    font-weight: 800;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }
  .nav-list li:hover {
    transform: translateX(10px);
    color: #ff6b35;
  }
  .nav-footer-links {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 32px;
  }
  .nav-footer-links a {
    font-weight: 700;
    font-size: 16px;
    color: #666;
    transition: all 0.3s ease;
  }
  body.dark-mode .nav-footer-links a {
    color: #e8e8e8;
  }
  .nav-footer-links a:hover {
    color: #ff6b35;
    transform: translateX(5px);
  }
  .home {
    margin-top: 96px;
    padding-bottom: 80px;
  }

  .magazine-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
    max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    padding: 0 20px;
  }
  
  /* 태블릿과 모바일에서는 기존대로 제한된 너비 유지 */
  @media (max-width: 1280px) {
    .magazine-row { max-width: 1400px; }
  }

  .magazine-row.reverse {
    grid-template-columns: 1fr 1fr;
  }

  .magazine-large {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    min-height: 500px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .magazine-large:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.15);
  }

  .magazine-large .hero {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    inset: 0;
  }

  .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 28px;
    color: #fff;
  }

  .hero-title {
    font-size: 32px;
    font-weight: 900;
    margin: 0 0 12px;
    line-height: 1.3;
  }

  .magazine-small-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
  }
  .card {
    background: #fff;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.06);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 24px rgba(0,0,0,0.12);
  }
  .card .thumb {
    width: 100%;
    height: 220px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .card .thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  .card:hover .thumb img {
    transform: scale(1.05);
  }
  .card-body {
    padding: 18px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .cat-row {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }
  .cat-badge {
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 11px;
    font-weight: 800;
    color: #fff;
  }
  .card h3 {
    font-size: 18px;
    font-weight: 800;
    margin: 0 0 12px;
    line-height: 1.4;
    flex: 1;
  }
  .meta {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    color: #666;
    margin-top: auto;
  }
  body.dark-mode .meta {
    color: #cccccc;
  }
  .author-name {
    font-weight: 700;
  }
  .cat-badge {
    padding: 6px 10px;
    border-radius: 6px;
    font-weight: 800;
    font-size: 12px;
    color: #fff;
    margin-bottom: 8px;
  }
  .hero-cats {
    position: absolute;
    right: 16px;
    bottom: 16px;
    display: flex;
    gap: 6px;
  }
  .cat-tech{ background:#1e90ff; }
  .cat-eat{ background:#ff6347; }
  .cat-style{ background:#32cd32; }
  .cat-culture{ background:#8a2be2; }
  .cat-life{ background:#ffa500; color:#000; }
  .cat-editors-pick{ background:#ff1493; }
  .category-overlay, .post-overlay, .search-overlay, .about-page, .editors-overlay {
    display:none;
    position:fixed;
    inset:0;
    background:#fff;
    z-index:1800;
    overflow:auto;
    padding:28px;
    animation: overlayIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  #searchLoading {
    color: #000000;
  }
  .post-overlay {
    z-index:1900;
    padding: 0;
    touch-action: pan-y;
  }
  .category-overlay.active, .post-overlay.active, .search-overlay.active, .about-page.active, .editors-overlay.active { display:block; }
  @keyframes overlayIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .roadmap-item:hover {
    transform: translateX(5px);
    transition: transform 0.3s ease;
  }
  .category-top {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    border-bottom:1px solid rgba(0,0,0,0.06);
    padding-bottom:12px;
  }
  .category-title { font-size:24px; font-weight:900; color:#111; }
  .category-sub { font-size:13px; color:#666; margin-top:4px; }
  body.dark-mode .category-sub { color: #cccccc; }
  .category-grid {
    margin-top:18px;
    display:grid;
    gap:18px;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    padding:20px 0 80px;
  }
  .post-article {
    margin:0 auto;
    max-width:100%;
    padding: 120px 20px 60px;
  }
  
  /* 태블릿과 모바일에서는 기존대로 제한된 너비 유지 */
  @media (max-width: 1280px) {
    .post-article { max-width: 1600px; }
  }

  .post-hero-section {
    position: relative;
    margin-bottom: 48px;
  }

  .post-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 48px;
    align-items: start;
    min-height: 80vh;
  }

  .post-thumbnail-container {
    position: sticky;
    top: 120px;
    width: 100%;
    height: 70vh;
    min-height: 500px;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  }

  .post-thumbnail {
    width: 100%;
    height: 100%;
  }

  .post-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.6s ease;
  }

  .post-thumbnail.scrolled img {
    opacity: 0;
    transform: translateY(-20px);
  }

  .post-info-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 40px 0;
  }

  .post-info h1 {
    font-size: 42px;
    font-weight: 900;
    margin: 0 0 24px;
    color: #111;
    line-height: 1.3;
  }

  .post-meta-info {
    display: flex;
    flex-direction: column;
    gap: 16px;
    color: #666;
    font-size: 16px;
    margin-bottom: 32px;
  }
  body.dark-mode .post-meta-info {
    color: #cccccc;
  }

  .post-meta-info .meta-row {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .post-meta-info .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
  }

  @media (max-width: 1024px) {
    .post-header {
      grid-template-columns: 1fr;
      gap: 32px;
      min-height: auto;
    }

    .post-thumbnail-container {
      position: relative;
      top: 0;
      height: 60vh;
      min-height: 400px;
    }

    .post-info h1 {
      font-size: 32px;
    }
  }

  @media (max-width: 768px) {
    .post-article {
      padding: 28px 20px 60px;
    }

    .post-header {
      gap: 24px;
    }

    .post-thumbnail-container {
      height: 50vh;
      min-height: 300px;
    }

    .post-info h1 {
      font-size: 28px;
    }

    .post-info-container {
      padding: 20px 0;
    }
  }

  .post-content {
    color: #222;
    line-height: 1.9;
    font-size: 18px;
    max-width: 800px;
    margin: 0 auto;
    padding: 48px 0;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .post-content p {
    margin: 1.8em 0;
    color: #333;
  }

  body.dark-mode .post-content p {
    color: #e8e8e8;
  }

  .post-content h2 {
    margin: 2.5em 0 1em;
    font-size: 28px;
    font-weight: 800;
  }

  .post-content h3 {
    margin: 2em 0 0.8em;
    font-size: 22px;
    font-weight: 700;
  }

  .post-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 32px 0;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.2s ease;
    pointer-events: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
  }

  .post-content img:hover {
    transform: scale(1.02);
  }
  
  /* 유튜브 임베드 반응형 스타일 - 데스크탑에서는 게시물 너비에 맞추고, 모바일에서는 약간의 여백 */
  .post-content iframe[src*="youtube.com"],
  .post-content iframe[src*="youtu.be"] {
    max-width: 100%;
    width: 100%;
    aspect-ratio: 16 / 9;
    height: auto;
    border-radius: 12px;
    margin: 32px 0;
  }
  
  /* iframe 컨테이너가 있는 경우를 위한 스타일 - 데스크탑에서는 게시물 너비에 맞춤 */
  .post-content .video-container,
  .post-content .youtube-container {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 비율 */
    height: 0;
    overflow: hidden;
    margin: 32px 0;
    border-radius: 12px;
  }
  
  .post-content .video-container iframe,
  .post-content .youtube-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 12px;
    margin: 0;
  }
  
  /* 모바일에서 유튜브 영상 여백 조정 - 좌우 20px 여백 */
  @media (max-width: 768px) {
    .post-content iframe[src*="youtube.com"],
    .post-content iframe[src*="youtu.be"] {
      width: calc(100vw - 40px);
      max-width: calc(100vw - 40px);
      margin-left: calc(-50vw + 50% + 20px);
      border-radius: 8px;
    }
    
    .post-content .video-container,
    .post-content .youtube-container {
      width: calc(100vw - 40px);
      margin-left: calc(-50vw + 50% + 20px);
      border-radius: 8px;
    }
  }

  .author-profile-section {
    max-width: 800px;
    margin: 48px auto;
    padding: 24px;
    background: #f9f9f9;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.06);
    display: flex;
    align-items: center;
    gap: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .author-profile-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .author-profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #ff6b35;
    flex-shrink: 0;
  }

  .author-profile-info {
    flex: 1;
  }

  .author-profile-name {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 8px;
    color: #111;
  }

  .author-profile-bio {
    font-size: 14px;
    color: #666;
    line-height: 1.6;
  }

  .image-modal {
    display: none; /* 기본적으로 숨김 */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    cursor: zoom-out;
    padding: 20px;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }

  .image-modal.active {
    display: flex;
  }

  .image-modal img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }

  .image-modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10001;
    -webkit-tap-highlight-color: transparent; /* 모바일 탭 하이라이트 제거 */
  }

  .image-modal-close:hover,
  .image-modal-close:active {
    background: rgba(255,255,255,0.2);
    transform: rotate(90deg);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .related-posts {
    margin-top: 80px;
    padding-top: 48px;
    border-top: 2px solid rgba(0,0,0,0.1);
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }

  body.dark-mode .related-posts {
    border-top-color: rgba(255,255,255,0.1);
  }

  .related-posts h3 {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 32px;
    text-align: left;
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 24px;
  }

  .related-grid .card h3 {
    text-align: left;
  }

  .search-bar {
    display:flex;
    align-items:center;
    background:#fff;
    border-radius:50px;
    box-shadow:0 6px 20px rgba(0,0,0,0.06);
    padding:6px 10px;
    gap:8px;
  }
  .search-bar input[type="search"] {
    flex:1;
    border:none;
    outline:none;
    font-size:16px;
    padding:12px 14px;
    border-radius:50px;
    background: transparent;
    color: #111;
  }
  .search-bar .close-btn {
    background:none;
    border:none;
    font-size:28px;
    cursor:pointer;
    color:#666;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }
  @media (max-width: 640px) {
    .search-bar .close-btn {
      margin-right: 6px;
    }
  }
  body.dark-mode .search-bar .close-btn {
    color: #e8e8e8;
  }
  .search-bar .close-btn:hover {
    background: rgba(0,0,0,0.05);
    transform: rotate(90deg);
  }
  body.dark-mode .search-bar .close-btn:hover {
    background: rgba(255,255,255,0.1);
  }
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin: 60px auto 40px;
    padding: 20px;
    flex-wrap: wrap;
  }
  
  /* 에디터 페이지 내 페이지네이션은 grid 컨테이너에서 분리 */
  #editorPostsGrid .pagination,
  #searchResults .pagination {
    grid-column: 1 / -1;
    width: 100%;
  }
  .pagination button {
    background-color: transparent;
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 15px;
    font-weight: 500;
    min-width: 44px;
    text-align: center;
    user-select: none;
  }
  .pagination button:hover:not(:disabled):not(.active) {
    background-color: rgba(255,255,255,0.1);
    color: #fff;
  }
  .pagination button.active {
    background-color: transparent;
    color: #ff6600;
    font-weight: 700;
    cursor: default;
    pointer-events: none;
    opacity: 1 !important;
  }
  .pagination button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .pagination span {
    background-color: transparent;
    border-color: transparent;
    color: #ccc;
    font-size: 15px;
    font-weight: 500;
    padding: 0 8px;
    pointer-events: none;
  }
  
  /* 라이트 모드용 페이지네이션 */
  body:not(.dark-mode) .pagination button {
    background-color: transparent;
    color: #000;
    border-color: transparent;
  }
  body:not(.dark-mode) .pagination button:hover:not(:disabled):not(.active) {
    background-color: #f5f5f5;
    color: #000;
    border-color: transparent;
  }
  body:not(.dark-mode) .pagination button.active {
    background-color: transparent;
    color: #ff6600;
    border-color: transparent;
    font-weight: 700;
    pointer-events: none;
    opacity: 1 !important;
  }
  body:not(.dark-mode) .pagination span {
    color: #666;
  }
  
  /* 모바일 반응형 */
  @media (max-width: 640px) {
    .pagination button {
      padding: 8px 12px;
      font-size: 14px;
      min-width: 38px;
    }
    .pagination {
      gap: 6px;
    }
  }
  .editors-overlay {
    padding: 28px;
  }

  .editors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 24px;
    margin-top: 24px;
  }

  .editor-card {
    background: #fff;
    border-radius: 14px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.06);
  }

  .editor-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 24px rgba(0,0,0,0.12);
  }

  .editor-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 16px;
    border: 3px solid #ff6b35;
  }

  .editor-name {
    font-weight: 800;
    font-size: 18px;
    margin-bottom: 8px;
  }

  .editor-bio {
    font-size: 13px;
    color: #666;
    line-height: 1.5;
  }
  body.dark-mode .editor-bio {
    color: #cccccc;
  }
  .to-top {
    position: fixed;
    bottom: 32px;
    right: 32px;
    width: 56px;
    height: 56px;
    background: #000000;
    color: #ffffff;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    z-index: 1100;
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  }

  body.dark-mode .to-top {
    background: #ffffff;
    color: #000000;
  }

  .to-top.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }
  .to-top:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .post-to-top {
    position: fixed;
    bottom: 100px;
    right: 32px;
    width: 56px;
    height: 56px;
    background: #000000;
    color: #ffffff;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    z-index: 9998;
    opacity: 0;
    transform: translateY(20px);
    pointer-events: none;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  }

  body.dark-mode .post-to-top {
    background: #ffffff;
    color: #000000;
  }

  .post-to-top.show {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  .post-to-top:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .site-footer {
    background: #2a2a2a;
    padding: 48px 0 32px;
    color: #fff;
    margin-top: 80px;
  }

  .footer-inner {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 48px;
    align-items: start;
  }

  .footer-brand {
    font-size: 28px;
    font-weight: 900;
    margin-bottom: 16px;
  }

  .footer-links {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .footer-links a {
    font-weight: 700;
    color: #ddd;
    transition: all 0.3s ease;
  }

  .footer-links a:hover {
    color: #ff6b35;
  }

  .theme-toggle {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .theme-toggle-label {
    font-size: 13px;
    color: #aaa;
    font-weight: 600;
  }

  .theme-switch {
    position: relative;
    width: 140px;
    height: 48px;
    background: linear-gradient(145deg, #e0e0e0, #f5f5f5);
    border-radius: 24px;
    cursor: pointer;
    box-shadow:
      inset 2px 2px 5px rgba(0,0,0,0.2),
      inset -2px -2px 5px rgba(255,255,255,0.7);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
  }

  body.dark-mode .theme-switch {
    background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
    box-shadow:
      inset 2px 2px 5px rgba(0,0,0,0.5),
      inset -2px -2px 5px rgba(255,255,255,0.05);
  }

  .theme-switch-text {
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 0.5px;
    pointer-events: none;
  }

  .theme-switch-text .light-text {
    color: #666;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
    transition: all 0.4s ease;
  }

  .theme-switch-text .dark-text {
    color: #333;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
    transition: all 0.4s ease;
  }

  body.dark-mode .theme-switch-text .light-text {
    color: #555;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  }

  body.dark-mode .theme-switch-text .dark-text {
    color: #aaa;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  }

  .theme-switch-slider {
    position: absolute;
    top: 4px;
    left: 4px;
    width: 62px;
    height: 40px;
    background: linear-gradient(145deg, #ffffff, #f0f0f0);
    border-radius: 20px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
      2px 2px 5px rgba(0,0,0,0.2),
      -1px -1px 3px rgba(255,255,255,0.7);
  }

  body.dark-mode .theme-switch-slider {
    left: 74px;
    background: linear-gradient(145deg, #333, #2a2a2a);
    box-shadow:
      2px 2px 5px rgba(0,0,0,0.5),
      -1px -1px 3px rgba(255,255,255,0.05);
  }
  .about-page, .editors-overlay {
    padding: 40px 20px;
  }

  .about-page .wrap {
    max-width: 900px;
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    padding-bottom: 16px;
  }

  .page-header h2 {
    font-size: 32px;
    margin: 0;
    font-weight: 900;
  }
  @media (max-width: 1100px) {
    .magazine-row {
      grid-template-columns: 1fr;
    }

    .magazine-row.reverse {
      grid-template-columns: 1fr;
    }

    .magazine-small-grid {
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .footer-inner {
      grid-template-columns: 1fr;
      gap: 32px;
    }
  }

  @media (max-width: 680px) {
    .home {
      margin-top: 80px;
    }

    .magazine-large {
      min-height: 400px;
    }

    .magazine-large .hero-title {
      font-size: 24px;
    }

    .card .thumb {
      height: 160px;
    }

    .mobile-large-post {
      margin-bottom: 24px;
    }

    .mobile-large-post .magazine-large {
      width: 100%;
      min-height: 350px;
    }

    .mobile-small-grid {
      margin-bottom: 32px;
    }

    .mobile-small-grid .magazine-small-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .mobile-grid .card {
      margin-bottom: 0;
    }

    .mobile-grid .card .thumb {
      height: 180px;
    }

    .mobile-grid .card h3 {
      font-size: 15px;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    .mobile-grid .card-body {
      padding: 14px;
    }

    .mobile-grid .card .meta {
      font-size: 12px;
    }

    .hero-title {
      font-size: 22px;
    }

    .card h3 {
      font-size: 14px;
    }

    .card-body {
      padding: 14px;
    }

    .theme-switch {
      width: 120px;
      height: 42px;
    }

    .theme-switch-slider {
      width: 54px;
      height: 34px;
    }

    body.dark-mode .theme-switch-slider {
      left: 62px;
    }

    .author-profile-section {
      flex-direction: column;
      text-align: center;
    }

    .post-to-top {
      bottom: 32px;
      right: 20px;
      width: 48px;
      height: 48px;
    }

    .to-top {
      display: none;
    }
  }

  @media (min-width: 1400px) {
    .magazine-row {
      gap: 28px;
    }

    .magazine-small-grid {
      gap: 24px;
    }
  }
  .copyright-notice {
    margin-top: 48px;
    color: #666;
    font-size: 14px;
    text-align: center;
    line-height: 1.8;
    padding: 20px;
    background: #f9f9f9;
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.06);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  body.dark-mode .copyright-notice {
    color: #cccccc;
    background: #1a1a1a;
    border-color: rgba(255,255,255,0.12);
  }

  .share-section {
    max-width: 800px;
    margin: 48px auto;
    padding: 24px;
    background: transparent;
    border-radius: 12px;
    border: none;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  body.dark-mode .share-section {
    background: transparent;
    border-color: transparent;
  }

  .share-title {
    font-size: 18px;
    font-weight: 800;
    color: #111;
    margin: 0;
  }

  body.dark-mode .share-title {
    color: #f5f5f5;
  }

  .share-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  .share-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    color: #fff;
  }

  .share-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .share-btn:active {
    transform: translateY(1px);
  }

  .share-btn.facebook {
    background: #1877f2;
  }

  .share-btn.twitter {
    background: #1da1f2;
  }

  .share-btn.kakao {
    background: #fee500;
    color: #000;
  }

  .share-btn.link {
    background: #666;
  }

  .share-btn svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }

  /* 수정됨: 모바일 공유 버튼 왼쪽 하단 정렬로 디자인 변경 */
  @media (max-width: 680px) {
    .share-section {
      padding: 20px;
      margin: 32px auto;
      align-items: flex-start;
    }

    .share-title {
      text-align: left;
    }

    .share-buttons {
      width: 100%;
      justify-content: flex-start;
      gap: 12px;
    }

    .share-btn {
      flex: 0 0 auto;
      min-width: 48px;
      width: 48px;
      height: 48px;
      padding: 12px;
      justify-content: center;
    }
  }
  
  /* 검색 결과 스타일 개선 */
  #searchLoading {
    text-align: center;
    margin: 24px 0;
    color: #000;
  }
  
  body.dark-mode #searchLoading {
    color: #fff;
  }
  
  #searchResults .card h3,
  #searchResults .card .meta,
  #searchResults .card p {
    color: #000;
  }
  
  body.dark-mode #searchResults .card h3,
  body.dark-mode #searchResults .card .meta,
  body.dark-mode #searchResults .card p {
    color: #fff;
  }
  
  /* 워드프레스 갤러리 슬라이더 스타일 */
  .wp-gallery-slider {
    position: relative;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    border-radius: 12px;
    margin: 32px 0;
    background: #f5f5f5;
    /* 높이는 JavaScript로 동적 설정 */
  }
  
  body.dark-mode .wp-gallery-slider {
    background: #1a1a1a;
  }
  
  .wp-gallery-slider-track {
    display: flex;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: grab;
    width: 100%;
    height: 100%;
  }
  
  .wp-gallery-slider-track:active {
    cursor: grabbing;
  }
  
  .wp-gallery-slider-slide {
    min-width: 100%;
    width: 100%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }
  
  .wp-gallery-slider-slide img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    display: block;
    object-fit: contain;
    margin: 0 auto !important;
    border-radius: 0 !important;
  }
  
  /* 모바일 최적화 */
  @media (max-width: 768px) {
    .wp-gallery-slider {
      margin: 20px 0;
      border-radius: 8px;
    }
    
    .wp-gallery-slider-slide img {
      max-width: 100%;
      max-height: 100%;
    }
  }
  
  .wp-gallery-slider-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
  }
  
  .wp-gallery-slider-nav:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-50%) scale(1.1);
  }
  
  .wp-gallery-slider-nav.prev {
    left: 16px;
  }
  
  .wp-gallery-slider-nav.next {
    right: 16px;
  }
  
  .wp-gallery-slider-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  
  .wp-gallery-slider-dots {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
  }
  
  .wp-gallery-slider-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
  }
  
  .wp-gallery-slider-dot.active {
    background: white;
    width: 24px;
    border-radius: 4px;
  }
  
  .wp-gallery-slider-counter {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    z-index: 10;
  }
  
  @media (max-width: 768px) {
    .wp-gallery-slider-nav {
      width: 40px;
      height: 40px;
      font-size: 20px;
    }
    
    .wp-gallery-slider-nav.prev {
      left: 8px;
    }
    
    .wp-gallery-slider-nav.next {
      right: 8px;
    }
  }
  </style>
  
  <!-- ⚡ 성능 최적화: 리소스 우선순위 힌트 -->
  <link rel="preload" as="image" href="/logo.png" type="image/png">
</head>
<body>
  <!-- ⚡ 성능 최적화: 초기 로딩 스크립트 -->
  <script>
    // 페이지 로드 시간 측정
    window.performanceMetrics = {
      start: performance.now(),
      fcp: 0,
      lcp: 0
    };
    
    // PerformanceObserver 안전하게 사용 (네이버 웨일 등 호환성 개선)
    try {
      if (typeof PerformanceObserver !== 'undefined' && PerformanceObserver.supportedEntryTypes) {
        // First Contentful Paint 감지
        if (PerformanceObserver.supportedEntryTypes.includes('paint')) {
          new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              if (entry.name === 'first-contentful-paint') {
                window.performanceMetrics.fcp = entry.startTime;
                
              }
            }
          }).observe({ entryTypes: ['paint'] });
        }
        
        // Largest Contentful Paint 감지
        if (PerformanceObserver.supportedEntryTypes.includes('largest-contentful-paint')) {
          new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastEntry = entries[entries.length - 1];
            window.performanceMetrics.lcp = lastEntry.startTime;
            
          }).observe({ entryTypes: ['largest-contentful-paint'] });
        }
        
        // Cumulative Layout Shift 감지
        if (PerformanceObserver.supportedEntryTypes.includes('layout-shift')) {
          let clsScore = 0;
          new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              if (!entry.hadRecentInput) {
                clsScore += entry.value;
                
              }
            }
          }).observe({ entryTypes: ['layout-shift'] });
        }
      }
    } catch (e) {
      
    }
  </script>
  
  <div class="page-transition" id="pageTransition"></div>
  <div class="progress-bar" id="progressBar"></div>
  <header class="header" id="siteHeader">
    <div class="header-inner wrap">
      <div class="brand">
        <div class="logo" id="logoBtn" onclick="goToHome()">
          <img src="/logo.png" alt="IMPACT logo" width="36" height="36" style="width:36px;height:36px;border-radius:8px;object-fit:cover;" fetchpriority="high">
          <div class="logo-text">
            <div class="main-text">IMPACT</div>
            <small>MAKE A IMPACT</small>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn icon-btn" id="topSearchBtn" onclick="openNavlessSearch()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
        </button>
        <button class="btn icon-btn" onclick="ui.toggleNav()">☰</button>
      </div>
    </div>
  </header>

  <div class="post-header-bar" id="postHeaderBar">
    <div class="header-inner wrap">
      <div class="brand">
        <div class="logo" onclick="goToHome()">
          <img src="/logo.png" alt="IMPACT logo" style="width:36px;height:36px;border-radius:8px;object-fit:cover;">
          <div class="logo-text">
            <div class="main-text">IMPACT</div>
            <small>MAKE A IMPACT</small>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn icon-btn" onclick="handleNavToggle()">☰</button>
      </div>
    </div>
  </div>
  <aside class="nav-overlay" id="navOverlay">
    <button class="nav-close" onclick="ui.toggleNav(true)">✕</button>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div class="nav-search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <input type="search" id="globalNavSearch" placeholder="검색어 입력">
      </div>
      <ul class="nav-list" id="navList"></ul>
      <div class="nav-footer-links">
        <a href="javascript:void(0)" onclick="handleNavAction(() => router.openAbout())">ABOUT</a>
        <a href="javascript:void(0)" onclick="handleNavAction(() => router.openEditors())">EDITORS</a>
        <a href="javascript:void(0)" onclick="ui.toggleNav(true); window.open('https://impactceo.art/newsletter', '_blank')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>
    </div>
  </aside>
  <main class="home" id="home">
    <!-- Skeleton UI for initial loading - Matches real layout -->
    <div id="skeletonUI" class="skeleton-container">
      <!-- First group: 1 large + 4 small -->
      <div class="skeleton-row">
        <!-- Large post -->
        <div class="skeleton-large-card">
          <div class="skeleton-large-image"></div>
          <div class="skeleton-large-overlay">
            <div class="skeleton-large-title"></div>
            <div class="skeleton-large-meta"></div>
          </div>
        </div>
        <!-- Small posts 2x2 grid -->
        <div class="skeleton-small-grid">
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- Second group: 1 large + 4 small (reversed on desktop only) -->
      <div class="skeleton-row skeleton-reverse">
        <!-- Small posts 2x2 grid -->
        <div class="skeleton-small-grid">
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
          <div class="skeleton-card">
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-title"></div>
              <div class="skeleton-text"></div>
              <div class="skeleton-meta"></div>
            </div>
          </div>
        </div>
        <!-- Large post -->
        <div class="skeleton-large-card">
          <div class="skeleton-large-image"></div>
          <div class="skeleton-large-overlay">
            <div class="skeleton-large-title"></div>
            <div class="skeleton-large-meta"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="rowsContainer"></div>
    <div id="homeLoading" style="text-align:center;color:#666;padding:36px 0">로딩 중...</div>
    <div class="pagination" id="homePagination"></div>
  </main>
  <section class="category-overlay" id="categoryOverlay">
    <div class="wrap">
      <div class="category-top">
        <div>
          <div class="category-title" id="categoryOverlayTitle">CATEGORY</div>
          <div class="category-sub" id="categoryOverlaySubtitle">카테고리 설명</div>
        </div>
        <div>
          <button class="btn" onclick="router.closeCategory()">✕</button>
        </div>
      </div>
      <div class="category-grid" id="categoryGrid"></div>
      <div id="categoryLoading" style="text-align:center;color:#666;padding:28px 0"></div>
      <div class="pagination" id="categoryPagination"></div>
    </div>
  </section>
  <section class="editors-overlay" id="editorsOverlay">
    <div class="wrap">
      <div class="page-header">
        <div>
          <h2>EDITORS</h2>
          <div style="color:#666;font-size:14px;margin-top:8px">IMPACT에 참여하는 에디터 목록과 각 에디터의 작성 글을 확인할 수 있습니다.</div>
        </div>
        <div>
          <button class="btn" onclick="router.closeEditors()">✕</button>
        </div>
      </div>
      <div id="editorsGridWrapper">
        <div id="editorsGrid" class="editors-grid"></div>
        <div id="editorsLoading" style="text-align:center;color:#666;padding:28px 0"></div>
      </div>
      <div id="editorProfileSection" style="display:none">
        <button class="btn" onclick="showEditorsList()" style="margin-bottom:20px">← 에디터 목록으로</button>
        <h3 id="editorProfileName" style="font-size:28px;margin:0 0 12px"></h3>
        <p id="editorProfileBio" style="color:#666;margin-bottom:32px"></p>
        <div id="editorPostsGrid" class="category-grid"></div>
        <div id="editorPostsLoading" style="text-align:center;color:#666;padding:28px 0"></div>
      </div>
    </div>
  </section>
  <section class="search-overlay" id="searchOverlay">
    <div class="wrap" style="max-width:1200px">
      <div style="margin-bottom:32px">
        <div class="search-bar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width:20px;height:20px;fill:currentColor;">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          <input type="search" id="searchInput" placeholder="검색어를 입력하세요" autofocus>
          <button class="close-btn" onclick="closeSearch()">✕</button>
        </div>
        <div id="searchLoading" style="text-align:center;padding:20px 0;font-size:24px;font-weight:700;min-height:60px"></div>
      </div>
      <div id="searchResults" class="category-grid"></div>
      <div id="searchPagination" style="width:100%;display:flex;justify-content:center;"></div>
    </div>
  </section>
  <section class="about-page" id="aboutPage">
    <div class="wrap">
      <div class="page-header">
        <h2>ABOUT</h2>
        <button class="btn" onclick="router.closeAbout()">✕</button>
      </div>
      <div style="line-height:1.9;color:#444">
        <p style="font-size:22px;margin-bottom:16px;font-weight:700;color:#ff6b35">IMPACT MAGAZINE.</p>
        <p style="font-size:17px;margin-bottom:32px;font-weight:500;color:#333">임팩트 매거진은 사회적 이슈와 기술 변화를 분석해 일상의 문제를 발견하고 그 본질을 탐구하는 플랫폼입니다.</p>
        <p style="font-size:16px;margin-bottom:48px;color:#555">청년 창업가 인터뷰와 사회혁신 사례를 통해 문제를 기회로 전환하는 통찰을 제시하는 <span style="background:linear-gradient(to top, #ff6b35 40%, transparent 40%);padding:2px 4px;font-weight:600">'이슈 기반 인사이트 매거진'</span>입니다.</p>

        <p style="margin-top:48px"><strong>made by KAIST IP-CEO & POSTECH CEO</strong></p>

        <div style="margin-top:80px;margin-bottom:80px;border-top:1px solid #e0e0e0;padding-top:60px">
          <h3 style="font-size:20px;margin-bottom:8px;color:#333;font-weight:600">Our Journey</h3>
          <p style="font-size:14px;margin-bottom:48px;color:#999">2025-2029 성장 로드맵</p>

          <div style="position:relative">
            <div class="roadmap-timeline">
              <div class="roadmap-item" style="opacity:0;transform:translateX(-30px);animation:slideIn 0.6s ease forwards;animation-delay:0.2s">
                <div style="display:flex;align-items:center;margin-bottom:32px">
                  <div style="min-width:80px">
                    <span style="font-size:24px;font-weight:700;color:#ff6b35">2025</span>
                  </div>
                  <div style="flex:1;padding-left:24px;border-left:3px solid #ff6b35">
                    <h4 style="font-size:16px;font-weight:600;color:#333;margin-bottom:6px">커뮤니티 기반 구축</h4>
                    <p style="font-size:14px;color:#777;line-height:1.5">First Impact — 브랜드 보이스 확립 및 공식 채널 런칭</p>
                  </div>
                </div>
              </div>

              <div class="roadmap-item" style="opacity:0;transform:translateX(-30px);animation:slideIn 0.6s ease forwards;animation-delay:0.4s">
                <div style="display:flex;align-items:center;margin-bottom:32px">
                  <div style="min-width:80px">
                    <span style="font-size:24px;font-weight:700;color:#888">2026</span>
                  </div>
                  <div style="flex:1;padding-left:24px;border-left:3px solid #ddd">
                    <h4 style="font-size:16px;font-weight:600;color:#333;margin-bottom:6px">콘텐츠 참여도 증대</h4>
                    <p style="font-size:14px;color:#777;line-height:1.5">Second Impact — 정기 메일링 서비스를 통한 큐레이션 콘텐츠 전달</p>
                  </div>
                </div>
              </div>

              <div class="roadmap-item" style="opacity:0;transform:translateX(-30px);animation:slideIn 0.6s ease forwards;animation-delay:0.6s">
                <div style="display:flex;align-items:center;margin-bottom:32px">
                  <div style="min-width:80px">
                    <span style="font-size:24px;font-weight:700;color:#888">2027</span>
                  </div>
                  <div style="flex:1;padding-left:24px;border-left:3px solid #ddd">
                    <h4 style="font-size:16px;font-weight:600;color:#333;margin-bottom:6px">사업 확장 기반 마련</h4>
                    <p style="font-size:14px;color:#777;line-height:1.5">Third Impact — 오피스 개소 및 프로젝트 협업 허브 구축</p>
                  </div>
                </div>
              </div>

              <div class="roadmap-item" style="opacity:0;transform:translateX(-30px);animation:slideIn 0.6s ease forwards;animation-delay:0.8s">
                <div style="display:flex;align-items:center;margin-bottom:32px">
                  <div style="min-width:80px">
                    <span style="font-size:24px;font-weight:700;color:#888">2028</span>
                  </div>
                  <div style="flex:1;padding-left:24px;border-left:3px solid #ddd">
                    <h4 style="font-size:16px;font-weight:600;color:#333;margin-bottom:6px">운영 효율 극대화</h4>
                    <p style="font-size:14px;color:#777;line-height:1.5">Fourth Impact — AI 기반 콘텐츠 제작 및 분석 시스템 구축</p>
                  </div>
                </div>
              </div>

              <div class="roadmap-item" style="opacity:0;transform:translateX(-30px);animation:slideIn 0.6s ease forwards;animation-delay:1s">
                <div style="display:flex;align-items:center;margin-bottom:32px">
                  <div style="min-width:80px">
                    <span style="font-size:24px;font-weight:700;color:#888">2029</span>
                  </div>
                  <div style="flex:1;padding-left:24px;border-left:3px solid #ddd">
                    <h4 style="font-size:16px;font-weight:600;color:#333;margin-bottom:6px">미션 확장</h4>
                    <p style="font-size:14px;color:#777;line-height:1.5">Fifth Impact — Factalk 런칭, Dream·Design·Do 미션 확장</p>
                  </div>
                </div>
              </div>
            </div>

            <p style="margin-top:32px;font-size:16px;color:#333;font-weight:700;padding:16px 20px;background:linear-gradient(to right, rgba(255,107,53,0.1), transparent);border-left:4px solid #ff6b35">
              → <span style="background:linear-gradient(to top, #ff6b35 35%, transparent 35%);padding:2px 0">기술과 사람을 연결하는 지속가능한 영향력 창출</span>
            </p>
          </div>
        </div>

        <h3 style="margin-top:48px;font-size:24px">IMPACT 공식 계정</h3>
        <p>광고 문의: <a href="/cdn-cgi/l/email-protection#74031118171b1911341d190415170017111b5a150600" style="color:#ff6b35;font-weight:700"><span class="__cf_email__" data-cfemail="384f5d545b57555d78515548595b4c5b5d5716594a4c">[email&#160;protected]</span></a></p>
        <p>뉴스레터: <a href="/cdn-cgi/l/email-protection#b2c2c0d7c1c1f2dbdfc2d3d1c6d1d7dd9cd3c0c6" style="color:#ff6b35;font-weight:700"><span class="__cf_email__" data-cfemail="3b4b495e48487b52564b5a584f585e54155a494f">[email&#160;protected]</span></a></p>
        <p>공식 계정: <a href="/cdn-cgi/l/email-protection#3b585e547b52564b5a584f585e54155a494f" style="color:#ff6b35;font-weight:700"><span class="__cf_email__" data-cfemail="3152545e71585c4150524552545e1f504345">[email&#160;protected]</span></a></p>
        <p>Instagram: <a href="https://www.instagram.com/ceo_impact_official" target="_blank" style="color:#ff6b35;font-weight:700">@ceo_impact_official</a></p>
      </div>
    </div>
  </section>

  <section class="post-overlay" id="postOverlay">
    <div class="post-article" id="postArticle">
    </div>
  </section>

  <div class="image-modal" id="imageModal">
    <button class="image-modal-close" onclick="closeImageModal()">✕</button>
    <img id="modalImage" src="" alt="확대 이미지">
  </div>

  <button class="to-top" id="toTopBtn" onclick="scrollToTopButton()">↑</button>
  <button class="post-to-top" id="postToTopBtn" onclick="scrollToTopButton()">↑</button>

  <footer class="site-footer">
    <div class="wrap footer-inner">
      <div>
        <div class="footer-brand">IMPACT</div>
        <div style="margin-top:12px;color:#ddd;font-size:14px">광고 문의 | <a href="/cdn-cgi/l/email-protection#1e697b727d71737b5e77736e7f7d6a7d7b71307f6c6a"><span class="__cf_email__" data-cfemail="3740525b54585a52775e5a4756544354525819564543">[email&#160;protected]</span></a></div>
        <div style="color:#ddd;font-size:14px;margin-top:8px">뉴스레터 | <a href="/cdn-cgi/l/email-protection#78080a1d0b0b38111508191b0c1b1d1756190a0c"><span class="__cf_email__" data-cfemail="562624332525163f3b2637352235333978372422">[email&#160;protected]</span></a></div>
        <div style="color:#ddd;font-size:14px;margin-top:8px">공식 계정 | <a href="/cdn-cgi/l/email-protection#ea898f85aa83879a8b899e898f85c48b989e"><span class="__cf_email__" data-cfemail="7112141e31181c0110120512141e5f100305">[email&#160;protected]</span></a></div>
      </div>
      <div class="footer-links">
        <a href="javascript:void(0)" onclick="router.openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="router.openEditors()">EDITORS</a>
        <a href="javascript:void(0)" onclick="window.open('https://impactceo.art/newsletter', '_blank')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>
      <div class="footer-right">
        <div style="font-weight:800;color:#fff;margin-bottom:16px">IMPACT CEO. ALL RIGHTS RESERVED.</div>
        <div class="theme-toggle">
          <div class="theme-toggle-label">THEME</div>
          <div class="theme-switch" onclick="toggleTheme()">
            <div class="theme-switch-text">
              <span class="light-text">LIGHT</span>
              <span class="dark-text">DARK</span>
            </div>
            <div class="theme-switch-slider"></div>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <template id="cardTpl">
    <article class="card">
      <div class="thumb"><img src="" alt=""></div>
      <div class="card-body">
        <div class="cat-row"></div>
        <h3 class="title"></h3>
        <div class="meta">
          <img class="author-avatar" src="" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
          <div>
            <div class="author-name"></div>
            <div class="date" style="font-size:12px;color:#777"></div>
          </div>
        </div>
      </div>
    </article>
  </template>
  <template id="editorTpl">
    <div class="editor-card">
      <img class="editor-avatar" src="" alt="">
      <div class="editor-name"></div>
      <div class="editor-bio"></div>
    </div>
  </template>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
const WP_SITE = "impactceo0.wordpress.com";
const HOME_PER_PAGE = 20;
const CATEGORIES = {
  "tech": 318,
  "eat": 123073,
  "style": 2286,
  "culture": 1098,
  "life": 124,
  "editors-pick": 259543
};
const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];
const state = {
  homePage: 1,
  homeTotal: 0,
  allPostsCount: 0, // 전체 게시물 수 저장
  categoryPage: 1,
  categoryTotal: 0,
  currentCategory: '',
  postsCache: {},
  editorsList: [],
  editorsLoaded: false,
  lastScrollY: 0,
  scrollingDown: false,
  currentPostId: null,
  isProcessing: false,
  searchDebounce: null,
  homeLoadPromise: null,
  initialScrollDone: {}, // 각 오버레이별 초기 스크롤 완료 여부
  scrollListeners: {}, // 스크롤 리스너 저장
  cacheExpiry: 1000 * 60 * 10 // 캐시 만료 시간: 10분
};

// ⚡ 성능 최적화: localStorage 캐싱 함수
function getCachedData(key) {
  try {
    const cached = localStorage.getItem(key);
    if (!cached) return null;
    
    const data = JSON.parse(cached);
    if (Date.now() - data.timestamp > state.cacheExpiry) {
      localStorage.removeItem(key);
      return null;
    }
    return data.value;
  } catch (e) {
    return null;
  }
}

function setCachedData(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify({
      value: value,
      timestamp: Date.now()
    }));
  } catch (e) {
    // localStorage 초과 시 무시
    console.warn('localStorage full, skipping cache');
  }
}

// [IMPACT-LOADING] A. Loading overlay controller (replaces showPageTransition)
let __loadingTimer = null;
let __loadingDelayTimer = null;
let __loadingStartTime = null;

function openLoading(label = '불러오는 중...', delay = 150) {
  const el = document.getElementById('pageTransition');
  if (!el) return;
  
  // 기존 타이머 정리
  clearTimeout(__loadingDelayTimer);
  clearTimeout(__loadingTimer);
  
  // 시작 시간 기록
  __loadingStartTime = Date.now();
  
  // delay 밀리초 후에만 로딩 표시 (기본 150ms로 개선)
  __loadingDelayTimer = setTimeout(() => {
    el.textContent = label;
    el.classList.add('active');
    
    // 안전장치: 표시된 후 5초 뒤 강제 해제
    __loadingTimer = setTimeout(() => closeLoading(), 5000);
  }, delay);
}

function closeLoading() {
  const el = document.getElementById('pageTransition');
  if (!el) return;
  
  // 지연 타이머가 아직 실행 안됐으면 취소
  clearTimeout(__loadingDelayTimer);
  clearTimeout(__loadingTimer);
  
  // 로딩이 실제로 표시됐으면 숨김
  el.classList.remove('active');
  
  __loadingDelayTimer = null;
  __loadingTimer = null;
  __loadingStartTime = null;
}

// 스크롤 상단 세팅 헬퍼: 오버레이/페이지 컨테이너 모두 대응
// 수정됨: 초기 스크롤만 실행하고 이후 사용자 스크롤 유지
function resetScrollTop(target = 'window', force = false) {
  // force가 true이거나 초기 스크롤이 아직 완료되지 않은 경우만 스크롤
  if (target === 'post') {
    const o = document.getElementById('postOverlay');
    if (o) {
      if (force || !state.initialScrollDone['post']) {
        o.scrollTop = 0; // 즉시 상단으로 이동 (애니메이션 없이)
        state.initialScrollDone['post'] = true;
        
        // 사용자가 스크롤하기 시작하면 초기 스크롤 플래그 유지 (추가 강제 스크롤 방지)
        if (!state.scrollListeners['post']) {
          const scrollHandler = () => {
            state.initialScrollDone['post'] = true;
          };
          o.addEventListener('scroll', scrollHandler, { passive: true });
          state.scrollListeners['post'] = scrollHandler;
        }
      }
    }
  } else if (target === 'category') {
    const o = document.getElementById('categoryOverlay');
    if (o && (force || !state.initialScrollDone['category'])) {
      o.scrollTop = 0;
      state.initialScrollDone['category'] = true;
    }
  } else if (target === 'editors') {
    const o = document.getElementById('editorsOverlay');
    if (o && (force || !state.initialScrollDone['editors'])) {
      o.scrollTop = 0;
      state.initialScrollDone['editors'] = true;
    }
  } else if (target === 'search') {
    const o = document.getElementById('searchOverlay');
    if (o && (force || !state.initialScrollDone['search'])) {
      o.scrollTop = 0;
      state.initialScrollDone['search'] = true;
    }
  } else if (target === 'about') {
    const o = document.getElementById('aboutPage');
    if (o && (force || !state.initialScrollDone['about'])) {
      o.scrollTop = 0;
      state.initialScrollDone['about'] = true;
    }
  } else {
    window.scrollTo(0, 0); // 즉시 상단으로 이동 (수정: scrollTop -> scrollTo)
  }
}

// 렌더 프레임 동기화를 위한 작은 헬퍼
function nextFrame() {
  return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
}

// Netlify Functions를 통한 WordPress API 호출 - 최적화: 필요할 때만 _embed
function api(path, includeEmbed = false) {
  let p = path;
  if (includeEmbed && !path.includes('_embed')) {
    p = path + (path.includes('?') ? '&' : '?') + '_embed';
  }
  
  // Netlify Functions를 통한 프록시만 사용 (CORS 문제 해결)
  return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`;
}

// Netlify Functions를 통해 전체 게시물 수를 가져오는 헬퍼 함수
async function getTotalPostsCount() {
  
  
  try {
    // Netlify Functions를 통한 호출 (per_page=1로 최소 데이터만, _embed 불필요)
    const proxyUrl = api('posts?per_page=1&page=1', false);
    
    const res = await fetch(proxyUrl);
    
    const totalFromProxy = parseInt(res.headers.get('X-WP-Total') || '0');
    const totalPagesFromProxy = parseInt(res.headers.get('X-WP-TotalPages') || '0');
    
    
    
    if(totalFromProxy > 0) {
      return {
        total: totalFromProxy,
        totalPages: Math.ceil(totalFromProxy / HOME_PER_PAGE)
      };
    }
    
    // 헤더가 없으면 응답 본문 확인
    const data = await res.json();
    
    
    if(Array.isArray(data) && data.length > 0) {
      
      return {
        total: 1,
        totalPages: 1
      };
    }
  } catch(e) {
    console.error('  → Netlify Functions 호출 실패:', e);
  }
  
  
  return null;
}
function formatDate(dstr) {
  try {
    const d = new Date(dstr);
    return `${d.getFullYear()}. ${String(d.getMonth()+1).padStart(2,'0')}. ${String(d.getDate()).padStart(2,'0')}.`;
  } catch(e) { return ''; }
}
function placeholderDataURI(w=600,h=400,txt='No Image') {
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='#efefef'/><text x='50%' y='50%' fill='#aaa' font-size='20' text-anchor='middle' dominant-baseline='middle'>${txt}</text></svg>`;
  return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
}
function pickCategoryClass(nameOrSlug) {
  if(!nameOrSlug) return '';
  const s = String(nameOrSlug).toLowerCase();
  if(s.includes('tech') || s.includes('technology')) return 'cat-tech';
  if(s.includes('eat')) return 'cat-eat';
  if(s.includes('style')) return 'cat-style';
  if(s.includes('culture')) return 'cat-culture';
  if(s.includes('life')) return 'cat-life';
  if(s.includes('editor') || s.includes('editors')) return 'cat-editors-pick';
  return '';
}
function stripTags(str='') {
  return str.replace(/<\/?[^>]+(>|$)/g, "");
}

// OG 메타태그 업데이트 함수
function updateMetaTags(data) {
  const defaults = {
    title: 'IMPACT – MAKE A IMPACT',
    description: 'Innovation Management Passion Acceleration Creativity Technology',
    image: `${window.location.origin}/logo.png`,
    url: window.location.href,
    type: 'website'
  };
  
  const metaData = { ...defaults, ...data };
  
  // Document title
  document.title = metaData.title;
  
  // Description
  const metaDesc = document.getElementById('metaDescription');
  if(metaDesc) metaDesc.setAttribute('content', metaData.description);
  
  // Open Graph
  const ogType = document.getElementById('ogType');
  if(ogType) ogType.setAttribute('content', metaData.type);
  
  const ogUrl = document.getElementById('ogUrl');
  if(ogUrl) ogUrl.setAttribute('content', metaData.url);
  
  const ogTitle = document.getElementById('ogTitle');
  if(ogTitle) ogTitle.setAttribute('content', metaData.title);
  
  const ogDescription = document.getElementById('ogDescription');
  if(ogDescription) ogDescription.setAttribute('content', metaData.description);
  
  const ogImage = document.getElementById('ogImage');
  if(ogImage) ogImage.setAttribute('content', metaData.image);
  
  // Twitter
  const twitterUrl = document.getElementById('twitterUrl');
  if(twitterUrl) twitterUrl.setAttribute('content', metaData.url);
  
  const twitterTitle = document.getElementById('twitterTitle');
  if(twitterTitle) twitterTitle.setAttribute('content', metaData.title);
  
  const twitterDescription = document.getElementById('twitterDescription');
  if(twitterDescription) twitterDescription.setAttribute('content', metaData.description);
  
  const twitterImage = document.getElementById('twitterImage');
  if(twitterImage) twitterImage.setAttribute('content', metaData.image);
  
  // Canonical URL
  const canonicalUrl = document.getElementById('canonicalUrl');
  if(canonicalUrl) canonicalUrl.setAttribute('href', metaData.url);
}

// JSON-LD 구조화된 데이터 업데이트 함수 (SEO 최적화)
function updateStructuredData(data) {
  // 기존 JSON-LD 제거
  const existingScript = document.querySelector('script[type="application/ld+json"]');
  if(existingScript) {
    existingScript.remove();
  }
  
  // 새 JSON-LD 추가 (데이터가 있을 때만)
  if(data) {
    const script = document.createElement('script');
    script.type = 'application/ld+json';
    script.textContent = JSON.stringify(data);
    document.head.appendChild(script);
  }
}

function scrollToTop() {
  window.scrollTo({top: 0, behavior: 'smooth'});
}
function scrollToTopButton() {
  const postOverlay = document.getElementById('postOverlay');
  if(postOverlay.classList.contains('active')) {
    postOverlay.scrollTo({top: 0, behavior: 'smooth'});
  } else {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
}
function toggleTheme() {
  // transition 일시적으로 비활성화
  document.body.style.transition = 'none';
  
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  
  // About 페이지의 Our Journey 부분 강제 리플로우로 즉시 스타일 반영
  const aboutPage = document.getElementById('aboutPage');
  if(aboutPage && aboutPage.classList.contains('active')) {
    // 강제 리플로우 트리거
    void aboutPage.offsetHeight;
    
    // Our Journey 섹션의 모든 요소에 강제 스타일을 직접 적용
    const isDark = document.body.classList.contains('dark-mode');
    
    // 일반 텍스트 요소들
    const textElements = aboutPage.querySelectorAll('p, h3, h4, div');
    textElements.forEach(el => {
      const currentColor = el.style.color;
      if(currentColor && currentColor !== '' && currentColor !== 'rgb(255, 107, 53)' && currentColor !== '#ff6b35' && currentColor !== '#ff8c5a' && !currentColor.includes('gradient')) {
        if(isDark) {
          if(currentColor === '#333' || currentColor === 'rgb(51, 51, 51)') {
            el.style.color = '#e8e8e8';
          } else if(currentColor === '#444' || currentColor === 'rgb(68, 68, 68)') {
            el.style.color = '#e8e8e8';
          } else if(currentColor === '#555' || currentColor === 'rgb(85, 85, 85)') {
            el.style.color = '#e8e8e8';
          } else if(currentColor === '#666' || currentColor === 'rgb(102, 102, 102)') {
            el.style.color = '#e8e8e8';
          } else if(currentColor === '#777' || currentColor === 'rgb(119, 119, 119)') {
            el.style.color = '#cccccc';
          } else if(currentColor === '#888' || currentColor === 'rgb(136, 136, 136)') {
            el.style.color = '#aaaaaa';
          } else if(currentColor === '#999' || currentColor === 'rgb(153, 153, 153)') {
            el.style.color = '#999999';
          }
        } else {
          // 라이트 모드로 복원
          if(el.dataset.originalColor) {
            el.style.color = el.dataset.originalColor;
          }
        }
      }
    });
    
    // roadmap-item의 span 요소들 (년도 표시)
    const roadmapSpans = aboutPage.querySelectorAll('.roadmap-item span');
    roadmapSpans.forEach(el => {
      const currentColor = el.style.color;
      if(currentColor && currentColor !== 'rgb(255, 107, 53)' && currentColor !== '#ff6b35') {
        if(isDark) {
          if(!el.dataset.originalColor) {
            el.dataset.originalColor = currentColor;
          }
          el.style.color = '#aaaaaa';
        } else {
          if(el.dataset.originalColor) {
            el.style.color = el.dataset.originalColor;
            delete el.dataset.originalColor;
          }
        }
      }
    });
    
    // border-top 색상 변경
    const borderDivs = aboutPage.querySelectorAll('[style*="border-top"]');
    borderDivs.forEach(el => {
      if(isDark) {
        el.style.borderTopColor = 'rgba(255, 255, 255, 0.12)';
      } else {
        el.style.borderTopColor = '#e0e0e0';
      }
    });
    
    // border-left 색상 변경
    const borderLeftDivs = aboutPage.querySelectorAll('[style*="border-left"]');
    borderLeftDivs.forEach(el => {
      const currentBorder = el.style.borderLeft;
      if(currentBorder && currentBorder.includes('#ddd')) {
        if(isDark) {
          el.style.borderLeftColor = 'rgba(255, 255, 255, 0.12)';
        } else {
          el.style.borderLeftColor = '#ddd';
        }
      }
    });
  }
  
  // 다음 프레임에서 transition 복원
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      document.body.style.transition = '';
    });
  });
}

function goToHome() {
  const logo = document.getElementById('logoBtn');
  logo.classList.add('clicked');
  setTimeout(() => {
    logo.classList.remove('clicked');
  }, 200);

  // 게시물 오버레이가 열려있는 경우
  if(document.getElementById('postOverlay').classList.contains('active')) {
    const overlay = document.getElementById('postOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');
    
    // 메타태그 즉시 복원 (웨일 브라우저 호환성)
    document.title = 'IMPACT – MAKE A IMPACT';
    updateMetaTags({});
    updateStructuredData(null);
    
    // 메인 페이지로 URL 변경 (항상 루트 경로로)
    const newUrl = `${window.location.origin}/`;
    history.pushState({page:'home'}, '', newUrl);
    
    // 부드럽게 위로 스크롤
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // 홈 콘텐츠가 비어있으면 다시 로드
    const container = document.getElementById('rowsContainer');
    if(!container || container.children.length === 0) {
      state.homeLoadPromise = null;
      loadHomeChunk(state.homePage || 1);
    }
    return;
  }

  // 카테고리나 다른 오버레이가 열려있는 경우
  const overlays = document.querySelectorAll('.category-overlay, .search-overlay, .about-page, .editors-overlay');
  let anyOverlayActive = false;
  
  overlays.forEach(el => {
    if(el.classList.contains('active')) {
      anyOverlayActive = true;
      el.classList.remove('active');
    }
  });
  
  document.body.style.overflow = '';

  // 메타태그 즉시 복원 (웨일 브라우저 호환성)
  document.title = 'IMPACT – MAKE A IMPACT';
  updateMetaTags({});
  updateStructuredData(null);

  // URL을 홈으로 변경 (항상 루트 경로로)
  const newUrl = `${window.location.origin}/`;
  history.pushState({page:'home'}, '', newUrl);

  // 부드럽게 위로 스크롤 (오버레이가 있었든 없었든 항상 실행)
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // 홈 콘텐츠가 비어있으면 다시 로드
  const container = document.getElementById('rowsContainer');
  if(!container || container.children.length === 0) {
    state.homeLoadPromise = null;
    loadHomeChunk(state.homePage || 1);
  }
}

function handleNavToggle() {
  ui.toggleNav();
}
function handleNavAction(actionCallback) {
  ui.toggleNav(true);

  if(document.getElementById('postOverlay').classList.contains('active')) {
    const overlay = document.getElementById('postOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');
  }

  actionCallback();
}
if(localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark-mode');
}
let ticking = false;
window.addEventListener('scroll', () => {
  if(!ticking) {
    window.requestAnimationFrame(() => {
      const toTop = document.getElementById('toTopBtn');
      if(window.scrollY > 300) toTop.classList.add('show');
      else toTop.classList.remove('show');

      const header = document.getElementById('siteHeader');
      const currentScrollY = window.scrollY;

      if(currentScrollY > state.lastScrollY && currentScrollY > 100) {
        header.classList.add('hide');
      } else {
        header.classList.remove('hide');
      }

      state.lastScrollY = currentScrollY;

      ticking = false;
    });
    ticking = true;
  }
});
document.getElementById('postOverlay').addEventListener('scroll', () => {
  if(!ticking) {
    window.requestAnimationFrame(() => {
      const progressBar = document.getElementById('progressBar');
      const postOverlay = document.getElementById('postOverlay');
      const postHeaderBar = document.getElementById('postHeaderBar');
      const postToTopBtn = document.getElementById('postToTopBtn');
      const winScroll = postOverlay.scrollTop;
      const height = postOverlay.scrollHeight - postOverlay.clientHeight;
      const scrolled = height > 0 ? (winScroll / height) * 100 : 0;
      progressBar.style.width = scrolled + '%';
      progressBar.classList.add('active');

      if(winScroll > 20) {
        postHeaderBar.classList.add('show');
      } else {
        postHeaderBar.classList.remove('show');
      }

      if(winScroll > 300) {
        postToTopBtn.classList.add('show');
      } else {
        postToTopBtn.classList.remove('show');
      }

      const thumbnail = document.querySelector('.post-thumbnail');
      if(thumbnail && winScroll > 100) {
        thumbnail.classList.add('scrolled');
      } else if(thumbnail) {
        thumbnail.classList.remove('scrolled');
      }

      ticking = false;
    });
    ticking = true;
  }
});
function renderNavList() {
  const navList = document.getElementById('navList');
  navList.innerHTML = '';
  
  // 현재 페이지 경로 확인
  const currentPath = window.location.pathname;
  const urlParams = new URLSearchParams(window.location.search);
  const categoryParam = urlParams.get('category');
  
  NAV_ORDER.forEach(item => {
    const li = document.createElement('li');
    li.textContent = item;
    const slug = item.toLowerCase().replace(/'/g,'').replace(/\s/g,'-');
    
    // 현재 페이지인지 확인
    const isCurrentPage = (currentPath === `/category/${slug}`) || (categoryParam === slug);
    
    if(isCurrentPage) {
      // 현재 페이지는 주황색으로 표시하고 클릭 비활성화
      li.style.color = '#ff6b35';
      li.style.cursor = 'default';
      li.style.pointerEvents = 'none';
    } else {
      // 다른 페이지는 클릭 가능
      li.addEventListener('click', () => {
        if(CATEGORIES[slug]) {
          handleNavAction(() => router.openCategory(slug));
        }
      });
    }
    
    navList.appendChild(li);
  });
}
// ⚡ Image Optimization Helper
function optimizeImage(imgEl, thumbUrl, alt, priority = false) {
  if (!thumbUrl || thumbUrl.startsWith('data:')) {
    imgEl.src = thumbUrl || placeholderDataURI(1200, 800, 'No Image');
    imgEl.alt = alt;
    return;
  }
  
  // Generate responsive image sizes
  const sizes = [400, 800, 1200, 1600];
  const srcsetParts = sizes.map(size => {
    const url = new URL(thumbUrl);
    // WordPress image size parameters
    url.searchParams.set('w', size);
    return `${url.toString()} ${size}w`;
  }).join(', ');
  
  // Set srcset for responsive images
  if (srcsetParts) {
    imgEl.srcset = srcsetParts;
    imgEl.sizes = '(max-width: 768px) 100vw, (max-width: 1280px) 50vw, 33vw';
  }
  
  // Set loading priority
  if (priority) {
    imgEl.loading = 'eager';
    imgEl.fetchpriority = 'high';
    // Preload critical images
    const preloadLink = document.createElement('link');
    preloadLink.rel = 'preload';
    preloadLink.as = 'image';
    preloadLink.href = thumbUrl;
    if (srcsetParts) {
      preloadLink.imageSrcset = srcsetParts;
      preloadLink.imageSizes = imgEl.sizes;
    }
    document.head.appendChild(preloadLink);
  } else {
    imgEl.loading = 'lazy';
    imgEl.decoding = 'async';
  }
  
  imgEl.src = thumbUrl;
  imgEl.alt = alt;
}

function createCardNode(post, priority = false) {
  const tpl = document.getElementById('cardTpl');
  const node = tpl.content.firstElementChild.cloneNode(true);
  const imgEl = node.querySelector('.thumb img');
  let thumbUrl = '';
  try {
    thumbUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
  } catch(e) { thumbUrl = ''; }
  
  const alt = (post.title && post.title.rendered) ? stripTags(post.title.rendered) : 'thumb';
  optimizeImage(imgEl, thumbUrl, alt, priority);
  node.querySelector('.title').innerHTML = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
  const avatarImg = node.querySelector('.author-avatar');
  const authorNameEl = node.querySelector('.author-name');
  const dateEl = node.querySelector('.date');
  if(post._embedded && post._embedded.author && post._embedded.author[0]) {
    const a = post._embedded.author[0];
    const avatarUrl = a.avatar_urls ? (a.avatar_urls['48']||a.avatar_urls['24']||'') : '';
    avatarImg.src = avatarUrl || placeholderDataURI(96,96,'U');
    avatarImg.loading = 'lazy';
    avatarImg.decoding = 'async';
    avatarImg.alt = a.name || 'author';
    authorNameEl.textContent = a.name || '익명';
  } else {
    avatarImg.src = placeholderDataURI(96,96,'U');
    authorNameEl.textContent = '익명';
  }
  dateEl.textContent = formatDate(post.date);
  const catRow = node.querySelector('.cat-row');
  catRow.innerHTML = '';
  if(post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) {
    const cats = post._embedded['wp:term'][0];
    cats.forEach(c => {
      if(c && c.name) {
        const span = document.createElement('span');
        span.className = 'cat-badge';
        span.textContent = c.name;
        const cls = pickCategoryClass(c.slug || c.name);
        if(cls) span.classList.add(cls);
        else span.style.background = '#666';
        catRow.appendChild(span);
      }
    });
  }
  node.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if(state.isProcessing) return;
    // [IMPACT-LOADING] 클릭 즉시 로딩 표시 - 최적화: 지연 제거
    openLoading('게시물을 불러오는 중...');
    openPostOverlayById(post.id);
  });

  return node;
}
function renderMobileLayout(posts, container) {
  for(let i = 0; i < posts.length; i += 5) {
    const group = posts.slice(i, i + 5);
    const isFirstGroup = (i === 0); // Priority for first viewport

    if(group[0]) {
      const largeDiv = document.createElement('div');
      largeDiv.className = 'magazine-row mobile-large-post';
      
      const largeContainer = createLargePostElement(group[0], isFirstGroup);
      largeDiv.appendChild(largeContainer);
      container.appendChild(largeDiv);
    }

    const smallPosts = group.slice(1, 5);
    if(smallPosts.length > 0) {
      const smallDiv = document.createElement('div');
      smallDiv.className = 'magazine-row mobile-small-grid';

      const smallGrid = document.createElement('div');
      smallGrid.className = 'magazine-small-grid mobile-grid';

      smallPosts.forEach((post, idx) => {
        if(post) {
          // Priority for first few posts in viewport
          const priority = isFirstGroup && idx < 2;
          const card = createCardNode(post, priority);
          smallGrid.appendChild(card);
        }
      });

      smallDiv.appendChild(smallGrid);
      container.appendChild(smallDiv);
    }
  }
}
// 큰 게시물 생성 헬퍼 함수 (중복 제거)
function createLargePostElement(largePost, priority = false) {
  const largeDiv = document.createElement('div');
  largeDiv.className = 'magazine-large';

  let heroUrl = largePost._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
  const loadingAttr = priority ? 'eager' : 'lazy';
  const fetchPriorityAttr = priority ? ' fetchpriority="high"' : '';
  
  largeDiv.innerHTML = `
    <img class="hero" src="${heroUrl || placeholderDataURI(1200,800,'No Image')}" alt="hero" loading="${loadingAttr}"${fetchPriorityAttr} decoding="async">
    <div class="hero-overlay">
      <h2 class="hero-title">${largePost.title?.rendered || '제목 없음'}</h2>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="hero-author" style="font-weight:800;color:#fff">${largePost._embedded?.author?.[0]?.name || '익명'}</div>
        <div class="hero-date" style="color:#eee;opacity:.9">${formatDate(largePost.date)}</div>
      </div>
    </div>
  `;
  
  // Preload critical hero images
  if (priority && heroUrl && !heroUrl.startsWith('data:')) {
    const preloadLink = document.createElement('link');
    preloadLink.rel = 'preload';
    preloadLink.as = 'image';
    preloadLink.href = heroUrl;
    document.head.appendChild(preloadLink);
  }

  const catWrap = document.createElement('div');
  catWrap.className = 'hero-cats';
  const firstCat = largePost._embedded?.['wp:term']?.[0]?.[0];
  if(firstCat) {
    const span = document.createElement('span');
    span.className = 'cat-badge ' + pickCategoryClass(firstCat.slug || firstCat.name);
    span.textContent = firstCat.name;
    catWrap.appendChild(span);
  }
  largeDiv.appendChild(catWrap);

  largeDiv.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if(state.isProcessing) return;
    // 최적화: 지연 제거
    openLoading('게시물을 불러오는 중...');
    openPostOverlayById(largePost.id);
  });

  return largeDiv;
}

// 아이패드 세로모드 전용 렌더링 함수
function renderIpadPortraitLayout(posts, container) {
  for(let i = 0; i < posts.length; i += 5) {
    const group = posts.slice(i, i + 5);
    const isFirstGroup = (i === 0);
    
    // 첫 번째 게시물 - 큰 게시물
    if(group[0]) {
      const largeDiv = document.createElement('div');
      largeDiv.className = 'magazine-row';
      largeDiv.style.gridTemplateColumns = '1fr';
      
      const largeContainer = createLargePostElement(group[0], isFirstGroup);
      largeDiv.appendChild(largeContainer);
      container.appendChild(largeDiv);
    }
    
    // 2-5번째 게시물 - 작은 게시물 2x2 그리드
    const smallPosts = group.slice(1, 5);
    if(smallPosts.length > 0) {
      const smallDiv = document.createElement('div');
      smallDiv.className = 'magazine-row';
      smallDiv.style.gridTemplateColumns = '1fr';
      
      const smallGrid = document.createElement('div');
      smallGrid.className = 'magazine-small-grid';
      
      smallPosts.forEach((post, idx) => {
        if(post) {
          const priority = isFirstGroup && idx < 2;
          const card = createCardNode(post, priority);
          smallGrid.appendChild(card);
        }
      });
      
      smallDiv.appendChild(smallGrid);
      container.appendChild(smallDiv);
    }
  }
}

function renderDesktopLayout(posts, container) {
  for(let i = 0; i < posts.length; i += 5) {
    const group = posts.slice(i, i + 5);
    const row = document.createElement('div');
    row.className = 'magazine-row';

    const isEven = Math.floor(i / 5) % 2 === 0;
    const isFirstGroup = (i === 0);
    if(!isEven) {
      row.classList.add('reverse');
    }
    
    // 작은 게시물 그리드 생성
    const smallGrid = document.createElement('div');
    smallGrid.className = 'magazine-small-grid';
    group.slice(1, 5).forEach((post, idx) => {
      if(post) {
        const priority = isFirstGroup && idx < 3;
        const card = createCardNode(post, priority);
        smallGrid.appendChild(card);
      }
    });

    // 큰 게시물과 작은 게시물 순서 배치
    if(group[0]) {
      const largeDiv = createLargePostElement(group[0], isFirstGroup);
      
      if(isEven) {
        row.appendChild(largeDiv);
        row.appendChild(smallGrid);
      } else {
        row.appendChild(smallGrid);
        row.appendChild(largeDiv);
      }
    } else {
      row.appendChild(smallGrid);
    }
    
    container.appendChild(row);
  }
}
async function loadHomeChunk(page = 1) {
  if(state.isProcessing || state.homeLoadPromise) return state.homeLoadPromise;

  state.isProcessing = true;

  const loadingEl = document.getElementById('homeLoading');
  loadingEl.textContent = '로딩 중...';
  state.homeLoadPromise = new Promise(async (resolve, reject) => {
    try {
      // ⚡ 성능 최적화: 캐시 확인
      const cacheKey = `home_page_${page}`;
      const cachedPosts = getCachedData(cacheKey);
      
      let posts, totalPages, totalPosts;
      
      if (cachedPosts && Array.isArray(cachedPosts.posts)) {
        
        posts = cachedPosts.posts;
        totalPages = cachedPosts.totalPages || 1;
        totalPosts = cachedPosts.totalPosts || 0;
      } else {
        
        // 최적화: _embed는 필요할 때만 (홈에서는 미리 필요)
        const res = await fetch(api(`posts?per_page=${HOME_PER_PAGE}&page=${page}`, true));
        if(!res.ok) throw new Error('Failed to load');

        // 방법 1: 헤더에서 읽기 시도
        totalPages = parseInt(res.headers.get('X-WP-TotalPages') || '0');
        totalPosts = parseInt(res.headers.get('X-WP-Total') || '0');
        
        
        

        posts = await res.json();
        
        
        // 방법 2: 헤더가 없으면 전체 게시물 수로 계산
        if(totalPages === 0 && totalPosts > 0) {
          totalPages = Math.ceil(totalPosts / HOME_PER_PAGE);
          
        }
        
        // 방법 3: 헤더도 없고 totalPosts도 없으면, Netlify Functions로 재시도
        if(totalPages === 0) {
          
          const count = await getTotalPostsCount();
          
          if(count && count.totalPages > 0) {
            totalPages = count.totalPages;
            state.allPostsCount = count.total;
            
          }
        }
        
        // 방법 4: state에 저장된 값 사용
        if(totalPages === 0 && state.homeTotal > 0) {
          totalPages = state.homeTotal;
          
        }
        
        // 방법 5: 받은 게시물 개수로 추정 (최후의 수단)
        if(totalPages === 0 && Array.isArray(posts)) {
          if(posts.length === HOME_PER_PAGE) {
            // 20개 받았다면 최소 현재 페이지 + 1
            totalPages = page + 1;
            
          } else if(posts.length > 0) {
            // 20개 미만이면 현재가 마지막 페이지
            totalPages = page;
            
          } else {
            totalPages = Math.max(1, page - 1);
            
          }
        }
        
        // 최소값 보장
        if(totalPages === 0) totalPages = 1;
        
        // 현재 페이지가 totalPages보다 크면 조정
        if(page > totalPages) {
          console.warn('현재 페이지가 총 페이지보다 큼. 조정 필요');
          totalPages = page;
        }
        
        // ⚡ 성능 최적화: 캐시에 저장
        setCachedData(cacheKey, { posts, totalPages, totalPosts });
      }
      
      state.homeTotal = totalPages;
      

      if(!Array.isArray(posts) || posts.length === 0) {
        console.warn('게시물 없음 - 페이지:', page);
        
        // 페이지가 1이 아니면 1페이지로 리다이렉트
        if(page !== 1) {
          
          state.isProcessing = false;
          state.homeLoadPromise = null;
          return loadHomeChunk(1);
        }
        
        loadingEl.textContent = '게시물이 없습니다.';
        
        // 게시물이 없어도 페이지네이션은 표시 (비활성화 상태로)
        renderPagination('homePagination', page, totalPages, (p) => {
          openLoading('페이지를 불러오는 중...');
          state.homePage = p;
          state.homeLoadPromise = null;
          loadHomeChunk(p).then(() => {
            resetScrollTop('window');
            closeLoading();
          }).catch(() => {
            closeLoading();
          });
        });
        
        state.isProcessing = false;
        state.homeLoadPromise = null;
        resolve();
        return;
      }
      
      const uniquePosts = posts.filter((post, index, self) =>
        index === self.findIndex(p => p.id === post.id)
      );

      uniquePosts.forEach(p => state.postsCache[p.id] = p);
      const container = document.getElementById('rowsContainer');

      // ⚡ Remove skeleton UI when real content is ready
      const skeletonUI = document.getElementById('skeletonUI');
      if (skeletonUI) {
        skeletonUI.style.display = 'none';
      }

      // 페이지 전환 시 항상 기존 게시물 제거
      container.innerHTML = '';
      
      // ⚡ 홈 페이지 렌더링 후 즉시 프리페치 시작
      setTimeout(() => {
        prefetchVisiblePosts();
      }, 500);
      
      // 디바이스 타입 감지
      const isMobile = window.innerWidth <= 680;
      const isIpadPortrait = window.innerWidth > 680 && window.innerWidth <= 1100 && window.innerHeight > window.innerWidth;
      
      if(isMobile) {
        renderMobileLayout(uniquePosts, container);
      } else if(isIpadPortrait) {
        renderIpadPortraitLayout(uniquePosts, container);
      } else {
        renderDesktopLayout(uniquePosts, container);
      }
      
      // ⚡ 렌더링 완료 후 프리페치 트리거
      setTimeout(() => {
        prefetchVisiblePosts();
      }, 300);
      
      
      renderPagination('homePagination', page, totalPages, (p) => {
        // [IMPACT-LOADING] 페이지네이션 클릭 시 로딩 표시
        openLoading('페이지를 불러오는 중...');
        state.homePage = p;
        state.homeLoadPromise = null;
        loadHomeChunk(p).then(() => {
          resetScrollTop('window');
          closeLoading();
        }).catch(() => {
          closeLoading();
        });
      });
      loadingEl.textContent = '';
      resolve();
    } catch(err) {
      console.error('loadHomeChunk 에러:', err);
      loadingEl.textContent = '로딩 실패. 새로고침을 시도해주세요.';
      reject(err);
    } finally {
      state.isProcessing = false;
      state.homeLoadPromise = null;
    }
  });

  return state.homeLoadPromise;
}
function renderPagination(containerId, currentPage, totalPages, onPageClick) {
  const container = document.getElementById(containerId);
  if(!container) {
    console.error('페이지네이션 컨테이너를 찾을 수 없음:', containerId);
    return;
  }

  container.innerHTML = '';
  
  
  
  
  

  if(totalPages <= 0) {
    console.warn('totalPages가 0 이하입니다. 페이지네이션 표시 안함.');
    return;
  }
  
  // 현재 페이지를 숫자로 강제 변환
  currentPage = parseInt(currentPage) || 1;
  totalPages = parseInt(totalPages) || 1;
  
  // 현재 페이지가 범위를 벗어나면 조정
  if(currentPage < 1) currentPage = 1;
  if(currentPage > totalPages) currentPage = totalPages;

  // 이전 버튼
  const prevBtn = document.createElement('button');
  prevBtn.textContent = '«';
  prevBtn.disabled = currentPage === 1;
  if(currentPage > 1) {
    prevBtn.onclick = () => onPageClick(currentPage - 1);
  }
  container.appendChild(prevBtn);

  // 모바일 감지
  const isMobile = window.innerWidth <= 640;
  const maxVisible = isMobile ? 5 : 7;
  
  

  // 페이지 번호 계산
  const pages = calculatePageNumbers(currentPage, totalPages, maxVisible);
  
  

  if(!pages || pages.length === 0) {
    console.error('페이지 배열이 비어있습니다!');
    // 최소한 현재 페이지라도 표시
    pages = [currentPage];
  }

  pages.forEach((page, index) => {
    
    
    if(page === '...') {
      const dots = document.createElement('span');
      dots.textContent = '...';
      container.appendChild(dots);
    } else {
      const btn = document.createElement('button');
      btn.textContent = page;
      if(page === currentPage) {
        btn.classList.add('active');
        btn.disabled = true; // 현재 페이지는 비활성화
        
      } else {
        btn.onclick = () => onPageClick(page);
      }
      container.appendChild(btn);
    }
  });

  // 다음 버튼
  const nextBtn = document.createElement('button');
  nextBtn.textContent = '»';
  nextBtn.disabled = currentPage === totalPages;
  if(currentPage < totalPages) {
    nextBtn.onclick = () => onPageClick(currentPage + 1);
  }
  container.appendChild(nextBtn);
  
  // 최적화: 프리렌더링 제거 (불필요한 리소스 사용)
  
  
}

function calculatePageNumbers(current, total, maxVisible) {
  
  
  const pages = [];
  
  // 입력값 검증
  current = parseInt(current) || 1;
  total = parseInt(total) || 1;
  maxVisible = parseInt(maxVisible) || 7;
  
  if(current < 1) current = 1;
  if(current > total) current = total;

  // 전체 페이지가 maxVisible 이하면 모두 표시
  if(total <= maxVisible) {
    
    for(let i = 1; i <= total; i++) {
      pages.push(i);
    }
    
    return pages;
  }

  // 항상 첫 페이지 표시
  pages.push(1);
  

  // 현재 페이지 기준으로 표시할 범위 계산
  const sidesCount = maxVisible - 3; // 첫 페이지, 마지막 페이지, 현재 페이지를 제외한 개수
  const leftSide = Math.floor(sidesCount / 2);
  const rightSide = Math.ceil(sidesCount / 2);
  
  

  // 현재 페이지가 왼쪽에 치우쳐 있는 경우
  if(current <= leftSide + 2) {
    
    // 1, 2, 3, 4, 5 ... last 형태
    for(let i = 2; i < Math.min(maxVisible - 1, total); i++) {
      pages.push(i);
      
    }
    
    if(total > maxVisible - 1) {
      pages.push('...');
      
    }
  }
  // 현재 페이지가 오른쪽에 치우쳐 있는 경우
  else if(current >= total - rightSide - 1) {
    
    // 1 ... 16, 17, 18, 19, 20 형태
    pages.push('...');
    
    
    for(let i = Math.max(total - maxVisible + 3, 2); i < total; i++) {
      pages.push(i);
      
    }
  }
  // 현재 페이지가 중간에 있는 경우
  else {
    
    // 1 ... 8, 9, 10 ... 20 형태
    pages.push('...');
    
    
    for(let i = current - leftSide; i <= current + rightSide; i++) {
      if(i > 1 && i < total) {
        pages.push(i);
        
      }
    }
    
    pages.push('...');
    
  }

  // 항상 마지막 페이지 표시
  if(total > 1) {
    pages.push(total);
    
  }
  
  

  return pages;
}
async function loadCategory(slug, page = 1) {
  if(state.isProcessing) return;
  state.isProcessing = true;

  // [IMPACT-LOADING] router.openCategory에서 이미 openLoading이 호출되었으므로
  // 페이지네이션에서 직접 호출될 때만 로딩 표시
  const loadingEl = document.getElementById('pageTransition');
  if(!loadingEl || !loadingEl.classList.contains('active')) {
    openLoading('카테고리를 불러오는 중...');
  }

  state.currentCategory = slug;
  state.categoryPage = page;

  const overlay = document.getElementById('categoryOverlay');
  // 수정됨: 카테고리 페이지 열기 전에 먼저 스크롤 리셋
  overlay.scrollTop = 0;
  overlay.classList.add('active');

  // 수정됨: 모바일과 데스크탑 모두에서 메인 홈 스크롤 중단
  document.body.style.overflow = 'hidden';

  document.getElementById('categoryOverlayTitle').textContent = slug.toUpperCase();

  const newUrl = `${window.location.origin}${window.location.pathname}?category=${slug}`;
  history.pushState({page:'category', slug:slug}, '', newUrl);

  const descriptions = {
    'tech': '기술과 혁신에 대한 심층 분석',
    'eat': '음식과 외식 문화 탐구',
    'style': '패션과 라이프스타일 트렌드',
    'culture': '문화와 예술에 대한 인사이트',
    'life': '일상과 삶에 대한 이야기',
    'editors-pick': '에디터가 선정한 추천 콘텐츠'
  };
  document.getElementById('categoryOverlaySubtitle').textContent = descriptions[slug] || '카테고리 설명';

  const grid = document.getElementById('categoryGrid');
  grid.innerHTML = '';
  document.getElementById('categoryLoading').textContent = '로딩 중...';
  
  try {
    const catId = CATEGORIES[slug];
    if(!catId) {
      document.getElementById('categoryLoading').textContent = '알 수 없는 카테고리입니다.';
      state.isProcessing = false;
      closeLoading();
      return;
    }

    // 최적화: 카테고리에서도 _embed 필요
    const res = await fetch(api(`posts?categories=${catId}&per_page=20&page=${page}`, true));
    if(!res.ok) throw new Error('Failed');

    let totalPages = parseInt(res.headers.get('X-WP-TotalPages') || '0');
    let totalPosts = parseInt(res.headers.get('X-WP-Total') || '0');
    
    
    
    const posts = await res.json();
    
    // 헤더가 없으면 전체 게시물 수로 계산
    if(totalPages === 0 && totalPosts > 0) {
      totalPages = Math.ceil(totalPosts / 20);
      
    }
    
    // 최소값 보장
    if(totalPages === 0) totalPages = 1;
    
    state.categoryTotal = totalPages;
    
    if(Array.isArray(posts)) {
      const uniquePosts = posts.filter((post, index, self) =>
        index === self.findIndex(p => p.id === post.id)
      );

      uniquePosts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        grid.appendChild(card);
      });
    }

    renderPagination('categoryPagination', page, totalPages, (p) => {
      // [IMPACT-LOADING] 페이지네이션 클릭 시 로딩 표시
      openLoading('페이지를 불러오는 중...');
      loadCategory(slug, p);
    });

    document.getElementById('categoryLoading').textContent = '';
    
    // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
    resetScrollTop('category');
    await nextFrame();
    closeLoading();
  } catch(e) {
    console.error(e);
    document.getElementById('categoryLoading').textContent = '불러오기 실패';
    // [IMPACT-LOADING] 에러 시에도 로딩 해제
    closeLoading();
  } finally {
    state.isProcessing = false;
  }
}
async function loadEditors() {
  if(state.editorsLoaded) return;
  document.getElementById('editorsLoading').textContent = '로딩 중...';
  try {
    // 최적화: users API는 _embed 불필요
    const res = await fetch(api(`users?per_page=100`, false));
    if(!res.ok) throw new Error('editors api fail ' + res.status);
    const users = await res.json();
    state.editorsList = Array.isArray(users) ? users : [];
    renderEditorsGrid();
    state.editorsLoaded = true;
    document.getElementById('editorsLoading').textContent = '';
  } catch(e) {
    console.error(e);
    document.getElementById('editorsLoading').textContent = '에디터 목록을 불러오지 못했습니다.';
  }
}
function renderEditorsGrid() {
  const wrap = document.getElementById('editorsGrid');
  wrap.innerHTML = '';
  const tpl = document.getElementById('editorTpl');
  state.editorsList.forEach(u => {
    const node = tpl.content.firstElementChild.cloneNode(true);
    const img = node.querySelector('.editor-avatar');
    img.src = (u.avatar_urls && (u.avatar_urls['96']||u.avatar_urls['48']||u.avatar_urls['24'])) ? (u.avatar_urls['96']||u.avatar_urls['48']||u.avatar_urls['24']) : placeholderDataURI(96,96,'U');
    img.alt = u.name || u.slug || 'editor';
    node.querySelector('.editor-name').textContent = u.name || u.slug || 'unknown';
    node.querySelector('.editor-bio').textContent = u.description || '';
    node.addEventListener('click', () => router.openEditorProfile(u));
    wrap.appendChild(node);
  });
}
function showEditorsList() {
  document.getElementById('editorProfileSection').style.display = 'none';
  document.getElementById('editorsGridWrapper').style.display = 'block';
  history.pushState({page:'editors'}, '', '#editors');
}
async function loadRelatedPosts(categories, currentPostId) {
  if(!categories || categories.length === 0) return [];

  try {
    const catId = categories[0].id;
    // 최적화: 관련 게시물에서는 _embed 필요
    const res = await fetch(api(`posts?categories=${catId}&per_page=8&exclude=${currentPostId}`, true));
    if(!res.ok) return [];
    const posts = await res.json();

    const uniquePosts = Array.isArray(posts)
      ? posts.filter((p, index, self) =>
          p.id !== currentPostId && index === self.findIndex(post => post.id === p.id)
        ).slice(0, 4)
      : [];

    return uniquePosts;
  } catch(e) {
    console.error(e);
    return [];
  }
}

function openImageModal(imgSrc) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  modalImg.src = imgSrc;
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeImageModal(skipHistory = false) {
  const modal = document.getElementById('imageModal');
  modal.style.display = 'none';
  modal.classList.remove('active');
  document.body.style.overflow = '';
  
  // X 버튼이나 배경 클릭으로 닫을 때만 히스토리 뒤로 가기
  if (!skipHistory && history.state && history.state.imageModal) {
    history.back();
  }
  
  
}

// slug로 게시물 ID를 찾는 함수
async function getPostIdBySlug(slug) {
  try {
    // 최적화: slug 검색에서는 _embed 필요
    const res = await fetch(api(`posts?slug=${encodeURIComponent(slug)}`, true));
    if(!res.ok) return null;
    const posts = await res.json();
    if(Array.isArray(posts) && posts.length > 0) {
      // 캐시에 저장
      state.postsCache[posts[0].id] = posts[0];
      return posts[0].id;
    }
    return null;
  } catch(e) {
    console.error('getPostIdBySlug 에러:', e);
    return null;
  }
}

// slug 또는 ID로 게시물 열기
async function openPostOverlayBySlug(slugOrId, updateURL = true) {
  // 숫자인 경우 ID로 처리
  if(/^\d+$/.test(slugOrId)) {
    return await openPostOverlayById(parseInt(slugOrId), updateURL);
  }
  
  // slug인 경우 ID를 찾아서 처리
  const postId = await getPostIdBySlug(slugOrId);
  if(postId) {
    return await openPostOverlayById(postId, updateURL);
  } else {
    console.error('게시물을 찾을 수 없습니다:', slugOrId);
    alert('게시물을 찾을 수 없습니다.');
    // 홈으로 리다이렉트
    window.location.href = '/';
  }
}

async function openPostOverlayById(id, updateURL = true) {
  if(!id || state.isProcessing) return;
  state.isProcessing = true;

  // [IMPACT-LOADING] 출발 즉시 로딩 오버레이 표시
  openLoading('게시물을 불러오는 중...');

  state.currentPostId = id;

  if(updateURL) {
    const currentUrl = window.location.href;
    const currentParams = new URLSearchParams(window.location.search);
    const currentCategory = currentParams.get('category');
    const currentEditor = currentParams.get('editor');
    const currentPage = currentParams.get('page');
    const currentPath = window.location.pathname;

    let previousState = {
      url: currentUrl,
      page: 'home',
      scrollPosition: window.scrollY
    };

    // 검색 페이지에서 게시물 진입 확인
    if(currentPath === '/search' || document.getElementById('searchOverlay').classList.contains('active')) {
      previousState.page = 'search';
      previousState.searchTerm = document.getElementById('searchInput')?.value || '';
      // 검색 결과 상태 저장
      try {
        sessionStorage.setItem('lastSearchQuery', previousState.searchTerm);
        sessionStorage.setItem('searchScrollPosition', document.getElementById('searchOverlay').scrollTop);
      } catch(e) {
        console.error('sessionStorage error:', e);
      }
    } else if(currentCategory) {
      previousState.page = 'category';
      previousState.category = currentCategory;
    } else if(currentEditor) {
      previousState.page = 'editor';
      previousState.editor = currentEditor;
    } else if(currentPage === 'search') {
      previousState.page = 'search';
      previousState.searchTerm = document.getElementById('searchInput')?.value || '';
      // 검색 오버레이 스크롤 위치 저장
      const searchOverlay = document.getElementById('searchOverlay');
      if(searchOverlay) {
        try {
          sessionStorage.setItem('searchScrollPosition', searchOverlay.scrollTop.toString());
        } catch(e) {
          console.error('sessionStorage error:', e);
        }
      }
    } else if(currentPage === 'about') {
      previousState.page = 'about';
    } else if(currentPage === 'editors') {
      previousState.page = 'editors';
    }

    // 게시물 정보를 먼저 가져와서 slug 사용
    let postSlug = id;
    const cached = state.postsCache[id];
    if(cached && cached.slug) {
      postSlug = cached.slug;
    }
    
    const newUrl = `${window.location.origin}/post/${postSlug}`;
    history.pushState({page: 'post', id: id, slug: postSlug, previous: previousState}, '', newUrl);
  }

  const overlay = document.getElementById('postOverlay');
  const article = document.getElementById('postArticle');

  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
  
  // 수정됨: 오버레이 열기 전에 먼저 스크롤을 최상단으로 리셋
  overlay.scrollTop = 0;

  const cached = state.postsCache[id];
  if(cached && cached.content && cached.content.rendered) {
    // ⚡ 캐시된 데이터 사용 - 즉시 표시
    
    await renderPostOverlay(cached);
    // [IMPACT-LOADING] 렌더 완료 후 로딩 해제
    await nextFrame();
    closeLoading();
    state.isProcessing = false;
    return;
  }

  article.innerHTML = `
    <div class="post-loading-container" style="
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      flex-direction: column;
      gap: 16px;
    ">
      <div class="spinner" style="
        width: 40px;
        height: 40px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff6b35;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      "></div>
      <p style="color: #666; font-size: 16px;">게시물을 불러오는 중...</p>
    </div>
  `;

  try {
    // 최적화: 게시물에서는 _embed 필수 (작성자, 이미지 등)
    const res = await fetch(api(`posts/${id}`, true));
    if(!res.ok) throw new Error('post fetch failed ' + res.status);
    const post = await res.json();

    state.postsCache[id] = post;

    await renderPostOverlay(post);
    // [IMPACT-LOADING] 렌더 완료 후 로딩 해제
    // 수정됨: 중복 스크롤 리셋 제거 (이미 오버레이 열 때 리셋됨)
    await nextFrame();
    closeLoading();
  } catch(e) {
    console.error(e);
    article.innerHTML = `
      <div class="post-error-container" style="
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
        flex-direction: column;
        gap: 16px;
      ">
        <p style="color: #e74c3c; font-size: 18px;">게시물을 불러올 수 없습니다.</p>
        <button onclick="router.closePost()" class="btn" style="padding: 8px 16px;">돌아가기</button>
      </div>
    `;
    // [IMPACT-LOADING] 에러 시에도 로딩 해제
    closeLoading();
  } finally {
    state.isProcessing = false;
  }
}
async function renderPostOverlay(post) {
  const overlay = document.getElementById('postOverlay');
  const article = document.getElementById('postArticle');
  const title = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
  const authorName = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].name) ? post._embedded.author[0].name : '익명';
  const authorData = post._embedded?.author?.[0] || {};
  const avatar = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].avatar_urls) ? (post._embedded.author[0].avatar_urls['96'] || post._embedded.author[0].avatar_urls['48']) : '';
  const categories = (post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) ? post._embedded['wp:term'][0].map(t=>t.name).join(', ') : '-';
  const dateStr = formatDate(post.date);
  const contentHTML = post.content && post.content.rendered ? post.content.rendered : (post.excerpt && post.excerpt.rendered ? post.excerpt.rendered : '');
  const featuredUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || '';
  
  // OG 메타태그 업데이트
  const excerpt = post.excerpt && post.excerpt.rendered ? stripTags(post.excerpt.rendered).substring(0, 160) : stripTags(title);
  updateMetaTags({
    title: stripTags(title) + ' - IMPACT',
    description: excerpt,
    image: featuredUrl || `${window.location.origin}/logo.png`,
    url: `${window.location.origin}/post/${post.slug}`,
    type: 'article'
  });
  
  // JSON-LD 구조화된 데이터 추가 (SEO 향상)
  updateStructuredData({
    '@context': 'https://schema.org',
    '@type': 'Article',
    'headline': stripTags(title),
    'description': excerpt,
    'image': featuredUrl || `${window.location.origin}/logo.png`,
    'datePublished': post.date,
    'dateModified': post.modified || post.date,
    'author': {
      '@type': 'Person',
      'name': authorName,
      'url': `${window.location.origin}/editor/${authorData.id}`
    },
    'publisher': {
      '@type': 'Organization',
      'name': 'IMPACT',
      'logo': {
        '@type': 'ImageObject',
        'url': `${window.location.origin}/logo.png`
      }
    },
    'mainEntityOfPage': {
      '@type': 'WebPage',
      '@id': `${window.location.origin}/post/${post.slug}`
    }
  });
  article.innerHTML = `
    <div class="post-hero-section">
      <div class="post-header">
        ${featuredUrl ? `
          <div class="post-thumbnail-container">
            <div class="post-thumbnail">
              <img src="${featuredUrl}" alt="${stripTags(title) || 'featured image'}" loading="eager" fetchpriority="high" decoding="async">
            </div>
          </div>
        ` : ''}
        <div class="post-info-container">
          <div class="post-info">
            <div class="cat-row" style="margin-bottom:16px">
              ${post._embedded?.['wp:term']?.[0]?.map(c => {
                const cls = pickCategoryClass(c.slug || c.name);
                return `<span class="cat-badge ${cls}">${c.name}</span>`;
              }).join('') || ''}
            </div>
            <h1>${title}</h1>
            <div class="post-meta-info">
              <div class="meta-row">
                <img src="${avatar || placeholderDataURI(96,96,'U')}" alt="author" class="author-avatar">
                <strong>${authorName}</strong>
              </div>
              <div class="meta-row">
                <span>📅 ${dateStr}</span>
              </div>
              <div class="meta-row">
                <span>🏷️ ${categories}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="post-content" id="postContent-${post.id}">${contentHTML}</div>
    
    <div class="share-section" style="
      max-width: 800px;
      margin: 48px auto;
      padding: 32px 24px;
      text-align: left;
    ">
      <h3 class="share-title" style="
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 24px;
        color: #000;
      ">게시물 공유</h3>
      <div class="share-buttons" style="
        display: flex;
        justify-content: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      ">
        <button class="share-btn" onclick="shareToFacebook()" style="
          background: #f6f7f9;
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
        " onmouseover="this.style.background='#1877f2';this.querySelector('svg').style.fill='white'" onmouseout="this.style.background='#f6f7f9';this.querySelector('svg').style.fill='#666'">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill:#666;">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </button>
        <button class="share-btn" onclick="shareToTwitter()" style="
          background: #f6f7f9;
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
        " onmouseover="this.style.background='#000';this.querySelector('svg').style.fill='white'" onmouseout="this.style.background='#f6f7f9';this.querySelector('svg').style.fill='#666'">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="fill:#666;">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </button>
        <button class="share-btn" onclick="shareToLinkedIn()" style="
          background: #f6f7f9;
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
        " onmouseover="this.style.background='#0A66C2';this.querySelector('svg').style.fill='white'" onmouseout="this.style.background='#f6f7f9';this.querySelector('svg').style.fill='#666'">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="fill:#666;">
            <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
          </svg>
        </button>
        <button class="share-btn" onclick="shareEmail()" style="
          background: #f6f7f9;
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
        " onmouseover="this.style.background='#EA4335';this.querySelector('svg').style.fill='white'" onmouseout="this.style.background='#f6f7f9';this.querySelector('svg').style.fill='#666'">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="fill:#666;">
            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
          </svg>
        </button>
        <button class="share-btn" onclick="copyLink()" style="
          background: #f6f7f9;
          border: none;
          padding: 12px;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 48px;
          height: 48px;
          display: flex;
          align-items: center;
          justify-content: center;
        " onmouseover="this.style.background='#666';this.querySelector('svg').style.fill='white'" onmouseout="this.style.background='#f6f7f9';this.querySelector('svg').style.fill='#666'">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="fill:#666;">
            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="author-profile-section" 
         role="link" 
         tabindex="0" 
         data-editor-id="${authorData.id}"
         style="cursor: pointer;">
      <img src="${avatar || placeholderDataURI(96,96,'U')}" alt="${authorName}" class="author-profile-avatar">
      <div class="author-profile-info">
        <div class="author-profile-name">${authorName}</div>
        <div class="author-profile-bio">${authorData.description || '에디터 소개가 없습니다.'}</div>
      </div>
    </div>
    <div class="copyright-notice">
      본 콘텐츠의 모든 저작권 및 지식재산권은 IMPACT에 귀속됩니다. 무단 복제, 전재 등 2차적 저작물 생성 등 일체의 무단 이용을 금합니다. 이를 위반할 경우, 민형사상 강력한 법적 조치가 취해질 수 있습니다.
    </div>
    <div id="relatedPostsContainer"></div>
  `;
  
  // ⚡ Optimize all images in post content
  article.querySelectorAll('.post-content img').forEach((img, index)=>{
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    img.style.display = 'block';
    img.style.margin = '12px 0';
    img.style.cursor = 'pointer';
    img.style.pointerEvents = 'auto';
    
    // Add lazy loading for images not in first viewport
    if (index > 2) {
      img.loading = 'lazy';
    } else {
      img.loading = 'eager';
    }
    img.decoding = 'async';
    
    // Add alt text if missing
    if (!img.alt) {
      img.alt = stripTags(title) || 'Post image';
    }
    
    img.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openImageModal(img.src);
    });
  });

  try {
    const allNodes = Array.from(article.querySelectorAll('.post-content *'));
    allNodes.forEach(el => {
      if (el && el.textContent && el.textContent.trim().includes('이 글 공유하기')) {
        el.remove();
      }
    });
  } catch(e) { }
  try {
    article.querySelectorAll('.updated, time[itemprop="dateModified"], [data-modified], .post-modified, .modified-date').forEach(el => el.remove());
  } catch(e) { }
  const postCategories = post._embedded?.['wp:term']?.[0] || [];
  if(postCategories.length > 0) {
    const relatedPosts = await loadRelatedPosts(postCategories, post.id);
    if(relatedPosts.length > 0) {
      const relatedContainer = document.getElementById('relatedPostsContainer');
      const relatedSection = document.createElement('div');
      relatedSection.className = 'related-posts';
      relatedSection.innerHTML = '<h3>같은 카테고리의 다른 글</h3><div class="related-grid" id="relatedGrid"></div>';
      relatedContainer.appendChild(relatedSection);

      const relatedGrid = document.getElementById('relatedGrid');
      relatedPosts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCardNode(p);
        relatedGrid.appendChild(card);
      });
    }
  }
  
  // [IMPACT-LOADING] C. 에디터 박스 클릭/키보드 이벤트 핸들러
  const editorBox = article.querySelector('.author-profile-section');
  if (editorBox && authorData.id) {
    const handleEditorClick = async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // [IMPACT-LOADING] 즉시 로딩 표시
      openLoading('에디터 페이지로 이동 중...');
      
      // 게시물 오버레이 닫기
      const postOverlay = document.getElementById('postOverlay');
      postOverlay.classList.remove('active');
      document.body.style.overflow = '';
      document.getElementById('progressBar').classList.remove('active');
      document.getElementById('postHeaderBar').classList.remove('show');
      document.getElementById('postToTopBtn').classList.remove('show');
      
      // 에디터 프로필로 이동
      try {
        await router.openEditorProfile({
          id: authorData.id,
          name: authorName,
          description: authorData.description || '',
          avatar_urls: authorData.avatar_urls || {},
          slug: authorData.slug || ''
        }, true);
        
        // 타이틀 즉시 변경
        document.title = 'EDITORS - IMPACT';
        
        // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
        resetScrollTop('editors');
        await nextFrame();
        closeLoading();
      } catch (err) {
        console.error('에디터 페이지 이동 실패:', err);
        closeLoading();
      }
    };
    
    editorBox.addEventListener('click', handleEditorClick);
    editorBox.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        handleEditorClick(e);
      }
    });
  }
  
  overlay.classList.add('active');
  overlay.scrollTop = 0;
  document.body.style.overflow = 'hidden';

  const progressBar = document.getElementById('progressBar');
  progressBar.classList.add('active');
  progressBar.style.width = '0%';
  
  // 워드프레스 갤러리 슬라이더 초기화
  await nextFrame();
  initializeGallerySliders();
}

// 워드프레스 갤러리 슬라이더 초기화 함수
async function initializeGallerySliders() {
  const postContent = document.querySelector('.post-content');
  if (!postContent) return;
  
  
  
  // 워드프레스 갤러리 찾기 (.wp-block-gallery, .gallery, .blocks-gallery-grid 등)
  const galleries = postContent.querySelectorAll('.wp-block-gallery, .gallery, .blocks-gallery-grid, [class*="gallery"]');
  
  for (let i = 0; i < galleries.length; i++) {
    const gallery = galleries[i];
    
    // 이미 처리된 갤러리는 건너뛰기
    if (gallery.classList.contains('wp-gallery-processed')) continue;
    
    const images = gallery.querySelectorAll('img');
    
    // 이미지가 2개 이상일 때만 슬라이더로 변환
    if (images.length >= 2) {
      
      await createGallerySlider(gallery, images, i);
      gallery.classList.add('wp-gallery-processed');
    }
  }
  
  // figure 안에 여러 img가 있는 경우도 처리
  const figures = postContent.querySelectorAll('figure');
  for (let i = 0; i < figures.length; i++) {
    const figure = figures[i];
    
    if (figure.classList.contains('wp-gallery-processed')) continue;
    
    const images = figure.querySelectorAll('img');
    if (images.length >= 2) {
      
      await createGallerySlider(figure, images, i + 1000);
      figure.classList.add('wp-gallery-processed');
    }
  }
  
  
}

// 갤러리 슬라이더 생성 함수
async function createGallerySlider(container, images, galleryId) {
  const imageArray = Array.from(images);
  
  
  
  // 슬라이더 구조 생성
  const slider = document.createElement('div');
  slider.className = 'wp-gallery-slider';
  slider.dataset.galleryId = galleryId;
  
  const track = document.createElement('div');
  track.className = 'wp-gallery-slider-track';
  
  // 이미지 비율 배열
  const imageData = [];
  
  // 모든 이미지 로드 및 비율 계산
  for (let idx = 0; idx < imageArray.length; idx++) {
    const img = imageArray[idx];
    const slide = document.createElement('div');
    slide.className = 'wp-gallery-slider-slide';
    
    const clonedImg = img.cloneNode(true);
    clonedImg.style.cursor = 'pointer'; // 클릭 가능하도록 변경
    
    // 이미지 로드 및 비율 계산
    await new Promise((resolve) => {
      if (img.complete && img.naturalWidth && img.naturalHeight) {
        const width = img.naturalWidth;
        const height = img.naturalHeight;
        const ratio = width / height;
        
        imageData[idx] = { width, height, ratio, src: img.src };
        
        
        // 이미지 클릭 이벤트 추가
        clonedImg.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openImageModal(img.src);
        });
        
        slide.appendChild(clonedImg);
        track.appendChild(slide);
        resolve();
      } else {
        const tempImg = new Image();
        tempImg.onload = function() {
          const width = this.naturalWidth;
          const height = this.naturalHeight;
          const ratio = width / height;
          
          imageData[idx] = { width, height, ratio, src: img.src };
          
          
          clonedImg.src = img.src;
          
          // 이미지 클릭 이벤트 추가
          clonedImg.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openImageModal(img.src);
          });
          
          slide.appendChild(clonedImg);
          track.appendChild(slide);
          resolve();
        };
        tempImg.onerror = function() {
          console.error(`이미지 ${idx + 1} 로드 실패`);
          imageData[idx] = { width: 800, height: 600, ratio: 1.33, src: img.src };
          
          // 이미지 클릭 이벤트 추가
          clonedImg.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openImageModal(img.src);
          });
          
          slide.appendChild(clonedImg);
          track.appendChild(slide);
          resolve();
        };
        tempImg.src = img.src;
      }
    });
  }
  
  slider.appendChild(track);
  
  // 네비게이션 버튼
  const prevBtn = document.createElement('button');
  prevBtn.className = 'wp-gallery-slider-nav prev';
  prevBtn.innerHTML = '‹';
  prevBtn.setAttribute('aria-label', '이전 이미지');
  
  const nextBtn = document.createElement('button');
  nextBtn.className = 'wp-gallery-slider-nav next';
  nextBtn.innerHTML = '›';
  nextBtn.setAttribute('aria-label', '다음 이미지');
  
  slider.appendChild(prevBtn);
  slider.appendChild(nextBtn);
  
  // 카운터
  const counter = document.createElement('div');
  counter.className = 'wp-gallery-slider-counter';
  counter.textContent = `1 / ${imageArray.length}`;
  slider.appendChild(counter);
  
  // 도트 네비게이션
  if (imageArray.length <= 10) {
    const dots = document.createElement('div');
    dots.className = 'wp-gallery-slider-dots';
    
    imageArray.forEach((_, idx) => {
      const dot = document.createElement('button');
      dot.className = 'wp-gallery-slider-dot';
      if (idx === 0) dot.classList.add('active');
      dot.setAttribute('aria-label', `이미지 ${idx + 1}로 이동`);
      dots.appendChild(dot);
    });
    
    slider.appendChild(dots);
  }
  
  // 기존 갤러리를 슬라이더로 교체
  container.innerHTML = '';
  container.appendChild(slider);
  
  // DOM이 완전히 렌더링된 후 높이 설정
  setTimeout(() => {
    if (imageData.length > 0 && imageData[0]) {
      setSliderHeight(slider, imageData[0].ratio);
    }
  }, 100);
  
  // 슬라이더 컨트롤 초기화
  initializeSliderControls(slider, track, imageArray.length, prevBtn, nextBtn, counter, imageData);
  
  
}

// 이미지 모달 열기 함수
function openImageModal(imageSrc) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  
  if (modal && modalImg) {
    modalImg.src = imageSrc;
    modal.style.display = 'flex';
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // 히스토리에 추가 (뒤로가기 지원)
    history.pushState({ imageModal: true }, '', window.location.href);
    
    
  }
}

// 프리렌더링 함수: 인접 페이지 미리 로드
function prerenderAdjacentPages(currentPage, totalPages) {
  const baseUrl = window.location.origin + window.location.pathname;
  const urlsToPrerender = [];
  
  // 다음 페이지
  if (currentPage < totalPages) {
    urlsToPrerender.push(`${baseUrl}?page=${currentPage + 1}`);
  }
  
  // 이전 페이지
  if (currentPage > 1) {
    urlsToPrerender.push(`${baseUrl}?page=${currentPage - 1}`);
  }
  
  // 다다음 페이지 (사용자가 연속으로 클릭할 가능성 대비)
  if (currentPage + 2 <= totalPages) {
    urlsToPrerender.push(`${baseUrl}?page=${currentPage + 2}`);
  }
  
  
  
  // 기존 prefetch 링크 업데이트
  updatePrefetchLinks(urlsToPrerender);
  
  // Speculation Rules API 업데이트 (Chrome 지원)
  updateSpeculationRules(urlsToPrerender);
}

// Prefetch 링크 동적 업데이트
function updatePrefetchLinks(urls) {
  for (let i = 0; i < Math.min(urls.length, 3); i++) {
    const linkId = `prefetchLink${i + 1}`;
    let link = document.getElementById(linkId);
    
    if (link && urls[i]) {
      link.href = urls[i];
      
    }
  }
}

// Speculation Rules API 업데이트 (최신 Chrome에서 더 효과적인 프리렌더링)
function updateSpeculationRules(urls) {
  const script = document.getElementById('speculationRules');
  
  if (script && 'speculationrules' in HTMLScriptElement.prototype) {
    const rules = {
      prefetch: [{
        source: "list",
        urls: urls.slice(0, 3) // 최대 3개
      }],
      prerender: [{
        source: "list", 
        urls: urls.slice(0, 1) // 다음 페이지만 prerender (리소스 절약)
      }]
    };
    
    script.textContent = JSON.stringify(rules);
    
  } else {
    
  }
}

// 포스트 상세 페이지 프리렌더링
function prerenderPostLinks() {
  // 현재 화면에 보이는 포스트 링크들을 수집
  const postLinks = document.querySelectorAll('.post-title a, .post-link');
  const visibleLinks = [];
  
  postLinks.forEach(link => {
    const rect = link.getBoundingClientRect();
    const isVisible = (
      rect.top >= 0 &&
      rect.left >= 0 &&
      rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
      rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
    
    if (isVisible && visibleLinks.length < 5) {
      visibleLinks.push(link.href);
    }
  });
  
  if (visibleLinks.length > 0) {
    
    updatePrefetchLinks(visibleLinks);
  }
}

// 페이지 로드 시 초기화
window.addEventListener('load', () => {
  // 포스트 링크 프리렌더링 (3초 후 - 초기 로딩 완료 후)
  setTimeout(() => {
    prerenderPostLinks();
  }, 3000);
});

// 슬라이더 높이 설정 함수
function setSliderHeight(slider, ratio) {
  // 실제 슬라이더 너비 측정 (여러 방법 시도)
  let sliderWidth = slider.offsetWidth;
  
  // offsetWidth가 0이면 부모 컨테이너나 viewport 너비 사용
  if (!sliderWidth || sliderWidth === 0) {
    const parent = slider.parentElement;
    if (parent) {
      sliderWidth = parent.offsetWidth;
    }
    if (!sliderWidth || sliderWidth === 0) {
      sliderWidth = window.innerWidth;
    }
  }
  
  // 패딩 제거 (좌우 20px씩)
  const isMobile = window.innerWidth <= 768;
  if (isMobile) {
    sliderWidth = sliderWidth - 40; // 좌우 패딩 제거
  }
  
  
  
  // 이미지 비율로 높이 계산
  let calculatedHeight = sliderWidth / ratio;
  
  // 최대/최소 높이 제한
  const maxHeight = isMobile ? window.innerHeight * 0.6 : window.innerHeight * 0.75;
  const minHeight = isMobile ? 250 : 300;
  
  calculatedHeight = Math.max(minHeight, Math.min(calculatedHeight, maxHeight));
  
  slider.style.height = `${calculatedHeight}px`;
  slider.style.transition = 'height 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  
  
}

// 슬라이더 컨트롤 초기화
function initializeSliderControls(slider, track, totalSlides, prevBtn, nextBtn, counter, imageData) {
  let currentIndex = 0;
  let startX = 0;
  let currentX = 0;
  let isDragging = false;
  
  const updateSlider = () => {
    track.style.transform = `translateX(-${currentIndex * 100}%)`;
    counter.textContent = `${currentIndex + 1} / ${totalSlides}`;
    
    // 현재 이미지의 비율로 슬라이더 높이 재설정
    if (imageData && imageData[currentIndex] && imageData[currentIndex].ratio) {
      // 약간의 지연을 주어 DOM이 완전히 렌더링된 후 높이 설정
      setTimeout(() => {
        setSliderHeight(slider, imageData[currentIndex].ratio);
      }, 50);
    }
    
    // 도트 업데이트
    const dots = slider.querySelectorAll('.wp-gallery-slider-dot');
    dots.forEach((dot, idx) => {
      dot.classList.toggle('active', idx === currentIndex);
    });
    
    // 버튼 상태 업데이트
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex === totalSlides - 1;
  };
  
  const goToSlide = (index) => {
    currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
    updateSlider();
  };
  
  // 버튼 이벤트
  prevBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    goToSlide(currentIndex - 1);
  });
  
  nextBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    goToSlide(currentIndex + 1);
  });
  
  // 도트 클릭 이벤트
  const dots = slider.querySelectorAll('.wp-gallery-slider-dot');
  dots.forEach((dot, idx) => {
    dot.addEventListener('click', (e) => {
      e.stopPropagation();
      goToSlide(idx);
    });
  });
  
  // 터치/마우스 드래그 이벤트
  const handleStart = (e) => {
    isDragging = true;
    const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    startX = clientX;
    currentX = clientX;
    track.style.transition = 'none';
  };
  
  const handleMove = (e) => {
    if (!isDragging) return;
    
    e.preventDefault();
    currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const diff = currentX - startX;
    const percentage = (diff / slider.offsetWidth) * 100;
    
    track.style.transform = `translateX(calc(-${currentIndex * 100}% + ${percentage}%))`;
  };
  
  const handleEnd = (e) => {
    if (!isDragging) return;
    
    isDragging = false;
    track.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    const diff = currentX - startX;
    const threshold = slider.offsetWidth * 0.15; // 임계값 15%로 낮춤 (더 민감하게)
    
    
    
    if (Math.abs(diff) > threshold) {
      // 오른쪽으로 스와이프 (이전 슬라이드)
      if (diff > 0 && currentIndex > 0) {
        
        goToSlide(currentIndex - 1);
      } 
      // 왼쪽으로 스와이프 (다음 슬라이드)
      else if (diff < 0 && currentIndex < totalSlides - 1) {
        
        goToSlide(currentIndex + 1);
      } 
      // 경계에서의 스와이프
      else {
        
        updateSlider();
      }
    } else {
      
      updateSlider();
    }
    
    // 초기화
    startX = 0;
    currentX = 0;
  };
  
  // 마우스 이벤트
  track.addEventListener('mousedown', handleStart);
  document.addEventListener('mousemove', handleMove);
  document.addEventListener('mouseup', handleEnd);
  
  // 터치 이벤트
  track.addEventListener('touchstart', handleStart, { passive: false });
  track.addEventListener('touchmove', handleMove, { passive: false });
  track.addEventListener('touchend', handleEnd, { passive: false });
  
  // 키보드 네비게이션
  slider.setAttribute('tabindex', '0');
  slider.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      goToSlide(currentIndex - 1);
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      goToSlide(currentIndex + 1);
    }
  });
  
  // 윈도우 리사이즈 시 높이 재계산
  let resizeTimeout;
  const handleResize = () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (imageData && imageData[currentIndex] && imageData[currentIndex].ratio) {
        setSliderHeight(slider, imageData[currentIndex].ratio);
      }
    }, 300);
  };
  window.addEventListener('resize', handleResize);
  
  // 초기 상태 설정 (약간의 지연)
  setTimeout(() => {
    updateSlider();
  }, 100);
}

const ui = {
  toggleNav: (forceClose = false) => {
    const nav = document.getElementById('navOverlay');
    if(forceClose) {
      nav.classList.remove('active');
      if(window.innerWidth <= 680) {
        document.body.style.overflow = '';
      }
    } else {
      nav.classList.toggle('active');
      if(window.innerWidth <= 680) {
        if(nav.classList.contains('active')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      }
      // 네비게이션이 열릴 때 현재 페이지 상태를 반영하여 renderNavList 업데이트
      if(nav.classList.contains('active')) {
        renderNavList();
      }
    }
  }
};
const router = {
  openCategory: (slug, updateURL = true) => {
    // [IMPACT-LOADING] 즉시 로딩 표시
    openLoading('카테고리를 불러오는 중...');
    
    // 타이틀 즉시 변경 (로딩 전에)
    if(updateURL) {
      const newUrl = `${window.location.origin}/category/${slug}`;
      history.pushState({page:'category', slug:slug}, '', newUrl);
      
      // 카테고리 메타태그 업데이트
      const categoryNames = {
        'tech': 'TECH',
        'eat': 'EAT',
        'style': 'STYLE',
        'culture': 'CULTURE',
        'life': 'LIFE',
        'editors-pick': "EDITORS' PICK"
      };
      updateMetaTags({
        title: `${categoryNames[slug] || slug.toUpperCase()} - IMPACT`,
        url: newUrl
      });
      
      // 네비게이션 리스트 업데이트 (현재 페이지 강조 표시)
      renderNavList();
    }
    
    loadCategory(slug, 1);
  },
  closeCategory: async () => {
    // 메타태그 즉시 복원
    updateMetaTags({});
    updateStructuredData(null);
    
    document.getElementById('categoryOverlay').classList.remove('active');
    document.body.style.overflow = '';
    const newUrl = `${window.location.origin}/`;
    history.pushState({page:'home'}, '', newUrl);
    
    // 네비게이션 리스트 업데이트 (현재 페이지 강조 해제)
    renderNavList();
    
    // 수정됨: 메인 홈이 로드되지 않았다면 즉시 로드 및 로딩 표시
    const container = document.getElementById('rowsContainer');
    if(!container || container.children.length === 0) {
      openLoading('홈페이지를 불러오는 중...');
      await loadHomeChunk(1);
      closeLoading();
    }
    
    // 스크롤 리셋
    resetScrollTop('window');
    await nextFrame();
  },
  openEditors: async (updateURL = true) => {
    // [IMPACT-LOADING] 즉시 로딩 표시
    openLoading('에디터 목록을 불러오는 중...');
    
    // 타이틀 즉시 변경 (로딩 전에)
    if(updateURL) {
      const newUrl = `${window.location.origin}/editors`;
      history.pushState({page:'editors'}, '', newUrl);
      updateMetaTags({
        title: 'EDITORS - IMPACT',
        description: 'IMPACT에 참여하는 에디터 목록과 각 에디터의 작성 글을 확인할 수 있습니다.',
        url: newUrl
      });
    }
    
    // 수정됨: EDITORS 페이지 열기 전에 먼저 스크롤 리셋
    const editorsOverlay = document.getElementById('editorsOverlay');
    editorsOverlay.scrollTop = 0;
    
    document.getElementById('editorsOverlay').classList.add('active');
    // 수정됨: 모바일과 데스크탑 모두에서 메인 홈 스크롤 중단
    document.body.style.overflow = 'hidden';
    
    await loadEditors();
    
    // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
    resetScrollTop('editors');
    await nextFrame();
    closeLoading();
  },
  closeEditors: async (resetView = true) => {
    // 메타태그 즉시 복원
    updateMetaTags({});
    updateStructuredData(null);
    
    // resetView가 true이면 에디터 목록 뷰로 복귀
    if(resetView) {
      document.getElementById('editorProfileSection').style.display = 'none';
      document.getElementById('editorsGridWrapper').style.display = 'block';
    }
    const editorsOverlay = document.getElementById('editorsOverlay');
    editorsOverlay.classList.remove('active');
    // 에디터 오버레이 스크롤 위치 초기화
    editorsOverlay.scrollTop = 0;
    document.body.style.overflow = '';
    const newUrl = `${window.location.origin}/`;
    history.pushState({page:'home'}, '', newUrl);
    
    // 수정됨: 메인 홈이 로드되지 않았다면 즉시 로드 및 로딩 표시
    const container = document.getElementById('rowsContainer');
    if(!container || container.children.length === 0) {
      openLoading('홈페이지를 불러오는 중...');
      await loadHomeChunk(1);
      closeLoading();
    }
    
    // 스크롤 리셋
    resetScrollTop('window');
    await nextFrame();
  },
  openAbout: async (updateURL = true) => {
    // [IMPACT-LOADING] 즉시 로딩 표시
    openLoading('ABOUT 페이지를 불러오는 중...');
    
    // 타이틀 즉시 변경 (로딩 전에)
    if(updateURL) {
      const newUrl = `${window.location.origin}/about`;
      history.pushState({page:'about'}, '', newUrl);
      updateMetaTags({
        title: 'ABOUT - IMPACT',
        description: 'IMPACT에 대해 알아보고 우리의 비전과 목표를 확인하세요.',
        url: newUrl
      });
    }
    
    // 수정됨: ABOUT 페이지 열기 전에 먼저 스크롤 리셋
    const aboutPage = document.getElementById('aboutPage');
    aboutPage.scrollTop = 0;
    
    document.getElementById('aboutPage').classList.add('active');
    // 수정됨: 모바일과 데스크탑 모두에서 메인 홈 스크롤 중단
    document.body.style.overflow = 'hidden';
    
    // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
    resetScrollTop('about');
    await nextFrame();
    closeLoading();
  },
  closeAbout: async () => {
    // 메타태그 즉시 복원
    updateMetaTags({});
    updateStructuredData(null);
    
    const aboutPage = document.getElementById('aboutPage');
    aboutPage.classList.remove('active');
    // 어바웃 페이지 스크롤 위치 초기화
    aboutPage.scrollTop = 0;
    document.body.style.overflow = '';
    const newUrl = `${window.location.origin}/`;
    history.pushState({page:'home'}, '', newUrl);
    
    // 수정됨: 메인 홈이 로드되지 않았다면 즉시 로드 및 로딩 표시
    const container = document.getElementById('rowsContainer');
    if(!container || container.children.length === 0) {
      openLoading('홈페이지를 불러오는 중...');
      await loadHomeChunk(1);
      closeLoading();
    }
    
    // 스크롤 리셋
    resetScrollTop('window');
    await nextFrame();
  },
  closePost: () => {
    console.log('🔵 router.closePost 호출됨!');
    console.trace('호출 스택:');
    const overlay = document.getElementById('postOverlay');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');
    
    // 초기 스크롤 플래그 리셋 (다음 게시물 진입을 위해)
    state.initialScrollDone['post'] = false;

    const currentState = history.state;
    if(currentState && currentState.previous) {
      const prev = currentState.previous;

      if(prev.page === 'category' && prev.category) {
        const newUrl = `${window.location.origin}${window.location.pathname}?category=${prev.category}`;
        history.pushState({page: 'category', slug: prev.category}, '', newUrl);
        router.openCategory(prev.category, false);
      } else if(prev.page === 'editor' && prev.editor) {
        const newUrl = `${window.location.origin}${window.location.pathname}?editor=${prev.editor}`;
        history.pushState({page: 'editor', id: prev.editor}, '', newUrl);
        router.openEditors(false);
        setTimeout(async () => {
          if(state.editorsList.length === 0) {
            await loadEditors();
          }
          const editor = state.editorsList.find(e => e.id === parseInt(prev.editor));
          if(editor) {
            router.openEditorProfile(editor, false);
          }
        }, 100);
      } else if(prev.page === 'search') {
        // 검색 페이지로 돌아가기
        const newUrl = `${window.location.origin}/search`;
        window.history.replaceState({page: 'search', searchTerm: prev.searchTerm}, '', newUrl);
        
        // 검색 오버레이 다시 활성화
        const searchOverlay = document.getElementById('searchOverlay');
        searchOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // 검색어와 스크롤 위치 복원
        if(prev.searchTerm) {
          const searchInput = document.getElementById('searchInput');
          if(searchInput) {
            searchInput.value = prev.searchTerm;
            // 검색 결과 다시 표시
            performSearch(prev.searchTerm, 'fullSearch');
          }
        }
        
        // 세션 스토리지에서 스크롤 위치 복원
        try {
          const scrollPos = sessionStorage.getItem('searchScrollPosition');
          if(scrollPos) {
            setTimeout(() => {
              searchOverlay.scrollTop = parseInt(scrollPos);
            }, 200);
          }
        } catch(e) {
          console.error('sessionStorage error:', e);
        }
      } else if(prev.page === 'about') {
        const newUrl = `${window.location.origin}${window.location.pathname}?page=about`;
        history.pushState({page: 'about'}, '', newUrl);
        router.openAbout(false);
      } else if(prev.page === 'editors') {
        const newUrl = `${window.location.origin}${window.location.pathname}?page=editors`;
        history.pushState({page: 'editors'}, '', newUrl);
        router.openEditors(false);
      } else {
        const newUrl = `${window.location.origin}${window.location.pathname}`;
        history.pushState({page: 'home'}, '', newUrl);
        
        // 수정됨: 메인 홈이 로드되지 않았다면 즉시 로딩 표시 및 로드
        const container = document.getElementById('rowsContainer');
        if(!container || container.children.length === 0) {
          openLoading('홈페이지를 불러오는 중...');
          loadHomeChunk(1).then(() => {
            closeLoading();
            if(prev.scrollPosition) {
              setTimeout(() => {
                window.scrollTo(0, prev.scrollPosition);
              }, 100);
            }
          }).catch(() => {
            closeLoading();
          });
        } else if(prev.scrollPosition) {
          setTimeout(() => {
            window.scrollTo(0, prev.scrollPosition);
          }, 100);
        }
      }
    } else {
      // 기본 동작: 브라우저의 뒤로가기 사용
      history.back();
    }
  },
  openEditorProfile: async (user, updateURL = true) => {
    if(!user || !user.id) return;
    
    // [IMPACT-LOADING] 이미 에디터 박스에서 openLoading이 호출되었으므로 여기서는 생략
    // 단, 직접 호출되는 경우를 위해 조건부로 체크
    const loadingEl = document.getElementById('pageTransition');
    if(!loadingEl || !loadingEl.classList.contains('active')) {
      openLoading('에디터 프로필을 불러오는 중...');
    }
    
    const overlay = document.getElementById('editorsOverlay');
    
    // 수정됨: 에디터 프로필 페이지 열기 전에 먼저 스크롤 리셋
    overlay.scrollTop = 0;
    
    if(!overlay.classList.contains('active')) {
      overlay.classList.add('active');
      // 수정됨: 모바일과 데스크탑 모두에서 메인 홈 스크롤 중단
      document.body.style.overflow = 'hidden';
    }
    
    document.getElementById('editorsGridWrapper').style.display = 'none';
    const section = document.getElementById('editorProfileSection');
    section.style.display = 'block';
    document.getElementById('editorProfileName').textContent = user.name || user.slug || '';
    document.getElementById('editorProfileBio').textContent = user.description || '';
    const grid = document.getElementById('editorPostsGrid');
    grid.innerHTML = '';
    document.getElementById('editorPostsLoading').textContent = '로딩 중...';
    
    if(state.editorsList.length === 0) {
      await loadEditors();
    }
    
    try {
      // 최적화: 에디터 게시물에서는 _embed 필요
      const res = await fetch(api(`posts?author=${user.id}&per_page=100`, true));
      const posts = await res.json();
      if(Array.isArray(posts) && posts.length > 0) {
        const uniquePosts = posts.filter((post, index, self) =>
          index === self.findIndex(p => p.id === post.id)
        );
        
        // 페이지네이션 설정 (검색 결과와 동일)
        const itemsPerPage = 12;
        const totalPages = Math.ceil(uniquePosts.length / itemsPerPage);
        let currentPage = 1;
        
        // 에디터 게시물 렌더링 함수
        const renderPage = (page) => {
          grid.innerHTML = '';
          const start = (page - 1) * itemsPerPage;
          const end = Math.min(start + itemsPerPage, uniquePosts.length);
          
          for(let i = start; i < end; i++) {
            state.postsCache[uniquePosts[i].id] = uniquePosts[i];
            const card = createCardNode(uniquePosts[i]);
            grid.appendChild(card);
          }
          
          // 페이지네이션 버튼 추가 (홈과 동일한 스타일)
          if(totalPages > 1) {
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination';
            paginationDiv.id = 'editorPagination';
            
            // 이전 버튼
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '«';
            prevBtn.disabled = page === 1;
            if(page > 1) {
              prevBtn.onclick = () => {
                currentPage = page - 1;
                renderPage(currentPage);
                document.getElementById('editorsOverlay').scrollTop = 0;
              };
            }
            paginationDiv.appendChild(prevBtn);
            
            // 모바일 감지
            const isMobile = window.innerWidth <= 640;
            const maxVisible = isMobile ? 5 : 7;
            
            // 페이지 번호 계산 (calculatePageNumbers 함수 사용)
            const pages = calculatePageNumbers(page, totalPages, maxVisible);
            
            pages.forEach((pageNum) => {
              if(pageNum === '...') {
                const dots = document.createElement('span');
                dots.textContent = '...';
                paginationDiv.appendChild(dots);
              } else {
                const btn = document.createElement('button');
                btn.textContent = pageNum;
                if(pageNum === page) {
                  btn.classList.add('active');
                  btn.disabled = true;
                } else {
                  btn.onclick = () => {
                    currentPage = pageNum;
                    renderPage(currentPage);
                    document.getElementById('editorsOverlay').scrollTop = 0;
                  };
                }
                paginationDiv.appendChild(btn);
              }
            });
            
            // 다음 버튼
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '»';
            nextBtn.disabled = page === totalPages;
            if(page < totalPages) {
              nextBtn.onclick = () => {
                currentPage = page + 1;
                renderPage(currentPage);
                document.getElementById('editorsOverlay').scrollTop = 0;
              };
            }
            paginationDiv.appendChild(nextBtn);
            
            grid.appendChild(paginationDiv);
          }
        };
        
        // 첫 페이지 렌더링
        renderPage(currentPage);
      }
      document.getElementById('editorPostsLoading').textContent = '';

      if(updateURL) {
        const newUrl = `${window.location.origin}/editors?editor=${user.id}`;
        history.pushState({page:'editor', id:user.id}, '', newUrl);
      }
      
      // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
      resetScrollTop('editors');
      await nextFrame();
      closeLoading();
    } catch(e) {
      console.error(e);
      document.getElementById('editorPostsLoading').textContent = '불러오기 실패';
      // [IMPACT-LOADING] 에러 시에도 로딩 해제
      closeLoading();
    }
  }
};
async function openNavlessSearch(updateURL = true) {
  // [IMPACT-LOADING] 즉시 로딩 표시
  openLoading('검색 페이지를 불러오는 중...');
  
  const overlay = document.getElementById('searchOverlay');
  // 수정됨: 검색 페이지 열기 전에 먼저 스크롤 리셋
  overlay.scrollTop = 0;
  overlay.classList.add('active');
  
  // 수정됨: 모바일과 데스크탑 모두에서 메인 홈 스크롤 중단
  document.body.style.overflow = 'hidden';
  
  // 메인 홈에서 검색창 진입 시 검색창 초기화 및 페이지네이션 제거
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('searchLoading').textContent = '';
  // 페이지네이션도 완전히 초기화
  const existingPagination = document.querySelector('#searchResults .pagination');
  if (existingPagination) {
    existingPagination.remove();
  }
  
  // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
  resetScrollTop('search');
  await nextFrame();
  closeLoading();
  
  document.getElementById('searchInput').focus();
  if(updateURL) {
    const newUrl = `${window.location.origin}/search`;
    history.pushState({page:'search'}, '', newUrl);
    updateMetaTags({
      title: 'SEARCH - IMPACT',
      description: 'IMPACT 게시물을 검색하세요.',
      url: newUrl
    });
  }
}
async function closeSearch() {
  // 메타태그 즉시 복원
  updateMetaTags({});
  
  document.getElementById('searchOverlay').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('searchInput').value = '';
  
  // 세션 스토리지 정리
  try {
    sessionStorage.removeItem('lastSearchQuery');
  } catch(e) {
    console.error('sessionStorage access failed:', e);
  }
  
  const newUrl = `${window.location.origin}${window.location.pathname}`;
  history.pushState({page:'home'}, '', newUrl);
  
  // [IMPACT-LOADING] 완료 후 스크롤 리셋 및 로딩 해제
  resetScrollTop('window');
  await nextFrame();
  closeLoading();
}
document.getElementById('globalNavSearch').addEventListener('keypress', (e) => {
  if(e.key === 'Enter') {
    e.preventDefault();
    const query = e.target.value.trim();
    if(query.length >= 1) {
      ui.toggleNav(true);
      openSearchWithQuery(query);
    }
  }
});
document.getElementById('searchInput').addEventListener('input', (e) => {
  clearTimeout(state.searchDebounce);
  const query = e.target.value.trim();
  if(query.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchLoading').textContent = '';
    return;
  }

  state.searchDebounce = setTimeout(() => {
    performSearch(query, 'fullSearch');
  }, 500);
});
async function performSearch(query, mode) {
  if(mode === 'fullSearch') {
    const resultsEl = document.getElementById('searchResults');
    const loadingEl = document.getElementById('searchLoading');
    resultsEl.innerHTML = '';
    loadingEl.textContent = '검색 중...';

    try {
      const res = await fetch(api(`posts?search=${encodeURIComponent(query)}&per_page=100&_embed`));
      const posts = await res.json();

      loadingEl.textContent = '';

      if(Array.isArray(posts) && posts.length > 0) {
        const uniquePosts = posts.filter((post, index, self) =>
          index === self.findIndex(p => p.id === post.id)
        );

        // 검색 결과 개수 표시 - 정중앙 배치
        const isDarkMode = document.body.classList.contains('dark-mode');
        loadingEl.innerHTML = `
          <div style="display:flex;justify-content:center;align-items:center;margin:32px 0;text-align:center;">
            <span style="font-size:18px;color:${isDarkMode ? '#e8e8e8' : '#666'};">
              <strong style="color:#ff6b35;font-weight:700;">'${query}'</strong>에 대한 검색 결과 : <span style="color:#ff6b35;font-weight:700;">${uniquePosts.length}</span>개
            </span>
          </div>
        `;
        
        // 페이지네이션 설정
        const itemsPerPage = 12;
        const totalPages = Math.ceil(uniquePosts.length / itemsPerPage);
        let currentPage = 1;
        
        // 검색 결과 렌더링 함수
        const renderPage = (page) => {
          resultsEl.innerHTML = '';
          const start = (page - 1) * itemsPerPage;
          const end = Math.min(start + itemsPerPage, uniquePosts.length);
          
          for(let i = start; i < end; i++) {
            state.postsCache[uniquePosts[i].id] = uniquePosts[i];
            const card = createCardNode(uniquePosts[i]);
            resultsEl.appendChild(card);
          }
          
          // 페이지네이션 버튼 추가 (홈과 동일한 스타일)
          if(totalPages > 1) {
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination';
            
            // 이전 버튼
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '«';
            prevBtn.disabled = page === 1;
            if(page > 1) {
              prevBtn.onclick = () => {
                currentPage = page - 1;
                renderPage(currentPage);
                document.getElementById('searchOverlay').scrollTop = 0;
              };
            }
            paginationDiv.appendChild(prevBtn);
            
            // 모바일 감지
            const isMobile = window.innerWidth <= 640;
            const maxVisible = isMobile ? 5 : 7;
            
            // 페이지 번호 계산 (calculatePageNumbers 함수 사용)
            const pages = calculatePageNumbers(page, totalPages, maxVisible);
            
            pages.forEach((pageNum) => {
              if(pageNum === '...') {
                const dots = document.createElement('span');
                dots.textContent = '...';
                paginationDiv.appendChild(dots);
              } else {
                const btn = document.createElement('button');
                btn.textContent = pageNum;
                if(pageNum === page) {
                  btn.classList.add('active');
                  btn.disabled = true;
                } else {
                  btn.onclick = () => {
                    currentPage = pageNum;
                    renderPage(currentPage);
                    document.getElementById('searchOverlay').scrollTop = 0;
                  };
                }
                paginationDiv.appendChild(btn);
              }
            });
            
            // 다음 버튼
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '»';
            nextBtn.disabled = page === totalPages;
            if(page < totalPages) {
              nextBtn.onclick = () => {
                currentPage = page + 1;
                renderPage(currentPage);
                document.getElementById('searchOverlay').scrollTop = 0;
              };
            }
            paginationDiv.appendChild(nextBtn);
            
            resultsEl.appendChild(paginationDiv);
          }
        };
        
        // 첫 페이지 렌더링
        renderPage(currentPage);
      } else {
        const textColor = document.body.classList.contains('dark-mode') ? '#fff' : '#000';
        loadingEl.innerHTML = `<div style="text-align:center;margin:32px 0;"><span style="font-size:18px;font-weight:600;color:${textColor};">검색 결과가 없습니다.</span></div>`;
      }
      
      // [IMPACT-LOADING] 검색 완료 후 로딩 해제
      await nextFrame();
      closeLoading();
    } catch(e) {
      console.error(e);
      loadingEl.innerHTML = `<span style="color:#e74c3c">검색 실패</span>`;
      // [IMPACT-LOADING] 에러 시에도 로딩 해제
      closeLoading();
    }
  }
}
async function openSearchWithQuery(query) {
  // [IMPACT-LOADING] 즉시 로딩 표시
  openLoading('검색 중...');
  
  const overlay = document.getElementById('searchOverlay');
  overlay.classList.add('active');
  
  if(window.innerWidth <= 680) {
    document.body.style.overflow = 'hidden';
  }

  // [IMPACT-LOADING] 스크롤 리셋
  resetScrollTop('search');
  await nextFrame();

  const searchInput = document.getElementById('searchInput');
  searchInput.value = query;

  performSearch(query, 'fullSearch');
}
async function checkURLAndLoadPost() {
  const pathname = window.location.pathname;
  const urlParams = new URLSearchParams(window.location.search);
  
  // 새로운 URL 패턴: /post/slug 또는 /post/id
  if(pathname.startsWith('/post/')) {
    const postSlugOrId = pathname.replace('/post/', '');
    
    // 숫자면 ID로 처리
    if(!isNaN(parseInt(postSlugOrId))) {
      openPostOverlayById(parseInt(postSlugOrId), false);
      return true;
    }
    
    // 문자열이면 slug로 처리 - API에서 게시물 검색
    try {
      const res = await fetch(api(`posts?slug=${postSlugOrId}&_embed`));
      if(res.ok) {
        const posts = await res.json();
        if(posts && posts.length > 0) {
          const post = posts[0];
          state.postsCache[post.id] = post;
          openPostOverlayById(post.id, false);
          return true;
        }
      }
    } catch(e) {
      console.error('게시물 slug 로드 실패:', e);
    }
    return true;
  }
  
  // 새로운 URL 패턴: /category/slug
  if(pathname.startsWith('/category/')) {
    const categorySlug = pathname.replace('/category/', '');
    router.openCategory(categorySlug, false);
    return true;
  }
  
  // 새로운 URL 패턴: /editors
  if(pathname === '/editors') {
    router.openEditors(false);
    return true;
  }
  
  // 새로운 URL 패턴: /about
  if(pathname === '/about') {
    router.openAbout(false);
    return true;
  }
  
  // 새로운 URL 패턴: /search
  if(pathname === '/search') {
    openNavlessSearch(false);
    return true;
  }

  // 이전 query parameter 방식도 지원 (하위 호환성)
  const postParam = urlParams.get('post');
  const categoryParam = urlParams.get('category');
  const editorParam = urlParams.get('editor');
  const pageParam = urlParams.get('page');

  if(postParam) {
    const postId = parseInt(postParam);
    if(!isNaN(postId)) {
      openPostOverlayById(postId, false);
      return true;
    }
  }

  if(categoryParam) {
    router.openCategory(categoryParam, false);
    return true;
  }

  if(editorParam) {
    const editorId = parseInt(editorParam);
    if(!isNaN(editorId)) {
      router.openEditors(false);
      setTimeout(async () => {
        if(state.editorsList.length === 0) {
          await loadEditors();
        }
        const editor = state.editorsList.find(e => e.id === editorId);
        if(editor) {
          router.openEditorProfile(editor, false);
        }
      }, 300);
      return true;
    }
  }

  if(pageParam === 'editors') {
    router.openEditors(false);
    return true;
  } else if(pageParam === 'about') {
    router.openAbout(false);
    return true;
  } else if(pageParam === 'search') {
    openNavlessSearch(false);
    return true;
  }

  // 이전 hash 방식도 지원 (하위 호환성)
  const hash = window.location.hash;

  if(hash.startsWith('#post-')) {
    const postId = hash.replace('#post-', '');
    if(postId && !isNaN(parseInt(postId))) {
      const newUrl = `${window.location.origin}/post/${postId}`;
      history.replaceState({page: 'post', id: parseInt(postId)}, '', newUrl);
      setTimeout(() => {
        openPostOverlayById(parseInt(postId), false);
      }, 100);
      return true;
    }
  } else if(hash.startsWith('#editor-')) {
    const editorId = hash.replace('#editor-', '');
    if(editorId && !isNaN(parseInt(editorId))) {
      const newUrl = `${window.location.origin}/editor/${editorId}`;
      history.replaceState({page: 'editor', id: parseInt(editorId)}, '', newUrl);
      router.openEditorProfile(parseInt(editorId), false);
      return true;
    }
  } else if(hash === '#editors') {
    const newUrl = `${window.location.origin}/editors`;
    history.replaceState({page: 'editors'}, '', newUrl);
    router.openEditors(false);
    return true;
  } else if(hash === '#about') {
    const newUrl = `${window.location.origin}/about`;
    history.replaceState({page: 'about'}, '', newUrl);
    router.openAbout(false);
    return true;
  } else if(hash === '#search') {
    const newUrl = `${window.location.origin}/search`;
    history.replaceState({page: 'search'}, '', newUrl);
    openNavlessSearch(false);
    return true;
  }

  return false;
}
window.addEventListener('popstate', async (e) => {
  const pathname = window.location.pathname;
  const postOverlay = document.getElementById('postOverlay');
  const imageModal = document.getElementById('imageModal');
  
  // 이미지 모달이 열려있으면 닫기 (히스토리 변경 없이)
  if(imageModal && (imageModal.style.display === 'flex' || imageModal.classList.contains('active'))) {
    closeImageModal(true);
    e.preventDefault();
    return;
  }
  
  // 게시물에서 뒤로가기 - 게시물이 열려있으면 닫고 이전 상태 복원
  if(postOverlay.classList.contains('active')) {
    postOverlay.classList.remove('active');
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');
    
    // 이전 상태가 존재하는 경우 복원하지 않고 그냥 종료
    // (URL이 이미 변경되었으므로 다시 처리됨)
    return;
  }
  
  // 먼저 새로운 URL 패턴 체크
  if(await checkURLAndLoadPost()) {
    return;
  }
  
  // 이전 query parameter 방식도 지원
  const urlParams = new URLSearchParams(window.location.search);
  const postParam = urlParams.get('post');
  const categoryParam = urlParams.get('category');
  const editorParam = urlParams.get('editor');
  const pageParam = urlParams.get('page');

  if(postParam) {
    const postId = parseInt(postParam);
    if(!isNaN(postId)) {
      setTimeout(() => {
        openPostOverlayById(postId, false);
      }, 50);
      return;
    }
  }

  if(categoryParam) {
    document.querySelectorAll('.post-overlay, .search-overlay, .about-page, .editors-overlay').forEach(el => {
      el.classList.remove('active');
    });
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');

    router.openCategory(categoryParam, false);
    return;
  }

  if(editorParam) {
    const editorId = parseInt(editorParam);
    if(!isNaN(editorId)) {
      document.querySelectorAll('.post-overlay, .search-overlay, .about-page, .category-overlay').forEach(el => {
        el.classList.remove('active');
      });
      document.body.style.overflow = '';
      document.getElementById('progressBar').classList.remove('active');
      document.getElementById('postHeaderBar').classList.remove('show');
      document.getElementById('postToTopBtn').classList.remove('show');

      if(!document.getElementById('editorsOverlay').classList.contains('active')) {
        router.openEditors(false);
      }

      setTimeout(async () => {
        if(state.editorsList.length === 0) {
          await loadEditors();
        }
        const editor = state.editorsList.find(e => e.id === editorId);
        if(editor) {
          router.openEditorProfile(editor, false);
        }
      }, 100);
      return;
    }
  }

  if(pageParam === 'editors') {
    // 게시물 오버레이가 활성화되어 있으면 먼저 닫기
    const postOverlay = document.getElementById('postOverlay');
    if(postOverlay.classList.contains('active')) {
      postOverlay.classList.remove('active');
    }
    
    // 모든 오버레이 닫기
    document.querySelectorAll('.post-overlay, .search-overlay, .about-page, .category-overlay').forEach(el => {
      el.classList.remove('active');
    });
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');

    // 에디터 오버레이 강제 활성화
    const editorsOverlay = document.getElementById('editorsOverlay');
    if(!editorsOverlay.classList.contains('active')) {
      router.openEditors(false);
    }
    return;
  } else if(pageParam === 'about') {
    // 게시물 오버레이가 활성화되어 있으면 먼저 닫기
    const postOverlay = document.getElementById('postOverlay');
    if(postOverlay.classList.contains('active')) {
      postOverlay.classList.remove('active');
    }
    
    document.querySelectorAll('.post-overlay, .search-overlay, .editors-overlay, .category-overlay').forEach(el => {
      el.classList.remove('active');
    });
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');

    router.openAbout(false);
    return;
  } else if(pageParam === 'search' || pathname === '/search') {
    // 게시물 오버레이가 활성화되어 있으면 먼저 닫기
    const postOverlay = document.getElementById('postOverlay');
    const wasFromPost = postOverlay.classList.contains('active');
    
    if(wasFromPost) {
      // 게시물에서 돌아온 경우 새로고침으로 검색 상태 복원
      window.location.reload();
      return;
    }
    
    // 다른 오버레이 닫기
    document.querySelectorAll('.about-page, .editors-overlay, .category-overlay').forEach(el => {
      el.classList.remove('active');
    });

    // 검색 오버레이 활성화
    const searchOverlay = document.getElementById('searchOverlay');
    if(!searchOverlay.classList.contains('active')) {
      searchOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // 세션 스토리지에서 검색어와 스크롤 위치 복원
    setTimeout(() => {
      const searchInput = document.getElementById('searchInput');
      if(searchInput) {
        try {
          const lastQuery = sessionStorage.getItem('lastSearchQuery');
          const scrollPos = sessionStorage.getItem('searchScrollPosition');
          
          if(lastQuery) {
            searchInput.value = lastQuery;
            // 검색 결과 다시 표시
            performSearch(lastQuery, 'fullSearch');
          }
          
          // 스크롤 위치 복원
          if(scrollPos && searchOverlay) {
            searchOverlay.scrollTop = parseInt(scrollPos);
          }
        } catch(e) {
          console.error('sessionStorage access failed:', e);
        }
        searchInput.focus();
      }
    }, 100);
    
    return;
  }

  if(!postParam && !categoryParam && !editorParam && !pageParam) {
    document.querySelectorAll('.category-overlay, .post-overlay, .search-overlay, .about-page, .editors-overlay').forEach(el => {
      el.classList.remove('active');
    });
    document.body.style.overflow = '';
    document.getElementById('progressBar').classList.remove('active');
    document.getElementById('postHeaderBar').classList.remove('show');
    document.getElementById('postToTopBtn').classList.remove('show');
  }
});

// 즉시 실행: 초기 로딩 최적화를 위해 DOMContentLoaded 제거
(function() {
  // DOM 준비 체크 함수
  function ready(fn) {
    if (document.readyState !== 'loading') {
      fn();
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  }
  
  // 이미지 모달 이벤트는 DOM이 준비된 후 등록
  ready(() => {
    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
      imageModal.addEventListener('click', (e) => {
        if(e.target.id === 'imageModal' || e.target.classList.contains('image-modal')) {
          closeImageModal();
        }
      });
    }
  });
  
  // 초기 로딩 로직 - 즉시 실행
  ready(async () => {
    renderNavList();

    const loadingEl = document.getElementById('homeLoading');
    if (loadingEl) {
      loadingEl.textContent = '페이지를 불러오는 중...';
    }

    // 수정됨: 새로고침 시 항상 메인 콘텐츠를 미리 로드
    // 메인 홈 콘텐츠를 백그라운드로 로드
    const loadHomeInBackground = async () => {
      try {
        await loadHomeChunk(1);
        
      } catch(err) {
        console.error('Background home loading failed:', err);
      }
    };

    // 중요: await를 사용하여 checkURLAndLoadPost의 결과를 기다림
    const hasSpecificPage = await checkURLAndLoadPost();

    if(!hasSpecificPage) {
      // 메인 페이지인 경우 즉시 로드
      loadHomeChunk(1)
        .then(() => {
          
        })
        .catch((err) => {
          console.error('Home loading failed:', err);
          if (loadingEl) {
            loadingEl.textContent = '페이지를 불러오지 못했습니다. 새로고침을 시도해주세요.';
          }
        });
    } else {
      // 수정됨: 서브 페이지에서 시작한 경우도 백그라운드로 메인 콘텐츠 로드
      if (loadingEl) {
        loadingEl.textContent = '';
      }
      // 약간의 디레이 후 백그라운드로 메인 콘텐츠 로드
      setTimeout(() => {
        loadHomeInBackground();
      }, 1000);
    }
    
    // 리사이즈 및 키보드 이벤트는 지연 등록하여 초기 로딩 최적화
    setTimeout(() => {
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if(!document.getElementById('categoryOverlay').classList.contains('active') &&
             !document.getElementById('postOverlay').classList.contains('active') &&
             !document.getElementById('searchOverlay').classList.contains('active') &&
             !document.getElementById('aboutPage').classList.contains('active') &&
             !document.getElementById('editorsOverlay').classList.contains('active')) {
            state.homeLoadPromise = null;
            loadHomeChunk(state.homePage || 1);
          }
        }, 300);
      });
      
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
          console.log('⚡ 글로벌 ESC 키 눌림');
          
          // 이미지 뷰어 체크
          const imageViewerOverlay = document.querySelector('.image-viewer-overlay');
          if(imageViewerOverlay && imageViewerOverlay.classList.contains('active')) {
            console.log('⚡ image-viewer-overlay 활성화됨 - 글로벌 핸들러 스킵');
            return;
          }
          
          if(document.getElementById('imageModal').classList.contains('active')) {
            console.log('⚡ imageModal 닫기');
            closeImageModal();
          } else if(document.getElementById('postOverlay').classList.contains('active')) {
            console.log('⚡ postOverlay 닫기 - router.closePost 호출');
            router.closePost();
          } else if(document.getElementById('searchOverlay').classList.contains('active')) {
            closeSearch();
          } else if(document.getElementById('categoryOverlay').classList.contains('active')) {
            router.closeCategory();
          } else if(document.getElementById('editorsOverlay').classList.contains('active')) {
            router.closeEditors();
          } else if(document.getElementById('aboutPage').classList.contains('active')) {
            router.closeAbout();
          } else if(document.getElementById('navOverlay').classList.contains('active')) {
            ui.toggleNav(true);
          }
        }
      });
    }, 100);
  });
})();

// 검색 기능 개선: 중복 제거 및 키워드 매칭 정확도 향상
function performSearch(query, source = 'overlay') {
  if(!query || query.trim() === '') {
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchLoading').textContent = '';
    // 빈 검색어는 세션 스토리지에서 제거
    try {
      sessionStorage.removeItem('lastSearchQuery');
    } catch(e) {
      console.error('sessionStorage access failed:', e);
    }
    return;
  }
  
  const loadingEl = document.getElementById('searchLoading');
  loadingEl.textContent = '검색 중...';
  
  const searchTerm = query.toLowerCase().trim();
  
  // 검색어를 세션 스토리지에 저장
  try {
    sessionStorage.setItem('lastSearchQuery', query);
  } catch(e) {
    console.error('sessionStorage access failed:', e);
  }
  
  // 검색 결과도 세션 스토리지에 저장 (캐시용)
  try {
    const cachedResults = {};
    results.forEach(post => {
      cachedResults[post.id] = post;
    });
    sessionStorage.setItem('lastSearchResults', JSON.stringify(results.map(p => p.id)));
  } catch(e) {
    console.error('sessionStorage save failed:', e);
  }
  
  const results = [];
  const seen = new Set(); // 중복 방지
  
  // 모든 캐시된 게시물에서 검색
  Object.values(state.postsCache).forEach(post => {
    // 중복 체크
    if(seen.has(post.id)) return;
    
    const title = (post.title?.rendered || '').toLowerCase();
    const content = stripTags(post.content?.rendered || '').toLowerCase();
    const excerpt = stripTags(post.excerpt?.rendered || '').toLowerCase();
    const authorName = (post._embedded?.author?.[0]?.name || '').toLowerCase();
    
    // 키워드가 제목, 내용, 발췌문, 에디터 이름에 포함되는 경우만
    if (title.includes(searchTerm) || 
        content.includes(searchTerm) || 
        excerpt.includes(searchTerm) || 
        authorName.includes(searchTerm)) {
      seen.add(post.id);
      results.push(post);
    }
  });
  
  // 검색 결과 표시
  const resultsContainer = document.getElementById('searchResults');
  resultsContainer.innerHTML = '';
  
  if(results.length === 0) {
    const textColor = document.body.classList.contains('dark-mode') ? '#fff' : '#000';
    loadingEl.innerHTML = `<div style="text-align:center;margin:32px 0;"><span style="font-size:18px;font-weight:600;color:${textColor};">"${query}"에 대한 검색 결과가 없습니다.</span></div>`;
  } else {
    // 페이지네이션 설정
    const itemsPerPage = 12;
    const totalPages = Math.ceil(results.length / itemsPerPage);
    let currentPage = 1;
    
    // 검색 결과 개수 표시 - 이미지 예시처럼 스타일링
    const isDarkMode = document.body.classList.contains('dark-mode');
    loadingEl.innerHTML = `
      <div style="text-align:left;margin:24px 0;padding:16px 0;">
        <div style="display:inline-block;">
          <span style="background:#ff6b35;color:#fff;font-weight:800;font-size:18px;padding:4px 8px;border-radius:4px;">${query}</span>
          <span style="color:${isDarkMode ? '#e8e8e8' : '#111'};font-weight:800;font-size:18px;margin-left:8px;">에 대한 검색 결과 :</span>
          <span style="background:#c3ff00;color:#111;font-weight:800;font-size:18px;padding:4px 8px;border-radius:4px;margin-left:8px;">${results.length}개</span>
        </div>
      </div>
    `;
    
    // 검색 결과 렌더링 함수
    const renderPage = (page) => {
      resultsContainer.innerHTML = '';
      const paginationContainer = document.getElementById('searchPagination');
      if(paginationContainer) {
        paginationContainer.innerHTML = '';
      }
      
      const start = (page - 1) * itemsPerPage;
      const end = Math.min(start + itemsPerPage, results.length);
      
      for(let i = start; i < end; i++) {
        const card = createCardNode(results[i]);
        resultsContainer.appendChild(card);
      }
      
      // 페이지네이션 버튼 추가 (별도 컨테이너에)
      if(totalPages > 1 && paginationContainer) {
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination';
        
        // 이전 버튼
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '«';
        prevBtn.disabled = page === 1;
        if(page > 1) {
          prevBtn.onclick = () => {
            currentPage = page - 1;
            renderPage(currentPage);
            document.getElementById('searchOverlay').scrollTop = 0;
          };
        }
        paginationDiv.appendChild(prevBtn);
        
        // 모바일 감지
        const isMobile = window.innerWidth <= 640;
        const maxVisible = isMobile ? 5 : 7;
        
        // 페이지 번호 계산
        const pages = calculatePageNumbers(page, totalPages, maxVisible);
        
        pages.forEach((pageNum) => {
          if(pageNum === '...') {
            const dots = document.createElement('span');
            dots.textContent = '...';
            paginationDiv.appendChild(dots);
          } else {
            const btn = document.createElement('button');
            btn.textContent = pageNum;
            if(pageNum === page) {
              btn.classList.add('active');
              btn.disabled = true;
            } else {
              btn.onclick = () => {
                currentPage = pageNum;
                renderPage(currentPage);
                document.getElementById('searchOverlay').scrollTop = 0;
              };
            }
            paginationDiv.appendChild(btn);
          }
        });
        
        // 다음 버튼
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '»';
        nextBtn.disabled = page === totalPages;
        if(page < totalPages) {
          nextBtn.onclick = () => {
            currentPage = page + 1;
            renderPage(currentPage);
            document.getElementById('searchOverlay').scrollTop = 0;
          };
        }
        paginationDiv.appendChild(nextBtn);
        
        paginationContainer.appendChild(paginationDiv);
      }
    };
    
    // 첫 페이지 렌더링
    renderPage(currentPage);
  }
}

// 공유 기능 함수들
function shareToFacebook() {
  const url = encodeURIComponent(window.location.href);
  const title = encodeURIComponent(document.querySelector('.post-info h1')?.textContent || document.title);
  
  // 모바일 디바이스 감지
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  
  if (isMobile) {
    // 모바일에서는 페이스북 앱 딥링크 시도 후 웹으로 폴백
    const fbAppUrl = `fb://facewebmodal/f?href=https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`;
    const fbWebUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`;
    
    // 현재 창에서 열기 (모바일에서 더 안정적)
    window.location.href = fbWebUrl;
  } else {
    // 데스크톱에서는 팝업 사용
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank', 'width=600,height=400');
  }
}

function shareToTwitter() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent(document.title);
  window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function shareToLinkedIn() {
  const url = encodeURIComponent(window.location.href);
  window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
}

function shareEmail() {
  const url = window.location.href;
  const title = document.title;
  const body = `${title}\n\n${url}`;
  window.location.href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
}

function shareToKakao() {
  const url = window.location.href;
  const title = document.title;
  
  // 카카오톡 공유하기 (웹 URL 복사)
  if(navigator.share) {
    navigator.share({
      title: title,
      url: url
    }).catch(err => {
      
      copyLink();
    });
  } else {
    // Web Share API를 지원하지 않으면 링크 복사
    copyLink();
  }
}

function copyLink() {
  const url = window.location.href;
  
  if(navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(() => {
      alert('링크가 복사되었습니다!');
    }).catch(err => {
      console.error('복사 실패:', err);
      fallbackCopyLink(url);
    });
  } else {
    fallbackCopyLink(url);
  }
}

function fallbackCopyLink(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-999999px';
  textArea.style.top = '-999999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
    textArea.remove();
    alert('링크가 복사되었습니다!');
  } catch(err) {
    console.error('복사 실패:', err);
    textArea.remove();
    alert('링크 복사에 실패했습니다. 수동으로 복사해주세요.');
  }
}

// 검색 입력 이벤트 리스너
const searchInput = document.getElementById('searchInput');
if(searchInput) {
  searchInput.addEventListener('input', (e) => {
    clearTimeout(state.searchDebounce);
    state.searchDebounce = setTimeout(() => {
      performSearch(e.target.value, 'overlay');
    }, 300);
  });
}

const globalNavSearch = document.getElementById('globalNavSearch');
if(globalNavSearch) {
  globalNavSearch.addEventListener('input', (e) => {
    clearTimeout(state.searchDebounce);
    state.searchDebounce = setTimeout(() => {
      performSearch(e.target.value, 'nav');
    }, 300);
  });
  
  globalNavSearch.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      e.preventDefault();
      const query = e.target.value.trim();
      if(query) {
        ui.toggleNav(true);
        openNavlessSearch();
        setTimeout(() => {
          const searchInput = document.getElementById('searchInput');
          if(searchInput) {
            searchInput.value = query;
            performSearch(query, 'fullSearch');
          }
        }, 100);
      }
    }
  });
}

// popstate 이벤트 핸들러 (뒤로가기/앞으로가기 처리) - 중복 제거
window.addEventListener('popstate', async (e) => {
  const path = window.location.pathname;
  const imageModal = document.getElementById('imageModal');
  
  // 이미지 모달이 열려있으면 닫기 (히스토리 변경 없이)
  if(imageModal && (imageModal.style.display === 'flex' || imageModal.classList.contains('active'))) {
    closeImageModal(true);
    e.preventDefault();
    return;
  }
  
  // /post/게시물슬러그 형식 체크
  if(path.startsWith('/post/')) {
    const slug = path.replace('/post/', '');
    if(slug) {
      await openPostOverlayBySlug(slug, false);
      return;
    }
  }
  
  // /category/카테고리명 형식 체크
  if(path.startsWith('/category/')) {
    const slug = path.replace('/category/', '');
    if(slug && CATEGORIES[slug]) {
      router.openCategory(slug, false);
      return;
    }
  }
  
  // /search 체크
  if(path === '/search') {
    await openNavlessSearch(false);
    // 저장된 검색 상태 복원
    try {
      const savedQuery = sessionStorage.getItem('lastSearchQuery');
      const savedScrollPos = sessionStorage.getItem('searchScrollPosition');
      
      if(savedQuery) {
        const searchInput = document.getElementById('searchInput');
        if(searchInput) {
          searchInput.value = savedQuery;
          // 검색 실행
          await performSearch(savedQuery, 'overlay');
          
          // 스크롤 위치 복원
          if(savedScrollPos) {
            setTimeout(() => {
              const searchOverlay = document.getElementById('searchOverlay');
              if(searchOverlay) {
                searchOverlay.scrollTop = parseInt(savedScrollPos, 10);
              }
            }, 100);
          }
        }
      }
    } catch(e) {
      console.error('검색 상태 복원 실패:', e);
    }
    return;
  }
  
  // /about 체크
  if(path === '/about') {
    await router.openAbout(false);
    return;
  }
  
  // /editors 체크
  if(path === '/editors') {
    await router.openEditors(false);
    return;
  }
  
  // 기타 경로는 홈으로 처리
  const overlay = document.getElementById('postOverlay');
  const categoryOverlay = document.getElementById('categoryOverlay');
  const searchOverlay = document.getElementById('searchOverlay');
  const aboutPage = document.getElementById('aboutPage');
  const editorsOverlay = document.getElementById('editorsOverlay');
  
  overlay.classList.remove('active');
  categoryOverlay.classList.remove('active');
  searchOverlay.classList.remove('active');
  aboutPage.classList.remove('active');
  editorsOverlay.classList.remove('active');
  document.body.style.overflow = '';
  
  // 홈 콘텐츠가 없으면 로드
  const container = document.getElementById('rowsContainer');
  if(!container || container.children.length === 0) {
    await loadHomeChunk(1);
  }
});

// 페이지 초기 로드 시 URL 체크 및 라우팅
async function handleInitialRoute() {
  const path = window.location.pathname;
  
  // /post/게시물슬러그 형식 체크
  if(path.startsWith('/post/')) {
    const slug = path.replace('/post/', '');
    if(slug) {
      await openPostOverlayBySlug(slug, false);
      return;
    }
  }
  
  // /category/카테고리명 형식 체크
  if(path.startsWith('/category/')) {
    const slug = path.replace('/category/', '');
    if(slug && CATEGORIES[slug]) {
      router.openCategory(slug, false);
      return;
    }
  }
  
  // /search 체크
  if(path === '/search') {
    await openNavlessSearch(false);
    // 저장된 검색 상태 복원
    try {
      const savedQuery = sessionStorage.getItem('lastSearchQuery');
      const savedScrollPos = sessionStorage.getItem('searchScrollPosition');
      
      if(savedQuery) {
        const searchInput = document.getElementById('searchInput');
        if(searchInput) {
          searchInput.value = savedQuery;
          // 검색 실행
          await performSearch(savedQuery, 'overlay');
          
          // 스크롤 위치 복원
          if(savedScrollPos) {
            setTimeout(() => {
              const searchOverlay = document.getElementById('searchOverlay');
              if(searchOverlay) {
                searchOverlay.scrollTop = parseInt(savedScrollPos, 10);
              }
            }, 100);
          }
        }
      }
    } catch(e) {
      console.error('검색 상태 복원 실패:', e);
    }
    return;
  }
  
  // /about 체크
  if(path === '/about') {
    await router.openAbout(false);
    return;
  }
  
  // /editors 체크
  if(path === '/editors') {
    await router.openEditors(false);
    return;
  }
  
  // 기본: 홈 로드
  renderNavList();
  loadHomeChunk(1);
}

// 화면 회전 감지 및 레이아웃 재렌더링
let resizeTimeout;
let lastOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';

window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    const currentOrientation = window.innerWidth > window.innerHeight ? 'landscape' : 'portrait';
    
    // 방향이 바뀌었고 홈 페이지에 있을 때만 재렌더링
    if (currentOrientation !== lastOrientation) {
      lastOrientation = currentOrientation;
      
      const container = document.getElementById('rowsContainer');
      if (container && container.children.length > 0) {
        // 현재 표시된 게시물들을 가져와서 재렌더링
        const posts = [];
        Object.values(state.postsCache).forEach(post => {
          // 현재 페이지의 게시물들만 가져오기
          if (post && post.id) {
            posts.push(post);
          }
        });
        
        if (posts.length > 0) {
          // 날짜순으로 정렬
          posts.sort((a, b) => new Date(b.date) - new Date(a.date));
          
          // 현재 페이지에 해당하는 게시물만 표시
          const startIndex = (state.homePage - 1) * HOME_PER_PAGE;
          const endIndex = startIndex + HOME_PER_PAGE;
          const currentPagePosts = posts.slice(startIndex, endIndex);
          
          container.innerHTML = '';
          
          const isMobile = window.innerWidth <= 680;
          const isIpadPortrait = window.innerWidth > 680 && window.innerWidth <= 1100 && window.innerHeight > window.innerWidth;
          
          if (isMobile) {
            renderMobileLayout(currentPagePosts, container);
          } else if (isIpadPortrait) {
            renderIpadPortraitLayout(currentPagePosts, container);
          } else {
            renderDesktopLayout(currentPagePosts, container);
          }
        }
      }
    }
  }, 300);
});

// 페이지 로드 완료 시 초기 라우팅 실행 - 최적화: 즉시 실행
(function() {
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleInitialRoute);
  } else {
    handleInitialRoute();
  }
})();

// ⚡ 성능 최적화: 이미지 lazy loading 강화 - 최적화: 중복 제거
// 브라우저 네이티브 lazy loading을 우선 사용
if (!('loading' in HTMLImageElement.prototype)) {
  // 구형 브라우저만 polyfill 로드
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js';
  document.body.appendChild(script);
}

// ⚡ 모바일 성능 최적화: 네트워크 상태 감지
function detectNetworkAndOptimize() {
  const connection = navigator.connection?.effectiveType || '4g';
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  const isSaveData = navigator.connection?.saveData || false;
  
  
  
  // 네트워크 속도별 최적화
  if (connection === 'slow-2g' || connection === '2g') {
    state.mobileOptimization = { maxPrefetch: 2, imageQuality: 'low', lazy: true };
    
  } else if (connection === '3g') {
    state.mobileOptimization = { maxPrefetch: 5, imageQuality: 'medium', lazy: true };
    
  } else if (connection === '4g') {
    state.mobileOptimization = { maxPrefetch: isMobile ? 10 : 15, imageQuality: 'high', lazy: true };
    
  }
  
  // 절약 모드 감지
  if (isSaveData) {
    state.mobileOptimization.maxPrefetch = Math.max(2, Math.floor(state.mobileOptimization.maxPrefetch / 2));
    
  }
  
  // 모바일 이미지 최적화
  if (isMobile) {
    optimizeMobileImages();
  }
  
  return state.mobileOptimization;
}

// ⚡ 이미지 최적화: 모바일용 작은 이미지 우선 로드
function optimizeMobileImages() {
  const images = document.querySelectorAll('img[data-src], img[src*="impactceo.art"]');
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  images.forEach(img => {
    if (isMobile) {
      // 모바일: 화질 낮춤 + 크기 축소
      const src = img.dataset.src || img.src;
      if (src && !src.includes('?')) {
        // WordPress 이미지 최적화 파라미터
        img.dataset.src = `${src}?w=600&q=75`;  // 모바일: 600px, 75% 화질
      }
      
      // loading="lazy" 속성 자동 추가
      if (!img.hasAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
      
      // 모바일에서 aspect-ratio 설정
      if (!img.style.aspectRatio) {
        img.style.aspectRatio = '16/9';
      }
    }
  });
  
  
}

// ⚡ 모바일 폰트 최적화: font-display: swap 사용
function optimizeMobileFonts() {
  // 기존 폰트 링크 제거 (비동기 로드)
  const fontLink = document.querySelector('link[href*="fonts.googleapis.com"]');
  if (fontLink) {
    fontLink.setAttribute('rel', 'preload');
    fontLink.setAttribute('as', 'style');
    fontLink.setAttribute('onload', "this.rel='stylesheet'");
  }
}

// ⚡ 모바일 레이아웃 최적화: 보이는 것부터 렌더링
function optimizeMobileLayout() {
  const cards = document.querySelectorAll('.card, .magazine-large');
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  if (isMobile) {
    // 모바일: 스크롤 범위 내 카드만 렌더링
    cards.forEach(card => {
      const rect = card.getBoundingClientRect();
      const isVisible = rect.top < window.innerHeight + 500;
      
      if (!isVisible) {
        // 화면 밖: 렌더링 중지
        card.style.contentVisibility = 'auto';
      }
    });
  }
}

// ⚡ 모바일 JavaScript 최소화: 불필요한 기능 비활성화
function minimizeJavaScriptForMobile() {
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  if (isMobile) {
    
    
    // 모바일: 프리페치 개수 줄이기
    if (state.mobileOptimization?.maxPrefetch) {
      const originalMaxPrefetch = 15;
      const mobileMaxPrefetch = state.mobileOptimization.maxPrefetch;
      
      
    }
    
    // 모바일: 무거운 애니메이션 비활성화
    const style = document.createElement('style');
    style.textContent = `
      @media (max-width: 768px) {
        * { animation-duration: 0s !important; }
        .page-transition { animation: none !important; }
        .skeleton-loading { animation: none !important; }
      }
    `;
    document.head.appendChild(style);
  }
}

// ⚡ Viewport 기반 리소스 로드 (모바일 최적화)
function loadResourcesBasedOnViewport() {
  const images = document.querySelectorAll('img[data-src]');
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const dataSrc = img.dataset.src;
        
        if (dataSrc) {
          // 모바일: 화질 낮춤
          if (isMobile) {
            img.src = dataSrc.includes('?') ? `${dataSrc}&w=600` : `${dataSrc}?w=600`;
          } else {
            img.src = dataSrc;
          }
          
          img.removeAttribute('data-src');
          observer.unobserve(img);
          
        }
      }
    });
  }, {
    rootMargin: '50px',  // 모바일: 50px 미리 로드 (배터리 절감)
    threshold: 0.01
  });
  
  images.forEach(img => observer.observe(img));
}

// ⚡ 모바일 CSS 미니마이징: 불필요한 스타일 제거
function minifyMobileCSS() {
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  if (isMobile) {
    // 모바일: 데스크톱 전용 스타일 제거
    const desktopStyles = document.querySelectorAll('style, link[rel="stylesheet"]');
    
    desktopStyles.forEach(style => {
      const content = style.textContent || '';
      if (content.includes('@media (min-width: 1281px)')) {
        // 데스크톱 CSS는 병렬 로드하되 우선순위 낮춤
        style.setAttribute('media', '(min-width: 1281px)');
      }
    });
  }
}

// ⚡ 주요 콘텐츠 우선 로드 (모바일 LCP 최적화)
function prioritizeAboveTheFoldContent() {
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  
  if (isMobile) {
    // 모바일: 첫 번째 이미지에 fetchpriority="high" 설정
    const firstImage = document.querySelector('img[data-src], img');
    if (firstImage) {
      firstImage.fetchPriority = 'high';
      firstImage.loading = 'eager';  // 즉시 로드
      
    }
    
    // 모바일: 첫 번째 텍스트 콘텐츠도 우선 로드
    const firstText = document.querySelector('h1, h2, .title, .headline');
    if (firstText) {
      firstText.style.contentVisibility = 'visible';
    }
  }
}

// ⚡ 모바일 API 응답 캐싱 (30분)
async function cacheAPIResponseForMobile(postId) {
  const cacheKey = `post_${postId}_mobile`;
  const cached = sessionStorage.getItem(cacheKey);
  
  if (cached) {
    
    return JSON.parse(cached);
  }
  
  try {
    const response = await fetch(api(`posts/${postId}`, true));
    if (!response.ok) throw new Error('API 실패');
    
    const data = await response.json();
    sessionStorage.setItem(cacheKey, JSON.stringify(data));
    
    
    return data;
  } catch (e) {
    console.warn(`⚠️ API 캐싱 실패: ${postId}`, e.message);
    return null;
  }
}

// MutationObserver 최적화 - debounce 적용
let observerTimeout;
const mutationObserver = new MutationObserver((mutations) => {
  clearTimeout(observerTimeout);
  observerTimeout = setTimeout(() => {
    mutations.forEach((mutation) => {
      mutation.addedNodes.forEach((node) => {
        if (node.tagName === 'IMG' && node.dataset.src) {
          imageObserver.observe(node);
        } else if (node.querySelectorAll) {
          node.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
          });
        }
      });
    });
  }, 50); // 50ms debounce
});
mutationObserver.observe(document.body, {
  childList: true,
  subtree: true
});
// ⚡ 성능 최적화: 리소스 힌트 추가
const resourceHints = [
  { rel: 'dns-prefetch', href: 'https://impactceo.art' },
  { rel: 'preconnect', href: 'https://impactceo.art' }
];
resourceHints.forEach(hint => {
  const link = document.createElement('link');
  link.rel = hint.rel;
  link.href = hint.href;
  if (hint.rel === 'preconnect') link.crossOrigin = '';
  document.head.appendChild(link);
});

// ⚡ 프리렌더링 최적화: Speculation Rules 초기화 - 침묵 모드 (로그 없음)
function initSpeculationRulesEarly() {
  try {
    const speculationScript = document.getElementById('speculationRules');
    if (!speculationScript) return;
    
    const currentUrl = window.location.origin;
    const initialUrls = [
      `${currentUrl}/`,
      `${currentUrl}/?sort=popular`,
      `${currentUrl}/?sort=latest`,
    ];

    const rules = {
      prefetch: [{
        source: "list",
        urls: initialUrls
      }],
      prerender: [{
        source: "list",
        urls: initialUrls.slice(0, 2)
      }]
    };

    speculationScript.textContent = JSON.stringify(rules, null, 2);
    // 로그 제거 - 침묵 모드
  } catch (e) {
    // 에러 로그 제거
  }
}

// ⚡ 즉시 초기화 (DOM ready 전) - 비동기 없이 즉시
if (document.readyState === 'loading') {
  // 스크립트가 head에 있으면 즉시 실행
  initSpeculationRulesEarly();
  document.addEventListener('DOMContentLoaded', initSpeculationRulesEarly);
} else {
  initSpeculationRulesEarly();
}

// ⚡ 프리렌더링 최적화: Speculation Rules 동적 업데이트 (침묵 모드)
function updateSpeculationRules(urls = []) {
  try {
    const speculationScript = document.getElementById('speculationRules');
    if (!speculationScript) return;
    
    // 중복 제거 및 유효성 검사
    const uniqueUrls = [...new Set(urls)].filter(url => {
      return url && typeof url === 'string' && (url.startsWith('http') || url.startsWith('/'));
    });
    
    const prerender = uniqueUrls.slice(0, 8);
    const prefetch = uniqueUrls.slice(0, 20);
    
    const rules = {
      prefetch: [{
        source: "list",
        urls: prefetch
      }],
      prerender: [{
        source: "list", 
        urls: prerender
      }]
    };
    
    speculationScript.textContent = JSON.stringify(rules, null, 2);
    // 로그 제거 - 침묵 모드
  } catch (e) {
    // 에러 로그 제거
  }
}

// ⚡ 향상된 페이지 프리렌더링 함수 - 게시물, 에디터, 카테고리 모두 포함
function prerenderRelatedPages() {
  const currentUrl = window.location.origin;
  const urls = new Set();
  
  // 1️⃣ 홈페이지 항상 프리렌더링
  urls.add(`${currentUrl}/`);
  
  // 2️⃣ 현재 보이는 게시물들의 URL 수집 (viewport 내)
  const cards = document.querySelectorAll('.magazine-large, .card');
  let postCount = 0;
  
  cards.forEach(card => {
    if (postCount >= 12) return; // 최대 12개 게시물 (기존 8에서 증가)
    
    const rect = card.getBoundingClientRect();
    // viewport 위아래 300px 범위 내의 요소
    const isInViewport = rect.top >= -300 && rect.top <= window.innerHeight + 300;
    
    if (isInViewport) {
      const onClick = card.getAttribute('onclick');
      if (onClick) {
        const match = onClick.match(/openPostOverlayById\((\d+)\)/);
        if (match && match[1]) {
          const postUrl = `${currentUrl}/?p=${match[1]}`;
          urls.add(postUrl);
          postCount++;
          
        }
      }
    }
  });
  
  // 3️⃣ 카테고리 페이지 프리렌더링 (모든 네비게이션 링크)
  const navLinks = document.querySelectorAll('.nav-list li, [data-category]');
  let catCount = 0;
  navLinks.forEach((link) => {
    if (catCount >= 6) return; // 6개로 증가
    const slug = link.dataset?.slug || link.textContent?.trim().toLowerCase();
    if (slug && slug !== 'home') {
      const catUrl = `${currentUrl}/?category=${slug}`;
      urls.add(catUrl);
      
      catCount++;
    }
  });
  
  // 4️⃣ 에디터 페이지 프리렌더링
  try {
    const editorLink = document.querySelector('[href*="editor"], [onclick*="editor"], .editor-button');
    if (editorLink) {
      const editorUrls = [
        `${currentUrl}/editor/`,
        `${currentUrl}/?page=editor`,
        `${currentUrl}/?mode=editor`
      ];
      editorUrls.forEach(url => urls.add(url));
      
    }
  } catch (e) {
    
  }
  
  // 5️⃣ 정렬/필터 페이지 (인기순, 최신순, 조회수 등)
  const sortPages = [
    `${currentUrl}/?sort=popular`,
    `${currentUrl}/?sort=latest`,
    `${currentUrl}/?sort=views`,
    `${currentUrl}/?sort=trending`
  ];
  sortPages.forEach(url => urls.add(url));
  
  
  // 6️⃣ 검색 페이지 (준비)
  urls.add(`${currentUrl}/?search=`);
  
  // 7️⃣ 페이지네이션 (다음 페이지)
  const pageParams = ['?page=2', '?page=3', '?offset=10', '?page=2&category='];
  pageParams.forEach(param => {
    urls.add(`${currentUrl}/${param}`);
  });
  
  
  const finalUrls = Array.from(urls);
  
  updateSpeculationRules(finalUrls);
}

// ⚡ 홈화면 게시물 프리페치 - 보이는 게시물들을 미리 로드 (향상된 버전)
function prefetchVisiblePosts() {
  const cards = document.querySelectorAll('.magazine-large, .card');
  let count = 0;
  const maxPrefetch = 15; // 최대 15개 게시물 프리페치
  const fetched = [];
  
  // 병렬 API 요청 (최대 3개 동시)
  const concurrencyLimit = 3;
  let activeRequests = 0;

  cards.forEach(card => {
    if (count >= maxPrefetch) return;
    
    const rect = card.getBoundingClientRect();
    const isVisible = rect.top >= -500 && rect.top <= window.innerHeight + 800;
    
    if (isVisible) {
      const onClick = card.getAttribute('onclick');
      if (onClick) {
        const match = onClick.match(/openPostOverlayById\((\d+)\)/);
        if (match && match[1]) {
          const postId = parseInt(match[1]);
          
          // 캐시 확인
          if (!state.postsCache[postId] || !state.postsCache[postId].content) {
            // 동시성 제한으로 병렬 실행
            if (activeRequests < concurrencyLimit) {
              activeRequests++;
              prefetchPostParallel(postId, () => {
                activeRequests--;
              });
              fetched.push(postId);
              count++;
            }
          }
        }
      }
    }
  });
  
  if (count > 0) {
    
  }
}

// ⚡ 병렬 API 프리페치 (더 짧은 타임아웃)
async function prefetchPostParallel(postId, callback) {
  if (!postId || state.postsCache[postId]?.content) {
    if (callback) callback();
    return;
  }

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3초 타임아웃 (기존 5s에서 단축)

    const res = await fetch(api(`posts/${postId}`, true), {
      signal: controller.signal,
      priority: 'low'
    });

    clearTimeout(timeoutId);

    if (!res.ok) {
      console.warn(`⚠️ 게시물 프리페치 실패 (${res.status}): ID ${postId}`);
      if (callback) callback();
      return;
    }

    const post = await res.json();
    state.postsCache[postId] = post;
    
  } catch(e) {
    if (e.name !== 'AbortError') {
      console.warn(`⚠️ 프리페치 오류 (ID ${postId}):`, e.message);
    }
  } finally {
    if (callback) callback();
  }
}

// ⚡ 관련 페이지 프리페치 (에디터, 검색, 필터 등)
function prefetchRelatedPages() {
  const currentUrl = window.location.origin;
  
  // 주요 페이지들을 Prefetch 링크로 추가
  const pages = [
    { url: `${currentUrl}/?sort=popular`, title: '인기 게시물' },
    { url: `${currentUrl}/?sort=latest`, title: '최신 게시물' },
    { url: `${currentUrl}/editor/`, title: '에디터' }
  ];
  
  pages.forEach(page => {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = page.url;
    link.as = 'document';
    link.onload = () => 
    document.head.appendChild(link);
  });
  
  
}

// ⚡ 페이지 로드 완료 후 프리렌더링 즉시 시작 (병렬)
window.addEventListener('load', () => {
  // 모든 것을 즉시 병렬로 시작
  
  // 1. RequestIdleCallback (지원하면)
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      prerenderRelatedPages();
      prefetchVisiblePosts();
      prefetchRelatedPages();
    }, { timeout: 500 });  // 타임아웃 단축
  } else {
    // 2. 폴백: 즉시 시작 (지연 없음)
    prerenderRelatedPages();
    prefetchVisiblePosts();
    prefetchRelatedPages();
  }
}, { once: true });  // 한 번만 실행

// ⚡ 스크롤 시에만 추가 프리페치 (페이지 로드 후)
let scrollOptimizationActive = false;

window.addEventListener('load', () => {
  // 즉시 활성화
  scrollOptimizationActive = true;
}, { once: true });

let prerenderTimeout;
let prefetchTimeout;
window.addEventListener('scroll', () => {
  if (!scrollOptimizationActive) return;
  
  clearTimeout(prerenderTimeout);
  clearTimeout(prefetchTimeout);
  
  prerenderTimeout = setTimeout(() => {
    prerenderRelatedPages();
  }, 300);  // 300ms로 단축
  
  prefetchTimeout = setTimeout(() => {
    prefetchVisiblePosts();
  }, 500);
}, { passive: true });

// ⚡ 워드프레스 게시물 콘텐츠 처리
function initializePostContent() {
  // 1. 게시물 콘텐츠 찾기
  const postContent = document.querySelector('.post-content, .wp-content, .entry-content, [class*="content"]');
  
  if (!postContent) {
    
    return;
  }

  

  // 2. 유튜브 비디오 처리 (반응형 컨테이너로 감싸기)
  const iframes = postContent.querySelectorAll('iframe[src*="youtube"], iframe[src*="youtu.be"]');
  iframes.forEach(iframe => {
    if (!iframe.parentElement.classList.contains('video-container')) {
      const container = document.createElement('div');
      container.className = 'video-container';
      iframe.parentElement.insertBefore(container, iframe);
      container.appendChild(iframe);
      
    }
  });

  // 3. 게시물 이미지에 클릭 이벤트 추가
  setupImageViewer(postContent);

  // 4. 갤러리 처리
  setupGallery(postContent);
}

// ⚡ 이미지 뷰어 초기화
function setupImageViewer(container) {
  const images = container.querySelectorAll('img:not(.logo):not([class*="icon"]):not([width*="50"])');
  
  images.forEach((img, index) => {
    img.style.cursor = 'pointer';
    
    img.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const src = img.dataset.src || img.src;
      const alt = img.alt || `Image ${index + 1}`;
      
      openImageViewer(src, alt, index, images);
    });
  });

  
}

// ⚡ 이미지 뷰어 열기
function openImageViewer(src, alt, currentIndex, allImages) {
  // 기존 뷰어 제거
  const existing = document.querySelector('.image-viewer-overlay');
  if (existing) existing.remove();

  // 뷰어 HTML 생성
  const viewer = document.createElement('div');
  viewer.className = 'image-viewer-overlay active';
  viewer.innerHTML = `
    <div class="image-viewer-container">
      <img src="${src}" alt="${alt}" class="image-viewer-img" draggable="false">
      <div class="image-viewer-close"></div>
      <div class="image-viewer-info">${alt}</div>
      <div class="image-viewer-controls">
        📱 핀치줌 | 🖱️ Ctrl+휠 | ⬅️➡️ 화살표키
      </div>
    </div>
  `;

  document.body.appendChild(viewer);

  // 이미지 뷰어 기능 초기화
  initializeImageViewerFeatures(viewer, src, alt, currentIndex, allImages);

  // 스크롤 방지
  document.body.style.overflow = 'hidden';

  
}

// ⚡ 이미지 뷰어 기능 (확대/축소, 네비게이션)
function initializeImageViewerFeatures(viewer, initialSrc, initialAlt, currentIndex, allImages) {
  const overlay = viewer;
  const container = viewer.querySelector('.image-viewer-container');
  const img = viewer.querySelector('.image-viewer-img');
  const closeBtn = viewer.querySelector('.image-viewer-close');
  const infoDiv = viewer.querySelector('.image-viewer-info');
  
  let scale = 1;
  let currentImageIndex = currentIndex;
  let isPanning = false;
  let startX = 0;
  let startY = 0;
  let translateX = 0;
  let translateY = 0;

  // ⚡ 모바일 핀치줌
  let lastDistance = 0;

  container.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      lastDistance = getTouchDistance(e.touches[0], e.touches[1]);
      isPanning = true;
    } else if (e.touches.length === 1) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      isPanning = true;
    }
  }, { passive: true });

  container.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      // 핀치줌
      const distance = getTouchDistance(e.touches[0], e.touches[1]);
      const delta = distance - lastDistance;
      scale = Math.max(1, Math.min(scale + delta * 0.01, 4));
      updateImageTransform();
      lastDistance = distance;
    } else if (e.touches.length === 1 && scale > 1) {
      // 팬 (드래그)
      const moveX = e.touches[0].clientX - startX;
      const moveY = e.touches[0].clientY - startY;
      translateX = moveX;
      translateY = moveY;
      updateImageTransform();
    }
  }, { passive: true });

  container.addEventListener('touchend', () => {
    isPanning = false;
  }, { passive: true });

  // ⚡ 데스크톱 마우스 휠 줌 (Ctrl + 휠, Shift + 휠)
  container.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.shiftKey) {
      e.preventDefault();
      
      // Shift + 휠: 수평 스크롤 (확대 상태일 때)
      if (e.shiftKey && scale > 1) {
        translateX -= e.deltaY * 2;
      } else if (e.ctrlKey) {
        // Ctrl + 휠: 확대/축소
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.max(1, Math.min(scale + delta, 4));
      }
      
      updateImageTransform();
    }
  }, { passive: false });

  // ⚡ 데스크톱 마우스 드래그
  let isMouseDown = false;
  let mouseStartX = 0;
  let mouseStartY = 0;

  img.addEventListener('mousedown', (e) => {
    if (scale > 1) {
      isMouseDown = true;
      mouseStartX = e.clientX - translateX;
      mouseStartY = e.clientY - translateY;
      img.style.cursor = 'grabbing';
    }
  });

  document.addEventListener('mousemove', (e) => {
    if (isMouseDown && scale > 1) {
      translateX = e.clientX - mouseStartX;
      translateY = e.clientY - mouseStartY;
      updateImageTransform();
    }
  });

  document.addEventListener('mouseup', () => {
    isMouseDown = false;
    img.style.cursor = 'grab';
  });

  // ⚡ 화살표키 네비게이션
  const keyHandler = (e) => {
    if (!overlay || !overlay.classList.contains('active')) {
      document.removeEventListener('keydown', keyHandler);
      return;
    }

    if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
      currentImageIndex--;
      updateImage();
    } else if (e.key === 'ArrowRight' && currentImageIndex < allImages.length - 1) {
      currentImageIndex++;
      updateImage();
    } else if (e.key === 'Escape') {
      closeImageViewer();
    }
  };

  document.addEventListener('keydown', keyHandler);

  // ⚡ 닫기 버튼
  closeBtn.addEventListener('click', (e) => {
    console.log('❌ X 버튼 클릭됨');
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    closeImageViewer();
  });

  // ⚡ 오버레이 클릭 시 닫기 (이미지 제외)
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      closeImageViewer();
    }
  });

  // ⚡ 도움 함수들
  function getTouchDistance(touch1, touch2) {
    const dx = touch1.clientX - touch2.clientX;
    const dy = touch1.clientY - touch2.clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function updateImageTransform() {
    img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
  }

  function updateImage() {
    const selectedImg = allImages[currentImageIndex];
    const src = selectedImg.dataset.src || selectedImg.src;
    const alt = selectedImg.alt || `Image ${currentImageIndex + 1}`;
    
    img.src = src;
    img.alt = alt;
    infoDiv.textContent = alt;
    
    scale = 1;
    translateX = 0;
    translateY = 0;
    updateImageTransform();
    
    
  }

  function closeImageViewer() {
    console.log('🔴 closeImageViewer 호출됨');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', keyHandler);
    
    // ⚡ 수정: 페이지 스크롤만 복구하고 라우팅 하지 않음
    setTimeout(() => {
      if (overlay && overlay.parentElement) {
        overlay.remove();
        console.log('✅ 이미지 뷰어 오버레이 제거 완료');
      }
    }, 100);  // 매우 짧은 지연
    
    console.log('🔴 closeImageViewer 완료 - router.closePost나 history.back 호출 안함');
  }
}

// ⚡ 갤러리 처리 (여러 이미지 연결)
function setupGallery(container) {
  const galleries = container.querySelectorAll('.gallery, [class*="gallery"], [class*="wp-block-gallery"]');
  
  galleries.forEach((gallery) => {
    const images = gallery.querySelectorAll('img');
    
    images.forEach((img, index) => {
      img.style.cursor = 'pointer';
      
      img.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const src = img.dataset.src || img.src;
        const alt = img.alt || `Gallery Image ${index + 1}`;
        
        openImageViewer(src, alt, index, images);
      });
    });
  });

  
}

// ⚡ 페이지 로드 시 게시물 초기화
window.addEventListener('load', () => {
  setTimeout(() => {
    initializePostContent();
  }, 500);
});

// ⚡ 동적 콘텐츠 로드 감시 (Mutation Observer)
let initializeTimeout;
const contentObserver = new MutationObserver(() => {
  clearTimeout(initializeTimeout);
  initializeTimeout = setTimeout(() => {
    const postContent = document.querySelector('.post-content, .wp-content, .entry-content');
    if (postContent) {
      // 이미 초기화되지 않았으면 초기화
      if (!postContent.dataset.initialized) {
        initializePostContent();
        postContent.dataset.initialized = 'true';
      }
    }
  }, 300);
});

contentObserver.observe(document.body, {
  childList: true,
  subtree: true,
  attributes: false
});


</script>
</body>
</html>
