<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>IMPACT — MAKE A IMPACT</title>
  <meta name="description" content="IMPACT — KAIST / POSTECH 학생 저자들의 심층 콘텐츠 플랫폼 — WordPress 기반 콘텐츠를 자체 오버레이로 제공">

  <!-- 파비콘 (logo.png를 repo 루트에 올려두세요) -->
  <link rel="icon" href="logo.png" type="image/png">

  <!-- 웹앱 매니페스트 (선택) -->
  <link rel="manifest" href="manifest.json">

  <meta name="theme-color" content="#ffffff">

  <style>
  /* ======================================================================
     IMPACT — 통합 확장판 스타일시트
     - 밝은 톤, 반응형, 접근성 고려
     - 자세한 주석/예제 포함 (문서 길이 확장 목적도 포함)
     ====================================================================== */

  /* ----------------------------
     기본 리셋 / 글꼴
     ---------------------------- */
  *, *::before, *::after { box-sizing: border-box; }
  html, body { height:100%; margin:0; padding:0; }
  body {
    font-family: "Noto Sans KR", "Apple SD Gothic Neo", "Segoe UI", Roboto, Arial, sans-serif;
    background: #ffffff;
    color: #111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.6;
    -webkit-tap-highlight-color: transparent;
    scroll-behavior:smooth;
  }
  a { color:inherit; text-decoration:none; }
  img { display:block; max-width:100%; height:auto; }

  /* ----------------------------
     유틸리티 클래스
     ---------------------------- */
  .wrap { max-width:1400px; margin:0 auto; padding:0 20px; }
  .sr-only { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
  .flex { display:flex; }
  .gap-8 { gap:8px; }
  .center { display:flex; align-items:center; justify-content:center; }

  /* ----------------------------
     헤더
     ---------------------------- */
  header.site-header {
    position: sticky;
    top:0;
    z-index:1200;
    background: #fff;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    backdrop-filter: blur(6px);
  }
  .header-inner {
    height:72px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    max-width:1400px;
    margin:0 auto;
    padding:0 20px;
  }
  .brand { display:flex; gap:12px; align-items:center; cursor:pointer; }
  .brand .logo-img {
    width:48px; height:48px; border-radius:10px; overflow:hidden; display:inline-block; flex-shrink:0;
  }
  .brand .title {
    display:flex; flex-direction:column; line-height:1;
  }
  .brand .title .name { font-size:20px; font-weight:900; color:#111; letter-spacing:0.6px; }
  .brand .title .tag { font-size:11px; color:#666; font-weight:800; }

  .header-actions { display:flex; gap:10px; align-items:center; }
  .btn {
    border-radius:10px; padding:8px 12px; border:1px solid rgba(0,0,0,0.06);
    background:#fff; font-weight:800; cursor:pointer; font-size:14px;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn:active { transform: translateY(1px); }
  .btn-ghost { background:transparent; border:1px solid rgba(0,0,0,0.04); }
  .btn-primary { background: linear-gradient(135deg,#2e8b57,#1f7a6f); color:#fff; border:none; }

  /* ----------------------------
     NAV OVERLAY (더보기)
     - Desktop: 오른쪽 절반 슬라이드 인
     - Mobile: 전체 화면 슬라이드 인
     ---------------------------- */
  .nav-overlay {
    position: fixed; top:0; right:-50%; width:50%; height:100vh; background:#fff; z-index:2200;
    transition: right .32s cubic-bezier(.2,.9,.2,1); padding:40px; box-shadow:-8px 0 40px rgba(0,0,0,0.06);
    display:flex; flex-direction:column;
  }
  .nav-overlay.active { right:0; }
  @media (max-width:880px) {
    .nav-overlay { width:100%; right:-100%; padding:20px; }
    .nav-overlay.active { right:0; }
  }
  .nav-close { position:absolute; top:14px; right:14px; font-size:28px; background:none; border:none; cursor:pointer; }
  .nav-search { display:flex; gap:8px; align-items:center; margin-bottom:20px; }
  .nav-search input[type="search"] {
    flex:1; border:none; border-bottom:2px solid #ddd; padding:10px 8px; font-weight:800; font-size:15px; outline:none;
  }
  .nav-list { list-style:none; padding:0; margin:18px 0; display:flex; flex-direction:column; gap:12px; }
  .nav-list li { font-size:20px; font-weight:900; cursor:pointer; color:#111; padding:8px 2px; }
  .nav-list li:hover { color:#2e8b57; transform: translateX(6px); transition: transform .16s ease; }

  .nav-bottom { margin-top:auto; display:flex; flex-direction:column; gap:10px; font-size:13px; color:#444; }
  .nav-bottom a { font-weight:800; color:#111; }

  /* ----------------------------
     메인 그리드 (홈)
     - 좌: 큰 게시물(히어로)
     - 우: 4개 작은 카드(수직)
     - 반복해서 아래로 확장 (최대 20개)
     ---------------------------- */
  main.home {
    padding: 28px 20px 120px;
    max-width:1400px;
    margin:0 auto;
    display:flex;
    flex-direction:column;
    gap:20px;
    background:linear-gradient(90deg,#f5f5f5 50%, #ffffff 50%); /* 좌-우 투톤 배경 */
  }

  /* row: 하나의 그룹 (left hero + right column) */
  .row {
    display:grid; grid-template-columns: 2fr 1fr; gap:20px; align-items:start;
    margin-bottom:8px;
  }
  @media (max-width:1100px) {
    .row { grid-template-columns:1fr; }
  }

  /* left hero */
  .col-left {
    position:relative; border-radius:12px; overflow:hidden; min-height:360px; background:#f5f5f5;
  }
  .col-left .hero {
    width:100%; height:100%; object-fit:cover; display:block; min-height:360px; transition: transform .28s ease;
  }
  .col-left:hover .hero { transform: scale(1.02); }
  .hero-overlay {
    position:absolute; left:0; right:0; bottom:0; padding:22px; color:#fff;
    background: linear-gradient(180deg, rgba(0,0,0,0.00) 0%, rgba(0,0,0,0.55) 100%);
    display:flex; flex-direction:column; gap:12px;
  }
  .hero-title {
    font-size:28px; font-weight:900; margin:0; line-height:1.06;
  }
  .hero-meta { display:flex; gap:12px; align-items:center; color:rgba(255,255,255,0.95); font-weight:700; font-size:13px; }

  .hero-cats { position:absolute; right:16px; bottom:16px; display:flex; gap:8px; }

  /* small cards column on the right */
  .col-right { display:flex; flex-direction:column; gap:12px; }
  .card {
    background:#fff; border-radius:10px; overflow:hidden; border:1px solid rgba(0,0,0,0.06);
    transition: transform .16s ease, box-shadow .16s ease; cursor:pointer;
  }
  .card:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.06); }
  .card .thumb { width:100%; height:140px; overflow:hidden; background:#efefef; }
  .card .thumb img { width:100%; height:100%; object-fit:cover; }
  .card .body { padding:12px; }
  .card .title { font-weight:900; font-size:16px; margin-bottom:8px; color:#111; }
  .card .meta { display:flex; align-items:center; gap:8px; color:#666; font-size:13px; }

  /* badge */
  .cat-badge { padding:6px 10px; border-radius:8px; font-weight:800; color:#fff; font-size:12px; display:inline-block; }

  /* ----------------------------
     오버레이들 (카테고리 / 포스트 / 검색 / ABOUT)
     ---------------------------- */
  .overlay {
    position:fixed; inset:0; background:#fff; z-index:3000; overflow:auto; display:none; padding:28px;
    animation: overlayIn .26s ease;
  }
  .overlay.active { display:block; }
  @keyframes overlayIn { from { opacity:0; transform:translateY(6px) } to { opacity:1; transform:none } }

  .overlay .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .overlay .close { background:none; border:1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:10px; cursor:pointer; }

  .category-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:18px; margin-top:18px; }
  @media (max-width:720px) { .category-grid { grid-template-columns: 1fr; } }

  .post-article { max-width:900px; margin:0 auto; }
  .post-article h1 { font-size:34px; margin-bottom:12px; font-weight:900; color:#111; }
  .post-article .post-meta { display:flex; gap:12px; align-items:center; margin-bottom:12px; color:#666; }
  .post-article .post-content { color:#222; line-height:1.9; }

  /* ----------------------------
     검색 바 (요청: 더보기 내부 상단 검색 + 모바일에서 '검색' 텍스트 버튼 가로로 표시)
     ---------------------------- */
  .search-inline { display:flex; gap:8px; align-items:center; }
  .search-inline input[type="search"] { flex:1; padding:12px 10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); font-weight:700; }
  .search-inline .search-btn { padding:10px 18px; border-radius:999px; background:#111; color:#fff; font-weight:900; border:none; cursor:pointer; }
  @media (max-width:680px) {
    .search-inline .search-btn { padding:10px 18px; font-size:16px; }
  }

  /* ----------------------------
     푸터
     ---------------------------- */
  footer.site-footer { background:#111; color:#eee; padding:40px 20px; margin-top:30px; }
  .footer-inner { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; gap:20px; align-items:flex-start; flex-wrap:wrap; }
  .footer-brand { font-size:40px; font-weight:900; color:#fff; font-style:italic; }
  .footer-links { display:flex; gap:14px; align-items:center; }
  .footer-links a { color:#ddd; font-weight:700; }

  /* ----------------------------
     토스트/로딩/보조 스타일 (문서 길이 확장 및 예제)
     ---------------------------- */
  .loading { text-align:center; color:#666; padding:18px; }
  .badge-block { display:flex; gap:8px; flex-wrap:wrap; }

  /* ----------------------------
     추가 문서화/주석 영역 (확장판)
     - 이 블록은 문서화 목적이며 의도적으로 길이를 늘려 포함했습니다.
     - 실제 운영에서는 주석을 정리하시면 파일이 더 가벼워집니다.
     ---------------------------- */

  /*
    ACCESS PATTERN:
    - Home: /.netlify/functions/wpProxy?path=posts?per_page=5&page=1&_embed
    - Post: /.netlify/functions/wpProxy?path=posts/<id>?_embed
    - Category: /.netlify/functions/wpProxy?path=posts?categories=<id>&per_page=10&page=1&_embed
    - Search: /.netlify/functions/wpProxy?path=posts?search=<q>&per_page=20&_embed

    Netlify Function (wpProxy) should attach Authorization: Bearer <WP_TOKEN>
  */

  /* End of CSS */
  </style>
</head>
<body>

  <!-- ============================
       HEADER
       ============================ -->
  <header class="site-header" role="banner" aria-label="사이트 헤더">
    <div class="header-inner wrap">
      <div class="brand" onclick="router.goHome()" role="button" aria-label="홈으로 이동">
        <div class="logo-img">
          <img src="logo.png" alt="IMPACT logo" style="width:48px;height:48px;object-fit:cover;border-radius:8px;">
        </div>
        <div class="title">
          <div class="name">IMPACT</div>
          <div class="tag">MAKE A IMPACT</div>
        </div>
      </div>

      <div class="header-actions" role="navigation" aria-label="상단 메뉴">
        <!-- 요청대로 메인 상단에는 검색 버튼 제거하고 더보기만 노출 가능하므로
             여기서는 '더보기'만 배치. (사용자 원하면 검색 버튼 추가 가능) -->
        <button class="btn" onclick="ui.toggleNav()" aria-controls="navOverlay" aria-expanded="false">더보기</button>
      </div>
    </div>
  </header>

  <!-- ============================
       NAV OVERLAY (더보기)
       - 더보기에 검색창이 있으며, 데스크탑에서는 오른쪽 50% / 모바일에서는 전체 화면
       ============================ -->
  <aside class="nav-overlay" id="navOverlay" role="dialog" aria-label="더보기 메뉴" aria-hidden="true">
    <button class="nav-close" aria-label="더보기 닫기" onclick="ui.toggleNav()">×</button>

    <div style="display:flex;flex-direction:column;height:100%;">

      <!-- 네비 검색창 (더보기 상단) -->
      <div class="nav-search" role="search" aria-label="더보기 검색">
        <input type="search" id="navSearchInput" placeholder="검색어 입력" aria-label="검색어">
        <button class="btn" id="navSearchBtn">검색</button>
      </div>

      <!-- 카테고리 목록 -->
      <ul class="nav-list" id="navList" role="menu" aria-label="카테고리 목록">
        <!-- 동적으로 채워집니다 -->
      </ul>

      <div class="nav-bottom">
        <a href="javascript:void(0)" onclick="router.openAbout(); ui.toggleNav();">ABOUT</a>
        <a href="javascript:void(0)" onclick="alert('EDITORS 페이지는 추후 구현됩니다');">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER 페이지는 추후 구현됩니다');">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
        <div style="color:#777;font-size:13px;margin-top:14px">
          IMPACT는 WordPress 기반의 콘텐츠를 받아와 사이트 내에서 자체 포스트 페이지로 표시합니다.
        </div>
      </div>
    </div>
  </aside>

  <!-- ============================
       MAIN HOME (좌: #f5f5f5 / 우: #ffffff 투톤은 배경 그라데이션으로 표현)
       - rowsContainer 안에 좌1 + 우4 구조가 반복되어 최대 20개 게시물 렌더
       ============================ -->
  <main class="home" id="home" role="main" aria-live="polite">
    <div id="rowsContainer" aria-live="polite"></div>
    <div id="homeLoading" class="loading" aria-hidden="false">로딩 중...</div>
  </main>

  <!-- ============================
       CATEGORY OVERLAY
       ============================ -->
  <section class="overlay category-overlay" id="categoryOverlay" role="region" aria-hidden="true">
    <div class="topbar">
      <div>
        <h2 id="categoryTitle" style="font-size:24px;margin:0;font-weight:900">CATEGORY</h2>
        <div id="categorySubtitle" style="color:#666;margin-top:6px">카테고리 설명</div>
      </div>
      <div>
        <button class="close" onclick="router.closeCategory()">닫기</button>
      </div>
    </div>

    <div id="categoryGrid" class="category-grid" aria-live="polite"></div>
    <div id="categoryLoading" class="loading"></div>
  </section>

  <!-- ============================
       POST OVERLAY (닫기 버튼만 존재)
       ============================ -->
  <article class="overlay post-overlay" id="postOverlay" role="article" aria-hidden="true">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:flex;justify-content:flex-end;margin-bottom:18px">
        <button class="close" onclick="router.closePost()">닫기</button>
      </div>
      <div id="postArticle" class="post-article"></div>
    </div>
  </article>

  <!-- ============================
       SEARCH OVERLAY (검색 결과)
       - 더보기 내부 검색으로 대체했으므로 필요시 사용, 여전히 구현되어 있음
       ============================ -->
  <section class="overlay search-overlay" id="searchOverlay" role="search" aria-hidden="true">
    <div class="topbar">
      <div style="width:100%;">
        <div class="search-inline" style="width:100%;">
          <input type="search" id="searchInput" placeholder="검색어 입력 (Enter)" aria-label="검색어">
          <button class="search-btn" id="searchBtn">검색</button>
        </div>
      </div>
      <div>
        <button class="close" onclick="ui.closeSearch()">닫기</button>
      </div>
    </div>

    <div id="searchResults" class="category-grid" aria-live="polite"></div>
  </section>

  <!-- ============================
       ABOUT PAGE (전체 화면 오버레이)
       - 하이젠버그 내용 제거, 표 삽입 및 임팩트 소개
       ============================ -->
  <section class="overlay about-page" id="aboutPage" role="region" aria-hidden="true">
    <div style="max-width:1000px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <h1 style="font-size:32px;margin-bottom:6px">ABOUT</h1>
          <p style="color:#333;line-height:1.8">
            <strong>IMPACT</strong>은 現 & 前 KAIST IP-CEO 및 POSTECH CEO 학생들이 함께 작성하는 심층 콘텐츠 플랫폼입니다.
            학생 저자들의 실제 경험과 데이터 기반 분석을 결합하여 기술·경영·창의성에 대한 통찰을 제공합니다.
          </p>
          <p style="color:#333;line-height:1.8">
            본 사이트는 학생 주도의 독립 콘텐츠 발행을 목표로 하며, 현장의 사례, 데이터 인텔리전스, 이론적 접근을 균형있게 다룹니다.
          </p>

          <div style="margin-top:20px">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;font-weight:900">영역</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid #eee;font-weight:900">설명</th>
                </tr>
              </thead>
              <tbody>
                <tr><td style="padding:10px;border-bottom:1px solid #f0f0f0">Innovation</td><td style="padding:10px;border-bottom:1px solid #f0f0f0">혁신</td></tr>
                <tr><td style="padding:10px;border-bottom:1px solid #f0f0f0">Management</td><td style="padding:10px;border-bottom:1px solid #f0f0f0">관리</td></tr>
                <tr><td style="padding:10px;border-bottom:1px solid #f0f0f0">Passion</td><td style="padding:10px;border-bottom:1px solid #f0f0f0">열정</td></tr>
                <tr><td style="padding:10px;border-bottom:1px solid #f0f0f0">Acceleration</td><td style="padding:10px;border-bottom:1px solid #f0f0f0">혁신 가속화</td></tr>
                <tr><td style="padding:10px;border-bottom:1px solid #f0f0f0">Creativity</td><td style="padding:10px;border-bottom:1px solid #f0f0f0">창의성</td></tr>
                <tr><td style="padding:10px">Technology</td><td style="padding:10px">기술</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top:20px">
            <button class="btn" onclick="router.closeAbout()">닫기</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================
       TO TOP 버튼
       ============================ -->
  <button id="toTopBtn" class="btn" title="맨 위로" aria-label="맨 위로" style="position:fixed;right:22px;bottom:22px;z-index:3500;display:none;">↑</button>

  <!-- ============================
       FOOTER
       ============================ -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner wrap">
      <div>
        <div class="footer-brand">IMPACT</div>
        <div style="margin-top:10px;color:#ddd;font-size:13px">광고 제휴 문의 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
        <div style="color:#ddd;font-size:13px;margin-top:6px">보도자료 | <a href="mailto:ceo.impact.official@gmail.com">ceo.impact.official@gmail.com</a></div>
      </div>

      <div class="footer-links">
        <a href="javascript:void(0)" onclick="router.openAbout()">ABOUT</a>
        <a href="javascript:void(0)" onclick="alert('EDITORS 페이지는 추후 구현됩니다')">EDITORS</a>
        <a href="javascript:void(0)" onclick="alert('NEWSLETTER 페이지는 추후 구현됩니다')">NEWSLETTER</a>
        <a href="https://www.instagram.com/ceo_impact_official" target="_blank" rel="noopener">INSTAGRAM</a>
      </div>

      <div style="text-align:right">
        <div style="font-weight:800;color:#fff">IMPACT CEO. ALL RIGHTS RESERVED.</div>
        <div style="color:#999;font-size:13px;margin-top:10px">사이트는 WordPress.com API로부터 콘텐츠를 가져옵니다.</div>
      </div>
    </div>
  </footer>

  <!-- ============================
       템플릿: 카드
       ============================ -->
  <template id="cardTemplate">
    <article class="card" role="article">
      <div class="thumb"><img src="" alt=""></div>
      <div class="body">
        <div class="badge-row"></div>
        <div class="title"></div>
        <div class="meta" style="margin-top:10px">
          <img class="author-avatar" src="" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
          <div>
            <div class="author-name" style="font-weight:800;"></div>
            <div class="date" style="font-size:12px;color:#777"></div>
          </div>
        </div>
      </div>
    </article>
  </template>

  <!-- ============================
       자바스크립트 (긴 설명과 예제 포함 — 확장판)
       - Netlify Functions를 통해 WordPress API 호출 (토큰은 Netlify 환경변수에 보관)
       - 모든 요청은 /.netlify/functions/wpProxy?path=... 로 라우팅됩니다.
       ============================ -->
  <script>
  /* ===========================================================================
     IMPACT — 확장판 스크립트
     - 이 스크립트는 다음을 담당합니다:
       1. 네비 리스트 렌더링
       2. 홈에서 좌1+우4 레이아웃으로 게시물 렌더링 (최대 20개)
       3. 카테고리/검색/포스트 오버레이 로드
       4. 히스토리 pushState / popstate 처리
       5. 이미지 대비 계산으로 히어로 텍스트 색상 자동 변경
     - 보안: ACCESS TOKEN은 클라이언트에 삽입하지 않습니다. Netlify 함수에서 첨부합니다.
     =========================================================================== */

  // -------------------------
  // 설정값
  // -------------------------
  const WP_SITE = "impactceo0.wordpress.com"; // 참고용
  const HOME_PAGE_SIZE = 5; // 한 번에 받아오는 포스트 수 (그룹 당)
  const HOME_MAX_ITEMS = 20;  // 최대 렌더할 총 포스트 수
  const CATEGORIES = {
    "tech": 318,
    "eat": 123073,
    "style": 2286,
    "culture": 1098,
    "life": 124,
    "editors-pick": 259543
  };
  const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];

  // 상태 저장
  const state = {
    homePage: 1,
    homeCount: 0,
    loadingHome: false,
    homeFinished: false,
    postsCache: {},
    categoryPages: {},
    categoryFinished: {}
  };

  // -------------------------
  // 유틸리티
  // -------------------------
  function api(path) {
    // ensure _embed is present for author/featured images
    let p = path.includes('_embed') ? path : `${path}${path.includes('?') ? '&' : '?'}_embed`;
    // proxy via Netlify function (wpProxy)
    return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`;
  }

  function placeholderImage(w=1200,h=800,txt='No Image') {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='#efefef'/><text x='50%' y='50%' fill='#aaa' font-size='20' text-anchor='middle' dominant-baseline='middle'>${txt}</text></svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  function formatDate(dateStr) {
    try {
      const d = new Date(dateStr);
      return `${d.getFullYear()}. ${String(d.getMonth()+1).padStart(2,'0')}. ${String(d.getDate()).padStart(2,'0')}.`;
    } catch(e) {
      return '';
    }
  }

  function pickCategoryClass(slugOrName) {
    if(!slugOrName) return '';
    const s = String(slugOrName).toLowerCase();
    if(s.includes('tech') || s.includes('technology')) return 'cat-tech';
    if(s.includes('eat')) return 'cat-eat';
    if(s.includes('style')) return 'cat-style';
    if(s.includes('culture')) return 'cat-culture';
    if(s.includes('life')) return 'cat-life';
    if(s.includes('editor') || s.includes('editors')) return 'cat-editors-pick';
    return '';
  }

  // -------------------------
  // 네비 렌더링
  // -------------------------
  function renderNav() {
    const navList = document.getElementById('navList');
    navList.innerHTML = '';
    NAV_ORDER.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item;
      li.tabIndex = 0;
      li.setAttribute('role','menuitem');
      li.addEventListener('click', ()=> {
        const slug = item.toLowerCase().replace(/'/g,'').replace(/\s+/g,'-');
        ui.toggleNav(); // close nav
        if(slug === "editors-pick") router.openCategory('editors-pick');
        else if(CATEGORIES[slug]) router.openCategory(slug);
        else alert('해당 카테고리는 준비중입니다.');
      });
      li.addEventListener('keydown', (e)=> { if(e.key === 'Enter') li.click(); });
      navList.appendChild(li);
    });
  }

  // -------------------------
  // 카드 생성 (small card template)
  // -------------------------
  function createCard(post) {
    const tpl = document.getElementById('cardTemplate');
    const node = tpl.content.firstElementChild.cloneNode(true);

    const img = node.querySelector('.thumb img');
    let imgUrl = placeholderImage();
    try {
      if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0] && post._embedded['wp:featuredmedia'][0].source_url) {
        imgUrl = post._embedded['wp:featuredmedia'][0].source_url;
      }
    } catch(e) { imgUrl = placeholderImage(); }
    img.src = imgUrl;

    const titleEl = node.querySelector('.title');
    titleEl.innerHTML = post.title && post.title.rendered ? post.title.rendered : '제목 없음';

    const avatar = node.querySelector('.author-avatar');
    const authorName = node.querySelector('.author-name');
    const dateEl = node.querySelector('.date');
    if(post._embedded && post._embedded.author && post._embedded.author[0]) {
      const a = post._embedded.author[0];
      const aUrl = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
      avatar.src = aUrl || placeholderImage(96,96,'U');
      avatar.alt = a.name || 'author';
      authorName.textContent = a.name || '익명';
    } else {
      avatar.src = placeholderImage(96,96,'U');
      authorName.textContent = '익명';
    }
    dateEl.textContent = formatDate(post.date);

    // badges
    const badgeRow = node.querySelector('.badge-row');
    badgeRow.innerHTML = '';
    if(post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) {
      const cats = post._embedded['wp:term'][0];
      cats.forEach(c => {
        if(c && c.name) {
          const s = document.createElement('span');
          s.className = 'cat-badge ' + (pickCategoryClass(c.slug || c.name) || '');
          s.textContent = c.name;
          badgeRow.appendChild(s);
        }
      });
    }

    node.addEventListener('click', ()=> openPostById(post.id));
    return node;
  }

  // -------------------------
  // 히어로(좌측 큰 게시물) 만들기
  // -------------------------
  function createHeroNode(post) {
    const container = document.createElement('div');
    container.className = 'col-left';
    let heroUrl = placeholderImage();
    try {
      if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
        heroUrl = post._embedded['wp:featuredmedia'][0].source_url || heroUrl;
      }
    } catch(e) { heroUrl = placeholderImage(); }

    container.innerHTML = `
      <img class="hero" src="${heroUrl}" alt="">
      <div class="hero-overlay">
        <h3 class="hero-title"></h3>
        <div class="hero-meta">
          <img class="hero-avatar" src="" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
          <div class="hero-author" style="font-weight:800"></div>
          <div class="hero-date" style="color:rgba(255,255,255,0.9)"></div>
        </div>
      </div>
    `;

    // category badge in right-bottom with curvature
    const badgeWrap = document.createElement('div');
    badgeWrap.className = 'hero-cats';
    if(post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0] && post._embedded['wp:term'][0].length>0) {
      const c = post._embedded['wp:term'][0][0];
      const span = document.createElement('span');
      span.className = 'cat-badge ' + (pickCategoryClass(c.slug || c.name) || '');
      span.textContent = c.name;
      span.style.borderRadius = '12px';
      badgeWrap.appendChild(span);
    }
    container.appendChild(badgeWrap);

    // set content
    container.querySelector('.hero-title').innerHTML = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
    const heroAvatar = container.querySelector('.hero-avatar');
    const heroAuthor = container.querySelector('.hero-author');
    const heroDate = container.querySelector('.hero-date');

    if(post._embedded && post._embedded.author && post._embedded.author[0]) {
      const a = post._embedded.author[0];
      const aUrl = (a.avatar_urls && (a.avatar_urls['96']||a.avatar_urls['48']||a.avatar_urls['24'])) ? (a.avatar_urls['48']||a.avatar_urls['24']) : '';
      heroAvatar.src = aUrl || placeholderImage(48,48,'U');
      heroAuthor.textContent = a.name || '익명';
    } else {
      heroAvatar.src = placeholderImage(48,48,'U');
      heroAuthor.textContent = '익명';
    }
    heroDate.textContent = formatDate(post.date);

    // auto adjust contrast for hero title (text color)
    const heroImg = container.querySelector('.hero');
    const heroTitle = container.querySelector('.hero-title');
    const heroOverlay = container.querySelector('.hero-overlay');
    adjustHeroContrast(heroImg, heroTitle, heroOverlay);

    container.addEventListener('click', ()=> openPostById(post.id));
    return container;
  }

  // -------------------------
  // 홈 로드: 좌1+우4 반복해서 렌더링 (무한 스크롤)
  // -------------------------
  async function loadHome() {
    if(state.loadingHome || state.homeFinished) return;
    state.loadingHome = true;
    document.getElementById('homeLoading').textContent = '로딩 중...';

    try {
      const res = await fetch(api(`posts?per_page=${HOME_PAGE_SIZE}&page=${state.homePage}`));
      if(!res.ok) {
        if(res.status === 400) { state.homeFinished = true; document.getElementById('homeLoading').textContent = '더 이상 글이 없습니다.'; }
        else { throw new Error('Home fetch error ' + res.status); }
        state.loadingHome = false;
        return;
      }
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) {
        state.homeFinished = true;
        document.getElementById('homeLoading').textContent = '게시물이 없습니다.';
        state.loadingHome = false;
        return;
      }

      // store caches
      posts.forEach(p => { if(p && p.id) state.postsCache[p.id] = p; });

      const container = document.getElementById('rowsContainer');

      // process in groups of up to 5 (1 left + 4 right)
      for(let i=0;i<posts.length;i+=5) {
        if(state.homeCount >= HOME_MAX_ITEMS) { state.homeFinished = true; break; }
        const group = posts.slice(i,i+5);
        const row = document.createElement('div');
        row.className = 'row';

        // left hero
        const leftPost = group[0];
        const leftNode = createHeroNode(leftPost);
        row.appendChild(leftNode);

        // right column
        const right = document.createElement('div');
        right.className = 'col-right';
        const smalls = group.slice(1,5);
        smalls.forEach(s => {
          const card = createCard(s);
          right.appendChild(card);
        });

        row.appendChild(right);
        container.appendChild(row);

        state.homeCount += group.length;
      }

      state.homePage += 1;
      document.getElementById('homeLoading').textContent = '';
      if(state.homeCount >= HOME_MAX_ITEMS) {
        state.homeFinished = true;
        document.getElementById('homeLoading').textContent = '더 이상 불러올 항목이 없습니다.';
      }
    } catch(err) {
      console.error('loadHome error', err);
      document.getElementById('homeLoading').textContent = '메인 글 불러오기 실패';
    } finally {
      state.loadingHome = false;
    }
  }

  // -------------------------
  // 카테고리 로드
  // -------------------------
  async function loadCategory(slug) {
    if(!slug) return;
    if(state.categoryFinished[slug]) return;
    const page = state.categoryPages[slug] || 1;
    document.getElementById('categoryLoading').textContent = '로딩 중...';

    try {
      const catId = CATEGORIES[slug];
      if(!catId) { document.getElementById('categoryLoading').textContent = '알 수 없는 카테고리입니다.'; return; }
      const res = await fetch(api(`posts?categories=${catId}&per_page=10&page=${page}`));
      if(!res.ok) { if(res.status === 400) { state.categoryFinished[slug] = true; document.getElementById('categoryLoading').textContent = '더 이상 글이 없습니다.'; return; } throw new Error('Category fetch error ' + res.status); }
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length === 0) { state.categoryFinished[slug] = true; document.getElementById('categoryLoading').textContent = '게시물이 없습니다.'; return; }

      const grid = document.getElementById('categoryGrid');
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCard(p);
        grid.appendChild(card);
      });

      state.categoryPages[slug] = page + 1;
      document.getElementById('categoryLoading').textContent = '';
    } catch(err) {
      console.error(err);
      document.getElementById('categoryLoading').textContent = '카테고리 불러오기 실패';
    }
  }

  // -------------------------
  // 포스트 로드 및 오버레이
  // -------------------------
  async function openPostById(id) {
    if(!id) return;
    const cached = state.postsCache[id];
    if(cached && cached.content && cached.content.rendered) {
      renderPostOverlay(cached);
      return;
    }
    try {
      const res = await fetch(api(`posts/${id}`));
      if(!res.ok) throw new Error('post fetch error ' + res.status);
      const post = await res.json();
      // ensure _embed
      if(!(post._embedded && post._embedded.author)) {
        const res2 = await fetch(api(`posts/${id}?_embed`));
        if(res2.ok) {
          const p2 = await res2.json();
          state.postsCache[p2.id] = p2;
          renderPostOverlay(p2);
          return;
        }
      }
      state.postsCache[post.id] = post;
      renderPostOverlay(post);
    } catch(err) {
      console.error('openPostById error', err);
      alert('포스트 로드 실패 — 원문 이동을 시도합니다.');
      if(cached && cached.link) window.open(cached.link, '_blank');
    }
  }

  function renderPostOverlay(post) {
    const overlay = document.getElementById('postOverlay');
    const article = document.getElementById('postArticle');
    const title = post.title && post.title.rendered ? post.title.rendered : '제목 없음';
    const author = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].name) ? post._embedded.author[0].name : '익명';
    const avatar = (post._embedded && post._embedded.author && post._embedded.author[0] && post._embedded.author[0].avatar_urls) ? (post._embedded.author[0].avatar_urls['96']||post._embedded.author[0].avatar_urls['48']) : '';
    const categories = (post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0]) ? post._embedded['wp:term'][0].map(t=>t.name).join(', ') : '-';
    const dateStr = formatDate(post.date);
    const content = post.content && post.content.rendered ? post.content.rendered : (post.excerpt && post.excerpt.rendered ? post.excerpt.rendered : '');

    article.innerHTML = `
      <h1>${title}</h1>
      <div class="post-meta" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
        <img src="${avatar || placeholderImage(96,96,'U')}" alt="author" style="width:52px;height:52px;border-radius:50%;object-fit:cover;">
        <div>
          <div style="font-weight:900;color:#111">${author}</div>
          <div style="color:#666;font-size:13px">${dateStr} · ${categories}</div>
        </div>
      </div>
      <div class="post-content">${content}</div>
      <div style="margin-top:18px;color:#888;font-size:13px">원문 링크: <a href="${post.link}" target="_blank" rel="noopener">${post.link}</a></div>
    `;

    // img responsive
    article.querySelectorAll('.post-content img').forEach(img=>{
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.margin = '12px 0';
    });

    overlay.classList.add('active');
    overlay.scrollTop = 0;
    history.pushState({page:'post', id:post.id}, '', `#post-${post.id}`);
  }

  // -------------------------
  // 검색 (더보기 내 검색창 / 검색 오버레이 둘 다 사용 가능)
  // -------------------------
  async function doSearch(q) {
    if(!q) return;
    // open search overlay
    ui.openSearch();
    const results = document.getElementById('searchResults');
    results.innerHTML = '';
    try {
      const res = await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=20`));
      if(!res.ok) throw new Error('search failed ' + res.status);
      const posts = await res.json();
      if(!Array.isArray(posts) || posts.length===0) {
        results.innerHTML = '<div style="padding:20px;color:#666">검색 결과가 없습니다.</div>';
        return;
      }
      posts.forEach(p => {
        state.postsCache[p.id] = p;
        const card = createCard(p);
        results.appendChild(card);
      });
    } catch(err) {
      console.error('search error', err);
      results.innerHTML = '<div style="padding:20px;color:#d00">검색 중 오류가 발생했습니다.</div>';
    }
  }

  // -------------------------
  // 히어로 이미지 대비 계산
  // -------------------------
  function adjustHeroContrast(imgEl, titleEl, overlayEl) {
    if(!imgEl || !imgEl.src) return;
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = imgEl.src;
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        const w = Math.min(100, img.width);
        const h = Math.min(60, img.height);
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0,0,w,h).data;
        let r=0,g=0,b=0,cnt=0;
        for(let i=0;i<data.length;i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; cnt++; }
        const avgR = r/cnt, avgG = g/cnt, avgB = b/cnt;
        const luminance = 0.2126*avgR + 0.7152*avgG + 0.0722*avgB;
        if(luminance > 150) {
          // image is light -> use dark text
          titleEl.style.color = '#111';
          titleEl.style.textShadow = 'none';
          overlayEl.style.background = 'linear-gradient(0deg, rgba(255,255,255,0.85), rgba(255,255,255,0.35))';
        } else {
          // image is dark -> use white text
          titleEl.style.color = '#fff';
          titleEl.style.textShadow = '0 3px 12px rgba(0,0,0,0.45)';
          overlayEl.style.background = 'linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.45))';
        }
      } catch(e) {
        titleEl.style.color = '#fff';
      }
    };
    img.onerror = function(){ titleEl.style.color = '#fff'; };
  }

  // -------------------------
  // 스크롤 / to-top 동작 / 무한스크롤 트리거
  // -------------------------
  function onScroll() {
    const toTop = document.getElementById('toTopBtn');
    if(window.scrollY > 300) { toTop.style.display = 'block'; } else { toTop.style.display = 'none'; }

    // if category overlay active -> infinite load within overlay
    const categoryOverlay = document.getElementById('categoryOverlay');
    if(categoryOverlay.classList.contains('active')) {
      if(categoryOverlay.scrollHeight - (categoryOverlay.scrollTop + categoryOverlay.clientHeight) < 300) {
        const slug = categoryOverlay.dataset.slug;
        if(slug) loadCategory(slug);
      }
      return;
    }

    // if overlays open, do not auto load home
    if(document.getElementById('postOverlay').classList.contains('active')) return;
    if(document.getElementById('searchOverlay').classList.contains('active')) return;
    if(document.getElementById('aboutPage').classList.contains('active')) return;

    // bottom threshold for loading more home
    if(!state.loadingHome && !state.homeFinished) {
      const threshold = 1200;
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - threshold) {
        loadHome();
      }
    }
  }

  // -------------------------
  // UI / Router (pushState / popstate 통합)
  // -------------------------
  const ui = {
    toggleNav() {
      const nav = document.getElementById('navOverlay');
      const expanded = nav.classList.toggle('active');
      const btn = document.querySelector('.header-actions .btn');
      if(btn) btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      // history
      if(expanded) history.pushState({page:'nav'}, '', '#menu');
      else if(location.hash === '#menu') history.pushState({page:'home'}, '', '/');
    },
    openSearch() {
      const overlay = document.getElementById('searchOverlay');
      overlay.classList.add('active');
      history.pushState({page:'search'}, '', '#search');
    },
    closeSearch() {
      document.getElementById('searchOverlay').classList.remove('active');
      history.pushState({page:'home'}, '', '/');
    }
  };

  const router = {
    goHome() {
      document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
      document.getElementById('navOverlay').classList.remove('active');
      window.scrollTo({top:0, behavior:'smooth'});
      history.pushState({page:'home'}, '', '/');
    },
    openCategory(slug) {
      const overlay = document.getElementById('categoryOverlay');
      overlay.dataset.slug = slug;
      document.getElementById('categoryTitle').textContent = slug.toUpperCase();
      const desc = {
        tech: "기술의 최전선에서",
        eat: "맛있는 이야기들",
        style: "스타일과 디자인의 세계",
        culture: "문화와 예술의 공간",
        life: "일상 속 특별한 순간들",
        "editors-pick": "편집진이 선별한 특별한 콘텐츠"
      }[slug] || "카테고리 콘텐츠";
      document.getElementById('categorySubtitle').textContent = desc;
      document.getElementById('categoryGrid').innerHTML = '';
      state.categoryPages[slug] = 1;
      state.categoryFinished[slug] = false;
      overlay.classList.add('active');
      overlay.scrollTop = 0;
      loadCategory(slug);
      history.pushState({page:'category', slug}, '', `#category-${slug}`);
    },
    closeCategory() {
      const overlay = document.getElementById('categoryOverlay');
      overlay.classList.remove('active');
      delete overlay.dataset.slug;
      history.pushState({page:'home'}, '', '/');
    },
    openAbout() {
      document.getElementById('aboutPage').classList.add('active');
      history.pushState({page:'about'}, '', '#about');
    },
    closeAbout() {
      document.getElementById('aboutPage').classList.remove('active');
      history.pushState({page:'home'}, '', '/');
    },
    closePost() {
      document.getElementById('postOverlay').classList.remove('active');
      history.pushState({page:'home'}, '', '/');
    }
  };

  // -------------------------
  // 이벤트 바인딩
  // -------------------------
  function bind() {
    // nav render
    renderNav();

    // nav search
    const navSearchInput = document.getElementById('navSearchInput');
    const navSearchBtn = document.getElementById('navSearchBtn');
    if(navSearchBtn) navSearchBtn.addEventListener('click', ()=> {
      const q = (navSearchInput && navSearchInput.value.trim()) || '';
      if(!q) { alert('검색어를 입력하세요'); return; }
      document.getElementById('navOverlay').classList.remove('active');
      doSearch(q);
    });
    if(navSearchInput) navSearchInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') navSearchBtn.click(); });

    // search overlay input
    const sInput = document.getElementById('searchInput');
    const sBtn = document.getElementById('searchBtn');
    if(sBtn) sBtn.addEventListener('click', ()=> {
      const q = (sInput && sInput.value.trim()) || '';
      if(!q) { alert('검색어를 입력하세요'); return; }
      doSearch(q);
    });
    if(sInput) sInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sBtn.click(); });

    // to-top
    const toTop = document.getElementById('toTopBtn');
    if(toTop) toTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

    // nav close via ESC
    window.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape') {
        document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
        document.getElementById('navOverlay').classList.remove('active');
      }
    });

    // nav list items are rendered dynamically
    // popstate handling
    window.addEventListener('popstate', function(e) {
      // close all overlays
      document.querySelectorAll('.overlay').forEach(el => el.classList.remove('active'));
      document.getElementById('navOverlay').classList.remove('active');

      if(e.state && e.state.page) {
        const pg = e.state.page;
        if(pg === 'search') document.getElementById('searchOverlay').classList.add('active');
        else if(pg === 'about') document.getElementById('aboutPage').classList.add('active');
        else if(pg === 'category') {
          if(e.state.slug) router.openCategory(e.state.slug);
        } else if(pg === 'post') {
          if(e.state.id) openPostById(e.state.id);
        } else {
          // home
        }
      } else {
        // default: home
      }
    });

    // scroll
    window.addEventListener('scroll', onScroll, { passive:true });

    // initial click: nav toggle
    const headerBtn = document.querySelector('.header-actions .btn');
    if(headerBtn) headerBtn.addEventListener('click', ()=> {
      // toggleNav handled by inline onclick as well
    });

    // navList keyboard accessibility already handled in renderNav
  }

  // -------------------------
  // 초기화
  // -------------------------
  (function init() {
    bind();
    // initialize history state
    history.replaceState({page:'home'}, '', '/');
    // initial home load
    loadHome();
  })();

  // -------------------------
  // Netlify function example (for documentation only)
  // -------------------------
  /* 
    netlify/functions/wpProxy.js (Node example)
    -------------------------------------------
    exports.handler = async function(event, context) {
      const WP_SITE = "impactceo0.wordpress.com";
      const ACCESS_TOKEN = process.env.WP_TOKEN; // set in Netlify dashboard
      const path = event.queryStringParameters.path;
      if(!path) {
        return { statusCode:400, body: JSON.stringify({ error: "Missing path" }) };
      }
      const url = `https://public-api.wordpress.com/wp/v2/sites/${WP_SITE}/${path}`;
      try {
        const resp = await fetch(url, {
          headers: { "Authorization": `Bearer ${ACCESS_TOKEN}` }
        });
        const text = await resp.text();
        return { statusCode: resp.status, headers: { "Content-Type":"application/json" }, body: text };
      } catch(err) {
        return { statusCode:500, body: JSON.stringify({ error: err.message }) };
      }
    };
  */

  </script>

  <!-- ============================
       추가 긴 주석/참고 블록 (문서 길이 확장 목적)
       - 실제 운영 시 필요 없는 주석은 제거하세요.
       ============================ -->
  <!--
    파일 구조 권장:
    - index.html (이 파일)
    - logo.png (레포 루트 / 파비콘)
    - manifest.json (옵션)
    - netlify/functions/wpProxy.js (Netlify serverless proxy)
    - README.md (설치/배포/환경변수 설명)

    Netlify 환경변수:
    - WP_TOKEN : WordPress OAuth access token

    주의사항:
    - 토큰을 클라이언트 코드에 직접 삽입하지 마세요.
    - 공개 저장소에 토큰을 올리지 마세요.
  -->

</body>
</html>
