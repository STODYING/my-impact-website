<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMPACT – MAKE A IMPACT</title>

  <style>
  /* ===== Theme tokens ===== */
  :root{
    --bg:#f6f7f9; --text:#111; --muted:#666; --card:#fff; --border:rgba(0,0,0,.08);
    --shadow:rgba(0,0,0,.08); --accent:#2e8b57; --progress:#ff7a1a;
    --ease:cubic-bezier(.22,.61,.36,1); --dur:.22s;
  }
  html[data-theme="dark"]{
    --bg:#0f1115; --text:#f1f3f5; --muted:#a6adbb; --card:#171a21; --border:rgba(255,255,255,.08);
    --shadow:rgba(0,0,0,.35); --accent:#39c07c; --progress:#ff9f45;
  }

  /* ===== Reset ===== */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);line-height:1.6;font-family:"Noto Sans KR",system-ui,Arial,sans-serif;overflow-x:hidden;scroll-behavior:smooth}
  img{display:block;max-width:100%;height:auto}
  a{text-decoration:none;color:inherit}
  .wrap{max-width:1100px;margin:0 auto;padding:0 16px}

  /* ===== (3) 화면 최상단 진행바(전역) ===== */
  #progressTop{position:fixed;top:0;left:0;height:4px;width:0;background:var(--progress);z-index:3000;transition:width .08s linear}

  /* ===== Header (아이콘 유지) ===== */
  header.header{position:sticky;top:0;z-index:1200;background:var(--card);border-bottom:1px solid var(--border)}
  .header-inner{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
  .logo-btn{display:flex;gap:8px;align-items:center;font-weight:900;cursor:pointer}
  .logo-btn img{width:30px;height:30px;border-radius:6px;object-fit:cover}
  .icon-btn{width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;background:var(--card);cursor:pointer}

  /* ===== Nav/Search Overlay ===== */
  .overlay{position:fixed;inset:0;background:var(--card);z-index:2200;opacity:0;visibility:hidden;transform:translateY(8px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease),visibility 0s var(--dur)}
  .overlay.active{opacity:1;visibility:visible;transform:translateY(0)}
  .overlay-head{display:flex;justify-content:flex-end;padding:12px}
  .nav-body{max-width:900px;margin:0 auto;padding:0 16px 24px}
  .nav-list{list-style:none;padding:0;margin:8px 0;display:grid;gap:14px}
  .nav-item{font-size:26px;font-weight:900;cursor:pointer}
  .search-bar{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);outline:none;font-size:16px}

  /* ===== (1) 다크/라이트 토글 좌하단 ===== */
  .theme-toggle{position:fixed;left:12px;bottom:12px;z-index:2500;display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:8px 10px}
  .theme-toggle input{appearance:none;width:36px;height:20px;border-radius:999px;background:#ccc;position:relative;cursor:pointer}
  .theme-toggle input::after{content:"";position:absolute;left:2px;top:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:left var(--dur) var(--ease)}
  .theme-toggle input:checked{background:#222}.theme-toggle input:checked::after{left:18px}

  /* ===== (1) 홈 — 세로형 목록 ===== */
  main.home{padding:18px 0}
  .vlist{display:flex;flex-direction:column;gap:16px}
  .vcard{display:grid;grid-template-columns:160px 1fr;gap:16px;align-items:stretch;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;cursor:pointer;transition:transform var(--dur) var(--ease),box-shadow var(--dur) var(--ease)}
  .vcard:hover{transform:translateY(-4px);box-shadow:0 10px 28px var(--shadow)}
  .vthumb{width:100%;height:100%;min-height:140px;background:#222}
  .vthumb img{width:100%;height:100%;object-fit:cover}
  .vbody{padding:12px 12px 14px}
  .cat{display:inline-block;padding:4px 8px;border-radius:6px;background:#7e5fff;color:#fff;font-weight:800;font-size:11px;margin-bottom:8px}
  .cat-tech{background:#1e90ff}.cat-eat{background:#ff6347}.cat-style{background:#32cd32}.cat-culture{background:#8a2be2}.cat-life{background:#ffa500;color:#000}
  .vtitle{margin:0 0 8px;font-size:18px;font-weight:900;line-height:1.2}
  .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
  .meta img{width:28px;height:28px;border-radius:50%;object-fit:cover}

  @media (max-width:680px){
    .vcard{grid-template-columns:1fr}
    .vthumb{min-height:200px}
  }

  /* ===== Pagination (무한 스크롤 제거) ===== */
  .pager{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;padding:12px 0 22px}
  .pager button{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:var(--card);font-weight:800;cursor:pointer}
  .pager .current{border:none;background:transparent;color:var(--progress)}

  /* ===== Post overlay ===== */
  .post{position:fixed;inset:0;background:var(--card);z-index:2000;overflow:auto;opacity:0;visibility:hidden;transform:translateY(8px);transition:opacity var(--dur) var(--ease),transform var(--dur) var(--ease),visibility 0s var(--dur)}
  .post.active{opacity:1;visibility:visible;transform:translateY(0)}
  .post-wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
  /* (4) 위로 스크롤 시 나타나는 툴바(애니메이션) — 초기 숨김 */
  .post-toolbar{position:fixed;top:10px;left:50%;transform:translate(-50%,-60px);width:min(1100px,calc(100% - 24px));height:46px;padding:0 10px;display:flex;justify-content:space-between;align-items:center;background:color-mix(in oklab,var(--card) 88%,transparent);border:1px solid var(--border);border-radius:12px;backdrop-filter:blur(8px);box-shadow:0 8px 24px var(--shadow);transition:transform var(--dur) var(--ease);pointer-events:none}
  .post-toolbar.show{transform:translate(-50%,0);pointer-events:auto}
  .tool-left{display:flex;gap:8px;align-items:center;font-weight:900;cursor:pointer}
  .tool-left img{width:24px;height:24px;border-radius:6px;object-fit:cover}

  /* Post header (세로형 카드로 시작) */
  .post-head{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;align-items:center}
  .ph-img{border-radius:12px;overflow:hidden;background:#000;height:360px}
  .ph-img img{width:100%;height:100%;object-fit:cover}
  .ph-info h1{margin:0 0 10px;font-size:30px;line-height:1.2}
  .who{display:flex;gap:10px;align-items:center;color:var(--muted)}
  .who img{width:40px;height:40px;border-radius:50%}
  @media (max-width:900px){.post-head{grid-template-columns:1fr}.ph-img{height:300px}.ph-info h1{font-size:24px}}

  .post-content{line-height:1.9}
  /* (5) 임베드 보정: 모바일은 100%, PC는 적정 폭 */
  .post-content iframe,.post-content video,.post-content embed,.post-content object{max-width:100%;width:100%;height:auto}
  @media (min-width:1024px){
    .post-content iframe,.post-content video,.post-content embed,.post-content object{width:min(860px,100%);margin:12px auto;display:block;aspect-ratio:16/9;height:auto}
  }
  </style>
</head>
<body>

  <!-- (3) 화면 최상단 고정 진행바 -->
  <div id="progressTop"></div>

  <!-- 좌하단 다크/라이트 토글 -->
  <button class="theme-toggle" onclick="toggleTheme()" title="다크/라이트 전환">
    <span style="font-weight:800;font-size:12px">Light</span>
    <input id="themeSwitch" type="checkbox" aria-label="테마 전환">
    <span style="font-weight:800;font-size:12px">Dark</span>
  </button>

  <!-- Header -->
  <header class="header">
    <div class="header-inner wrap">
      <div class="logo-btn" onclick="router.goHome()">
        <img src="logo.png" alt=""><span>IMPACT</span>
      </div>
      <div>
        <button class="icon-btn" onclick="openSearch()" aria-label="검색">🔍</button>
        <button class="icon-btn" onclick="toggleNav(true)" aria-label="메뉴">☰</button>
      </div>
    </div>
  </header>

  <!-- NAV -->
  <aside id="nav" class="overlay" aria-hidden="true">
    <div class="overlay-head"><button class="icon-btn" onclick="toggleNav(false)" aria-label="닫기">×</button></div>
    <div class="nav-body">
      <div class="search-bar" style="margin-bottom:14px"><input id="navSearch" placeholder="검색어 입력 (Enter)"><button class="icon-btn" onclick="openSearchFromNav()">🔍</button></div>
      <ul id="navList" class="nav-list"></ul>
    </div>
  </aside>

  <!-- SEARCH -->
  <section id="search" class="overlay" aria-hidden="true">
    <div class="overlay-head"><button class="icon-btn" onclick="closeSearch()" aria-label="닫기">×</button></div>
    <div class="nav-body">
      <div class="search-bar"><input id="searchInput" placeholder="검색어 입력 (Enter)"></div>
      <div id="searchGrid" class="wrap" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:14px"></div>
    </div>
  </section>

  <!-- (1) 홈: 세로형 리스트 -->
  <main id="home" class="home wrap" role="main">
    <section id="vlist" class="vlist"></section>
    <nav id="homePager" class="pager" aria-label="페이지 이동"></nav>
  </main>

  <!-- POST -->
  <article id="post" class="post" aria-hidden="true">
    <!-- (4) 위로 스크롤 시 나타나는 툴바 -->
    <div id="postToolbar" class="post-toolbar">
      <div class="tool-left" onclick="router.goHome()">
        <img src="logo.png" alt=""><span>IMPACT</span>
      </div>
      <button class="icon-btn" onclick="toggleNav(true)" aria-label="메뉴">☰</button>
    </div>

    <div class="post-wrap">
      <div style="display:flex;justify-content:flex-end;margin-bottom:8px"><button class="icon-btn" onclick="closePost()" aria-label="닫기">×</button></div>

      <section id="postHead" class="post-head">
        <div class="ph-img"><img id="postHero" src="" alt=""></div>
        <div class="ph-info">
          <h1 id="postTitle">제목</h1>
          <div class="who">
            <img id="postAvatar" src="" alt="">
            <div>
              <div id="postAuthor" style="font-weight:800;color:var(--text)">author</div>
              <div id="postDate" style="font-size:13px;color:var(--muted)">date · categories</div>
            </div>
          </div>
        </div>
      </section>

      <div id="postContent" class="post-content"></div>

      <section id="related" class="wrap" style="display:none;margin-top:26px">
        <h3 style="margin:0 0 10px;font-size:20px;font-weight:900">관련 글</h3>
        <div id="relatedGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px"></div>
      </section>
    </div>
  </article>

  <!-- 템플릿: 세로카드 -->
  <template id="vcardTpl">
    <article class="vcard">
      <div class="vthumb"><img alt=""></div>
      <div class="vbody">
        <span class="cat">CATEGORY</span>
        <h3 class="vtitle"></h3>
        <div class="meta">
          <img class="av" alt="">
          <div><div class="name" style="font-weight:800;color:var(--text)"></div><div class="d"></div></div>
        </div>
      </div>
    </article>
  </template>

<script>
/* ===== Config ===== */
const PER_PAGE = 20; // (2)(8) 무한 스크롤 제거, 페이지당 20
const CATS = { tech:318, eat:123073, style:2286, culture:1098, life:124, "editors-pick":259543 };
const NAV_ORDER = ["TECH","EAT","STYLE","CULTURE","LIFE","EDITORS' PICK"];
const state = { page:1, total:1, cache:{}, lastY:0 };

function api(path){ const p=path.includes('_embed')?path:(path+(path.includes('?')?'&':'?')+'_embed'); return `/.netlify/functions/wpProxy?path=${encodeURIComponent(p)}`; }
function headers(){ return {}; }
function fmt(d){ const x=new Date(d); return `${x.getFullYear()}. ${String(x.getMonth()+1).padStart(2,'0')}. ${String(x.getDate()).padStart(2,'0')}.`; }
function ph(w=600,h=400,t='No Image'){ const s=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='%232b2f36'/><text x='50%' y='50%' fill='%239aa3af' font-size='20' text-anchor='middle' dominant-baseline='middle'>${t}</text></svg>`; return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(s); }
function catCls(slug){slug=String(slug||'').toLowerCase();if(slug.includes('tech'))return'cat-tech';if(slug.includes('eat'))return'cat-eat';if(slug.includes('style'))return'cat-style';if(slug.includes('culture'))return'cat-culture';if(slug.includes('life'))return'cat-life';return''}

/* ===== Theme toggle ===== */
(function(){const saved=localStorage.getItem('impact-theme')||'light';document.documentElement.setAttribute('data-theme',saved);document.getElementById('themeSwitch').checked=(saved==='dark');})();
function toggleTheme(){const cur=document.documentElement.getAttribute('data-theme')||'light';const nxt=cur==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',nxt);document.getElementById('themeSwitch').checked=(nxt==='dark');localStorage.setItem('impact-theme',nxt);}

/* ===== Nav/Search ===== */
function toggleNav(open){const el=document.getElementById('nav'); open?el.classList.add('active'):el.classList.remove('active');}
function openSearch(){document.getElementById('search').classList.add('active');document.getElementById('searchInput').focus();}
function closeSearch(){document.getElementById('search').classList.remove('active');}
(function renderNav(){const ul=document.getElementById('navList'); ul.innerHTML=''; NAV_ORDER.forEach(l=>{const li=document.createElement('li'); li.className='nav-item'; li.textContent=l; li.onclick=()=>{toggleNav(false); const slug=l.toLowerCase().replace(/'/g,'').replace(/\s/g,'-'); openCategory(slug,1);}; ul.appendChild(li);});})();
function openSearchFromNav(){const v=document.getElementById('navSearch').value.trim(); toggleNav(false); openSearch(); if(v){document.getElementById('searchInput').value=v; doSearch(v);}}

/* ===== Home: Vertical list ===== */
async function loadHome(page=1){
  const list=document.getElementById('vlist'); list.innerHTML='';
  const pager=document.getElementById('homePager'); pager.innerHTML='';
  const res=await fetch(api(`posts?per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
  if(!res.ok){ list.innerHTML='<div style="color:var(--muted)">불러오기 실패</div>'; return; }
  const posts=await res.json();
  const total=parseInt(res.headers.get('X-WP-TotalPages')||'1',10); state.page=page; state.total=total;
  posts.forEach(p=>{ state.cache[p.id]=p; list.appendChild(makeVCard(p)); });
  renderPager(pager,page,total, p=>loadHome(p));
}
function makeVCard(p){
  const tpl=document.getElementById('vcardTpl').content.firstElementChild.cloneNode(true);
  tpl.querySelector('.vthumb img').src = p._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
  const cat = p._embedded?.['wp:term']?.[0]?.[0];
  const catEl = tpl.querySelector('.cat'); catEl.textContent = cat?.name || ' '; const cls = catCls(cat?.slug); if(cls) catEl.classList.add(cls);
  tpl.querySelector('.vtitle').innerHTML = p.title?.rendered || '제목 없음';
  tpl.querySelector('.av').src = p._embedded?.author?.[0]?.avatar_urls?.['48'] || ph(48,48,'U');
  tpl.querySelector('.name').textContent = p._embedded?.author?.[0]?.name || '익명';
  tpl.querySelector('.d').textContent = fmt(p.date);
  tpl.onclick=()=> openPost(p.id);
  return tpl;
}
function renderPager(container, cur, total, cb){
  if(total<=1) return;
  const add=(label,page,isCur=false,dis=false)=>{const b=document.createElement('button'); b.textContent=label; if(isCur){b.className='current';b.disabled=true;} else if(!dis){b.onclick=()=>cb(page);} container.appendChild(b);};
  const ell=()=>{const s=document.createElement('span'); s.textContent='…'; s.style.opacity=.6; container.appendChild(s);};
  add('«',1,false,cur===1);
  if(total<=9){for(let p=1;p<=total;p++) add(p,p,p===cur);}
  else if(cur<=4){for(let p=1;p<=5;p++) add(p,p,p===cur); ell(); add(total,total);}
  else if(cur>=total-3){add(1,1); ell(); for(let p=total-4;p<=total;p++) add(p,p,p===cur);}
  else {add(1,1); ell(); for(let p=cur-1;p<=cur+1;p++) add(p,p,p===cur); ell(); add(total,total);}
  add('»',total,false,cur===total);
}

/* ===== Category via overlay search grid ===== */
async function openCategory(slug,page=1){
  openSearch(); const grid=document.getElementById('searchGrid'); grid.innerHTML='';
  const res=await fetch(api(`posts?categories=${CATS[slug]}&per_page=${PER_PAGE}&page=${page}`),{headers:headers()});
  const arr=await res.json(); arr.forEach(p=> grid.appendChild(makeVCard(p)));
}

/* ===== Search ===== */
document.getElementById('searchInput').addEventListener('keydown',e=>{if(e.key==='Enter'){doSearch(e.target.value.trim());}});
async function doSearch(q){const grid=document.getElementById('searchGrid'); grid.innerHTML=''; if(!q){grid.innerHTML='<div style="color:var(--muted)">검색어를 입력하세요</div>';return;} const res=await fetch(api(`posts?search=${encodeURIComponent(q)}&per_page=${PER_PAGE}`),{headers:headers()}); const posts=await res.json(); posts.forEach(p=> grid.appendChild(makeVCard(p)));}

/* ===== Post overlay ===== */
async function openPost(id){
  let post=state.cache[id];
  if(!post){const r=await fetch(api(`posts/${id}?_embed`),{headers:headers()}); post=await r.json(); state.cache[id]=post;}
  document.getElementById('postHero').src = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || ph(1200,800);
  document.getElementById('postTitle').innerHTML = post.title?.rendered || '제목 없음';
  document.getElementById('postAvatar').src = post._embedded?.author?.[0]?.avatar_urls?.['96'] || ph(96,96,'U');
  document.getElementById('postAuthor').textContent = post._embedded?.author?.[0]?.name || '익명';
  const cats=(post._embedded?.['wp:term']?.[0]||[]).map(t=>t.name).join(', '); document.getElementById('postDate').textContent = `${fmt(post.date)} · ${cats||'-'}`;

  const content=document.getElementById('postContent'); content.innerHTML = post.content?.rendered || post.excerpt?.rendered || '';
  // 불필요 요소 제거
  try{ Array.from(content.querySelectorAll('*')).forEach(el=>{ if(el.textContent?.includes('이 글 공유하기')) el.remove(); }); }catch(e){}
  try{ content.querySelectorAll('.updated, time[itemprop="dateModified"], [data-modified], .post-modified, .modified-date').forEach(el=>el.remove()); }catch(e){}
  // 임베드 보정 (PC는 적정폭, 모바일은 100%)
  content.querySelectorAll('iframe,video,embed,object').forEach(el=>{el.removeAttribute('width');el.removeAttribute('height');el.style.width='100%';el.style.maxWidth='100%';});

  // 관련 글 4개
  loadRelated(post);

  // 열기 + 진행바 0
  document.getElementById('post').classList.add('active');
  document.getElementById('progressTop').style.width='0%';
  document.getElementById('post').scrollTop=0; state.lastY=0;
  history.pushState({page:'post',id},'',`#post-${id}`);
}
function closePost(){document.getElementById('post').classList.remove('active'); document.getElementById('progressTop').style.width='0%'; history.pushState({page:'home'},'',location.pathname);}

/* 관련 글 */
async function loadRelated(post){
  const cat=(post.categories||[])[0]; const grid=document.getElementById('relatedGrid'); const sect=document.getElementById('related');
  grid.innerHTML=''; sect.style.display='none'; if(!cat) return;
  const res=await fetch(api(`posts?categories=${cat}&per_page=5&orderby=date&order=desc&exclude=${post.id}`),{headers:headers()});
  const arr=await res.json(); const list=(Array.isArray(arr)?arr:[]).slice(0,4); list.forEach(p=> grid.appendChild(makeVCard(p))); if(list.length) sect.style.display='block';
}

/* (4) 진행바 & 위로 스크롤시 툴바 */
document.getElementById('post').addEventListener('scroll', ()=>{
  const ov=document.getElementById('post'); const max=ov.scrollHeight-ov.clientHeight; const pct=max>0?(ov.scrollTop/max)*100:0;
  document.getElementById('progressTop').style.width=Math.min(100,Math.max(0,pct))+'%';
  const y=ov.scrollTop; const bar=document.getElementById('postToolbar');
  if(y < state.lastY - 2) bar.classList.add('show'); else if(y > state.lastY + 40) bar.classList.remove('show');
  state.lastY=y;
});

/* Boot */
document.addEventListener('DOMContentLoaded', ()=>{ loadHome(1); if(location.hash.startsWith('#post-')){const id=parseInt(location.hash.replace('#post-','')); if(id) openPost(id);} });
const router={goHome:()=>{closePost(); loadHome(1); window.scrollTo({top:0,behavior:'smooth'});}};

</script>
</body>
</html>
